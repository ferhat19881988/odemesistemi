<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Firebase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS library for Excel read/write -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // Firebase yapılandırması
  // Doğru yapılandırma için değişken adı belirtilmeli
  const firebaseConfig = {
    apiKey: "AIzaSyBABt0TN-k_ALfHyDv0yGzOiZMhACxfJbU",
    authDomain: "odeme-37f3e.firebaseapp.com",
    databaseURL: "https://odeme-37f3e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odeme-37f3e",
    storageBucket: "odeme-37f3e.firebasestorage.app",
    messagingSenderId: "433986287426",
    appId: "1:433986287426:web:264fe3aa9fabcc09103adb",
    measurementId: "G-QFHTWMBGZ9"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>
  <title>Fenomen Çocuk Kulübü</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-orange: #FF6B00;
      --light-orange: #ff8740;
      --white: #fff;
      --gray: #f4f4f4;
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--gray);
    }

    aside {
      width: 240px;
      background-color: var(--main-orange);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      color: white;
      box-shadow: var(--shadow);
    }

    aside h1 {
      font-size: 1.4rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .menu-item {
      background-color: transparent;
      border: none;
      color: white;
      font-size: 1rem;
      padding: 0.75rem 1rem;
      text-align: left;
      margin-bottom: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .menu-item:hover, .menu-item.active {
      background-color: var(--light-orange);
    }

    main {
      flex-grow: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .panel {
      display: none;
      animation: fade 0.4s ease;
    }

    .panel.active {
      display: block;
    }

    @keyframes fade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 768px) {
      aside {
        width: 100px;
        padding: 1rem 0.5rem;
      }

      aside h1 {
        font-size: 1rem;
      }

      .menu-item {
        font-size: 0.9rem;
        justify-content: center;
      }
    }
    
    .form-card {
  max-width: 700px;
  margin: auto;
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.form-title {
  color: #FF6B00;
  font-size: 1.6rem;
  text-align: center;
  margin-bottom: 2rem;
}

.form-section {
  border-top: 1px solid #ddd;
  padding-top: 1.5rem;
  margin-top: 1.5rem;
}

.form-section h3 {
  color: #FF6B00;
  margin-bottom: 0.3rem;
  font-size: 1.1rem;
}

.form-desc {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
}

label {
  display: block;
  font-weight: 600;
  margin: 0.5rem 0 0.25rem;
}

input, select, textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.radio-group {
  display: flex;
  gap: 1.5rem;
  margin-top: 0.5rem;
}

textarea {
  resize: vertical;
}

.submit-btn {
  margin-top: 0.5rem;
  background: #FF6B00;
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s;
}

.submit-btn:hover {
  background: #e05a00;
}

@media (max-width: 600px) {
  .form-card {
    padding: 1rem;
  }
}
.record-list {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.record-card {
  background: #fff;
  border: 1px solid #ddd;
  border-left: 5px solid #FF6B00;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.record-card p {
  margin: 0.3rem 0;
  font-size: 0.95rem;
}
.filter-bar {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

/* Dashboard kartları ve grafik düzeni */
.dashboard-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
}
.dash-card {
  flex: 1;
  min-width: 150px;
  background: #FFF8E1;
  border-left: 5px solid #FF6F00;
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
}
.dash-card h3 {
  margin: 0;
  font-size: 0.95rem;
  color: #BF360C;
  font-weight: bold;
}
.dash-card p {
  margin: 0.5rem 0 0;
  font-size: 1.4rem;
  font-weight: bold;
  color: #333;
}
.dashboard-charts {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

  /*
   * Dashboard list container and card styles (apply at all screen sizes)
   * The following styles ensure the four dashboard lists appear as separate cards
   * with consistent spacing and responsive behavior.  Previously these rules
   * were defined inside a mobile media query which prevented them from taking
   * effect on desktop screens.  By defining them here outside of any media
   * query they will be applied on all viewport widths.
   */
  .dashboard-lists {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .dashboard-card {
    flex: 1;
    min-width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Yeni düzen: dashboard grupları iki sütun halinde daha dengeli gösterilir */
  .dashboard-group {
    flex: 1;
    min-width: 250px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Dashboard listeleri için satırlar arasında daha fazla boşluk ve okunabilirlik */
  .dashboard-list p {
    /* Araları açmak için daha fazla boşluk ve satır yüksekliği ayarla */
    margin: 0.5rem 0;
    line-height: 1.6;
  }

  .card-header {
    padding: 0.6rem 1rem;
    color: #fff;
    font-weight: 700;
  }

  .card-content {
    padding: 0.6rem 1rem 1rem;
    flex: 1;
  }

  /* Colour variants for the card headers */
  .card-orange .card-header {
    background: #FF9800;
  }
  .card-blue .card-header {
    background: #42A5F5;
  }
  .card-red .card-header {
    background: #E57373;
  }
  .card-green .card-header {
    background: #66BB6A;
  }
@media (max-width: 768px) {
  .dashboard-summary {
    flex-direction: column;
  }

  /* Dashboard lists styles */
  .dashboard-lists {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .dashboard-section {
    flex: 1;
    min-width: 220px;
    background: #fff;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .dashboard-section h3 {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    color: #BF360C;
    font-weight: bold;
  }
  .dashboard-section ul {
    /* Liste madde işaretlerini kaldır */
    list-style-type: none !important;
    padding-left: 0;
    margin: 0;
  }
  .dashboard-section li {
    font-size: 0.9rem;
    padding: 0.3rem 0;
    border-bottom: 1px solid #f1f1f1;
  }
  .dashboard-section li:last-child {
    border-bottom: none;
  }

  /* Açıklama metni */
  .section-desc {
    font-size: 0.8rem;
    color: #555;
    margin: 0.25rem 0 0.5rem;
  }

  /* Yeni liste konteynerleri için stil */
  .dashboard-list {
    display: flex;
    flex-direction: column;
  }
  .dashboard-list p {
    font-size: 0.9rem;
    padding: 0.3rem 0;
    border-bottom: 1px solid #f1f1f1;
    margin: 0.3rem 0;
  }
  .dashboard-list p:last-child {
    border-bottom: none;
  }

  /* Kart tabanlı dashboard bölümleri */
  .dashboard-card {
    flex: 1;
    min-width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .card-header {
    padding: 0.6rem 1rem;
    color: #fff;
    font-weight: 700;
  }
  .card-content {
    padding: 0.6rem 1rem 1rem;
    flex: 1;
  }
  .card-orange .card-header {
    background: #FF9800;
  }
  .card-blue .card-header {
    background: #42A5F5;
  }
  .card-red .card-header {
    background: #E57373;
  }
  .card-green .card-header {
    background: #66BB6A;
  }
}

/* Mobil uyumluluk için ek düzenlemeler */
@media (max-width: 600px) {
  .filter-bar {
    flex-direction: column;
    gap: 0.5rem;
  }
  .btn1 {
    width: 100%;
    margin-right: 0;
  }
  .record-card, .form-card {
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  .record-actions button {
    margin-top: 0.3rem;
    width: 100%;
  }
}

.filter-bar input,
.filter-bar select {
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.record-card {
  background: white;
  padding: 1rem;
  border-left: 5px solid #FF6B00;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  margin-bottom: 1rem;
  position: relative;
}

.record-card .card-actions {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  gap: 0.5rem;
}

.card-actions button {
  padding: 4px 8px;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  font-size: 0.8rem;
}

.card-actions .delete {
  background: #e74c3c;
  color: white;
}

.card-actions .edit {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 99;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 10% auto;
  padding: 2rem;
  max-width: 400px;
  border-radius: 10px;
  position: relative;
}

.modal-content .close {
  position: absolute;
  top: 8px; right: 12px;
  font-size: 20px;
  cursor: pointer;
}
.tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.tab-button {
  padding: 0.6rem 1.2rem;
  background: #eee;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.tab-button.active {
  background: #FF6B00;
  color: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
.kategori-listesi {
  margin-top: 2rem;
}

.kategori-list {
  list-style: none;
  padding: 0;
}

.kategori-list li {
  background: #fff;
  padding: 0.6rem 1rem;
  margin: 0.3rem 0;
  border-left: 4px solid #FF6B00;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 6px;
}

.kategori-list li .actions {
  display: flex;
  gap: 0.5rem;
}

.kategori-list li button {
  padding: 3px 7px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.8rem;
}

.kategori-list li .edit {
  background-color: #3498db;
  color: white;
}

.kategori-list li .delete {
  background-color: #e74c3c;
  color: white;
}
.btn1 {
  padding: 0.5rem 1.2rem;
  background-color: #FF6B00;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.3s ease;
  margin-top: 20px;
}

.btn1:hover {
  background-color: #e25a00;
}
.form-actions1 {
  text-align: right;
}
.date-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.date-btn {
  padding: 6px 12px;
  border: none;
  background: #eee;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.date-btn:hover {
  background-color: #FF6B00;
  color: white;
}

.rapor-kutular {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.rapor-kutu {
  background-color: #fff;
  padding: 1.8rem 2rem;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.07);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.2rem;
  font-weight: 600;
  transition: 0.3s ease;
}

.rapor-kutu:hover {
  transform: scale(1.01);
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.rapor-kutu.gelir {
  border-left: 8px solid #2ecc71;
  background: linear-gradient(to right, #e9f7ef, #d4efdf);
  color: #145a32;
}

.rapor-kutu.gider {
  border-left: 8px solid #e74c3c;
  background: linear-gradient(to right, #fdecea, #fadbd8);
  color: #78281f;
}

.rapor-kutu.fark {
  border-left: 8px solid #ff6b00;
  background: linear-gradient(to right, #fff2e6, #ffe0cc);
  color: #a04000;
}

.rapor-kutu span {
  font-size: 1.6rem;
  font-weight: bold;
}

.print-panel {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.06);
  margin-top: 1.5rem;
}


.yazdir-onizleme {
  margin-top: 1rem;
  padding: 1rem;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  max-height: 400px;
  overflow-y: auto;
  font-size: 0.95rem;
}

.yazdir-onizleme table {
  width: 100%;
  border-collapse: collapse;
}

.yazdir-onizleme th,
.yazdir-onizleme td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.modal-content {
  background: #fff;
  padding: 2rem;
  border-radius: 16px;
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
  width: 400px;
  max-width: 95%;
  font-family: 'Nunito', sans-serif;
  position: relative;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.modal-content h3 {
  font-size: 22px;
  color: #FF6B00;
  margin-bottom: 1.5rem;
  text-align: center;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.modal-content label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  font-size: 14px;
  color: #444;
}

.modal-content input[type="text"] {
  width: 100%;
  padding: 12px 14px;
  font-size: 15px;
  border: 1px solid #ddd;
  border-radius: 10px;
  transition: 0.3s;
  outline: none;
  background-color: #f9f9f9;
}

.modal-content input[type="text"]:focus {
  border-color: #FF6B00;
  background-color: #fff;
  box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.2);
}

.modal-content button[type="submit"] {
  margin-top: 1.2rem;
  background-color: #FF6B00;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background-color 0.3s ease;
}

.modal-content button[type="submit"]:hover {
  background-color: #e25a00;
}

.modal-content .close {
  position: absolute;
  top: 12px;
  right: 18px;
  font-size: 28px;        /* Daha büyük */
  font-weight: bold;      /* Kalın */
  color: #333;            /* Daha koyu gri */
  cursor: pointer;
  transition: color 0.3s ease, transform 0.2s ease;
}

.modal-content .close:hover {
  color: #FF6B00;          /* Turuncuya döner */
  transform: scale(1.2);   /* Hafif büyür */
}

#giderListesi li {
  border-left: 4px solid #8e44ad; /* Mor ton */
}
.record-card {
  background: #fff;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: 0.2s;
}
.record-card:hover {
  transform: translateY(-2px);
}

.gelir-card {
  border-left: 4px solid #ffa726 !important;
}

.gider-card {
  border-left: 4px solid #ab47bc !important;
}

.record-title {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 6px;
}

.record-header {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-bottom: 6px;
}

.record-amount {
  font-weight: bold;
}

.record-details {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}

.record-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.record-actions .btn-sil {
  background: #f44336;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.record-actions .btn-guncelle {
  background: #2196f3;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}

.record-actions button {
  padding: 6px 12px;
  margin-right: 8px;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.record-actions button:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

/* Güncelle modal stilleri */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 30px 25px;
  border-radius: 8px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  position: relative;
  animation: slideIn 0.3s ease-out;
  font-family: sans-serif;
}

.modal-content h3 {
  margin-top: 0;
  color: #ff6600;
  font-size: 20px;
}

.modal-content label {
  font-weight: bold;
  margin-top: 10px;
  display: block;
  font-size: 14px;
}

.modal-content input,
.modal-content textarea {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.modal-content button {
  background-color: #28a745;
  color: #fff;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.modal-content button:hover {
  background-color: #218838;
}

/* Kapat X işareti */
.modal-content .close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 26px;
  font-weight: bold;
  color: #333;
  cursor: pointer;
  transition: color 0.2s ease;
}

.modal-content .close:hover {
  color: #000;
}

/* Giriş animasyonu */
@keyframes slideIn {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
.btn-guncelle {
  background-color: #ffc107;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-guncelle:hover {
  background-color: #ff9800;
  color: white;
}
/* Taksit ödeme durumuna göre renkler */
.taksit-odendi {
  border-left: 5px solid #2ecc71;
  background-color: #e9f7ef;
}

.taksit-odenmedi {
  border-left: 5px solid #e74c3c;
  background-color: #fdecea;
}

/* 🔶 Kısmi ödenmiş taksitler için stil */
.taksit-kismi {
  border-left: 5px solid #f1c40f;
  background-color: #fcf3cf;
  opacity: 0.9;
}

/* 🔴 Vadesi geçmiş taksitler için vurgu */
.taksit-overdue {
  border-left: 5px solid #e74c3c;
  background-color: #fadbd8;
}
.date-filter {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-end;
  gap: 1rem;
  margin: 1rem 0;
  background: #fff;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.date-filter label {
  font-weight: 600;
  margin-bottom: 4px;
  display: block;
  color: #333;
}

.date-filter input[type="date"] {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
  transition: border 0.3s;
  background: #f9f9f9;
}

.date-filter input[type="date"]:focus {
  border-color: #FF6B00;
  outline: none;
  background: #fff;
}

.quick-buttons {
  display: flex;
  gap: 0.5rem;
  margin-top: 6px;
}

.quick-buttons button {
  background-color: #eee;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.quick-buttons button:hover,
.quick-buttons button.active {
  background-color: #FF6B00;
  color: white;
}

.taksit-kart-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-top: 1rem;
}

.taksit-kart {
  background-color: #f1f1f1;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  padding: 1rem;
  position: relative;
  width: 240px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.taksit-kart label {
  font-weight: bold;
  margin-bottom: 0.3rem;
}

.taksit-kart input[type="number"],
.taksit-kart input[type="date"] {
  padding: 0.4rem;
  border-radius: 4px;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
}

.taksit-sil-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: #888;
  transition: color 0.2s ease;
}

.taksit-sil-btn:hover {
  color: #e53935;
}

.taksit-ekle-btn {
  background-color: #4caf50;
  color: white;
  padding: 0.5rem 1.2rem;
  border: none;
  border-radius: 6px;
  margin-top: 1rem;
  font-size: 15px;
  cursor: pointer;
}

.taksit-ekle-btn:hover {
  background-color: #3e8e41;
}

.record-card {
  background: #fff;
  border-left: 4px solid #FF6B00;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 10px;
  padding: 1.2rem 1.5rem;
  margin: 1rem auto;
  max-width: 550px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.ogrenci-kart-header {
  display: flex;
  justify-content: space-between;
  font-size: 1.1rem;
  font-weight: bold;
  color: #2c3e50;
}

.ogrenci-info {
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
  color: #444;
}

.ogrenci-info div {
  width: 48%;
}

.record-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.6rem;
  margin-top: 1rem;
}

.record-card {
  border-left: 4px solid #ccc; /* default */
}

.renk-mavi     { border-left-color: #3498db; }
.renk-yesil    { border-left-color: #2ecc71; }
.renk-lila     { border-left-color: #9b59b6; }
.renk-sari     { border-left-color: #f1c40f; }
.renk-pembe    { border-left-color: #e91e63; }
.renk-kahve    { border-left-color: #8e715f; }
.renk-kirmizi  { border-left-color: #e74c3c; }
.renk-turuncu  { border-left-color: #e67e22; }
.renk-default  { border-left-color: #bdc3c7; }


.responsive-modal {
    max-width: 95vw;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    margin: auto;
  }

  .grid-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group input,
  .form-group select {
    padding: 0.4rem;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  .grid-full {
    grid-column: 1 / -1;
  }

  .modal-actions {
    margin-top: 2rem;
    text-align: right;
    display: flex;
    gap: 1rem;
    justify: flex-end;
  }

  .btn-kaydet,
  .btn-iptal {
    padding: 0.6rem 1.2rem;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-kaydet {
    background-color: #28a745;
    color: white;
  }

  .btn-iptal {
    background-color: #dc3545;
    color: white;
  }
.taksit-buttons {
    display: flex;
    gap: 1rem;
  }

  .taksit-buttons button {
    padding: 0.4rem 1rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .taksit-buttons button:hover {
    background-color: #0056b3;
  }
  /* 📦 Modal dış çerçevesi */
.modal5 {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: none;
  justify-content: center;
  align-items: center;
  background-color: rgba(0,0,0,0.6);
  z-index: 999;
}

/* 📄 İçerik kutusu */
.modal-icerik {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 800px; /* yatay genişlik */
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  max-height: 90vh;
  overflow-y: auto;
}

/* 🧩 Form içerikleri grid yapısına böl */
.form-grid-2col {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

#ogrenciGuncelleModal button:hover {
  background-color: #0056b3;
  transform: scale(1.05);
}
  </style>
<aside>
    <h1>Fenomen Çocuk Kulübü</h1>
    <!-- Yeni Dashboard sekmesi -->
    <button class="menu-item" onclick="switchPanel('dashboard', event)">🏠 Anasayfa</button>
    <button class="menu-item active" onclick="switchPanel('gelir', event)">💰 Gelir-Gider</button>
    <button class="menu-item" onclick="switchPanel('ogrenci', event)">🎓 Öğrenci Takip</button>
    <!-- Yeni Raporlar menü öğesi -->
    <button class="menu-item" onclick="switchPanel('raporlar', event)">📊 Raporlar</button>
    <!-- Yeni yedekleme menü öğesi -->
    <button class="menu-item" onclick="switchPanel('yedekleme', event)">🗄️ Yedekleme</button>
</aside>

<main>
    <!-- 🏠 Dashboard Paneli -->
    <div id="panel-dashboard" class="panel">
      <div class="form-card" style="max-width:1200px;margin:auto;">
        <h2 class="form-title" style="margin-bottom:1rem;">📊 Genel Dashboard</h2>
        <!-- Özet Kutular -->
        <!-- Dashboard özet kutularını iki grup halinde düzenle -->
        <div class="dashboard-summary">
          <div class="dashboard-group">
            <div class="dash-card">
              <h3>👥 Öğrenci Sayısı</h3>
              <p id="dashStudentCount">-</p>
            </div>
            <div class="dash-card">
              <!-- 'Toplam Tutar' kutusunu 'Bugün Beklenen Alacak' olarak değiştirdik -->
              <h3>💰 Bugün Beklenen Alacak</h3>
              <p id="dashTotalDue">-</p>
            </div>
            <div class="dash-card">
              <h3>✅ Ödenen</h3>
              <p id="dashTotalPaid">-</p>
            </div>
          </div>
          <div class="dashboard-group">
            <div class="dash-card">
              <h3>🧾 Kalan</h3>
              <p id="dashTotalRemaining">-</p>
            </div>
            <div class="dash-card">
              <h3>⏰ Vadesi Geçmiş</h3>
              <p id="dashTotalOverdue">-</p>
            </div>
            <div class="dash-card">
              <h3>🌓 Kısmi Taksitler</h3>
              <p id="dashTotalPartial">-</p>
            </div>
          </div>
        </div>
        <!-- Listeler -->
        <div class="dashboard-lists">
          <div class="dashboard-card card-orange">
            <div class="card-header">
              <h3>🧑‍🎓 Son 5 Kayıtlı Öğrenci</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste sisteme en son kayıt olan 5 öğrenciyi ve kayıt/işlem tarihlerini gösterir.</p>
              <div id="lastStudentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-blue">
            <div class="card-header">
              <h3>📑 Son 10 Gelir/Gider Kaydı</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste en son eklenen 10 gelir veya gider kaydını; tarih, tür, tutar, kategori ve açıklama bilgisiyle listeler.</p>
              <div id="lastRecordsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-red">
            <div class="card-header">
              <h3>⏰ Vadesi Geçmiş Taksitler</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste vadesi geçmiş taksitlerin hangi öğrenci ve veliden, kaçıncı taksit olduğunu ve kalan tutarı gösterir.</p>
              <div id="overdueStudentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-green">
            <div class="card-header">
              <h3>📅 1 Hafta İçinde Vadesi Gelecek Taksitler</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste önümüzdeki 7 gün içinde ödemesi gelecek taksitleri; hangi öğrenci ve veliden, kaçıncı taksit olduğunu ve kalan tutarı gösterir.</p>
              <div id="upcomingPaymentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel-gelir" class="panel active">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('form', event)">➕ Yeni Kayıt</button>
            <button class="tab-button" onclick="switchTab('kategori', event)">📂 Kategori Yönetimi</button>
            <button class="tab-button" onclick="switchTab('liste', event)">📋 Kayıt Listesi</button>
            <button class="tab-button" onclick="switchTab('rapor', event)">📊 Raporlar</button>
        </div>

        <div id="tab-form" class="tab-content active">
            <form id="income-expense-form" class="form-card">
                <h2 class="form-title">Yeni Gelir/Gider Kaydı</h2>
                <div class="form-section">
                    <h3>📌 Kayıt Bilgisi</h3>
                    <p class="form-desc">Tarih ve gelir/gider türünü seçin.</p>
                    <label for="date">Tarih:</label>
                    <input type="date" id="date" required>
                    <label>Tür:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="type" value="gelir" onclick="kategoriSecimiYukle()"> Gelir</label>
                        <label><input type="radio" name="type" value="gider" onclick="kategoriSecimiYukle()"> Gider</label>
                    </div>
                </div>
                <div class="form-section">
                    <h3>📂 Kategori & Ödeme</h3>
                    <p class="form-desc">Kategori seçin ve ödeme yöntemini belirtin.</p>
                    <label for="category">Kategori:</label>
                    <select id="category" required>
                        <option value="">Kategori seçin</option>
                    </select>
                    <label for="payment">Ödeme Türü:</label>
                    <select id="payment" required>
                        <option value="">Seçiniz</option>
                        <option value="nakit">Nakit</option>
                        <option value="kredi_karti">Kredi Kartı</option>
                        <option value="eft">EFT / Havale</option>
                        <option value="elden_banka">Elden Bankaya Yatırma</option>
                        <option value="online">Online Ödeme</option>
                        <option value="diğer">Diğer</option>
                    </select>
                </div>
                <div class="form-section">
                    <h3>💰 Tutar & Para Birimi</h3>
                    <p class="form-desc">Para birimi ve giriş tutarını girin.</p>
                    <label for="currency">Para Birimi:</label>
                   <select id="currency" onchange="updateCurrencySymbol()">
  <option value="TRY">₺ TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">€ EUR</option>
</select>

<label for="amount">Tutar (<span id="currency-symbol">₺</span>)</label>
<input type="text"
       id="amount"
       autocomplete="off"
       data-raw="0"
       oninput="captureRawAmount()"
       onblur="formatAmountLive()">

                </div>
                <div class="form-section">
                    <h3>📝 Açıklama (Opsiyonel)</h3>
                    <p class="form-desc">Varsa kısa açıklama yazabilirsiniz.</p>
                    <label for="note">Açıklama:</label>
                    <textarea id="note" rows="2" placeholder="Açıklama girin..."></textarea>
                </div>
                <div class="form-section">
                    <div class="form-actions1">
                        <button type="submit" class="submit-btn">Kaydı Ekle</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="tab-kategori" class="tab-content">
            <div class="form-card">
                <div class="form-section">
                    <h3>📂 Kategori Yönetimi</h3>
                    <form id="kategoriForm">
                        <label>Tür:</label>
                        <select id="kategoriTur">
                            <option value="gelir">Gelir</option>
                            <option value="gider">Gider</option>
                        </select>
                        <label>Kategori Adı:</label>
                        <input type="text" id="kategoriAdi" required>
                        <button type="submit" class="btn1">➕ Ekle</button>
                    </form>
                    <div class="kategori-listesi">
                        <h4>📥 Gelir Kategorileri</h4>
                        <ul id="gelirListesi" class="kategori-list"></ul>
                        <h4>📤 Gider Kategorileri</h4>
                        <ul id="giderListesi" class="kategori-list"></ul>
                    </div>
                </div>
            </div>
            <div id="kategoriEditModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="kapatKategoriModal()">&times;</span>
                    <h3>Kategori Güncelle</h3>
                    <form id="kategoriEditForm">
                        <input type="hidden" id="editKategoriId">
                        <input type="hidden" id="editKategoriTur">
                        <label for="editKategoriAdi">Yeni Ad:</label>
                        <input type="text" id="editKategoriAdi" required>
                        <button type="submit">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="tab-liste" class="tab-content">
            <div class="form-card">
                <div class="form-section">
                    <h3>📋 Kayıt Listesi</h3>
                    <p class="form-desc">Tüm gelir/gider kayıtlarını aşağıda görüntüleyebilirsiniz.</p>
                    <div class="filter-bar">
                        <input type="text" id="searchInput" placeholder="🔍 Arama yapın...">
                        <select id="filterType" onchange="kategoriFiltreSecenekleriniYukle(); kayitlariGetir();">
                            <option value="">Hepsi</option>
                            <option value="gelir">Sadece Gelir</option>
                            <option value="gider">Sadece Gider</option>
                        </select>
                        <select id="filterKategori">
                            <option value="">Tüm Kategoriler</option>
                        </select>
                    </div>
                    <!-- Kayıt listesi filtrelerinin hemen altına yenile butonu eklendi. Bu buton tıklandığında veriler yeniden Firebase'den çekilir ve liste güncellenir. -->
                    <div style="margin-top:0.5rem;">
                        <button id="yenileKayitBtn" class="btn1" onclick="kayitlariGetir()">🔄 Yenile</button>
                    </div>
                    <div id="kayitlarListesi" class="record-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-rapor" class="tab-content">
            <div class="form-card">
                <h3>📊 Gelir-Gider Raporları</h3>
                <div class="date-filters">
                    <button onclick="raporFiltrele('bugun')" class="date-btn">Bugün</button>
                    <button onclick="raporFiltrele('hafta')" class="date-btn">Bu Hafta</button>
                    <button onclick="raporFiltrele('ay')" class="date-btn">Bu Ay</button>
                    <button onclick="raporFiltrele('3ay')" class="date-btn">3 Ay</button>
                    <button onclick="raporFiltrele('6ay')" class="date-btn">6 Ay</button>
                    <button onclick="raporFiltrele('1yil')" class="date-btn">1 Yıl</button>
                </div>
                <div class="rapor-kutular">
                    <div class="rapor-kutu gelir">💰 Toplam Gelir: <span id="raporGelir">₺0</span></div>
                    <div class="rapor-kutu gider">💸 Toplam Gider: <span id="raporGider">₺0</span></div>
                    <div class="rapor-kutu fark">🔄 Fark: <span id="raporFark">₺0</span></div>
                </div>
                <canvas id="raporChart" height="200"></canvas>
                <div id="yazdirPaneli"></div>
                <hr>
                <h4>🖨 Yazdırma Paneli</h4>
                <div class="print-panel">
                    <label>Rapor Türü:</label>
                    <select id="raporSecim" onchange="hazirlaYazdirmaOnizleme()">
                        <option value="tum" selected>Tüm Kayıtlar</option>
                        <option value="gelir">Sadece Gelir</option>
                        <option value="gider">Sadece Gider</option>
                    </select>
                    <div class="date-filter">
                        <label>Tarih Aralığı:</label>
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        <div class="quick-buttons">
                            <button onclick="setQuickRange('today')">Bugün</button>
                            <button onclick="setQuickRange('week')">1 Hafta</button>
                            <button onclick="setQuickRange('month')">1 Ay</button>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn1" onclick="tarihiUygula()">Tarihi Uygula</button>
                        <button class="btn1" onclick="yazdirRapor()">🖨 Yazdır</button>
                        <button class="btn1" onclick="acWhatsappModal()">📤 WhatsApp'tan Gönder</button>
                    </div>
                </div>
                <div id="yazdirOnizleme" class="yazdir-onizleme"></div>
            </div>
        </div>
    </div>

    <div id="panel-ogrenci" class="panel">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('kayit', event)">➕ Öğrenci Kayıt</button>
            <button class="tab-button" onclick="switchTab('ogrenci-liste', event)">📄 Öğrenci Listesi</button>
            <button class="tab-button" onclick="switchTab('taksit', event)">💸 Taksitler</button>
            <button class="tab-button" onclick="switchTab('odeme', event)">💳 Ödemeler</button>
        </div>

        <div id="tab-kayit" class="tab-content active">
            <div class="form-card">
                <h2 class="form-title">📚 Öğrenci Kayıt Formu</h2>
                <form id="ogrenciKayitFormu" onsubmit="return validateForm();">
                    <div class="form-section">
                        <h3>🤓 Öğrenci Bilgileri</h3>
                        <label>Ad Soyad <span style="color:red">*</span></label>
                        <small>Öğrencinin tam adını giriniz.</small>
                        <input type="text" id="adSoyad" autocomplete="off">
                        <small class="error" id="adSoyadError"></small>

                        <label>Doğum Tarihi</label>
                        <small>İsteğe bağlıdır. Öğrencinin doğum tarihini giriniz.</small>
                        <input type="date" id="dogumTarihi">

                        <label for="tc">TC Kimlik No <span style="color:red">*</span></label>
                        <small>11 haneli T.C. Kimlik numarası girilmelidir.</small>
                        <input type="text" id="tc" autocomplete="off" name="tc" maxlength="11" inputmode="numeric" pattern="[1-9][0-9]{10}" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,11);">
                        <small class="error" id="tcError"></small>

                        <label>Öğrenci Numarası (4–5 rakam) <span style="color:red">*</span></label>
                        <small>Kullanıcı tarafından belirlenir. 4 veya 5 rakamlı bir numara giriniz. Örn: 8001</small>
                        <input type="text" id="ogrNo" autocomplete="off" minlength="4" maxlength="5" pattern="\\d{4,5}" inputmode="numeric">
                        <small class="error" id="ogrNoError"></small>

                        <label>Sınıf <span style="color:red">*</span></label>
                        <small>1 ile 8 arasında sınıf seçimi yapınız.</small>
                        <select id="sinif">
                            <option value="">Seçin</option>
                            <option>1</option><option>2</option><option>3</option><option>4</option>
                            <option>5</option><option>6</option><option>7</option><option>8</option>
                        </select>
                        <small class="error" id="sinifError"></small>

                        <label>Grup <span style="color:red">*</span></label>
                        <small>A–H arasında bir grup seçiniz.</small>
                        <select id="grup">
                            <option value="">Seçin</option>
                            <option>A</option><option>B</option><option>C</option><option>D</option>
                            <option>E</option><option>F</option><option>G</option><option>H</option>
                        </select>
                        <small class="error" id="grupError"></small>

                        <label>Okul Adı</label>
                        <small>Öğrencinin devam ettiği okulun adını giriniz. (Zorunlu değil)</small>
                        <input type="text" id="okul" autocomplete="off">

                        <label>Eğitim Programı <span style="color:red">*</span></label>
                        <small>Programı seçiniz: Yaz, Kış veya Deneme Kulübü.</small>
                        <select id="egitimProgrami">
                            <option value="">Seçin</option>
                            <option>Yaz</option>
                            <option>Kış</option>
                            <option>Deneme Kulübü</option>
                        </select>
                        <small class="error" id="egitimProgramiError"></small>

                        <label for="kayitTarihi">Kayıt Tarihi <span style="color:red">*</span></label>
                        <small>Öğrencinin sisteme kayıt olduğu tarihi seçiniz.</small>
                        <input type="date" id="kayitTarihi" onchange="guncelleKayitTarihi()">
                        <small style="color:#555">Seçilen tarih: <span id="kayitTarihiGorunum"></span></small>

                        <label for="islemTarihi">İşlem Tarihi <span style="color:red">*</span></label>
                        <small>Bu formun doldurulduğu sistem tarihidir, değiştirilemez.</small>
                        <input type="date" id="islemTarihi" disabled>
                        <small style="color:#555">Görünüm: <span id="islemTarihiGorunum"></span></small>
                    </div>

                    <div class="form-section">
                        <h3>👨‍👩‍👧 Veli Bilgileri</h3>
                        <label>Veli Ad Soyad <span style="color:red">*</span></label>
                        <small>Öğrencinin velisinin tam adını giriniz.</small>
                        <input type="text" id="veliAd" autocomplete="off">
                        <small class="error" id="veliAdError"></small>

                        <label>Veli Telefon 1 <span style="color:red">*</span></label>
                        <small>Veliye ulaşılacak cep telefonu numarasını giriniz. Format: (5XX) XXX XX XX</small>
                        <input type="tel" id="veliTel1" autocomplete="off" maxlength="17" placeholder="(5__) ___ __ __" oninput="telefonGirisFormatla(this)">

                        <label>Veli Telefon 2</label>
                        <small>İsteğe bağlıdır. Alternatif bir telefon numarası girilebilir.</small>
                        <input type="tel" id="veliTel2" autocomplete="off" maxlength="17" placeholder="(5__) ___ __ __" oninput="telefonGirisFormatla(this)">
                    </div>

                    <div class="form-section">
                        <h3>💳 Ödeme Bilgileri</h3>
                        <label for="paraBirimi">Para Birimi:</label>
                        <small>İşlemin yapılacağı para birimini seçiniz.</small>
                        <!-- Öğrenci Para Birimi -->
<select id="paraBirimi" onchange="updateToplamTutarSymbol(); formatToplamTutar(); formatTaksitGorunumleri();">
  <option value="TRY">₺ TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">€ EUR</option>
</select>

<!-- Toplam Tutar -->
<label for="toplamTutar">
  Toplam Tutar (<span id="toplamTutarSymbol">₺</span>) <span style="color:red">*</span>
</label>
<small>Öğrencinin ödeyeceği toplam ücreti giriniz. Örn: 10000</small>

<input type="text"
       id="toplamTutar"
       required
       data-raw="0"
       autocomplete="off"
       oninput="captureToplamTutar(); olusturTaksitler();"
       onblur="formatToplamTutar()">

<small class="error" id="toplamTutarError"></small>


                        <label>Taksit Sayısı (1–12) <span style="color:red">*</span></label>
                        <small>Toplam ödeme kaç takside bölünecekse onu seçiniz. 1 ile 12 arasında olmalıdır.</small>
                        <input type="number" id="taksitSayisi" min="1" max="12" onchange="olusturTaksitler()">
                        <small class="error" id="taksitSayisiError"></small>

                        <label>İlk Taksit Tarihi <span style="color:red">*</span></label>
                        <small>İlk ödemenin yapılacağı tarihi giriniz. Diğerleri buna göre aylık hesaplanacaktır.</small>
                        <input type="date" id="ilkTaksitTarihi" onchange="olusturTaksitler()">
                        <small class="error" id="ilkTaksitTarihiError"></small>

                        <div id="taksitBolumu">
                            <h3>📋 Taksitler</h3>
                            <div id="taksitKutulari" class="taksit-kart-container"></div>
                            <button type="button" class="taksit-ekle-btn" onclick="taksitEkle()">+ Taksit Ekle</button>
                        </div>
                    </div>

                    <div class="form-actions1">
                        <button type="button" class="submit-btn" onclick="kaydetOgrenci()">Kaydet</button>
                        <button class="submit-btn" onclick="event.preventDefault(); sayfayiYenile()">↻ Yenile</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Yeni, çakışmasız versiyon -->
<div id="tab-ogrenci-liste" class="tab-content active">
  <div class="form-card" style="max-width: 1200px; margin: auto;">

    <!-- 📌 Başlık ve Toplam -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <h2 class="form-title" style="margin: 0;">🎓 Öğrenci Listesi</h2>
      <span id="ogrToplam" style="font-weight: 600; font-size: 1rem; color: #555;">Toplam: 0 öğrenci</span>
    </div>

    <!-- 🔍 Filtre Bar -->
    <div class="filter-bar" style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
      <input type="text" id="ogrAraNo" placeholder="🔢 Öğrenci No">
      <input type="text" id="ogrAraAdSoyad" placeholder="👤 Ad Soyad">
      <input type="text" id="ogrAraTC" placeholder="🆔 TC Kimlik No">
      <select id="ogrAraProgram">
        <option value="">🎓 Tüm Programlar</option>
        <option value="Yaz">Yaz</option>
        <option value="Kış">Kış</option>
        <option value="Deneme Kulübü">Deneme Kulübü</option>
      </select>
    </div>

    <!-- 📋 Listele Butonu (orta hizalı) -->
    <div style="text-align: right; margin-top: 1rem;">
      <button class="btn1" onclick="ogrListele()">📋 Listele</button>
      <button class="btn1" onclick="ogrYenile()">🔄 Yenile</button>
    </div>

    <!-- 📤 Üst Butonlar -->
    <div style="margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 0.8rem;">
      <button class="btn1" onclick="excelDisariAktar()">📥 Dışa Aktar</button>
      <button class="btn1" onclick="acTopluYukleModal()">📤 Toplu Öğrenci Yükle</button>
      <button class="btn1" onclick="gosterSablonModal()">📄 Şablon Örneği</button>
      <button class="btn1" onclick="acTopluSilModal()">🧹 Toplu Sil</button>
    </div>

    <!-- 🧾 Öğrenci Kartları -->
    <div id="ogrKartListesi" class="taksit-kart-container" style="margin-top: 2rem;"></div>

    <!-- 🔢 Sayfa Kontrolleri -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; flex-wrap: wrap;">
      <div>
        <label for="ogrSayfaBoyutu"><strong>👁 Sayfa Boyutu:</strong></label>
        <select id="ogrSayfaBoyutu" onchange="ogrListele()" style="margin-left: 0.5rem;">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
      <div id="ogrPagination" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
    </div>

  </div>
</div>



        <div id="tab-taksit" class="tab-content">
            <div class="form-card">
                <h3>💳 Taksit Listesi</h3>
                <div class="filter-bar">
                    <input type="text" id="taksitAraNo" placeholder="🔢 Öğrenci No...">
                    <input type="text" id="taksitAraAd" placeholder="👤 Öğrenci Adı...">
                    <select id="taksitDurum">
                        <option value="">💼 Tüm Durumlar</option>
                        <option value="odendi">Ödendi</option>
                        <option value="odenmedi">Ödenmedi</option>
                    </select>
                    <input type="date" id="taksitBaslangic">
                    <input type="date" id="taksitBitis">
                    <button class="btn1" onclick="taksitListele()">🔍 Listele</button>
                    <button class="btn1" onclick="taksitFiltreTemizle()">❌ Temizle</button>
                </div>
                <!-- 🛑 Vadesi geçmiş taksitler için ayrı liste -->
                <div id="taksitOverdueListesi" class="record-list"></div>
                <div id="taksitListesi" class="record-list"></div>

                <!-- 📊 Rapor ve Yazdır butonları -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <!-- Raporla butonu kaldırıldı -->
                </div>
            </div>
        </div>

        <div id="tab-odeme" class="tab-content">
            <div class="form-card">
                <h3>💸 Ödeme Geçmişi</h3>
                <div class="filter-bar">
                    <input type="text" id="odemeAraNo" placeholder="🔢 Öğrenci No...">
                    <input type="text" id="odemeAraAd" placeholder="👤 Öğrenci Adı...">
                    <select id="odemeProgram">
                        <option value="">🎓 Tüm Programlar</option>
                        <option value="Yaz">Yaz</option>
                        <option value="Kış">Kış</option>
                        <option value="Deneme Kulübü">Deneme Kulübü</option>
                    </select>
                    <button class="btn1" onclick="odemeListele()">🔍 Listele</button>
                    <button class="btn1" onclick="odemeFiltreTemizle()">❌ Temizle</button>
                </div>
                <div id="odemeListesi" class="record-list"></div>
                <!-- 📊 Rapor ve Yazdır butonları -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <!-- Raporla butonu kaldırıldı -->
                </div>
            </div>
        </div>
    </div>
    <!-- 📊 Raporlar Paneli -->
    <div id="panel-raporlar" class="panel">
        <div class="form-card" style="max-width: 800px; margin: auto;">
            <h2 class="form-title">📊 Raporlar</h2>
            <p style="margin-bottom: 1rem;">Bu bölümde finansal, öğrenci ve taksit durumu raporları oluşturabilirsiniz. Tarih aralığı, rapor türü ve sınıf/grup gibi filtreler seçerek rapor alın.</p>
            <label for="raporlar-tur">Rapor Türü:</label>
            <select id="raporlar-tur" style="margin-bottom: 0.5rem;">
                <option value="finans">Finansal Rapor</option>
                <option value="ogrenci">Öğrenci Raporu</option>
                <option value="taksit">Taksit Durumu Raporu</option>
            </select>
            <label for="raporlar-start-date">Tarih Aralığı:</label>
            <div style="display:flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap:wrap;">
                <input type="date" id="raporlar-start-date">
                <input type="date" id="raporlar-end-date">
            </div>
            <label for="raporlar-sinif">Sınıf/Grup/Program (opsiyonel):</label>
            <div style="display:flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap:wrap;">
                <select id="raporlar-sinif">
                    <option value="">Tüm Sınıflar</option>
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                </select>
                <select id="raporlar-grup">
                    <option value="">Tüm Gruplar</option>
                    <option>A</option><option>B</option><option>C</option><option>D</option>
                    <option>E</option><option>F</option><option>G</option><option>H</option>
                </select>
                <!-- Program filtresi -->
                <select id="raporlar-program">
                    <option value="">Tüm Programlar</option>
                    <option>Yaz</option>
                    <option>Kış</option>
                    <option>Deneme Kulübü</option>
                </select>
            </div>
            <div style="display:flex; gap: 0.5rem; flex-wrap:wrap; margin-bottom: 0.5rem;">
                <button class="btn1" onclick="raporlarOlustur()">Raporu Oluştur</button>
                <button class="btn1" onclick="raporlarYazdir()">🖨 Yazdır</button>
                <button class="btn1" onclick="raporlarWhatsappGonder()">📤 WhatsApp'tan Gönder</button>
                <!-- 🧾 Excel indirme butonu -->
                <button class="btn1" onclick="raporlarExcelIndir()">📥 Excel İndir</button>
            </div>
            <div id="raporlarSonuc" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <!-- 🗄️ Yedekleme Paneli -->
    <div id="panel-yedekleme" class="panel">
      <div class="form-card" style="max-width:600px;margin:auto;">
        <h2 class="form-title">🗄️ Yedekleme</h2>
        <p style="margin-bottom:1rem;">Veri tabanınızı yedekleyebilir veya daha önce oluşturulmuş bir yedeği geri yükleyebilirsiniz.</p>
        <button class="btn1" onclick="yedekOlustur()">📁 Yedek Oluştur</button>
        <button class="btn1" onclick="yedekYukle()">📂 Yedeği Geri Yükle</button>
        <!-- Dosya seçimi için gizli input -->
        <input type="file" id="yedekDosyaInput" accept=".json" style="display:none;" />
      </div>
    </div>
</main>

<div id="whatsappModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="kapatWhatsappModal()">&times;</span>
        <h3>📲 WhatsApp Mesajı Gönder</h3>
        <p>Oluşturulan mesaj:</p>
        <textarea id="whatsappMesaji" rows="6" style="width:100%; font-size:1rem;"></textarea>
        <button onclick="gonderWhatsappMesaji()" class="btn1">Gönder</button>
    </div>
</div>

<div id="guncelleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="modalKapat()">&times;</span>
        <h3>✏️ Kaydı Güncelle</h3>
        <input type="hidden" id="modalId">
        <label>Tarih:</label>
        <input type="date" id="modalTarih"><br>
        <label>Tür:</label>
        <div class="radio-group">
            <label><input type="radio" name="modalType" value="gelir" onchange="modalKategoriYukle()"> Gelir</label>
            <label><input type="radio" name="modalType" value="gider" onchange="modalKategoriYukle()"> Gider</label>
        </div>
        <label>Kategori:</label>
        <select id="modalKategori"></select><br>
        <label>Ödeme Türü:</label>
        <select id="modalOdeme">
            <option value="nakit">Nakit</option>
            <option value="kredi_karti">Kredi Kartı</option>
            <option value="eft">EFT / Havale</option>
            <option value="elden_banka">Elden Bankaya Yatırma</option>
            <option value="online">Online Ödeme</option>
            <option value="diğer">Diğer</option>
        </select><br>
        <label>Para Birimi:</label>
        <select id="modalPara" onchange="modalFormatAmount()">
  <option value="TRY">₺ TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">€ EUR</option>
</select>

<input type="text"
       id="modalTutar"
       autocomplete="off"
       data-raw="0"
       oninput="modalCaptureRawAmount()"
       onblur="modalFormatAmount()">

        <label>Açıklama:</label>
        <textarea id="modalAciklama"></textarea><br>
        <button onclick="kaydiGuncelle()">💾 Kaydet</button>
    </div>
</div>
<!-- Öğrenci Güncelleme Modalı -->
<div id="ogrenciGuncelleModal" class="modal5" style="display: none;">
  <div class="modal-icerik responsive-modal">
  <h2>📋 Öğrenci Güncelle</h2>

  <div class="grid-form">
    <!-- 🧍‍♂️ Öğrenci Bilgileri -->
    <div class="form-group">
      <label>Ad Soyad</label>
      <input type="text" id="guncelleAdSoyad">
    </div>
    <div class="form-group">
      <label>Doğum Tarihi</label>
      <input type="date" id="guncelleDogumTarihi">
    </div>
    <div class="form-group">
      <label>Öğrenci No</label>
      <input type="text" id="guncelleOgrNo">
    </div>
    <div class="form-group">
      <label>Sınıf</label>
      <input type="text" id="guncelleSinif">
    </div>
    <div class="form-group">
      <label>Grup</label>
      <input type="text" id="guncelleGrup">
    </div>
    <div class="form-group">
      <label>Okul</label>
      <input type="text" id="guncelleOkul">
    </div>
    <div class="form-group">
      <label>Eğitim Programı</label>
      <input type="text" id="guncelleProgram">
    </div>
    <div class="form-group">
      <label>Kayıt Tarihi</label>
      <input type="date" id="guncelleKayitTarihi">
    </div>
    <div class="form-group">
      <label>İşlem Tarihi</label>
      <input type="date" id="guncelleIslemTarihi" disabled>
    </div>

    <!-- 👪 Veli Bilgileri -->
    <div class="form-group">
      <label>Veli Ad Soyad</label>
      <input type="text" id="guncelleVeliAd">
    </div>
    <div class="form-group">
      <label>Veli Telefon 1</label>
      <input type="tel" id="guncelleVeliTel1">
    </div>
    <div class="form-group">
      <label>Veli Telefon 2</label>
      <input type="tel" id="guncelleVeliTel2">
    </div>

    <!-- 💰 Ödeme Bilgileri -->
    <div class="form-group">
      <label>Para Birimi</label>
      <select id="guncelleParaBirimi">
        <option value="TRY">₺ TL</option>
        <option value="USD">$ USD</option>
        <option value="EUR">€ EUR</option>
      </select>
    </div>
    
    <div class="form-group">
  <label>Toplam Tutar (₺)</label>
  <input type="number" id="guncelleToplamTutar" oninput="guncelleTaksitKutulariniOlustur()">
</div>

<div class="form-group">
  <label>Taksit Sayısı</label>
  <input type="number" id="guncelleTaksitSayisi" min="1" oninput="guncelleTaksitKutulariniOlustur()">
</div>
<div class="form-group taksit-buttons">
  <button type="button" onclick="guncelleTaksitEkle()">➕ Taksit Ekle</button>
  <button type="button" onclick="guncelleTaksitSil()">➖ Taksit Sil</button>
</div>

    <!-- 💳 Taksit Kutuları -->
    <div class="form-group grid-full">
      <label>Taksitler</label>
      <div id="guncelleTaksitlerAlani" class="taksitler-wrapper">
        <!-- Taksit kutucukları burada oluşacak -->
      </div>
    </div>
  </div>

  <input type="hidden" id="guncelleOgrId">

  <!-- 🚀 Butonlar -->
  <div class="modal-actions">
    <button class="btn-kaydet" onclick="kaydetGuncelle()">💾 Kaydet</button>
    <button class="btn-iptal" onclick="document.getElementById('ogrenciGuncelleModal').style.display='none'">❌ Kapat</button>
  </div>
</div>
</div>

<!-- 📄 Şablon rehberi modalı -->
<div id="sablonModal" class="modal" style="display:none;" onclick="kapatSablonModal(event)">
  <!-- İçeriğe tıklanınca üst kattaki olayın tetiklenmesini engellemek için stopPropagation ekle -->
  <div class="modal-content" style="max-width:600px;" onclick="event.stopPropagation()">
    <!-- Sağ üst köşede çalışan kapatma butonu -->
    <button type="button" class="sablon-close" onclick="kapatSablonModal(event)" style="position:absolute; top:8px; right:12px; border:none; background:transparent; font-size:32px; font-weight:bold; cursor:pointer; color:#D84315;">×</button>
    <h3>📄 Excel Şablonu Nasıl Hazırlanır?</h3>
    <p>1. Aşağıdaki şablonu inceleyin.</p>
    <p>2. Dosyayı açıp her satıra sırasıyla <strong>Ad Soyad, Öğrenci No, Veli Telefon, Sınıf, Grup, Program, Toplam Tutar, Taksit Sayısı</strong> bilgilerini girin.</p>
    <p>3. Kaydedip, geri dönerek <em>Toplu Öğrenci Yükle</em> seçeneğinden bu dosyayı sisteme yükleyin.</p>
    <!-- Örnek resim daha önce yüklenemiyordu; yer tutucu resmi kullanıyoruz -->
    <!-- Şablon rehberi içerisindeki örnek resmi kullanıcı tarafından sağlanan ekran görüntüsü ile değiştirildi -->
    <img src="https://i.ibb.co/MyMJJJtH/Screenshot-1.png" alt="Excel şablon örneği" style="width:100%;height:auto;border-radius:8px;margin:0.5rem 0;" />
    <!-- İçerideki indirme butonu kaldırıldı; kullanıcı zaten modal dışından şablon indirebilir -->
  </div>
</div>

  <script>

const aktifSekmeler = {
  gelir: "form",        // default: "Yeni Kayıt"
  ogrenci: "kayit"      // default: "Öğrenci Kayıt"
};

function switchTab(tabId, event) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
  document.getElementById(`tab-${tabId}`).classList.add("active");

  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");

  // ✅ Aktif paneli bul ve aktif sekmeyi kaydet
  const aktifPanel = document.querySelector(".panel.active");
  if (aktifPanel) {
    if (aktifPanel.id === "panel-gelir") aktifSekmeler.gelir = tabId;
    if (aktifPanel.id === "panel-ogrenci") aktifSekmeler.ogrenci = tabId;
  }

  // 📊 Rapor sekmesinde tetikleyiciler
  if (tabId === "rapor") {
    document.getElementById("raporSecim").value = "tum";
    hazirlaYazdirmaOnizleme();
    raporFiltrele("bugun");
  }

  // 📑 Taksit ve Ödeme tablarında listeleme fonksiyonlarını çağır
  if (tabId === "taksit") {
    // Listelemeyi çağır sadece taksit paneli aktif olduğunda
    if (typeof taksitListele === 'function') taksitListele();
  }
  if (tabId === "odeme") {
    if (typeof odemeListele === 'function') odemeListele();
  }
}



function switchPanel(panel, event) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const aktifPanel = document.getElementById(`panel-${panel}`);
  aktifPanel.classList.add('active');

  document.querySelectorAll('.menu-item').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  // ✅ Hafızadaki tab'a otomatik tıkla
  const aktifTabId = aktifSekmeler[panel];
  const tabButton = aktifPanel.querySelector(`.tab-button[onclick*="${aktifTabId}"]`);
  if (tabButton) {
    tabButton.click();
  }

  // Eğer dashboard paneline geçiliyorsa verileri yükle
  if (panel === 'dashboard') {
    loadDashboardData();
  }
}



    

document.getElementById("currency").addEventListener("change", () => {
  updateCurrencySymbol();
  formatAmountLive();
});
    
document.addEventListener("DOMContentLoaded", () => {
  kayitlariGetir(); // ilk başta hepsini göster

  document.getElementById("filterType").addEventListener("change", kayitlariGetir);
  document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
  document.getElementById("searchInput").addEventListener("input", kayitlariGetir);
});


  // Tarih otomatik ayarlanır
  document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("date").value = today;

  kategoriSecimiYukle();        // ✅ kategori select'i yükle
  kategorileriYukle();          // ✅ kategori listeleri yükle
  kayitlariGetir();             // ✅ kayıtları listele
});


  // Form gönderimi
 document.getElementById("income-expense-form").addEventListener("submit", function(e) {
  e.preventDefault();

  const type = document.querySelector('input[name="type"]:checked')?.value;
  const date = document.getElementById("date").value;
  const category = document.getElementById("category").value;
  const payment = document.getElementById("payment").value;
  const currency = document.getElementById("currency").value;
  const tutar = parseFloat(document.getElementById("amount").dataset.raw);
  const note = document.getElementById("note").value.trim(); // ✅ açıklama alınır

  if (!type || !date || !category || !payment || isNaN(tutar)) {
    alert("Lütfen tüm alanları doğru doldurun.");
    return;
  }

  const kayit = {
    tip: type,
    tarih: date,
    kategori: category,
    odeme: payment,
    paraBirimi: currency,
    tutar: tutar,
    aciklama: note, // ✅ açıklama kaydı
    eklenmeZamani: new Date().toISOString()
  };

  firebase.database().ref("kayitlar").push(kayit).then(() => {
    alert("Kayıt başarıyla eklendi!");
    this.reset();
    document.getElementById("amount").dataset.raw = "0";
    formatAmountLive();
    kategoriSecimiYukle();
    kayitlariGetir();
    
    const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const today = now.toISOString().split("T")[0];
  document.getElementById("date").value = today;
  });
});



function formatTarih(tarihStr) {
  const d = new Date(tarihStr);
  const gun = String(d.getDate()).padStart(2, "0");
  const ay = String(d.getMonth() + 1).padStart(2, "0");
  const yil = d.getFullYear();
  return `${gun}-${ay}-${yil}`;
}



function bugununTarihiISO() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  return now.toISOString().split("T")[0];
}


function kaydiSil(id) {
  if (confirm("Bu kaydı silmek istediğinize emin misiniz?")) {
    firebase.database().ref("kayitlar/" + id).remove().then(() => {
      alert("Kayıt silindi");
      kayitlariGetir();
    });
  }
}

// Güncelleme modalını tetikleyecek (temel örnek)
function kaydiGuncellePopup(id, tutar, aciklama) {
  const yeniAd = prompt("Yeni açıklama girin:", aciklama);
  if (yeniAd === null) return;

  firebase.database().ref("kayitlar/" + id).update({
    aciklama: yeniAd
  }).then(() => {
    alert("Kayıt güncellendi.");
    kayitlariGetir();
  });
}


 document.getElementById("filterType").addEventListener("change", kayitlariGetir);
 document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
 document.getElementById("searchInput").addEventListener("input", kayitlariGetir);

 window.addEventListener("DOMContentLoaded", () => {
  kategoriFiltreSecenekleriniYukle(); // Dinamik kategorileri getir
  kayitlariGetir();                   // Tüm kayıtları ilk başta listele
});

 // Sayfa yüklendiğinde otomatik getir
 document.addEventListener("DOMContentLoaded", kayitlariGetir);
 let tumKayitlar = [];

 function kayitlariGetir() {
  const listDiv = document.getElementById("kayitlarListesi");
  const filterType = document.getElementById("filterType")?.value || "";
  const filterKategori = document.getElementById("filterKategori")?.value || "";
  const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";

  firebase.database().ref("kayitlar").once("value", (snap) => {
    const data = snap.val();
    listDiv.innerHTML = "";

    if (!data) {
      listDiv.innerHTML = "<p>📭 Henüz kayıt yok.</p>";
      return;
    }

    const kayitlarArray = Object.entries(data).sort((a, b) => {
  return new Date(b[1].tarih) - new Date(a[1].tarih);
});


    kayitlarArray.forEach(([id, kayit]) => {
      // Filtreleme
      if (
        (filterType && filterType !== "hepsi" && kayit.tip !== filterType) ||
        (filterKategori && kayit.kategori !== filterKategori) ||
        (searchTerm && !(
          (kayit.kategori || "").toLowerCase().includes(searchTerm) ||
          (kayit.tip || "").toLowerCase().includes(searchTerm) ||
          (kayit.aciklama || "").toLowerCase().includes(searchTerm)
        ))
      ) {
        return;
      }

      const formattedDate = new Date(kayit.tarih).toLocaleDateString("tr-TR");
      const upperCurrency = (kayit.paraBirimi || "").toUpperCase();
      const formattedAmount = `${kayit.tutar?.toFixed(2)} ${upperCurrency}`;
      const cardColor = kayit.tip === "gelir" ? "gelir-card" : "gider-card";

      const div = document.createElement("div");
      div.className = `record-card ${cardColor}`;
      div.innerHTML = `
        <div class="record-title"><strong>${kayit.aciklama || "(Açıklama yok)"}</strong></div>
        <div class="record-header">
          <span>${formattedDate}</span>
          <span class="record-amount">${formattedAmount}</span>
        </div>
        <div class="record-details">
          <span>Kategori: <strong>${
  kayit.kategori.charAt(0).toUpperCase() + kayit.kategori.slice(1)
}</strong></span> |
<span>Ödeme: <strong>${
  kayit.odeme.charAt(0).toUpperCase() + kayit.odeme.slice(1)
}</strong></span> |
<span>Tür: <strong>${
  kayit.tip.charAt(0).toUpperCase() + kayit.tip.slice(1)
}</strong></span>

        </div>
        <div class="record-actions">
          <button onclick="sil('${id}')" class="btn-sil">🗑 Sil</button>
<button data-id="${id}" class="btn-guncelle">✏️ Güncelle</button>        
        </div>
      `;
      listDiv.appendChild(div);
    });
  });
}

 document.addEventListener("click", function(e) {
  if (e.target.classList.contains("btn-guncelle")) {
    const id = e.target.getAttribute("data-id");

    // Sadece aktif panel gelir paneliyse çalıştır
    const aktifPanel = document.querySelector(".panel.active");
    if (aktifPanel && aktifPanel.id === "panel-gelir") {
      guncelleModal(id);
    }
  }
});



 function kayitlariFiltrele() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const filterType = document.getElementById("filterType").value;
  const filterKategori = document.getElementById("filterKategori").value;
  const listeDiv = document.getElementById("kayitlarListesi");

  const filtreli = tumKayitlar.filter(k =>
    (!filterType || k.tur === filterType) &&
    (!filterKategori || k.kategori === filterKategori) &&
    (
      k.kategori?.toLowerCase().includes(search) ||
      k.odeme?.toLowerCase().includes(search) ||
      k.aciklama?.toLowerCase().includes(search)
    )
  );

  listeDiv.innerHTML = "";
  if (filtreli.length === 0) {
    listeDiv.innerHTML = "<p>Filtrene uygun kayıt yok.</p>";
    return;
  }

  filtreli.forEach(k => {
    const kart = document.createElement("div");
    kart.className = "record-card";
    kart.innerHTML = `
      <div class="card-actions">
        <button class="edit" onclick="duzenle('${k.id}', '${k.kategori}', '${k.odeme}', '${k.tutar}', \`${k.aciklama || ''}\`)">Düzenle</button>
        <button class="delete" onclick="sil('${k.id}')">Sil</button>
      </div>
      <p><strong>${k.tarih}</strong> - ${k.tur.toUpperCase()} | ${k.kategori}</p>
      <p><strong>Tutar:</strong> ${k.tutar} ${k.paraBirimi.toUpperCase()}</p>
      <p><strong>Ödeme:</strong> ${k.odeme}</p>
      ${k.aciklama ? `<p><strong>Açıklama:</strong> ${k.aciklama}</p>` : ""}
    `;
    listeDiv.appendChild(kart);
  });
 }

 function sil(id) {
  if (!confirm("Bu kaydı silmek istediğinize emin misiniz?")) return;
  firebase.database().ref("kayitlar/" + id).remove()
    .then(() => {
      alert("Kayıt silindi.");
      kayitlariGetir();
    })
    .catch(err => alert("Silme hatası: " + err.message));
 }

 function duzenle(id, kategori, odeme, tutar, aciklama) {
  document.getElementById("editId").value = id;
  document.getElementById("editKategori").value = kategori;
  document.getElementById("editOdeme").value = odeme;
  document.getElementById("editTutar").value = tutar;
  document.getElementById("editAciklama").value = aciklama;
  document.getElementById("editModal").style.display = "block";
 }

 function kapatModal() {
  document.getElementById("editModal").style.display = "none";
 }

 // Filtre olayları
 document.getElementById("searchInput").addEventListener("input", kayitlariFiltrele);
 document.getElementById("filterType").addEventListener("change", kayitlariFiltrele);
 document.getElementById("filterKategori").addEventListener("change", kayitlariFiltrele);

 // Yeni kategori ekle
 document.getElementById("kategoriForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const tur = document.getElementById("kategoriTur").value;
  const adi = document.getElementById("kategoriAdi").value.trim();

  if (!adi) return alert("Kategori adı boş olamaz.");

  firebase.database().ref(`kategori${tur.charAt(0).toUpperCase() + tur.slice(1)}`).push({ ad: adi })
    .then(() => {
      document.getElementById("kategoriAdi").value = "";
      kategoriSecimiYukle();   // ✅ kayıt formundaki select'e yükle
      kategorileriYukle();     // ✅ listeyi yenile
    });
 });



 // Kategorileri yükle
 function kategorileriYukle() {
  const gelirListesi = document.getElementById("gelirListesi");
  const giderListesi = document.getElementById("giderListesi");
  gelirListesi.innerHTML = ""; giderListesi.innerHTML = "";

  // GELİR
  firebase.database().ref("kategoriGelir").once("value", snap => {
    const data = snap.val();
    for (let id in data) {
      const li = document.createElement("li");
      li.innerHTML = `
        ${data[id].ad}
        <div class="actions">
          <button class="edit" onclick="acKategoriModal('gelir', '${id}', '${data[id].ad}')">Düzenle</button>
          <button class="delete" onclick="kategoriSil('kategoriGelir', '${id}')">Sil</button>
        </div>
      `;
      gelirListesi.appendChild(li);
    }
    // ➕ Diğer sabit eklenmez burada, çünkü form tarafında olacak
    kategoriSecimiYukle("gelir", data);
  });

  // GİDER
  firebase.database().ref("kategoriGider").once("value", snap => {
    const data = snap.val();
    for (let id in data) {
      const li = document.createElement("li");
      li.innerHTML = `
        ${data[id].ad}
        <div class="actions">
          <button class="edit" onclick="acKategoriModal('gider', '${id}', '${data[id].ad}')">Düzenle</button>
          <button class="delete" onclick="kategoriSil('kategoriGider', '${id}')">Sil</button>
        </div>
      `;
      giderListesi.appendChild(li);
    }
    kategoriSecimiYukle("gider", data);
  });
 }

 // Modal aç/kapat
 function acKategoriModal(tur, id, ad) {
  document.getElementById("editKategoriId").value = id;
  document.getElementById("editKategoriTur").value = tur;
  document.getElementById("editKategoriAdi").value = ad;
  document.getElementById("kategoriEditModal").style.display = "block";
 }
 function kapatKategoriModal() {
  document.getElementById("kategoriEditModal").style.display = "none";
 }

 // Güncelleme
 document.getElementById("kategoriEditForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const id = document.getElementById("editKategoriId").value;
  const tur = document.getElementById("editKategoriTur").value;
  const yeniAd = document.getElementById("editKategoriAdi").value.trim();
  const ref = tur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(`${ref}/${id}`).update({ ad: yeniAd }).then(() => {
    kapatKategoriModal();
    kategorileriYukle();
  });
 });

 // Silme
 function kategoriSil(ref, id) {
  if (!confirm("Bu kategoriyi silmek istediğinize emin misiniz?")) return;
  firebase.database().ref(`${ref}/${id}`).remove().then(kategorileriYukle);
 }

 // Kayıt formuna kategori yükle

 let raporChart;

 function raporFiltrele(aralik) {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC düzeltmesi
  const bugunStr = now.toISOString().split("T")[0]; // "YYYY-MM-DD"

  let baslangic = new Date(now);

  switch(aralik) {
    case "bugun":
      // bugunStr zaten bugünün tarihi ISO formatında
      break;
    case "hafta":
      baslangic.setDate(baslangic.getDate() - 7);
      break;
    case "ay":
      baslangic.setMonth(baslangic.getMonth() - 1);
      break;
    case "3ay":
      baslangic.setMonth(baslangic.getMonth() - 3);
      break;
    case "6ay":
      baslangic.setMonth(baslangic.getMonth() - 6);
      break;
    case "1yil":
      baslangic.setFullYear(baslangic.getFullYear() - 1);
      break;
  }

  firebase.database().ref("kayitlar").once("value", snap => {
    let gelir = 0, gider = 0;
    const data = snap.val();

    for (let id in data) {
      const kayit = data[id];
      const kayitTarih = kayit.tarih; // "YYYY-MM-DD" formatında geliyor varsayıyoruz

      if (aralik === "bugun") {
        if (kayitTarih === bugunStr) {
          const tutar = parseFloat(kayit.tutar);
          if (kayit.tip === "gelir") gelir += tutar;
          else if (kayit.tip === "gider") gider += tutar;
        }
      } else {
        const tarihObj = new Date(kayitTarih);
        if (tarihObj >= baslangic && tarihObj <= now) {
          const tutar = parseFloat(kayit.tutar);
          if (kayit.tip === "gelir") gelir += tutar;
          else if (kayit.tip === "gider") gider += tutar;
        }
      }
    }

    document.getElementById("raporGelir").textContent = `₺${gelir.toFixed(2)}`;
    document.getElementById("raporGider").textContent = `₺${gider.toFixed(2)}`;
    document.getElementById("raporFark").textContent = `₺${(gelir - gider).toFixed(2)}`;

    guncelleGrafik(gelir, gider);
  });
 }


 function guncelleGrafik(gelir, gider) {
  if (raporChart) raporChart.destroy();

  const ctx = document.getElementById('raporChart').getContext('2d');
  raporChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Gelir', 'Gider'],
      datasets: [{
        data: [gelir, gider],
        backgroundColor: ['green', 'red']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
      }
    }
  });
 }
 function hazirlaYazdirmaOnizleme() {
  const secim = document.getElementById("raporSecim").value;
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;
  const onizleme = document.getElementById("yazdirOnizleme");

  onizleme.innerHTML = "<p>Yükleniyor...</p>";

  // Tarih nesnelerine çevir
  const startDate = startDateStr ? new Date(startDateStr) : null;
  const endDate = endDateStr ? new Date(endDateStr) : null;

  firebase.database().ref("kayitlar").once("value", snap => {
    const data = snap.val();

    if (!data) {
      onizleme.innerHTML = "<p>📭 Kayıt bulunamadı.</p>";
      return;
    }

    const entries = Object.entries(data)
      .filter(([id, k]) => {
        // Tip filtresi (gelir/gider/tum)
        if (secim === "gelir" && k.tip !== "gelir") return false;
        if (secim === "gider" && k.tip !== "gider") return false;

        // Tarih filtresi
        const kayitTarihi = new Date(k.tarih);
        if (startDate && kayitTarihi < startDate) return false;
        if (endDate && kayitTarihi > endDate) return false;

        return true;
      })
      .sort((a, b) => new Date(b[1].tarih) - new Date(a[1].tarih)); // Tarihe göre azalan sırala

    if (entries.length === 0) {
      onizleme.innerHTML = "<p>📭 Belirtilen aralıkta kayıt bulunamadı.</p>";
      return;
    }

    // GLOBAL: WhatsApp için kayıtları sakla
    window.sonFiltrelenenKayitlar = entries.map(([id, k]) => k);

    let html = `
      <table>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>Kategori</th>
          <th>Ödeme Türü</th>
          <th>Tutar</th>
        </tr>`;

    for (let [id, k] of entries) {
      html += `
        <tr>
          <td>${formatTarih(k.tarih)}</td>
          <td>${capitalize(k.tip)}</td>
          <td>${capitalize(k.kategori)}</td>
          <td>${capitalize(k.odeme)}</td>
          <td>${k.tutar.toFixed(2)} ₺</td>
        </tr>`;
    }

    html += `</table>`;
    onizleme.innerHTML = html;
  });
 }



function yazdirRapor() {
  const secim = document.getElementById("raporSecim").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  const kurumAdi = "Fenomen Çocuk Kulübü";
  const raporTarihi = new Date().toLocaleDateString("tr-TR", { day: '2-digit', month: 'long', year: 'numeric' });

  let raporBaslik = "Tüm Kayıtlar";
  if (secim === "gelir") raporBaslik = "Tüm Gelirler";
  else if (secim === "gider") raporBaslik = "Tüm Giderler";

  const tarihAraligiMetni = (start && end)
    ? `<p class="date-range"><strong>${formatTarih(start)} – ${formatTarih(end)}</strong> tarihleri arası kayıtlar</p>`
    : "";

  firebase.database().ref("kayitlar").once("value", snap => {
    const data = snap.val();
    if (!data) return alert("Yazdırılacak kayıt bulunamadı.");

    let entries = Object.entries(data)
      .filter(([id, k]) => {
        if (secim === "gelir" && k.tip !== "gelir") return false;
        if (secim === "gider" && k.tip !== "gider") return false;

        const kayitTarih = new Date(k.tarih);
        const startDate = start ? new Date(start) : null;
        const endDate = end ? new Date(end) : null;

        if (startDate && kayitTarih < startDate) return false;
        if (endDate && kayitTarih > endDate) return false;

        return true;
      })
      .sort((a, b) => new Date(a[1].tarih) - new Date(b[1].tarih));

    let toplamGelir = 0, toplamGider = 0;
    let rowsHTML = "";

    for (let [id, k] of entries) {
      const tutar = parseFloat(k.tutar) || 0;
      if (k.tip === "gelir") toplamGelir += tutar;
      else if (k.tip === "gider") toplamGider += tutar;

      rowsHTML += `
        <tr>
          <td style="text-align: center;"><strong>${formatTarih(k.tarih)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.tip)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.kategori)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.odeme)}</strong></td>
          <td style="text-align: center;"><strong>${tutar.toFixed(2)} ₺</strong></td>
        </tr>`;
    }

    const fark = toplamGelir - toplamGider;

    const html = `
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>${raporTarihi} – ${raporBaslik}</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 2rem;
      background-color: #fff;
      color: #222;
    }
    .header-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .logo {
      width: 60px;
      height: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
    }
    .header-text h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #D84315;
      font-weight: bold;
    }
    .header-text h2 {
      margin: 0.2rem 0 0 0;
      font-size: 1rem;
      color: #555;
      font-weight: normal;
    }
    .date-range {
      font-size: 0.95rem;
      color: #333;
      margin-top: 0.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 0.9rem 1rem;
      border: 1px solid #999;
      font-size: 0.95rem;
      text-transform: capitalize;
      text-align: center;
    }
    th {
      background-color: #FFE0B2;
      color: #BF360C;
      font-weight: bold;
    }
    tr:nth-child(even) td {
      background-color: #FFF3E0;
    }
    .summary {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }
    .summary-box {
      flex: 1;
      border: 2px solid #FF6F00;
      border-radius: 10px;
      padding: 1rem;
      background-color: #FFF8E1;
      text-align: center;
    }
    .summary-box h3 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      color: #FF6F00;
      font-weight: bold;
      text-transform: uppercase;
    }
    .summary-box p {
      margin: 0;
      font-size: 1.2rem;
      font-weight: bold;
      color: #222;
    }
    .footer {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-top: 3rem;
    }
  </style>
</head>
<body>
  <div class="header-wrapper">
    <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" class="logo">
    <div class="header-text">
      <h1>${kurumAdi}</h1>
      <h2>${raporBaslik}</h2>
      ${tarihAraligiMetni}
    </div>
  </div>

  <table>
    <tr>
      <th>Tarih</th>
      <th>Tip</th>
      <th>Kategori</th>
      <th>Ödeme Türü</th>
      <th>Tutar</th>
    </tr>
    ${rowsHTML}
  </table>

  <div class="summary">
    <div class="summary-box">
      <h3>Toplam Gelir</h3>
      <p>₺${toplamGelir.toFixed(2)}</p>
    </div>
    <div class="summary-box">
      <h3>Toplam Gider</h3>
      <p>₺${toplamGider.toFixed(2)}</p>
    </div>
    <div class="summary-box">
      <h3>Fark</h3>
      <p>₺${fark.toFixed(2)}</p>
    </div>
  </div>

  <div class="footer">Yazdırılma Tarihi: <strong>${raporTarihi}</strong> – Sayfa 1</div>
</body>
</html>`;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  });
}





 function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
 }



 function kategoriSecimiYukle() {
  const kategoriSelect = document.getElementById("category");
  const seciliTur = document.querySelector('input[name="type"]:checked')?.value;

  if (!seciliTur) {
    kategoriSelect.innerHTML = `<option value="">Lütfen tür seçin</option>`;
    return;
  }

  const ref = seciliTur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(ref).once("value", (snap) => {
    const data = snap.val();
    kategoriSelect.innerHTML = `<option value="">Kategori seçin</option>`;

    if (data) {
      for (let id in data) {
        const opt = document.createElement("option");
        opt.value = data[id].ad;
        opt.textContent = data[id].ad;
        kategoriSelect.appendChild(opt);
      }
    }

    // ➕ Diğer her zaman en sonda
    const diger = document.createElement("option");
    diger.value = "diğer";
    diger.textContent = "➕ Diğer...";
    kategoriSelect.appendChild(diger);
  });
 }



 document.querySelectorAll('input[name="type"]').forEach(r => r.addEventListener("change", kategoriSecimiYukle));
 document.addEventListener("DOMContentLoaded", kategoriSecimiYukle);



 function kategoriFiltreSecenekleriniYukle() {
  const kategoriFilter = document.getElementById("filterKategori");
  let seciliTur = document.getElementById("filterType").value;
  if (!seciliTur) seciliTur = "hepsi"; // boşsa hepsi gibi düşün

  kategoriFilter.innerHTML = `<option value="">Tüm Kategoriler</option>`;

  let refGelir = firebase.database().ref("kategoriGelir").once("value");
  let refGider = firebase.database().ref("kategoriGider").once("value");

  Promise.all([refGelir, refGider]).then(([snapGelir, snapGider]) => {
    const kategoriler = new Set();

    if (seciliTur === "hepsi" || seciliTur === "gelir") {
      const gelirData = snapGelir.val();
      if (gelirData) {
        Object.values(gelirData).forEach(item => {
          if (item.ad) kategoriler.add(item.ad);
        });
      }
    }

    if (seciliTur === "hepsi" || seciliTur === "gider") {
      const giderData = snapGider.val();
      if (giderData) {
        Object.values(giderData).forEach(item => {
          if (item.ad) kategoriler.add(item.ad);
        });
      }
    }

    // DOM’a kategorileri sırayla ekle
    Array.from(kategoriler).sort().forEach(ad => {
      const opt = document.createElement("option");
      opt.value = ad;
      opt.textContent = ad;
      kategoriFilter.appendChild(opt);
    });

    // Diğer seçeneğini en sona ekle
    const diger = document.createElement("option");
    diger.value = "diğer";
    diger.textContent = "➕ Diğer";
    kategoriFilter.appendChild(diger);
  });
 }








 document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
 document.getElementById("searchInput").addEventListener("input", kayitlariGetir);


 function guncelleModal(id) {
  firebase.database().ref("kayitlar/" + id).once("value", (snap) => {
    const kayit = snap.val();
    if (!kayit) return alert("Kayıt bulunamadı");

    document.getElementById("modalId").value = id;
    document.getElementById("modalTarih").value = kayit.tarih;
    document.getElementById("modalTutar").value = kayit.tutar.toFixed(2); // formatNumber yerine
    document.getElementById("modalTutar").dataset.raw = kayit.tutar;
    document.getElementById("modalAciklama").value = kayit.aciklama || "";
    document.getElementById("modalOdeme").value = kayit.odeme;
    document.getElementById("modalPara").value = kayit.paraBirimi;
modalFormatAmount();
    const radio = document.querySelector(`input[name="modalType"][value="${kayit.tip}"]`);
    if (radio) radio.checked = true;

    // Kategorileri yükle ve seç
    modalKategoriYukle(() => {
      document.getElementById("modalKategori").value = kayit.kategori;
    });

    document.getElementById("guncelleModal").style.display = "block";
  });
 }


 function formatNumber(num) {
  return Number(num).toLocaleString("tr-TR", { minimumFractionDigits: 2 });
 }

 function modalCaptureRawAmount() {
  const input = document.getElementById("modalTutar");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }


 function modalFormatAmount() {
  const input = document.getElementById("modalTutar");
  const raw = parseFloat(input.dataset.raw || "0");
  const currency = document.getElementById("modalPara")?.value || "TRY";

  if (!isNaN(raw)) {
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(raw);
  }
 }





 function modalKategoriYukle(callback) {
  const seciliTur = document.querySelector('input[name="modalType"]:checked')?.value;
  const kategoriSelect = document.getElementById("modalKategori");

  kategoriSelect.innerHTML = "<option value=''>Kategori seçin</option>";

  if (!seciliTur) return;

  const ref = seciliTur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(ref).once("value", (snap) => {
    const data = snap.val();
    if (data) {
      for (let id in data) {
        const opt = document.createElement("option");
        opt.value = data[id].ad;
        opt.textContent = data[id].ad;
        kategoriSelect.appendChild(opt);
      }
    }
    const diger = document.createElement("option");
    diger.value = "diğer";
    diger.textContent = "➕ Diğer...";
    kategoriSelect.appendChild(diger);

    if (typeof callback === "function") callback(); // kategori seçimini çağır
  });
 }


 modalKategoriYukle(() => {
  document.getElementById("modalKategori").value = kayit.kategori;
 });


 function kaydiGuncelle() {
  const id = document.getElementById("modalId").value;
  const tarih = document.getElementById("modalTarih").value;
  const tip = document.querySelector('input[name="modalType"]:checked')?.value;
  const kategori = document.getElementById("modalKategori").value;
  const odeme = document.getElementById("modalOdeme").value;
  const para = document.getElementById("modalPara").value;
  const tutar = parseFloat(document.getElementById("modalTutar").dataset.raw || "0");
  const aciklama = document.getElementById("modalAciklama").value;

  if (!id || !tarih || !tip || !kategori || !odeme || !para || isNaN(tutar)) {
    alert("Tüm alanları doldurun.");
    return;
  }

  const guncel = {
    tarih,
    tip,
    kategori,
    odeme,
    paraBirimi: para,
    tutar,
    aciklama
  };

  firebase.database().ref("kayitlar/" + id).update(guncel).then(() => {
    alert("Kayıt güncellendi!");
    document.getElementById("guncelleModal").style.display = "none";
    kayitlariGetir(); // listeyi güncelle
  });
 }





 function modalKapat() {
  document.getElementById("guncelleModal").style.display = "none";
 }


 document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("kategoriEditForm");
  if (form) {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const id = document.getElementById("editKategoriId").value;
      const tur = document.getElementById("editKategoriTur").value;
      const yeniAd = document.getElementById("editKategoriAdi").value.trim();
      const ref = tur === "gelir" ? "kategoriGelir" : "kategoriGider";

      firebase.database().ref(`${ref}/${id}`).update({ ad: yeniAd }).then(() => {
        kapatKategoriModal();
        kategorileriYukle();
      });
    });
  }
 });

 function setQuickRange(tip) {
  // Butonları temizle
  document.querySelectorAll('.quick-buttons button').forEach(btn => btn.classList.remove('active'));

  // UTC farkı düzeltilmiş bugünün tarihi
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const todayStr = now.toISOString().split("T")[0];

  const start = new Date(now); // başlangıcı UTC düzeltilmiş olarak başlat

  if (tip === 'week') start.setDate(start.getDate() - 7);
  else if (tip === 'month') start.setMonth(start.getMonth() - 1);

  document.getElementById("startDate").value = start.toISOString().split("T")[0];
  document.getElementById("endDate").value = todayStr;

  // Aktif sınıfı ekle
  const clickedBtn = [...document.querySelectorAll('.quick-buttons button')].find(btn =>
    btn.textContent.includes(tip === 'week' ? 'Hafta' : tip === 'month' ? 'Ay' : 'Bugün')
  );
  if (clickedBtn) clickedBtn.classList.add("active");

  hazirlaYazdirmaOnizleme();
 }



 function acWhatsappModal() {
  const mesaj = olusturWhatsappMesaji(); // Henüz oluşturulmadı, sıradaki iş
  document.getElementById("whatsappMesaji").value = mesaj;
  document.getElementById("whatsappModal").style.display = "block";
 }

 function kapatWhatsappModal() {
  document.getElementById("whatsappModal").style.display = "none";
 }
 function olusturWhatsappMesaji() {
  const raporBaslik = "Fenomen Çocuk Kulübü - Mali Rapor";
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const kayitlar = window.sonFiltrelenenKayitlar || [];

  if (!kayitlar.length) return "📭 Hiçbir kayıt bulunamadı.";

  const tarihMetni = start && end ? `${formatTarih(start)} - ${formatTarih(end)}` : "Tüm Kayıtlar";

  let toplamGelir = 0;
  let toplamGider = 0;

  const satirlar = kayitlar.map(k => {
    const tutar = k.tutar.toFixed(2);
    const aciklama = k.aciklama ? ` (${k.aciklama})` : "";
    const satir = `- ${k.aciklama || "Açıklama Yok"} | ${capitalize(k.odeme)} | ${tutar} ₺`;

    if (k.tip === "gelir") toplamGelir += k.tutar;
    else if (k.tip === "gider") toplamGider += k.tutar;

    return { satir, tip: k.tip };
  });

  const gelirSatirlari = satirlar.filter(s => s.tip === "gelir").map(s => s.satir).join("\n") || "- Yok";
  const giderSatirlari = satirlar.filter(s => s.tip === "gider").map(s => s.satir).join("\n") || "- Yok";

  const fark = toplamGelir - toplamGider;

  const mesaj =
`📄 *${raporBaslik}*

📅 Tarih Aralığı: ${tarihMetni}

🟩 *Gelir Kayıtları*
${gelirSatirlari}

🟥 *Gider Kayıtları*
${giderSatirlari}

💰 Toplam Gelir: ${toplamGelir.toFixed(2)} ₺
💸 Toplam Gider: ${toplamGider.toFixed(2)} ₺
📈 Fark: ${fark.toFixed(2)} ₺`;

  return mesaj;
 }
 function gonderWhatsappMesaji() {
  const message = document.getElementById("whatsappMesaji").value.trim();

  if (!message) {
    Swal.fire({
      icon: 'warning',
      title: 'Mesaj Boş!',
      text: 'Lütfen önce bir mesaj oluşturun.',
      confirmButtonText: 'Tamam'
    });
    return;
  }

  // ✅ encode işlemini burada doğrudan mesaj üstünde yap
  const url = `https://api.whatsapp.com/send/?text=${encodeURIComponent(message)}`;
  window.open(url, "_blank");
 }





 function tarihiUygula() {
  hazirlaYazdirmaOnizleme(); // Önizlemeyi yenile

  // Tüm hızlı tarih butonlarının turunculuğunu (active) kaldır
  document.querySelectorAll('.quick-buttons button').forEach(btn => {
    btn.classList.remove("active");
  });
 }

 function validateForm() {
  let isValid = true;

  const fields = [
    { id: "adSoyad", message: "⚠️ Ad Soyad alanı zorunludur." },
    { id: "tc", message: "⚠️ TC Kimlik No 11 haneli olmalıdır.", condition: val => val.length === 11 },
    { id: "ogrNo", message: "⚠️ Öğrenci numarası 4–5 rakam olmalıdır.", condition: val => /^\\d{4,5}$/.test(val) },
    { id: "sinif", message: "⚠️ Sınıf seçimi zorunludur." },
    { id: "grup", message: "⚠️ Grup seçimi zorunludur." },
    { id: "egitimProgrami", message: "⚠️ Eğitim programı seçilmelidir." },
    { id: "kayitTarihi", message: "⚠️ Kayıt tarihi girilmelidir." },
    { id: "veliAd", message: "⚠️ Veli adı girilmelidir." },
    { id: "veliTel1", message: "⚠️ Veli cep telefonu girilmelidir." },
    { id: "toplamTutar", message: "⚠️ Toplam ödeme tutarı girilmelidir.", condition: val => !isNaN(val) && val.trim() !== "" },
    { id: "taksitSayisi", message: "⚠️ Taksit sayısı girilmelidir." },
    { id: "ilkTaksitTarihi", message: "⚠️ İlk taksit tarihi girilmelidir." },
  ];

  fields.forEach(field => {
    const el = document.getElementById(field.id);
    const err = document.getElementById(field.id + "Error");
    const value = el.value.trim();

    if (!value || (field.condition && !field.condition(value))) {
      err.textContent = field.message;
      isValid = false;
    } else {
      err.textContent = "";
    }
  });

  return isValid;
 }

 function olusturTaksitler() {
  const toplamTutarEl = document.getElementById("toplamTutar");
  const taksitSayisiEl = document.getElementById("taksitSayisi");
  const ilkTaksitTarihiEl = document.getElementById("ilkTaksitTarihi");

  const toplamTutar = parseFloat(toplamTutarEl?.dataset.raw || "0");
  let taksitSayisi = parseInt(taksitSayisiEl?.value || "0");
  const ilkTaksitTarihi = ilkTaksitTarihiEl?.value;

  if (isNaN(toplamTutar) || isNaN(taksitSayisi) || !ilkTaksitTarihi) return;

  // ✅ Sınır kontrolü
  if (taksitSayisi > 12) {
    taksitSayisi = 12;
    taksitSayisiEl.value = 12;
    alert("⚠️ En fazla 12 taksit girilebilir.");
  }

  if (taksitSayisi < 1) {
    taksitSayisi = 1;
    taksitSayisiEl.value = 1;
    alert("⚠️ En az 1 taksit olmalıdır.");
  }

  taksitler = [];

  // 🎯 Sayı tam bölünüyorsa yuvarlama yok
  if (toplamTutar % taksitSayisi === 0) {
    const esitTutar = toplamTutar / taksitSayisi;

    for (let i = 0; i < taksitSayisi; i++) {
      const tarih = new Date(ilkTaksitTarihi);
      tarih.setMonth(tarih.getMonth() + i);

      taksitler.push({
        tutar: esitTutar,
        tarih: tarih.toISOString().split("T")[0]
      });
    }

  } else {
    // 🔁 Yuvarlama gerekiyorsa tabanı belirle
    let yuvarlamaTabani = 50;
    if (toplamTutar < 200) {
      yuvarlamaTabani = 20;
    } else if (toplamTutar >= 1000) {
      yuvarlamaTabani = 100;
    }

    const yuvarlanan = Math.floor((toplamTutar / taksitSayisi) / yuvarlamaTabani) * yuvarlamaTabani;
    const fark = toplamTutar - (yuvarlanan * taksitSayisi);

    for (let i = 0; i < taksitSayisi; i++) {
      const tarih = new Date(ilkTaksitTarihi);
      tarih.setMonth(tarih.getMonth() + i);

      taksitler.push({
        tutar: i === 0 ? yuvarlanan + fark : yuvarlanan,
        tarih: tarih.toISOString().split("T")[0]
      });
    }
  }

  renderTaksitKartlari();
  // Yeni taksitler oluşturulurken toplam tutarı bir kez hesapla. Böylece taksit kutuları
  // render edilirken manuel değişiklikler toplam tutarı etkilemez.
  if (typeof toplamTaksitleriHesapla === 'function') {
    toplamTaksitleriHesapla();
  }
 }








 function tutarGuncelle(degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("toplamTutar").dataset.raw || "0");

  let yeniDeger = parseFloat(document.querySelectorAll(".taksit-tutar")[degisenIndex].value);
  if (isNaN(yeniDeger)) return;

  taksitler[degisenIndex].tutar = yeniDeger;

  const kalanAdet = taksitler.length - 1;
  const kalanTutar = toplamTutar - yeniDeger;

  if (kalanTutar < 0 || kalanAdet <= 0) {
    // Hatalı giriş
    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    const pay = Math.floor(kalanTutar / kalanAdet);
    const fark = kalanTutar - pay * kalanAdet;
    let farkEklendi = false;

    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) {
        t.tutar = pay + (farkEklendi ? 0 : fark);
        farkEklendi = true;
      }
    });
  }

  renderTaksitKartlari(); // DOM'u yeniden oluştur
 }
 function captureRawAmount() {
  const input = document.getElementById("amount");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }
 function formatAmountLive() {
  const input = document.getElementById("amount");
  const rawValue = parseFloat(input.dataset.raw);

  if (!isNaN(rawValue)) {
    const currency = document.getElementById("currency").value;
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(rawValue);
  }
 }
 function updateCurrencySymbol() {
  const currency = document.getElementById("currency").value;
  const symbolMap = {
    "TRY": "₺",
    "USD": "$",
    "EUR": "€"
  };
  document.getElementById("currency-symbol").textContent = symbolMap[currency] || "";
  formatAmountLive();
 }
 function captureToplamTutar() {
  const input = document.getElementById("toplamTutar");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }
 function formatToplamTutar() {
  const input = document.getElementById("toplamTutar");
  const rawValue = parseFloat(input.dataset.raw);

  if (!isNaN(rawValue)) {
    const currency = document.getElementById("paraBirimi").value;
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(rawValue);
  }
 }
 function updateToplamTutarSymbol() {
  const currency = document.getElementById("paraBirimi").value;
  const symbolMap = {
    "TRY": "₺",
    "USD": "$",
    "EUR": "€"
  };
  document.getElementById("toplamTutarSymbol").textContent = symbolMap[currency] || "";
  formatToplamTutar();
 }


 function formatTaksitGorunumleri() {
  const currency = document.getElementById("paraBirimi")?.value || "TRY";
  const formatter = new Intl.NumberFormat("tr-TR", {
    style: "currency",
    currency,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });

  const tutarInputlar = document.querySelectorAll(".taksit-tutar");
  const gorunumler = document.querySelectorAll(".tutar-gorunum");

  tutarInputlar.forEach((input, index) => {
    const deger = parseFloat(input.value || "0");
    if (!isNaN(deger) && gorunumler[index]) {
      gorunumler[index].textContent = formatter.format(deger);
    }
  });
 }

 // Sayfa yüklendiğinde başlat
 document.addEventListener("DOMContentLoaded", () => {
  updateCurrencySymbol();
  formatAmountLive();
 });

 // Para birimi değişince güncelle
 document.getElementById("paraBirimi").addEventListener("change", updateCurrencySymbol);
 let taksitSayisi = 0; 

 function taksitEkle() {
  const input = document.getElementById("taksitSayisi");
  let sayi = parseInt(input.value || "0");
  if (sayi >= 12) {
    alert("En fazla 12 taksit ekleyebilirsiniz.");
    return;
  }

  input.value = sayi + 1;
  olusturTaksitTarihiVarsa(); // ilk tarih varsa taksitleri güncelle
 }

 function olusturTaksitTarihiVarsa() {
  const tarih = document.getElementById("ilkTaksitTarihi").value;
  if (tarih) olusturTaksitler();
 }


 function taksitSil(index) {
  const input = document.getElementById("taksitSayisi");
  let sayi = parseInt(input.value || "0");
  if (sayi > 1) {
    input.value = sayi - 1;
    olusturTaksitler();
  }
 }


 // Tarih varsayılanı bugünün tarihi
 function bugunISO() {
  const now = new Date();
  return now.toISOString().split("T")[0];
 }

 function renderTaksitKartlari() {
  const container = document.getElementById("taksitKutulari");
  container.innerHTML = "";

  const currency = document.getElementById("paraBirimi")?.value || "TRY";
  const formatter = new Intl.NumberFormat("tr-TR", {
    style: "currency",
    currency,
    minimumFractionDigits: 2
  });

  taksitler.forEach((taksit, index) => {
    const kart = document.createElement("div");
    kart.classList.add("taksit-kart");

    // 1. Etiket
    const label = document.createElement("label");
    label.textContent = `Taksit ${index + 1}`;

    // 2. Tutar input
    const inputTutar = document.createElement("input");
    inputTutar.type = "number";
    inputTutar.classList.add("taksit-tutar");
    inputTutar.value = taksit.tutar;

    // 2.1. Formatlı tutar görünümü (sadece gösterim)
    const tutarFormatli = document.createElement("small");
    tutarFormatli.textContent = formatter.format(taksit.tutar);
    tutarFormatli.style.color = "#777";
    tutarFormatli.style.fontSize = "0.85rem";

    // ⌨️ Enter'a basıldığında güncelle
    inputTutar.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const yeni = parseFloat(inputTutar.value) || 0;
        taksitler[index].tutar = yeni;
        tutarFormatli.textContent = formatter.format(yeni);
        tutarGuncelle(index); // varsa tetikle
      }
    });

    // 3. Tarih input
    const inputTarih = document.createElement("input");
    inputTarih.type = "date";
    inputTarih.classList.add("taksit-tarih");
    inputTarih.value = taksit.tarih;
    inputTarih.onchange = () => guncelleTarih(inputTarih.value, index);

    // 4. Görünüm
    const gorunum = document.createElement("small");
    gorunum.style.color = "#555";
    gorunum.textContent = `Görünüm: ${formatlaGorunurTarih(taksit.tarih)}`;

    // ✅ 5. Kullanıcıya açıklayıcı not
    const not = document.createElement("small");
    not.style.color = "#888";
    not.style.fontSize = "0.8rem";
    not.style.marginTop = "4px";
    not.textContent = "💡 Tutarı değiştirdikten sonra Enter'a basın.";

    // 6. Silme butonu
    const silBtn = document.createElement("button");
    silBtn.classList.add("taksit-sil-btn");
    silBtn.textContent = "❌";
    silBtn.onclick = () => {
      taksitSil(index);
      renderTaksitKartlari();
    };

    // Kartı oluştur
    kart.appendChild(label);
    kart.appendChild(inputTutar);
    kart.appendChild(tutarFormatli);   // 🆕 Biçimli gösterim
    kart.appendChild(inputTarih);
    kart.appendChild(gorunum);
    kart.appendChild(not);
    kart.appendChild(silBtn);

    container.appendChild(kart);
  });

  //
  // Not: previously we recalculated the "Toplam Tutar" whenever the taksit cards were rendered.
  // This caused the total amount input to update when the user manually adjusted a single installment
  // amount and pressed Enter. The desired behaviour is that the overall total remains what the
  // user initially specified, and only the remaining instalments are recalculated. Therefore
  // we removed the automatic call to toplamTaksitleriHesapla() here. The total will instead be
  // calculated once when new taksitler are first created in olusturTaksitler().
  // toplamTaksitleriHesapla();
 }





 function toplamTaksitleriHesapla() {
  const inputlar = document.querySelectorAll(".taksit-kart input[type='number']");
  let toplam = 0;

  inputlar.forEach(input => {
    const deger = parseFloat(input.value);
    if (!isNaN(deger)) {
      toplam += deger;
    }
  });

  const toplamGosterge = document.getElementById("toplamTutar");
  if (toplamGosterge) {
    const formatted = toplam.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    toplamGosterge.textContent = `${formatted} ₺`;
    toplamGosterge.dataset.raw = toplam.toFixed(2);
  }
 }






 function guncelleTutar(yeniDeger, degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("toplamTutar")?.dataset.raw || "0");
  const yeniTutar = parseFloat(yeniDeger) || 0;

  taksitler[degisenIndex].tutar = yeniTutar;

  const kalanTaksitler = taksitler.length - 1;
  const kalanTutar = toplamTutar - yeniTutar;

  if (kalanTaksitler <= 0 || kalanTutar < 0) {
    // Hatalı giriş: kalan taksit yok veya tutar fazla
    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    const yeniTaksit = Math.floor(kalanTutar / kalanTaksitler);
    const fark = kalanTutar - yeniTaksit * kalanTaksitler;

    let farkDagitildi = false;

    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) {
        t.tutar = yeniTaksit;
        if (!farkDagitildi) {
          t.tutar += fark;
          farkDagitildi = true;
        }
      }
    });
  }

  renderTaksitKartlari(); // DOM'u güncelle
 }





 function guncelleTarih(yeni, index) {
  taksitler[index].tarih = yeni;
  renderTaksitKartlari(); // Tarih değişince kartları yeniden çiz
 }

 function formatlaGorunurTarih(isoTarih) {
  const tarih = new Date(isoTarih);
  return tarih.toLocaleDateString("tr-TR", {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
 }
 document.addEventListener("DOMContentLoaded", () => {
  ayarlaIslemTarihi();     // 🔁 İşlem tarihi input ve görünümünü günceller
  const now = new Date();
 now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Türkiye saati düzeltme
 const isoTarih = now.toISOString().split("T")[0];

 document.getElementById("kayitTarihi").value = isoTarih;
 });

 function guncelleKayitTarihi() {
  const secilen = document.getElementById("kayitTarihi").value;
  const gorunum = document.getElementById("kayitTarihiGorunum");

  if (secilen && gorunum) {
    const tarih = new Date(secilen);
    gorunum.textContent = tarih.toLocaleDateString("tr-TR", {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  }
 }


 function ayarlaIslemTarihi() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC -> Local fix
  const iso = now.toISOString().split("T")[0];
  
  document.getElementById("islemTarihi").value = iso;
  document.getElementById("islemTarihiGorunum").textContent = formatlaGorunurTarih(iso);
 }


 document.addEventListener("DOMContentLoaded", () => {
  ayarlaIslemTarihi(); // Form açıldığında işlem tarihi hazır
 });
 document.addEventListener("DOMContentLoaded", () => {
  // Örnek varsayılan 1 taksit
  taksitEkle(0, bugunISO());
 });


 function getOgrenciBilgileri() {
  return {
    adSoyad: getValue("adSoyad"),
    tc: getValue("tc"),
    ogrNo: getValue("ogrNo"),
    sinif: getValue("sinif"),
    grup: getValue("grup"),
    dogumTarihi: getValue("dogumTarihi"),
    okul: getValue("okul"),
    egitimProgrami: getValue("egitimProgrami"),
    kayitTarihi: getValue("kayitTarihi"),
    islemTarihi: getValue("islemTarihi")
  };
 }
 function getVeliBilgileri() {
  return {
    adSoyad: getValue("veliAd"),
    telefon1: getValue("veliTel1"),
    telefon2: getValue("veliTel2", true) // opsiyonel
  };
 }
 function getTaksitListesi() {
  const kartlar = document.querySelectorAll(".taksit-kart");
  const liste = [];

  kartlar.forEach(kart => {
    const tutar = kart.querySelector("input[type='number']")?.value;
    const tarih = kart.querySelector("input[type='date']")?.value;

    if (tutar && tarih) {
      liste.push({
        tutar: parseFloat(tutar),
        tarih: tarih
      });
    }
  });

  return liste;
 }
 function toplaTumVeri() {
  return {
    ogrenci: getOgrenciBilgileri(),
    veli: getVeliBilgileri(),
    odeme: {
  taksitler: getTaksitListesi(),
  paraBirimi: getValue("paraBirimi"), // <select id="paraBirimi">
 toplamTutar: parseFloat(document.getElementById("toplamTutar")?.dataset.raw || "0")
},
    eklenmeZamani: new Date().toISOString()
  };
 }

 function getValue(id, optional = false) {
  const el = document.getElementById(id);
  if (!el && !optional) {
    throw new Error(`Form elemanı bulunamadı: #${id}`);
  }
  return el?.value.trim() || "";
 }

 function kaydetOgrenci() {
  try {
    const veri = toplaTumVeri();

    // ✅ TC ve Öğrenci No boş mu kontrolü
    if (!veri.ogrenci.tc || !veri.ogrenci.ogrNo) {
      alert("🚫 TC Kimlik No ve Öğrenci Numarası boş olamaz.");
      return;
    }

    // 🔍 Firebase'de bu TC veya Öğrenci No ile kayıtlı öğrenci var mı kontrolü
    firebase.database().ref("ogrenciler").once("value")
      .then(snapshot => {
        const data = snapshot.val();
        let tcVar = false;
        let ogrNoVar = false;

        if (data) {
          for (let id in data) {
            const ogr = data[id];
            if (ogr?.ogrenci?.tc === veri.ogrenci.tc) tcVar = true;
            if (ogr?.ogrenci?.ogrNo === veri.ogrenci.ogrNo) ogrNoVar = true;
            if (tcVar || ogrNoVar) break;
          }
        }

        if (tcVar) {
          alert("🚫 Bu TC Kimlik Numarasına sahip bir öğrenci zaten kayıtlı.");
          return;
        }

        if (ogrNoVar) {
          alert("🚫 Bu Öğrenci Numarasına sahip bir öğrenci zaten kayıtlı.");
          return;
        }

        // ✅ Her şey uygunsa kayıt yapılır
        return firebase.database().ref("ogrenciler").push(veri)
          .then(() => {
            alert("✅ Kayıt başarıyla tamamlandı.");
            sayfayiGercektenYenile(); // Formu sıfırla
          });
      })
      .catch((err) => {
        console.error("Firebase Hatası:", err);
        alert("❌ Kayıt başarısız: " + err.message);
      });

  } catch (err) {
    alert("🚨 Hata: " + err.message);
  }
 }


 document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("ogrenciKayitFormu");
  if (form) {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      kaydetOgrenci();
    });
  }
 });



 function sayfayiYenile() {
  Swal.fire({
    title: 'Form sıfırlansın mı?',
    text: "Bu işlem geri alınamaz.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Evet, sıfırla',
    cancelButtonText: 'Vazgeç',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6'
  }).then((result) => {
    if (result.isConfirmed) {
      sayfayiGercektenYenile(); // sıfırlama işlemini ayrı fonksiyonda yap
    }
  });
 }
 document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC düzelt
  const today = now.toISOString().split("T")[0];

  const dateInput = document.getElementById("date");
  if (dateInput) dateInput.value = today;
 });

 function sayfayiGercektenYenile() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const today = now.toISOString().split("T")[0];

  // Form alanlarını temizle
  const alanlar = [
    "adSoyad", "tc", "ogrNo", "sinif", "grup", "dogumTarihi",
    "okul", "egitimProgrami", "kayitTarihi", "islemTarihi",
    "veliAd", "veliTel1", "veliTel2",
    "taksitSayisi", "ilkTaksitTarihi"
  ];
  alanlar.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // Bugünün tarihi atanacak alanlar
  const kayitEl = document.getElementById("kayitTarihi");
  const islemEl = document.getElementById("islemTarihi");
  if (kayitEl) kayitEl.value = today;
  if (islemEl) islemEl.value = today;

  const toplamEl = document.getElementById("toplamTutar");
  if (toplamEl) {
    toplamEl.dataset.raw = "0";
    toplamEl.value = "";
    formatAmountLive();
  }

  const kutular = document.getElementById("taksitKutulari");
  if (kutular) kutular.innerHTML = "";

  if (typeof taksitler !== "undefined") taksitler = [];

  if (typeof toplamTaksitleriHesapla === "function") toplamTaksitleriHesapla();
 }



 function telefonGirisFormatla(input) {
  let raw = input.value.replace(/\D/g, "").slice(0, 10); // En fazla 10 rakam
  let formatted = "";

  if (raw.length > 0) {
    formatted += "(" + raw.substring(0, 3);
  }
  if (raw.length >= 4) {
    formatted += ") " + raw.substring(3, 6);
  }
  if (raw.length >= 7) {
    formatted += " " + raw.substring(6, 8);
  }
  if (raw.length >= 9) {
    formatted += " " + raw.substring(8, 10);
  }

  input.value = formatted;
 }

 function temizTelefon(numaraliGiris) {
  let numara = numaraliGiris.replace(/\D/g, ""); // Tüm rakamları al
  if (numara.length === 10) {
    return "90" + numara; // Türkiye için ülke kodu ekle
  }
  return numara;
 }

 // Örnek kullanım: whatsapp
 let veliTel1 = document.getElementById("veliTel1").value;
 let temiz1 = temizTelefon(veliTel1); // "90554XXXXXXX"



 //***************************

 async function ogrListele() {
  // Sayfa sıfırlama (yeni listeleme yapıldığında)
  if (typeof ogrAktifSayfa === 'undefined') ogrAktifSayfa = 1;

  const ogrNo = document.getElementById("ogrAraNo").value.trim().toLowerCase();
  const adSoyad = document.getElementById("ogrAraAdSoyad").value.trim().toLowerCase();
  const tc = document.getElementById("ogrAraTC").value.trim();
  const program = document.getElementById("ogrAraProgram").value;

  const sayfaBoyutu = parseInt(document.getElementById("ogrSayfaBoyutu").value);
  const kartListesi = document.getElementById("ogrKartListesi");
  const toplamEl = document.getElementById("ogrToplam");
  const paginationDiv = document.getElementById("ogrPagination");

  kartListesi.innerHTML = `<p>Yükleniyor...</p>`;
  paginationDiv.innerHTML = "";

  try {
    const snapshot = await firebase.database().ref("ogrenciler").once("value");
    const veriler = snapshot.val() || {};
    const liste = Object.entries(veriler).map(([id, data]) => ({ id, ...data }));

    // 🔍 Filtreleme
    const filtreli = liste.filter(item => {
      const no = (item.ogrenci?.ogrNo || "").toLowerCase();
      const ad = (item.ogrenci?.adSoyad || "").toLowerCase();
      const tcno = (item.ogrenci?.tc || "");
      const prog = (item.ogrenci?.egitimProgrami || "");

      return (!ogrNo || no.includes(ogrNo)) &&
             (!adSoyad || ad.includes(adSoyad)) &&
             (!tc || tcno.includes(tc)) &&
             (!program || prog === program);
    });

    // Filtrelenmiş listeyi dışa aktarmada kullanmak üzere global değişkende sakla
    window.filteredOgrenciler = filtreli;

    // 📄 Sayfalama hesaplaması
    const toplamSayfa = Math.ceil(filtreli.length / sayfaBoyutu);
    if (ogrAktifSayfa > toplamSayfa) ogrAktifSayfa = 1;

    const basla = (ogrAktifSayfa - 1) * sayfaBoyutu;
    const bitir = basla + sayfaBoyutu;
    const sayfaVeri = filtreli.slice(basla, bitir);

    // 🧱 Kartları Oluştur
    const kartlarHTML = sayfaVeri.map(item => `
      <div class="record-card ${renkSinifi(item.ogrenci?.sinif)}">
        <div class="ogrenci-kart-header">
          <div class="ogrenci-ad"><span>👤</span> <strong>${item.ogrenci?.adSoyad || "-"}</strong></div>
          <div class="ogrenci-sinif">🏫 ${item.ogrenci?.sinif || ""} / ${item.ogrenci?.grup || ""}</div>
        </div>

        <div class="ogrenci-info">
          <div class="ogrenci-no">🆔 <strong>Öğrenci No:</strong> ${item.ogrenci?.ogrNo || "-"}</div>
          <div class="ogrenci-program">🎓 <strong>Program:</strong> ${item.ogrenci?.egitimProgrami || "-"}</div>
        </div>

        <div class="ogrenci-info">
          <div class="ogrenci-veli">👪 <strong>Veli:</strong> ${item.veli?.adSoyad || "-"}</div>
          <div class="ogrenci-tutar">💰 <strong>Toplam Tutar:</strong> ₺${parseFloat(item.odeme?.toplamTutar || 0).toLocaleString("tr-TR")}</div>
        </div>

        <div class="record-actions">
          <button class="btn-guncelle" onclick="ogrenciGuncelle('${item.id}')">✏️ Düzenle</button>
          <button class="btn-sil" onclick="ogrenciSil('${item.id}')">🗑 Sil</button>
        </div>
      </div>
    `).join("");

    // 📤 Kartları Göster
    kartListesi.innerHTML = kartlarHTML || `<p>Hiç öğrenci bulunamadı.</p>`;
    toplamEl.textContent = `Toplam: ${filtreli.length} öğrenci`;

    // 📌 Sayfa Butonları
    if (toplamSayfa > 1) {
      const once = document.createElement("button");
      once.textContent = "⬅️ Geri";
      once.disabled = ogrAktifSayfa === 1;
      once.onclick = () => {
        ogrAktifSayfa--;
        ogrListele();
      };

      const ileri = document.createElement("button");
      ileri.textContent = "İleri ➡️";
      ileri.disabled = ogrAktifSayfa === toplamSayfa;
      ileri.onclick = () => {
        ogrAktifSayfa++;
        ogrListele();
      };

      const bilgi = document.createElement("span");
      bilgi.textContent = `Sayfa ${ogrAktifSayfa} / ${toplamSayfa}`;
      bilgi.style.padding = "6px";

      paginationDiv.appendChild(once);
      paginationDiv.appendChild(bilgi);
      paginationDiv.appendChild(ileri);
    }

  } catch (err) {
    kartListesi.innerHTML = `<p style="color: red;">Hata oluştu: ${err.message}</p>`;
    toplamEl.textContent = "";
  }
 }


 function renkSinifi(sinif) {
  if (!sinif) return "renk-default";

  const s = sinif.toString().toLowerCase();

  if (s.includes("1")) return "renk-mavi";
  if (s.includes("2")) return "renk-yesil";
  if (s.includes("3")) return "renk-lila";
  if (s.includes("4")) return "renk-sari";
  if (s.includes("5")) return "renk-pembe";
  if (s.includes("6")) return "renk-kahve";
  if (s.includes("7")) return "renk-kirmizi";
  if (s.includes("8")) return "renk-turuncu";

  return "renk-default";
 }

 function ogrYenile() {
  // Filtre alanlarını temizle
  document.getElementById("ogrAraNo").value = "";
  document.getElementById("ogrAraAdSoyad").value = "";
  document.getElementById("ogrAraTC").value = "";
  document.getElementById("ogrAraProgram").value = "";
  document.getElementById("ogrSayfaBoyutu").value = "10";

  // Kartları temizle
  const kartListesi = document.getElementById("ogrKartListesi");
  kartListesi.innerHTML = `<p>Henüz listeleme yapılmadı.</p>`;

  // Toplam öğrenci sayısını sıfırla
  const toplamEl = document.getElementById("ogrToplam");
  toplamEl.textContent = `Toplam: 0 öğrenci`;
 }

 document.getElementById("ogrSayfaBoyutu").addEventListener("change", () => {
  ogrAktifSayfa = 1;
  ogrListele();
 });

 async function ogrenciGuncelle(id) {
  try {
    const snapshot = await firebase.database().ref("ogrenciler/" + id).once("value");
    const data = snapshot.val();

    if (!data || !data.ogrenci) {
      alert("Öğrenci verisi alınamadı.");
      return;
    }

    // Öğrenci bilgileri
    document.getElementById("guncelleAdSoyad").value = data.ogrenci.adSoyad || "";
    document.getElementById("guncelleDogumTarihi").value = data.ogrenci.dogumTarihi || "";
    document.getElementById("guncelleOgrNo").value = data.ogrenci.ogrNo || "";
    document.getElementById("guncelleSinif").value = data.ogrenci.sinif || "";
    document.getElementById("guncelleGrup").value = data.ogrenci.grup || "";
    document.getElementById("guncelleOkul").value = data.ogrenci.okul || "";
    document.getElementById("guncelleProgram").value = data.ogrenci.egitimProgrami || "";
    document.getElementById("guncelleKayitTarihi").value = data.ogrenci.kayitTarihi || "";
    document.getElementById("guncelleIslemTarihi").value = data.ogrenci.islemTarihi || "";

    // Veli bilgileri
    document.getElementById("guncelleVeliAd").value = data.veli?.adSoyad || "";
    document.getElementById("guncelleVeliTel1").value = data.veli?.telefon1 || "";
    document.getElementById("guncelleVeliTel2").value = data.veli?.telefon2 || "";

    // Ödeme bilgileri
    const toplamTutar = data.odeme?.toplamTutar || 0;
    const paraBirimi = data.odeme?.paraBirimi || "TRY";
    const taksitler = data.odeme?.taksitler || {};

    document.getElementById("guncelleToplamTutar").value = toplamTutar;
    document.getElementById("guncelleParaBirimi").value = paraBirimi;

    const taksitSayisi = Object.keys(taksitler).length || 1;
    document.getElementById("guncelleTaksitSayisi").value = taksitSayisi;

    // 🆕 Takip değişkeni
    guncelleTaksitler = [];

    // 🧱 Taksit kutularını oluştur
    const taksitDiv = document.getElementById("guncelleTaksitlerAlani");
    taksitDiv.innerHTML = "";
    taksitDiv.style.display = "grid";
    taksitDiv.style.gridTemplateColumns = "1fr 1fr";
    taksitDiv.style.gap = "1rem";

    for (let i = 0; i < taksitSayisi; i++) {
      const val = taksitler[i] || { tarih: "", tutar: 0 };

      const kart = document.createElement("div");
      kart.className = "taksit-kart";

      const label = document.createElement("label");
      label.textContent = `Taksit ${i + 1}`;

      const tutarInput = document.createElement("input");
      tutarInput.type = "number";
      tutarInput.classList.add("taksitTutarInput");
      tutarInput.value = val.tutar || 0;

      tutarInput.addEventListener("blur", () => {
        yenidenDagit(i); // 🔁 Diğer taksitleri yeniden hesapla
      });

      const tarihInput = document.createElement("input");
      tarihInput.type = "date";
      tarihInput.classList.add("taksitTarihInput");
      tarihInput.value = val.tarih || new Date().toISOString().split("T")[0];

      tarihInput.addEventListener("input", e => {
        guncelleTaksitler[i].tarih = e.target.value;
      });

      guncelleTaksitler.push({
        tutar: parseFloat(tutarInput.value),
        tarih: tarihInput.value
      });

      kart.appendChild(label);
      kart.appendChild(tutarInput);
      kart.appendChild(tarihInput);
      taksitDiv.appendChild(kart);
    }

    // 👉 Toplam tutar veya taksit sayısı değişirse yeniden hesapla
    const toplamTutarInput = document.getElementById("guncelleToplamTutar");
    const taksitSayiInput = document.getElementById("guncelleTaksitSayisi");

    if (toplamTutarInput) {
      toplamTutarInput.addEventListener("input", guncelleTaksitKutulariniOlustur);
    }

    if (taksitSayiInput) {
      taksitSayiInput.addEventListener("input", guncelleTaksitKutulariniOlustur);
    }

    // Gizli ID alanı
    document.getElementById("guncelleOgrId").value = id;

    // Modalı aç
    document.getElementById("ogrenciGuncelleModal").style.display = "flex";

  } catch (err) {
    console.error("Hata:", err);
    alert("Veri alınamadı: " + err.message);
  }
 }

 function guncelleTaksitKutulariniOlustur() {
  const container = document.getElementById("guncelleTaksitlerAlani");
  container.innerHTML = "";
  container.style.display = "grid";
  container.style.gridTemplateColumns = "1fr 1fr";
  container.style.gap = "1rem";

  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar")?.value || "0");
  const taksitSayisi = parseInt(document.getElementById("guncelleTaksitSayisi")?.value || "0");

  if (isNaN(toplamTutar) || isNaN(taksitSayisi) || taksitSayisi < 1) return;

  const kalanTaksitSayisi = taksitSayisi - 1;
  const ortalama = Math.floor((toplamTutar / taksitSayisi) / 50) * 50;
  const kalanToplam = ortalama * kalanTaksitSayisi;
  const ilkTaksit = toplamTutar - kalanToplam;

  guncelleTaksitler = [];

  // 📅 Taksit tarihlerini ayarla: ilk taksit tarihini belirle ve her biri için ay ekle
  let basTarih = null;
  if (Array.isArray(guncelleTaksitler) && guncelleTaksitler.length > 0 && guncelleTaksitler[0].tarih) {
    basTarih = new Date(guncelleTaksitler[0].tarih);
  } else {
    basTarih = new Date();
  }
  for (let i = 0; i < taksitSayisi; i++) {
    const taksitDiv = document.createElement("div");
    taksitDiv.classList.add("taksit-kart");

    const label = document.createElement("label");
    label.textContent = `Taksit ${i + 1}`;

    const tutarInput = document.createElement("input");
    tutarInput.type = "number";
    tutarInput.classList.add("taksitTutarInput");
    tutarInput.value = i === 0 ? ilkTaksit.toFixed(2) : ortalama.toFixed(2);

    const tarihInput = document.createElement("input");
    tarihInput.type = "date";
    tarihInput.classList.add("taksitTarihInput");
    const d = new Date(basTarih.getTime());
    d.setMonth(d.getMonth() + i);
    tarihInput.value = d.toISOString().split("T")[0];

    guncelleTaksitler.push({
      tutar: parseFloat(tutarInput.value),
      tarih: tarihInput.value
    });

    tutarInput.addEventListener("blur", () => {
      yenidenDagit(i);
    });

    tarihInput.addEventListener("input", (e) => {
      guncelleTaksitler[i].tarih = e.target.value;
    });

    taksitDiv.appendChild(label);
    taksitDiv.appendChild(tutarInput);
    taksitDiv.appendChild(tarihInput);
    container.appendChild(taksitDiv);
  }
 }

 function guncelleTaksitEkle() {
  const mevcutSayi = parseInt(document.getElementById("guncelleTaksitSayisi").value) || 1;
  const yeniSayi = mevcutSayi + 1;
  document.getElementById("guncelleTaksitSayisi").value = yeniSayi;

  guncelleTaksitKutulariniOlustur(); // otomatik dağıtım yapılır
 }

 function guncelleTaksitSil() {
  const mevcutSayi = parseInt(document.getElementById("guncelleTaksitSayisi").value) || 1;

  if (mevcutSayi <= 1) {
    alert("En az 1 taksit kalmalıdır.");
    return;
  }

  const yeniSayi = mevcutSayi - 1;
  document.getElementById("guncelleTaksitSayisi").value = yeniSayi;

  guncelleTaksitKutulariniOlustur(); // yeniden dengeli şekilde oluşturulur
 }

 async function kaydetGuncelle() {
  const id = document.getElementById("guncelleOgrId").value;
  if (!id) {
    alert("ID bulunamadı.");
    return;
  }

  // 📘 Zorunlu alanlar
  const adSoyad = document.getElementById("guncelleAdSoyad").value.trim();
  const ogrNo = document.getElementById("guncelleOgrNo").value.trim();
  const veliAd = document.getElementById("guncelleVeliAd").value.trim();
  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar").value) || 0;

  if (!adSoyad || !ogrNo || !veliAd || toplamTutar <= 0) {
    alert("⚠️ Ad Soyad, Öğrenci No, Veli Adı ve Toplam Tutar alanlarını eksiksiz doldurun.");
    return;
  }

  // 📘 Öğrenci bilgileri
  const ogrenci = {
    adSoyad,
    ogrNo,
    sinif: document.getElementById("guncelleSinif").value.trim(),
    grup: document.getElementById("guncelleGrup").value.trim(),
    egitimProgrami: document.getElementById("guncelleProgram").value.trim(),
    dogumTarihi: document.getElementById("guncelleDogumTarihi")?.value || "",
    okul: document.getElementById("guncelleOkul")?.value || "",
    kayitTarihi: document.getElementById("guncelleKayitTarihi")?.value || "",
    islemTarihi: document.getElementById("guncelleIslemTarihi")?.value || ""
  };

  // 👨‍👩‍👧 Veli bilgileri
  const veli = {
    adSoyad: veliAd,
    telefon1: document.getElementById("guncelleVeliTel1")?.value.trim() || "",
    telefon2: document.getElementById("guncelleVeliTel2")?.value.trim() || ""
  };

  // 💳 Ödeme bilgileri
  const odeme = {
    toplamTutar,
    paraBirimi: document.getElementById("guncelleParaBirimi")?.value || "TRY",
    taksitler: {}
  };

  const tarihInputs = document.querySelectorAll(".taksitTarihInput");
  const tutarInputs = document.querySelectorAll(".taksitTutarInput");

  tarihInputs.forEach((tarihInput, index) => {
    const tarih = tarihInput.value || "";
    const tutar = parseFloat(tutarInputs[index].value) || 0;
    odeme.taksitler[index] = { tarih, tutar };
  });

  try {
    await firebase.database().ref(`ogrenciler/${id}`).set({
      ogrenci,
      veli,
      odeme,
      guncellenmeZamani: new Date().toISOString()
    });

    alert("✅ Öğrenci başarıyla güncellendi.");
    document.getElementById("ogrenciGuncelleModal").style.display = "none";

    if (typeof ogrListele === "function") {
      ogrListele(); // listeyi yenile
    }

  } catch (err) {
    alert("❌ Güncelleme başarısız: " + err.message);
  }
 }
 function kapatGuncelleModal() {
  const modal = document.getElementById("ogrenciGuncelleModal");
  if (modal) {
    modal.style.display = "none";
  }

  // 🧼 Formu temizle
  document.getElementById("guncelleOgrId").value = "";
  document.getElementById("guncelleAdSoyad").value = "";
  document.getElementById("guncelleDogumTarihi").value = "";
  document.getElementById("guncelleOgrNo").value = "";
  document.getElementById("guncelleSinif").value = "";
  document.getElementById("guncelleGrup").value = "";
  document.getElementById("guncelleOkul").value = "";
  document.getElementById("guncelleProgram").value = "";
  document.getElementById("guncelleKayitTarihi").value = "";
  document.getElementById("guncelleIslemTarihi").value = "";

  document.getElementById("guncelleVeliAd").value = "";
  document.getElementById("guncelleVeliTel1").value = "";
  document.getElementById("guncelleVeliTel2").value = "";

  document.getElementById("guncelleParaBirimi").value = "TRY";
  document.getElementById("guncelleToplamTutar").value = "";
  document.getElementById("guncelleTaksitSayisi").value = "";

  const taksitAlan = document.getElementById("guncelleTaksitlerAlani");
  if (taksitAlan) taksitAlan.innerHTML = "";

  if (typeof guncelleTaksitler !== "undefined") {
    guncelleTaksitler = [];
  }
 }
 function yenidenDagit(degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar").value) || 0;
  const taksitSayisi = guncelleTaksitler.length;

  // Kullanıcının değiştirdiği taksit
  const sabitTutar = parseFloat(document.querySelectorAll(".taksitTutarInput")[degisenIndex].value) || 0;
  guncelleTaksitler[degisenIndex].tutar = sabitTutar;

  // Kalan tutar ve kalan taksit sayısı
  const kalanTaksitler = taksitSayisi - 1;
  const kalanTutar = toplamTutar - sabitTutar;

  if (kalanTaksitler <= 0 || kalanTutar <= 0) {
    // Diğerlerini sıfırla
    guncelleTaksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    // 50’nin katı olacak şekilde bölüştür
    const ortalama = Math.floor((kalanTutar / kalanTaksitler) / 50) * 50;
    const toplamBolen = ortalama * kalanTaksitler;
    const fark = kalanTutar - toplamBolen;

    let farkDagitildi = false;
    guncelleTaksitler.forEach((t, i) => {
      if (i === degisenIndex) return;
      t.tutar = ortalama;
      if (!farkDagitildi && fark > 0) {
        t.tutar += fark;
        farkDagitildi = true;
      }
    });
  }

  // Güncel değerleri inputlara yaz
  const tutarInputs = document.querySelectorAll(".taksitTutarInput");
  guncelleTaksitler.forEach((t, i) => {
    tutarInputs[i].value = t.tutar.toFixed(2);
  });
 }

 async function ogrenciSil(id) {
  const onay = confirm("🗑️ Bu öğrenciyi silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz.");

  if (!onay) return;

  try {
    await firebase.database().ref("ogrenciler/" + id).remove();

    alert("✅ Öğrenci başarıyla silindi.");
    ogrListele(); // Listeyi yeniden yükle
  } catch (err) {
    console.error("❌ Silme hatası:", err);
    alert("Bir hata oluştu: " + err.message);
  }
 }

  /* ------------------ TAKSIT LISTELEME VE ODEME ------------------ */
  // Listeleme fonksiyonları, taksit ve ödeme sayfaları için
  function taksitListele() {
    // Listeleme: hem normal hem de vadesi geçmiş taksitleri ayırarak gösterir.
    const listEl = document.getElementById("taksitListesi");
    if (!listEl) return;
    const overdueEl = document.getElementById("taksitOverdueListesi");
    const noSearch = document.getElementById("taksitAraNo")?.value.trim().toLowerCase() || "";
    const search = document.getElementById("taksitAraAd")?.value.trim().toLowerCase() || "";
    const durum = document.getElementById("taksitDurum")?.value || "";
    const bas = document.getElementById("taksitBaslangic")?.value || "";
    const bit = document.getElementById("taksitBitis")?.value || "";
    // Temizle
    listEl.innerHTML = "<p>Yükleniyor...</p>";
    if (overdueEl) overdueEl.innerHTML = "";
    firebase.database().ref("ogrenciler").once("value", snap => {
      const data = snap.val();
      if (!data) {
        listEl.innerHTML = "<p>📭 Kayıt bulunamadı.</p>";
        return;
      }
      let normalItems = [];
      let overdueItems = [];
      const todayStr = new Date().toISOString().split("T")[0];
      Object.keys(data).forEach(id => {
        const ogr = data[id];
        const ogrBilgi = ogr.ogrenci || {};
        const odeme = ogr.odeme || {};
        const taksitler = odeme.taksitler || {};
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const odendi = t.odendi === true;
          const partialAmount = parseFloat(t.odenen || 0);
          // Duruma göre filtrele
          if (durum === "odendi" && !odendi) return;
          if (durum === "odenmedi" && odendi) return;
          const nameLower = (ogrBilgi.adSoyad || "").toLowerCase();
          const ogrNoLower = (ogrBilgi.ogrNo || "").toLowerCase();
          if (search && !nameLower.includes(search)) return;
          if (noSearch && !ogrNoLower.includes(noSearch)) return;
          const tarih = t.tarih || "";
          if (bas && tarih < bas) return;
          if (bit && tarih > bit) return;
          const isOverdue = !odendi && tarih && tarih < todayStr;
          const item = {
            ogrId: id,
            ogrAd: ogrBilgi.adSoyad || "",
            ogrNo: ogrBilgi.ogrNo || "",
            program: ogrBilgi.egitimProgrami || "",
            index: idx,
            tutar: parseFloat(t.tutar || 0),
            tarih: tarih,
            odendi: odendi,
            partial: partialAmount,
            paraBirimi: odeme.paraBirimi || "TRY",
            veliTel: ogrBilgi.velTel || ""
          };
          if (isOverdue) overdueItems.push(item); else normalItems.push(item);
        });
      });
      // Tarihe göre sırala
      normalItems.sort((a,b) => new Date(a.tarih) - new Date(b.tarih));
      overdueItems.sort((a,b) => new Date(a.tarih) - new Date(b.tarih));
      // Normal listeyi yaz
      listEl.innerHTML = "";
      if (normalItems.length === 0) {
        listEl.innerHTML = "<p>📭 Taksit bulunamadı.</p>";
      } else {
        normalItems.forEach(item => {
          const div = document.createElement("div");
          // Her kart için benzersiz bir id ata, böylece ödeme işlemi sonrası aynı karta kaydırabiliriz
          div.id = `taksit-${item.ogrId}-${item.index}`;
          // Sınıf belirleme: ödenmiş, kısmi veya ödenmemiş
          let cardClass = "record-card";
          if (item.odendi) {
            cardClass += " taksit-odendi";
          } else if (item.partial > 0) {
            cardClass += " taksit-kismi";
          } else {
            cardClass += " taksit-odenmedi";
          }
          div.className = cardClass;
          const symbolMap = { "TRY":"₺", "USD":"$", "EUR":"€" };
          const sym = symbolMap[item.paraBirimi] || "";
          const formattedAmount = `${item.tutar.toFixed(2)} ${sym}`;
          const kalan = Math.max(0, item.tutar - item.partial).toFixed(2);
          const durumText = item.odendi ? "Ödendi" : (item.partial > 0 ? "Kısmi Ödendi" : "Ödenmedi");
          let actionsHTML = "";
          if (item.odendi) {
            // Ödendi: ödenmediye çevir ve makbuz görüntüle butonları
            actionsHTML += `<button class="btn-guncelle" onclick="taksitSetOdenmedi('${item.ogrId}','${item.index}')">Ödenmedi</button>`;
            actionsHTML += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
          } else {
            // Ödenmedi veya kısmi: ödeme, kısmi ödeme ve kısmi geri al seçenekleri
            actionsHTML += `<button class="btn-guncelle" onclick="taksitSetOdendi('${item.ogrId}','${item.index}')">Ödendi</button>`;
            actionsHTML += `<button class="btn-guncelle" onclick="taksitKismiOdeme('${item.ogrId}','${item.index}',${item.tutar},${item.partial})">Kısmi Ödeme</button>`;
            if (item.partial > 0) {
              actionsHTML += `<button class="btn-guncelle" onclick="taksitKismiGeriAl('${item.ogrId}','${item.index}')">Kısmi Geri Al</button>`;
              // Kısmi ödenmiş taksitlerde makbuz görüntüleme seçeneği
              actionsHTML += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
            }
          }
          // Kart içeriği
          div.innerHTML = `
          <div class="record-header">
            <span>${item.ogrAd} (${item.ogrNo})</span>
            <span>${formattedAmount}</span>
          </div>
          <div class="record-details">
            <span>Program: <strong>${item.program}</strong></span> |
            <span>Tarih: <strong>${formatTarih(item.tarih)}</strong></span> |
            <span>Durum: <strong>${durumText}</strong></span>
          </div>
          <div class="record-details">
            <span>Kalan: <strong>${kalan} ${sym}</strong></span>
          </div>
          <div class="record-actions">
            ${actionsHTML}
          </div>
          `;
          listEl.appendChild(div);
        });
      }
      // Vadesi geçmişleri yaz
      if (overdueEl) {
        overdueEl.innerHTML = "";
        if (overdueItems.length > 0) {
          // Başlık ekle
          const h = document.createElement("h4");
          h.textContent = "🔴 Vadesi Geçmiş Taksitler";
          overdueEl.appendChild(h);
          overdueItems.forEach(item => {
            const div = document.createElement("div");
            // Her vadesi geçmiş kart için benzersiz id ata
            div.id = `taksit-${item.ogrId}-${item.index}`;
            let cardClass = "record-card taksit-overdue";
            if (item.partial > 0) cardClass += " taksit-kismi";
            div.className = cardClass;
            const symb = { "TRY":"₺","USD":"$","EUR":"€" }[item.paraBirimi] || "";
            const kalan = Math.max(0, item.tutar - item.partial).toFixed(2);
            const durumText = item.odendi ? "Ödendi" : (item.partial > 0 ? "Kısmi Ödendi" : "Ödenmedi");
            let actions = "";
            if (item.odendi) {
              actions += `<button class="btn-guncelle" onclick="taksitSetOdenmedi('${item.ogrId}','${item.index}')">Ödenmedi</button>`;
              actions += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
            } else {
              actions += `<button class="btn-guncelle" onclick="taksitSetOdendi('${item.ogrId}','${item.index}')">Ödendi</button>`;
              actions += `<button class="btn-guncelle" onclick="taksitKismiOdeme('${item.ogrId}','${item.index}',${item.tutar},${item.partial})">Kısmi Ödeme</button>`;
              if (item.partial > 0) {
                actions += `<button class="btn-guncelle" onclick="taksitKismiGeriAl('${item.ogrId}','${item.index}')">Kısmi Geri Al</button>`;
                actions += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
              }
            }
            // Uyarı gönder butonu
            actions += `<button class="btn-guncelle" onclick="sendOverdueReminder('${item.ogrId}','${item.index}')">Uyarı Gönder</button>`;
            div.innerHTML = `
            <div class="record-header">
              <span>${item.ogrAd} (${item.ogrNo})</span>
              <span>${item.tutar.toFixed(2)} ${symb}</span>
            </div>
            <div class="record-details">
              <span>Program: <strong>${item.program}</strong></span> |
              <span>Tarih: <strong>${formatTarih(item.tarih)}</strong></span> |
              <span>Durum: <strong>${durumText}</strong></span>
            </div>
            <div class="record-details">
              <span>Kalan: <strong>${kalan} ${symb}</strong></span>
            </div>
            <div class="record-actions">
              ${actions}
            </div>
            `;
            overdueEl.appendChild(div);
          });
        } else {
          // overdueEl boşsa gizle
          overdueEl.innerHTML = "";
        }
      }
      // Liste oluşturulduktan sonra, kaydedilen kaydırma konumu varsa geri dön
      if (typeof window.prevTaksitScrollY !== 'undefined') {
        const yPos = window.prevTaksitScrollY;
        window.prevTaksitScrollY = undefined;
        setTimeout(() => {
          window.scrollTo(0, yPos);
        }, 0);
        // Modal açılıp kapandıktan sonra da konum korunsun diye gecikmeli olarak tekrar kaydır
        setTimeout(() => {
          window.scrollTo(0, yPos);
        }, 500);
      }
      // Eğer son tıklanan kart ID'si kaydedildiyse, bu kartı merkeze kaydır
      if (window.lastTaksitCardId) {
        const target = document.getElementById(window.lastTaksitCardId);
        window.lastTaksitCardId = undefined;
        if (target) {
          setTimeout(() => {
            target.scrollIntoView({ block: 'center' });
          }, 0);
          // Modal kapandıktan sonra da hedefe kaydır
          setTimeout(() => {
            target.scrollIntoView({ block: 'center' });
          }, 500);
        }
      }
    });
  }

  function taksitOdendiToggle(ogrId, index, mevcut) {
    const ref = firebase.database().ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/odendi`);
    ref.set(!mevcut).then(() => {
      taksitListele();
    });
  }

  function taksitFiltreTemizle() {
    const ad = document.getElementById("taksitAraAd");
    const durumSel = document.getElementById("taksitDurum");
    const basInp = document.getElementById("taksitBaslangic");
    const bitInp = document.getElementById("taksitBitis");
    if (ad) ad.value = "";
    if (durumSel) durumSel.value = "";
    if (basInp) basInp.value = "";
    if (bitInp) bitInp.value = "";
    taksitListele();
  }

  function odemeListele() {
    const listEl = document.getElementById("odemeListesi");
    if (!listEl) return;
    const search = document.getElementById("odemeAraAd")?.value.trim().toLowerCase() || "";
    const noSearch = document.getElementById("odemeAraNo")?.value.trim().toLowerCase() || "";
    const program = document.getElementById("odemeProgram")?.value || "";
    listEl.innerHTML = "<p>Yükleniyor...</p>";
    firebase.database().ref("ogrenciler").once("value", snap => {
      const data = snap.val();
      if (!data) {
        listEl.innerHTML = "<p>📭 Kayıt bulunamadı.</p>";
        return;
      }
      let items = [];
      Object.keys(data).forEach(id => {
        const ogr = data[id];
        const ogrBilgi = ogr.ogrenci || {};
        const odeme = ogr.odeme || {};
        const taksitler = odeme.taksitler || {};
        if (program && ogrBilgi.egitimProgrami !== program) return;
        const nameLower = (ogrBilgi.adSoyad || "").toLowerCase();
        const ogrNoLower = (ogrBilgi.ogrNo || "").toLowerCase();
        if (search && !nameLower.includes(search)) return;
        if (noSearch && !ogrNoLower.includes(noSearch)) return;
        // Toplam tutarı taksitlerin toplamından hesapla
        let toplamTutar = 0;
        let odenen = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          toplamTutar += parseFloat(t.tutar || 0);
          if (t.odendi) {
            odenen += parseFloat(t.tutar || 0);
          } else if (t.odenen) {
            odenen += parseFloat(t.odenen || 0);
          }
        });
        items.push({
          ogrId: id,
          ogrAd: ogrBilgi.adSoyad || "",
          ogrNo: ogrBilgi.ogrNo || "",
          sinif: ogrBilgi.sinif || "",
          grup: ogrBilgi.grup || "",
          program: ogrBilgi.egitimProgrami || "",
          toplamTutar: toplamTutar,
          odenen: odenen,
          paraBirimi: odeme.paraBirimi || "TRY"
        });
      });
      listEl.innerHTML = "";
      if (items.length === 0) {
        listEl.innerHTML = "<p>📭 Kayıt bulunamadı.</p>";
        return;
      }
      items.forEach(item => {
        const symbolMap = { "TRY":"₺", "USD":"$", "EUR":"€" };
        const sym = symbolMap[item.paraBirimi] || "";
        const format = (v) => `${v.toFixed(2)} ${sym}`;
        const kalan = item.toplamTutar - item.odenen;
        const div = document.createElement("div");
        div.className = "record-card";
        div.innerHTML = `
        <div class="record-title"><strong>${item.ogrAd} (${item.ogrNo})</strong></div>
        <div class="record-details">
          <span>Program: <strong>${item.program}</strong></span> |
          <span>Sınıf/Grup: <strong>${item.sinif}/${item.grup}</strong></span>
        </div>
        <div class="record-details">
          <span>Toplam: <strong>${format(item.toplamTutar)}</strong></span> |
          <span>Ödenen: <strong>${format(item.odenen)}</strong></span> |
          <span>Kalan: <strong>${format(kalan)}</strong></span>
        </div>
        `;
        listEl.appendChild(div);
      });
    });
  }

  function odemeFiltreTemizle() {
    const ad = document.getElementById("odemeAraAd");
    const noInp = document.getElementById("odemeAraNo");
    const progSel = document.getElementById("odemeProgram");
    if (ad) ad.value = "";
    if (noInp) noInp.value = "";
    if (progSel) progSel.value = "";
    odemeListele();
  }

  /* ========= RAPORLAMA VE YAZDIRMA ========= */
  // Yardımcı: seçilen rapor türüne göre tarih aralığı döndürür
  function getDateRangeForReport(type) {
    const now = new Date();
    let start;
    let end = new Date();
    // normalize to 00:00:00 for start and end at 23:59:59? We'll use inclusive conditions later
    switch (type) {
      case 'today':
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week': {
        // Pazartesi başlangıçlı hafta
        const day = now.getDay() || 7;
        start = new Date(now);
        start.setDate(now.getDate() - day + 1);
        start.setHours(0,0,0,0);
        break;
      }
      case 'month':
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        break;
      case 'year':
        start = new Date(now.getFullYear(), 0, 1);
        break;
      default:
        start = new Date(0);
    }
    return { start, end };
  }

  // Taksit raporu oluşturma ve yazdırma fonksiyonu
  function taksitRaporla() {
    // Önce rapor türünü sor
    Swal.fire({
      title: 'Taksit Raporu',
      input: 'select',
      inputOptions: {
        'today': 'Bugün',
        'week': 'Bu Hafta',
        'month': 'Bu Ay',
        'year': 'Bu Yıl',
        'all': 'Tüm Zamanlar',
        'ogrenci': 'Öğrenci Bazlı'
      },
      inputPlaceholder: 'Rapor türünü seçin',
      showCancelButton: true,
      confirmButtonText: 'Devam',
      cancelButtonText: 'İptal'
    }).then(result => {
      if (!result.isConfirmed) return;
      const type = result.value;
      // İsteğe bağlı öğrenci numarası sorulacak
      const getStudentNo = () => {
        return Swal.fire({
          title: 'Öğrenci Numarası',
          input: 'text',
          inputLabel: 'Raporlamak istediğiniz öğrenci numarasını girin',
          inputPlaceholder: 'Örn: 8001',
          showCancelButton: true,
          confirmButtonText: 'Devam',
          preConfirm: (value) => {
            if (!value) {
              Swal.showValidationMessage('Öğrenci numarası girmelisiniz');
            }
            return value;
          }
        });
      };
      const askStatus = (ogrNoVal) => {
        // Durum filtreleri modalı
        Swal.fire({
          title: 'Durum Seçimi',
          html: `
            <div style="text-align:left;">
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="tam" checked> Tam Ödenen</label>
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="kismi" checked> Kısmi Ödenen</label>
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="odenmemis" checked> Ödenmemiş</label>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Raporla',
          preConfirm: () => {
            const inputs = document.querySelectorAll('.swal2-content input[type=checkbox]:checked');
            const arr = Array.from(inputs).map(i => i.value);
            if (arr.length === 0) {
              Swal.showValidationMessage('En az bir durum seçmelisiniz');
            }
            return arr;
          }
        }).then(res3 => {
          if (!res3.isConfirmed) return;
          const statuses = res3.value;
          generateTaksitReport(type, ogrNoVal, statuses);
        });
      };
      if (type === 'ogrenci') {
        getStudentNo().then(res2 => {
          if (!res2.isConfirmed) return;
          askStatus(res2.value.trim());
        });
      } else {
        askStatus(null);
      }
    });
  }

  function generateTaksitReport(type, ogrNo, statuses) {
    // Tarih aralığı belirle
    const { start, end } = getDateRangeForReport(type);
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [];
      Object.keys(data).forEach(id => {
        const ogrBilgi = data[id].ogrenci || {};
        if (ogrNo && ogrBilgi.ogrNo != ogrNo) return;
        const odeme = data[id].odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenen = 0;
        let kalan = 0;
        let count = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const tarihStr = t.tarih;
          if (!tarihStr) return;
          const tarih = new Date(tarihStr);
          if (type !== 'all' && (tarih < start || tarih > end)) return;
          // Taksit durumu belirle: tam, kismi veya odenmemis
          let durum;
          const tutar = parseFloat(t.tutar || 0);
          const odenenTutar = parseFloat(t.odenen || 0);
          if (t.odendi || odenenTutar >= tutar) {
            durum = 'tam';
          } else if (odenenTutar > 0) {
            durum = 'kismi';
          } else {
            durum = 'odenmemis';
          }
          // Eğer durum filtre listesinde değilse bu taksiti dahil etme
          if (Array.isArray(statuses) && statuses.length > 0 && !statuses.includes(durum)) return;
          // tutar ve odenenTutar zaten yukarıda tanımlandı
          toplam += tutar;
          if (t.odendi) {
            odenen += tutar;
          } else {
            odenen += odenenTutar;
          }
          count++;
        });
        kalan = toplam - odenen;
        if (count > 0) {
          rows.push({
            ogrAd: ogrBilgi.adSoyad || '',
            ogrNo: ogrBilgi.ogrNo || '',
            program: ogrBilgi.egitimProgrami || '',
            sinif: ogrBilgi.sinif || '',
            grup: ogrBilgi.grup || '',
            toplam: toplam,
            odenen: odenen,
          });
        }
      });
      // Toplamların özetini hazırla
      let totalToplam = 0;
      let totalOdenen = 0;
      rows.forEach(r => {
        totalToplam += r.toplam;
        totalOdenen += r.odenen;
      });
      const totalKalan = totalToplam - totalOdenen;
      // Raporun başlık ve tarih aralığı metinlerini oluştur
      const titleMap = { 'today':'Bugün', 'week':'Bu Hafta', 'month':'Bu Ay', 'year':'Bu Yıl', 'all':'Tüm Zaman', 'ogrenci':'Öğrenci Bazlı' };
      let titleText = titleMap[type] || '';
      if (type === 'ogrenci' && ogrNo) titleText += ` - ${ogrNo}`;
      // Tarih aralığı açıklaması
      let rangeDesc = '';
      if (type !== 'all') {
        // start ve end Date nesnelerini formatTarih kullanarak formatla
        const s = formatTarih(start.toISOString().split('T')[0]);
        const e = formatTarih(end.toISOString().split('T')[0]);
        rangeDesc = `${s} - ${e}`;
      }
      // HTML ve stil 
      let reportHTML = '<html><head><meta charset="UTF-8"><title>Fenomen Çocuk Kulübü - Taksit Raporu</title>';
      reportHTML += '<style>' +
        'body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#333;}' +
        'h1,h2{margin:0;padding:0;text-align:center;}' +
        '.summary{display:flex;justify-content:space-around;background:#f9f9f9;padding:10px 0;margin-top:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}' +
        '.summary div{flex:1;text-align:center;font-size:14px;}' +
        '.summary div span{display:block;font-size:18px;font-weight:bold;margin-top:4px;}' +
        'table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}' +
        'th,td{border:1px solid #ddd;padding:8px;}' +
        'th{background:#ffefe3;color:#b14400;font-weight:600;}' +
        'tr:nth-child(even){background:#f9f9f9;}' +
        '.footer{margin-top:25px;font-size:12px;text-align:center;color:#666;}' +
        '</style>';
      reportHTML += '</head><body onload="window.print()">';
      // Logo ve rapor başlığı satır haline getirildi; logo sol tarafta, başlık hemen sağında yer alacak
      reportHTML += `<div style="display:flex; align-items:center; margin-bottom:1rem;">` +
                    `<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />` +
                    `<h2 style="margin:0;">Fenomen Çocuk Kulübü - Taksit Raporu</h2>` +
                    `</div>`;
      reportHTML += `<h3>${titleText}${rangeDesc ? ' (' + rangeDesc + ')' : ''}</h3>`;
      if (rows.length === 0) {
        reportHTML += `<p>Rapor için kayıt bulunamadı.</p>`;
      } else {
        reportHTML += `<div class="summary">` +
          `<div><strong>Toplam Tutar</strong><span>${totalToplam.toFixed(2)}</span></div>` +
          `<div><strong>Ödenen</strong><span>${totalOdenen.toFixed(2)}</span></div>` +
          `<div><strong>Kalan</strong><span>${totalKalan.toFixed(2)}</span></div>` +
          `<div><strong>Öğrenci Sayısı</strong><span>${rows.length}</span></div>` +
        `</div>`;
        reportHTML += `<table><tr><th>Öğrenci</th><th>Program</th><th>Sınıf/Grup</th><th>Toplam Tutar</th><th>Ödenen</th><th>Kalan</th></tr>`;
        rows.forEach(r => {
          const kalan = (r.toplam - r.odenen).toFixed(2);
          reportHTML += `<tr><td>${r.ogrAd} (${r.ogrNo})</td><td>${r.program}</td><td>${r.sinif}/${r.grup}</td><td>${r.toplam.toFixed(2)}</td><td>${r.odenen.toFixed(2)}</td><td>${kalan}</td></tr>`;
        });
        reportHTML += `</table>`;
      }
      reportHTML += `<div class="footer">Bu rapor ${new Date().toLocaleString('tr-TR')} tarihinde oluşturuldu.</div>`;
      reportHTML += '</body></html>';
      const newWin = window.open('', '_blank');
      newWin.document.write(reportHTML);
      newWin.document.close();
      newWin.focus();
    });
  }

  // Ödeme raporu benzeri şekilde oluşturulur
  function odemeRaporla() {
    Swal.fire({
      title: 'Ödeme Raporu',
      input: 'select',
      inputOptions: {
        'today': 'Bugün',
        'week': 'Bu Hafta',
        'month': 'Bu Ay',
        'year': 'Bu Yıl',
        'all': 'Tüm Zamanlar',
        'ogrenci': 'Öğrenci Bazlı'
      },
      inputPlaceholder: 'Rapor türünü seçin',
      showCancelButton: true,
      confirmButtonText: 'Devam',
      cancelButtonText: 'İptal'
    }).then(result => {
      if (!result.isConfirmed) return;
      const type = result.value;
      if (type === 'ogrenci') {
        Swal.fire({
          title: 'Öğrenci Numarası',
          input: 'text',
          inputLabel: 'Raporlamak istediğiniz öğrenci numarasını girin',
          inputPlaceholder: 'Örn: 8001',
          showCancelButton: true,
          confirmButtonText: 'Oluştur',
          preConfirm: (value) => {
            if (!value) {
              Swal.showValidationMessage('Öğrenci numarası girmelisiniz');
            }
            return value;
          }
        }).then(res => {
          if (!res.isConfirmed) return;
          generateOdemeReport(type, res.value.trim());
        });
      } else {
        generateOdemeReport(type, null);
      }
    });
  }

  function generateOdemeReport(type, ogrNo) {
    const { start, end } = getDateRangeForReport(type);
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [];
      Object.keys(data).forEach(id => {
        const ogrBilgi = data[id].ogrenci || {};
        if (ogrNo && ogrBilgi.ogrNo != ogrNo) return;
        const odeme = data[id].odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenen = 0;
        let count = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const tarihStr = t.tarih;
          if (!tarihStr) return;
          const tarih = new Date(tarihStr);
          if (type !== 'all' && (tarih < start || tarih > end)) return;
          const tutar = parseFloat(t.tutar || 0);
          toplam += tutar;
          if (t.odendi) {
            odenen += tutar;
          } else {
            odenen += parseFloat(t.odenen || 0);
          }
          count++;
        });
        const kalan = toplam - odenen;
        if (count > 0) {
          rows.push({
            ogrAd: ogrBilgi.adSoyad || '',
            ogrNo: ogrBilgi.ogrNo || '',
            program: ogrBilgi.egitimProgrami || '',
            sinif: ogrBilgi.sinif || '',
            grup: ogrBilgi.grup || '',
            toplam: toplam,
            odenen: odenen,
            kalan: kalan
          });
        }
      });
      // Toplamların özetini hazırla
      let totalToplam = 0;
      let totalOdenen = 0;
      let totalKalan = 0;
      rows.forEach(r => {
        totalToplam += r.toplam;
        totalOdenen += r.odenen;
        totalKalan += r.kalan;
      });
      const titleMap = { 'today':'Bugün', 'week':'Bu Hafta', 'month':'Bu Ay', 'year':'Bu Yıl', 'all':'Tüm Zaman', 'ogrenci':'Öğrenci Bazlı' };
      let titleText = titleMap[type] || '';
      if (type === 'ogrenci' && ogrNo) titleText += ` - ${ogrNo}`;
      let rangeDesc = '';
      if (type !== 'all') {
        const s = formatTarih(start.toISOString().split('T')[0]);
        const e = formatTarih(end.toISOString().split('T')[0]);
        rangeDesc = `${s} - ${e}`;
      }
      let reportHTML = '<html><head><meta charset="UTF-8"><title>Fenomen Çocuk Kulübü - Ödeme Raporu</title>';
      reportHTML += '<style>' +
        'body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#333;}' +
        'h1,h2,h3{margin:0;padding:0;text-align:center;}' +
        '.summary{display:flex;justify-content:space-around;background:#f9f9f9;padding:10px 0;margin-top:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}' +
        '.summary div{flex:1;text-align:center;font-size:14px;}' +
        '.summary div span{display:block;font-size:18px;font-weight:bold;margin-top:4px;}' +
        'table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}' +
        'th,td{border:1px solid #ddd;padding:8px;}' +
        'th{background:#ffefe3;color:#b14400;font-weight:600;}' +
        'tr:nth-child(even){background:#f9f9f9;}' +
        '.footer{margin-top:25px;font-size:12px;text-align:center;color:#666;}' +
        '</style>';
      reportHTML += '</head><body onload="window.print()">';
      // Logo ve ödeme raporu başlığı birlikte gösterilir; logo sol tarafta konumlandırılmıştır
      reportHTML += `<div style="display:flex; align-items:center; margin-bottom:1rem;">` +
                    `<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />` +
                    `<h2 style="margin:0;">Fenomen Çocuk Kulübü - Ödeme Raporu</h2>` +
                    `</div>`;
      reportHTML += `<h3>${titleText}${rangeDesc ? ' (' + rangeDesc + ')' : ''}</h3>`;
      if (rows.length === 0) {
        reportHTML += `<p>Rapor için kayıt bulunamadı.</p>`;
      } else {
        reportHTML += `<div class="summary">` +
          `<div><strong>Toplam Tutar</strong><span>${totalToplam.toFixed(2)}</span></div>` +
          `<div><strong>Ödenen</strong><span>${totalOdenen.toFixed(2)}</span></div>` +
          `<div><strong>Kalan</strong><span>${totalKalan.toFixed(2)}</span></div>` +
          `<div><strong>Öğrenci Sayısı</strong><span>${rows.length}</span></div>` +
        `</div>`;
        reportHTML += `<table><tr><th>Öğrenci</th><th>Program</th><th>Sınıf/Grup</th><th>Toplam Tutar</th><th>Ödenen</th><th>Kalan</th></tr>`;
        rows.forEach(r => {
          reportHTML += `<tr><td>${r.ogrAd} (${r.ogrNo})</td><td>${r.program}</td><td>${r.sinif}/${r.grup}</td><td>${r.toplam.toFixed(2)}</td><td>${r.odenen.toFixed(2)}</td><td>${r.kalan.toFixed(2)}</td></tr>`;
        });
        reportHTML += `</table>`;
      }
      reportHTML += `<div class="footer">Bu rapor ${new Date().toLocaleString('tr-TR')} tarihinde oluşturuldu.</div>`;
      reportHTML += '</body></html>';
      const newWin = window.open('', '_blank');
      newWin.document.write(reportHTML);
      newWin.document.close();
      newWin.focus();
    });
  }

  /* ========= TAKSIT ÖDEME İŞLEMLERİ ========= */

  // Bu yardımcı fonksiyon, bir taksit ödemesi alındığında gelir/kayitlar
  // tablosuna otomatik bir gelir kaydı ekler. Odeme tutarı ve kısmi olup olmadığı
  // parametre olarak alınır ve kaydedilen kayıt kimliği taksit verisine not edilir.
  async function addGelirForTaksit(ogrId, index, odemeTutari, isKismi) {
    try {
      const db = firebase.database();
      // Öğrenci ve ödeme bilgilerini al
      const [ogrSnap, odemeSnap] = await Promise.all([
        db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
        db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
      ]);
      const ogrBilgi = ogrSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      // Taksit numarasını belirle (index genellikle 0 tabanlı)
      const taksitNo = parseInt(index) + 1;
      const adSoyad = ogrBilgi.adSoyad || "";
      const ogrNo = ogrBilgi.ogrNo || "";
      // Açıklama: öğrenci adı, numarası ve taksit numarası. Kısmi ödemede not düşülür
      const aciklama = `${adSoyad} (${ogrNo}) - ${taksitNo}. taksit${isKismi ? ' (Kısmi Ödeme)' : ''}`;
      // Güncel tarih (saat dilimi farkını hesaba katar)
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const tarihISO = now.toISOString().split("T")[0];
      // Kategorilerde "Taksit" kategorisi yoksa ekle
      const kategoriRef = db.ref("kategoriGelir");
      try {
        const catSnap = await kategoriRef.orderByChild("ad").equalTo("Taksit").once("value");
        if (!catSnap.exists()) {
          await kategoriRef.push({ ad: "Taksit" });
        }
      } catch (err) {
        console.error("Kategori kontrol hatası:", err);
      }

      // Kayıt nesnesi
      const kayit = {
        tip: "gelir",
        tarih: tarihISO,
        kategori: "Taksit",
        odeme: "taksit",
        paraBirimi: odemeBilgi.paraBirimi || "TRY",
        tutar: parseFloat(odemeTutari) || 0,
        aciklama: aciklama,
        eklenmeZamani: new Date().toISOString()
      };
      // Kayıtlar listesine ekle ve anahtarını al
      const kayitRef = await db.ref("kayitlar").push(kayit);
      const kayitId = kayitRef.key;
      // Taksit verisine bu kaydı not et
      const gelirKayitlarRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
      await gelirKayitlarRef.update({ [kayitId]: true });
      return kayitId;
    } catch (e) {
      console.error("Gelir kaydı ekleme hatası:", e);
    }
  }
  // Bu fonksiyon bir taksiti tamamen ödenmiş olarak işaretler ve makbuz seçeneklerini gösterir.
  // odemeMiktari parametresi isteğe bağlıdır; eğer verilirse o tutar gelir kaydı için kullanılır.
  function taksitSetOdendi(ogrId, index, odemeMiktari) {
    // Kaydırma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dön
    window.prevTaksitScrollY = window.scrollY;
    // Son tıklanan kartın id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini güncelleyerek bu karta bağlantıyı kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const taksitRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`);
    taksitRef.once("value").then(snap => {
      const t = snap.val() || {};
      const tutar = parseFloat(t.tutar || 0);
      // Daha önce ödenmiş bir miktar varsa, kalan kısmı hesapla
      const oncekiOdenen = parseFloat(t.odenen || 0);
      let odemeToRecord;
      if (typeof odemeMiktari === "number" && !isNaN(odemeMiktari)) {
        odemeToRecord = odemeMiktari;
      } else {
        odemeToRecord = tutar - oncekiOdenen;
      }
      // odeme bilgilerini güncelle
      taksitRef.update({ odendi: true, odenen: tutar }).then(() => {
        // Ödeme için gelir kaydı ekle (kısmi değil)
        addGelirForTaksit(ogrId, index, odemeToRecord, false);
        // öğrenci bilgilerini al
        Promise.all([
          db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
          db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
        ]).then(([ogrSnap, odemeSnap]) => {
          const ogrBilgi = ogrSnap.val() || {};
          const odemeBilgi = odemeSnap.val() || {};
          // Makbuz seçeneklerini göster
          showMakbuzOptions({
            ogrId: ogrId,
            ogrAd: ogrBilgi.adSoyad || "",
            ogrNo: ogrBilgi.ogrNo || "",
            veliTel: ogrBilgi.velTel || "",
            tutar: tutar,
            odenen: tutar,
            tarih: t.tarih || new Date().toISOString().split("T")[0],
            paraBirimi: odemeBilgi.paraBirimi || "TRY",
            program: ogrBilgi.egitimProgrami || ""
          });
          // Listeleri güncelle
          taksitListele();
          odemeListele();
          // Ödeme alındığında dashboard ve diğer listeleri yenile
          if (typeof loadDashboardData === 'function') {
            loadDashboardData();
          }
          // Gelir/Gider kayıt listesini de anında yenile
          if (typeof kayitlariGetir === 'function') {
            kayitlariGetir();
          }
        });
      });
    });
  }

  // Bu fonksiyon bir taksiti ödenmemiş olarak işaretler (geri alma).
  function taksitSetOdenmedi(ogrId, index) {
    // Kaydırma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dön
    window.prevTaksitScrollY = window.scrollY;
    // Son tıklanan kartın id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini güncelleyerek bu karta bağlantıyı kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const taksitRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`);
    taksitRef.once("value").then(snap => {
      const t = snap.val() || {};
      taksitRef.update({ odendi: false, odenen: 0 }).then(() => {
        // İlgili gelir kayıtlarını sil
        const gelirKeyRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
        gelirKeyRef.once("value").then(kSnap => {
          const keys = kSnap.val();
          if (keys) {
            const promises = [];
            Object.keys(keys).forEach(k => {
              promises.push(db.ref(`kayitlar/${k}`).remove());
            });
            Promise.all(promises).then(() => {
              gelirKeyRef.remove();
            });
          }
        });
        taksitListele();
        odemeListele();
        // Değişiklik sonrası dashboard'ı yenile
        if (typeof loadDashboardData === 'function') {
          loadDashboardData();
        }
        // Kayit listesi de yenilensin
        if (typeof kayitlariGetir === 'function') {
          kayitlariGetir();
        }
      });
    });
  }

  // Kısmi ödemeyi geri alır (ödenen tutarı sıfırlar ve durum ödenmedi olur)
  function taksitKismiGeriAl(ogrId, index) {
    // Kaydırma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dön
    window.prevTaksitScrollY = window.scrollY;
    // Son tıklanan kartın id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini güncelleyerek bu karta bağlantıyı kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).update({
      odenen: 0,
      odendi: false
    }).then(() => {
      // Kısmi ödemelere ait gelir kayıtlarını sil
      const gelirKeyRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
      gelirKeyRef.once("value").then(kSnap => {
        const keys = kSnap.val();
        if (keys) {
          const promises = [];
          Object.keys(keys).forEach(k => {
            promises.push(db.ref(`kayitlar/${k}`).remove());
          });
          Promise.all(promises).then(() => {
            gelirKeyRef.remove();
          });
        }
      });
      taksitListele();
      odemeListele();
      // Kısmi ödeme geri alındıktan sonra dashboard'ı yenile
      if (typeof loadDashboardData === 'function') {
        loadDashboardData();
      }
      // Gelir/Gider kayıt listesini de yenile
      if (typeof kayitlariGetir === 'function') {
        kayitlariGetir();
      }
    });
  }

  // Kısmi ödeme işlemi: kullanıcıdan ödeme tutarı alır ve günceller.
  function taksitKismiOdeme(ogrId, index, toplamTutar, mevcutOdenen) {
    // Kaydırma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dön
    window.prevTaksitScrollY = window.scrollY;
    // Son tıklanan kartın id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini güncelleyerek bu karta bağlantıyı kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const kalan = toplamTutar - mevcutOdenen;
    Swal.fire({
      heightAuto: false,
      title: 'Kısmi Ödeme',
      html: `<p>Kalan tutar: <strong>${kalan.toFixed(2)}</strong></p>`,
      input: 'number',
      inputAttributes: {
        min: 0.01,
        step: '0.01'
      },
      inputLabel: 'Ödeme Tutarı',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'İptal',
      preConfirm: (value) => {
        const v = parseFloat(value);
        if (isNaN(v) || v <= 0) {
          Swal.showValidationMessage('Geçerli bir tutar girin');
        } else if (v > kalan) {
          Swal.showValidationMessage('Tutar kalan değeri aşamaz');
        }
        return v;
      }
    }).then(result => {
      if (!result.isConfirmed) return;
      // Girilen ödeme tutarını değişkene al
      const paymentAmount = parseFloat(result.value);
      const yeniOdenen = mevcutOdenen + paymentAmount;
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once("value").then(snap => {
        const t = snap.val() || {};
        const tutar = parseFloat(t.tutar || 0);
        // Eğer yeni ödeme tüm tutarı karşılıyorsa tam ödeme fonksiyonunu çağır.
        // Son yapılan ödeme tutarı gelir kaydında kullanılmak üzere parametre olarak iletilir
        if (yeniOdenen >= tutar) {
          taksitSetOdendi(ogrId, index, paymentAmount);
          return;
        }
        db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).update({
          odendi: false,
          odenen: yeniOdenen
        }).then(() => {
          // Kısmi ödeme için gelir kaydı ekle
          addGelirForTaksit(ogrId, index, paymentAmount, true);
          // Makbuz seçenekleri için bilgileri al
          Promise.all([
            db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
            db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
          ]).then(([ogrSnap, odemeSnap]) => {
            const ogrBilgi = ogrSnap.val() || {};
            const odemeBilgi = odemeSnap.val() || {};
            showMakbuzOptions({
              ogrId: ogrId,
              ogrAd: ogrBilgi.adSoyad || "",
              ogrNo: ogrBilgi.ogrNo || "",
              veliTel: ogrBilgi.velTel || "",
              tutar: tutar,
              odenen: yeniOdenen,
              tarih: t.tarih || new Date().toISOString().split("T")[0],
              paraBirimi: odemeBilgi.paraBirimi || "TRY",
              program: ogrBilgi.egitimProgrami || ""
            });
            taksitListele();
            odemeListele();
            // Ödeme sonrası dashboard verilerini güncelle
            if (typeof loadDashboardData === 'function') {
              loadDashboardData();
            }
            // Gelir/Gider kayıt listesini de yenile
            if (typeof kayitlariGetir === 'function') {
              kayitlariGetir();
            }
          });
        });
      });
    });
  }

  // Ödeme sonrası makbuz ve WhatsApp seçeneklerini gösteren modal
  async function showMakbuzOptions(detay) {
    // Tüm taksitleri okuyarak toplam kalan borcu ve kalan taksit sayısını hesapla
    let toplamKalan = 0;
    let kalanTaksitSayisi = 0;
    try {
      const snap = await firebase.database().ref(`ogrenciler/${detay.ogrId}/odeme/taksitler`).once("value");
      snap.forEach(child => {
        const t = child.val() || {};
        const tutar = parseFloat(t.tutar || 0);
        const odenen = parseFloat(t.odenen || 0);
        toplamKalan += tutar - odenen;
        // Eğer taksit tamamen ödenmemişse kalan taksit sayısına ekle
        if (odenen < tutar) {
          kalanTaksitSayisi++;
        }
      });
    } catch (e) {
      console.error(e);
    }
    const symbolMap = { "TRY":"₺", "USD":"$", "EUR":"€" };
    const sym = symbolMap[detay.paraBirimi] || "";
    const kalanTaksit = (detay.tutar - detay.odenen).toFixed(2);
    const formatted = `${detay.odenen.toFixed(2)} ${sym}`;
    const kalanToplam = toplamKalan.toFixed(2);
    // hesaplanan toplam kalan ve kalan taksit sayısını detay nesnesine ekle
    detay.totalKalan = parseFloat(kalanToplam);
    detay.kalanTaksitSayisi = kalanTaksitSayisi;
    // Daha profesyonel ve bilgilendirici WhatsApp mesajını hazırla
    let waMsg;
    if (detay.odenen >= detay.tutar) {
      // Tam ödeme yapıldı: taksit kalanı zaten sıfırdır. Mesajda kalan toplam borcu bilgilendirme olarak sunulur
      waMsg =
        `Fenomen Çocuk Kulübü\n\n` +
        `Sayın Veli,\n` +
        `${detay.ogrAd} (${detay.ogrNo}) öğrencimizin ${formatTarih(detay.tarih)} tarihli ödemesi (${formatted}) tarafımıza ulaşmıştır.\n` +
        `Toplam kalan tutar: ${kalanToplam} ${sym}\n\n` +
        `İlginiz için teşekkür eder, sağlıklı ve başarılı günler dileriz.`;
    } else {
      // Kısmi ödeme: hem taksit kalanı hem toplam borç bilgisi yer alır
      waMsg =
        `Fenomen Çocuk Kulübü\n\n` +
        `Sayın Veli,\n` +
        `${detay.ogrAd} (${detay.ogrNo}) öğrencimizin ${formatTarih(detay.tarih)} tarihli taksitine ${formatted} tutarında kısmi ödeme yapılmıştır.\n` +
        `Bu taksitin kalan tutarı: ${kalanTaksit} ${sym}\n` +
        `Toplam kalan tutar: ${kalanToplam} ${sym}\n\n` +
        `İlginiz için teşekkür eder, sağlıklı ve başarılı günler dileriz.`;
    }
    // Modal başlığını belirle
    const title = (detay.odenen >= detay.tutar) ? 'Ödeme Kaydedildi' : 'Kısmi Ödeme Kaydedildi';
    // İçerik: kalan taksit ve toplam/ödenecek bilgisi. 
    // Başlık satırları kullanıcıya ödeme detaylarını özetler.
    let htmlContent = `
        <p><strong>${detay.ogrAd} (${detay.ogrNo})</strong> için ${formatted} ödeme kaydedildi.</p>
        <p>Tarih: <strong>${formatTarih(detay.tarih)}</strong></p>
        <p>Taksit Kalanı: <strong>${kalanTaksit} ${sym}</strong></p>
        <p>Toplam Kalan Tutar: <strong>${kalanToplam} ${sym}</strong></p>
        <div style="margin-top:1rem; display:flex; gap:0.5rem; justify-content:center;">
          <button id="printReceiptBtn" class="swal2-confirm swal2-styled" style="background:#28a745;">Makbuz Çıktısı</button>
          <button id="whatsAppBtn" class="swal2-confirm swal2-styled" style="background:#25D366;">WhatsApp</button>
        </div>
      `;
    // Eğer tam ödeme ise taksit kalanını sıfır olarak göster, ancak yine de bilgilendirme satırında yazdır
    Swal.fire({
      title: title,
      html: htmlContent,
      showConfirmButton: false,
      showCloseButton: true,
      didOpen: () => {
        const printBtn = document.getElementById('printReceiptBtn');
        const waBtn = document.getElementById('whatsAppBtn');
        // Makbuzu yazdırma butonu
        printBtn.addEventListener('click', () => {
          const receiptHTML = generateMakbuzHTML(detay);
          // Yeni pencere açıp makbuzu göster, otomatik yazdırma yerine kullanıcıya bırak
          const win = window.open('', '_blank');
          win.document.write(receiptHTML);
          win.document.close();
          win.focus();
        });
        // WhatsApp butonu: mesajı gönder
        waBtn.addEventListener('click', () => {
          sendWhatsappReceipt(waMsg, detay.veliTel);
        });
      },
      // Modal kapanırken kaydırma konumunu koru
      willClose: () => {
        try {
          // Kayıtlı scroll pozisyonu varsa geri dön
          if (typeof window.prevTaksitScrollY !== 'undefined') {
            const y = window.prevTaksitScrollY;
            // birkaç deneme ile scroll'u geri getir
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 0);
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 300);
            window.prevTaksitScrollY = undefined;
          }
          // Son tıklanan kart id'sine scroll
          if (window.lastTaksitCardId) {
            const target = document.getElementById(window.lastTaksitCardId);
            window.lastTaksitCardId = undefined;
            if (target) {
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 0);
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 300);
            }
          }
        } catch (e) {
          console.error(e);
        }
      },
      heightAuto: false,
      didClose: () => {
        // Bazı tarayıcılarda modal tamamen kapatıldıktan sonra scroll sıfırlanabilir;
        // bu nedenle aynı işlemi burada da tekrarla
        try {
          if (typeof window.prevTaksitScrollY !== 'undefined') {
            const y = window.prevTaksitScrollY;
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 0);
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 300);
            window.prevTaksitScrollY = undefined;
          }
          if (window.lastTaksitCardId) {
            const target = document.getElementById(window.lastTaksitCardId);
            window.lastTaksitCardId = undefined;
            if (target) {
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 0);
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 300);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }
    });
  }

// 📄 Şablon rehberi modalını açar
function gosterSablonModal() {
  const modal = document.getElementById('sablonModal');
  if (modal) {
    modal.style.display = 'block';
  }
}

// 📄 Şablon rehberi modalını kapatır
function kapatSablonModal(evt) {
  // Eğer bir etkinlik gönderilmişse, üstteki olayı durdur
  if (evt) evt.stopPropagation();
  const modal = document.getElementById('sablonModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// DOM yüklendiğinde şablon modalındaki çarpı düğmesine kapatma davranışı bağlanır
document.addEventListener('DOMContentLoaded', () => {
  const sablonModal = document.getElementById('sablonModal');
  if (sablonModal) {
    const closeBtn = sablonModal.querySelector('.close');
    if (closeBtn) {
      // Daha güvenilir kapatma için addEventListener kullanılıyor
      closeBtn.addEventListener('click', () => {
        sablonModal.style.display = 'none';
      });
    }
  }
});

  // Makbuz HTML içeriği oluşturur (A4 formatında basit bir dizayn)
  function generateMakbuzHTML(detay) {
    const symbolMap = { "TRY":"₺", "USD":"$", "EUR":"€" };
    const sym = symbolMap[detay.paraBirimi] || "";
    const formatted = `${detay.odenen.toFixed(2)} ${sym}`;
    const kalanInstalment = (detay.tutar - detay.odenen).toFixed(2);
    const totalKalan = (typeof detay.totalKalan !== 'undefined') ? detay.totalKalan.toFixed(2) : '';
    const kalanTaksitSayisi = (typeof detay.kalanTaksitSayisi !== 'undefined') ? detay.kalanTaksitSayisi : '';
    return `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Makbuz</title>
        <style>
          body { font-family: Arial, sans-serif; padding:40px; }
          h2 { text-align:center; margin-bottom:20px; }
          table { width:100%; border-collapse: collapse; margin-top:20px; }
          td { padding:8px; vertical-align: top; }
          .footer { margin-top:40px; text-align:center; font-size:12px; color:#666; }
        </style>
      </head>
      <body>
        <!-- Makbuz başlığında kulüp logosu gösterilir -->
        <div style="display:flex; align-items:center; margin-bottom:20px;">
          <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />
          <h2 style="margin:0;">Fenomen Çocuk Kulübü - Ödeme Makbuzu</h2>
        </div>
        <table>
          <tr>
            <td><strong>Öğrenci:</strong></td><td>${detay.ogrAd} (${detay.ogrNo})</td>
          </tr>
          <tr>
            <td><strong>Program:</strong></td><td>${detay.program}</td>
          </tr>
          <tr>
            <td><strong>Tarih:</strong></td><td>${formatTarih(detay.tarih)}</td>
          </tr>
          <tr>
            <td><strong>Ödenen Tutar:</strong></td><td>${formatted}</td>
          </tr>
          <tr>
            <td><strong>Taksit Kalanı:</strong></td><td>${kalanInstalment} ${sym}</td>
          </tr>
          <tr>
            <td><strong>Toplam Kalan Tutar:</strong></td><td>${totalKalan} ${sym}</td>
          </tr>
          <tr>
            <td><strong>Kalan Taksit Sayısı:</strong></td><td>${kalanTaksitSayisi}</td>
          </tr>
        </table>
        <div class="footer">
          Bu makbuz Fenomen Çocuk Kulübü tarafından ${new Date().toLocaleDateString("tr-TR")} tarihinde oluşturulmuştur.
        </div>
      </body>
    </html>
    `;
  }

  // Yeni pencere açarak makbuzu yazdırır
  function printMakbuz(html) {
    const newWin = window.open("", "_blank");
    newWin.document.write(html);
    newWin.document.close();
    // baskıyı tetikle
    newWin.focus();
    newWin.print();
    newWin.close();
  }

  // WhatsApp mesajı gönderme fonksiyonu
  function sendWhatsappReceipt(message, phone) {
    // Telefon numarası varsa linki ona göre hazırla; yoksa genel link
    let url = "https://wa.me/";
    if (phone) {
      // Türkiye formatında telefon numarasından non-digit karakterleri çıkar
      const digits = phone.replace(/\D/g, "");
      // Eğer başta sıfır varsa kaldır ve +90 ekle
      let normalized = digits;
      if (normalized.startsWith("0")) normalized = normalized.substring(1);
      if (!normalized.startsWith("90")) normalized = "90" + normalized;
      url += normalized;
    }
    url += "?text=" + encodeURIComponent(message);
    window.open(url, "_blank");
  }

  // Vadesi geçmiş taksitler için hatırlatma mesajı
  function sendOverdueReminder(ogrId, index) {
    const db = firebase.database();
    Promise.all([
      db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once("value"),
      db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
    ]).then(([ogrSnap, tSnap, odemeSnap]) => {
      const ogrBilgi = ogrSnap.val() || {};
      const t = tSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      const symbolMap = { "TRY":"₺","USD":"$","EUR":"€" };
      const sym = symbolMap[odemeBilgi.paraBirimi || "TRY"] || "";
      const kalan = (parseFloat(t.tutar || 0) - parseFloat(t.odenen || 0)).toFixed(2);
      const msg = `Fenomen Çocuk Kulübü\n\n` +
        `Değerli Veli,\n` +
        `${ogrBilgi.adSoyad || ""} (${ogrBilgi.ogrNo || ""}) öğrencimizin ${formatTarih(t.tarih)} tarihli ${kalan} ${sym} tutarındaki ödemesi vadesini geçmiştir. ` +
        `Lütfen en kısa sürede ödemenizi gerçekleştirmenizi rica ederiz.\n` +
        `Fenomen Çocuk Kulübü`;
      sendWhatsappReceipt(msg, ogrBilgi.velTel || "");
    });
  }

  /* ========= TOPLU ÖĞRENCİ İŞLEMLERİ ========= */
  // Öğrenci listesini CSV olarak dışa aktar
  function excelDisariAktar() {
    // Öğrenci listesini Excel formatında dışa aktar. Filtrelenmiş sonuçlar varsa onları kullan, yoksa tüm listeyi getir.
    const ogrList = window.filteredOgrenciler;
    const promise = ogrList && Array.isArray(ogrList) ? Promise.resolve(ogrList) : firebase.database().ref("ogrenciler").once("value").then(snap => {
      const data = snap.val() || {};
      return Object.entries(data).map(([id, d]) => ({ id, ...d }));
    });
    promise.then(list => {
      if (!list || list.length === 0) {
        Swal.fire('Uyarı', 'Aktarılacak öğrenci bulunamadı.', 'warning');
        return;
      }

  // Excel şablon dosyasını indir
  function indirExcelSablon() {
    const link = document.createElement('a');
    link.href = 'ogrenci_sablon.xlsx';
    link.download = 'ogrenci_sablon.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
      // Excel çalışma kitabı oluştur
      const wb = XLSX.utils.book_new();
      const rows = [];
      // Başlık satırı
      rows.push(["Öğrenci ID", "Ad Soyad", "Öğrenci No", "Sınıf", "Grup", "Program", "Toplam Tutar", "Ödenen"]);
      list.forEach(item => {
        const info = item.ogrenci || {};
        const odeme = item.odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenenTop = 0;
        Object.keys(taksitler).forEach(k => {
          const t = taksitler[k];
          toplam += parseFloat(t.tutar || 0);
          if (t.odendi) {
            odenenTop += parseFloat(t.tutar || 0);
          } else if (t.odenen) {
            odenenTop += parseFloat(t.odenen || 0);
          }
        });
        rows.push([
          item.id,
          info.adSoyad || "",
          info.ogrNo || "",
          info.sinif || "",
          info.grup || "",
          info.egitimProgrami || "",
          toplam.toFixed(2),
          odenenTop.toFixed(2)
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      // Stil: başlık satırı için arka plan rengi ve kalın font (şu an basit)
      // ExcelJS kullanılmadığı için sınırlı stil; ancak bold uygulanabilir.
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell = ws[XLSX.utils.encode_cell({ r:0, c:C })];
        if (cell) {
          cell.s = {
            fill: { fgColor: { rgb: "FFF3E0" } },
            font: { bold: true, color: { rgb: "BF360C" } },
            alignment: { horizontal: "center" }
          };
        }
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Öğrenciler');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ogrenci_listesi.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  // Toplu öğrenci yükleme modalı
  function acTopluYukleModal() {
    Swal.fire({
      title: 'Excel Dosyası Yükle',
      html: '<input type="file" id="excelFileInput" accept=".xlsx" />',
      showCancelButton: true,
      confirmButtonText: 'Yükle',
      cancelButtonText: 'İptal',
      preConfirm: () => {
        const fileInput = document.getElementById('excelFileInput');
        if (!fileInput.files || fileInput.files.length === 0) {
          Swal.showValidationMessage('Lütfen bir Excel (.xlsx) dosyası seçin');
        }
        return fileInput.files[0];
      }
    }).then(res => {
      if (!res.isConfirmed) return;
      const file = res.value;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        try {
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          topluOgrenciYukleExcel(json);
        } catch (error) {
          console.error('Excel dosyası işlenirken hata oluştu', error);
          Swal.fire('Hata', 'Dosya okunurken hata oluştu. Lütfen geçerli bir Excel dosyası seçin.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });
  }

  // CSV'den öğrencileri ekle
  function topluOgrenciYukle(csvText) {
    const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
    // İlk satır başlık olabilir, onu atla
    let startIndex = 0;
    if (lines[0] && (lines[0].toLowerCase().includes("ad") || lines[0].toLowerCase().includes("ogrno"))) {
      startIndex = 1;
    }

  // Excel veri dizisinden öğrencileri ekle
  function topluOgrenciYukleExcel(rows) {
    if (!rows || rows.length === 0) {
      Swal.fire('Uyarı', 'Yüklenecek veri bulunamadı.', 'warning');
      return;
    }
    const updates = {};
    rows.forEach(row => {
      // Satırda gereken alanlar: Ad Soyad, Öğrenci No, Veli Telefon, Sınıf, Grup, Program, Toplam Tutar, Taksit Sayısı
      const adSoyad = (row['Ad Soyad'] || '').toString().trim();
      const ogrNo = (row['Öğrenci No'] || '').toString().trim();
      const veliTel = (row['Veli Telefon'] || '').toString().trim();
      const sinif = (row['Sınıf'] || '').toString().trim();
      const grup = (row['Grup'] || '').toString().trim();
      const program = (row['Program'] || '').toString().trim();
      const toplamTutar = parseFloat(row['Toplam Tutar'] || 0) || 0;
      const taksitSayisi = parseInt(row['Taksit Sayısı'] || 0) || 0;
      if (!adSoyad || !ogrNo) return; // temel alanlar
      const newKey = firebase.database().ref().child('ogrenciler').push().key;
      updates[`ogrenciler/${newKey}/ogrenci`] = {
        adSoyad: adSoyad,
        ogrNo: ogrNo,
        velTel: veliTel,
        egitimProgrami: program,
        sinif: sinif,
        grup: grup
      };
      // odeme ve taksitler
      const taksitler = {};
      const taksitTutar = taksitSayisi > 0 ? (toplamTutar / taksitSayisi) : 0;
      for (let i = 0; i < taksitSayisi; i++) {
        // Taksit tarihlerini boş bırak; kullanıcı daha sonra düzenlesin
        taksitler[i] = { tutar: taksitTutar, tarih: '', odenen: 0, odendi: false };
      }
      updates[`ogrenciler/${newKey}/odeme`] = {
        paraBirimi: 'TRY',
        toplamTutar: toplamTutar,
        taksitler: taksitler
      };
    });
    firebase.database().ref().update(updates).then(() => {
      Swal.fire('Başarılı', 'Öğrenciler yüklendi.', 'success');
      ogrListele();
    }).catch(err => {
      console.error(err);
      Swal.fire('Hata', 'Öğrenciler yüklenirken bir hata oluştu.', 'error');
    });
  }
    const updates = {};
    lines.slice(startIndex).forEach(line => {
      const parts = line.split(",");
      if (parts.length < 3) return;
      const adSoyad = parts[0].replace(/^\"|\"$/g, "").trim();
      const ogrNo = parts[1].trim();
      const velTel = parts[2].trim();
      const newKey = firebase.database().ref().child('ogrenciler').push().key;
      updates[`ogrenciler/${newKey}/ogrenci`] = {
        adSoyad: adSoyad,
        ogrNo: ogrNo,
        velTel: velTel,
        egitimProgrami: "",
        sinif: "",
        grup: ""
      };
      updates[`ogrenciler/${newKey}/odeme`] = {
        paraBirimi: "TRY",
        toplamTutar: 0,
        taksitler: {}
      };
    });
    firebase.database().ref().update(updates).then(() => {
      Swal.fire('Başarılı', 'Öğrenciler yüklendi.', 'success');
      ogrListele();
    }).catch(err => {
      console.error(err);
      Swal.fire('Hata', 'Öğrenciler yüklenemedi.', 'error');
    });
  }
function topluOgrenciYukleExcel(jsonData) {
    if (!Array.isArray(jsonData) || jsonData.length === 0) {
        alert("Excel dosyasında geçerli öğrenci verisi bulunamadı.");
        return;
    }

    let yuklenen = 0;
    let basarisiz = 0;

    jsonData.forEach((item, index) => {
        const toplamTutar = parseFloat(item["Toplam Tutar"] || 0);
        const taksitSayisi = parseInt(item["Taksit Sayısı"] || 1);
        const ilkTaksitTarihi = new Date(item["İlk Taksit Tarihi"]);
        const taksitTutari = Math.floor(toplamTutar / taksitSayisi);

        const taksitler = [];
        for (let i = 0; i < taksitSayisi; i++) {
            const tarih = new Date(ilkTaksitTarihi);
            tarih.setMonth(tarih.getMonth() + i);
            taksitler.push({
                tarih: tarih.toISOString().split("T")[0], // yyyy-mm-dd
                tutar: taksitTutari,
                odenen: 0,
                odendi: false
            });
        }

        const payload = {
            guncellenmeZamani: new Date().toISOString(),
            ogrenci: {
                adSoyad: item["Ad Soyad"],
                dogumTarihi: formatTarih(item["Doğum Tarihi"]),
                tc: item["TC Kimlik No"],
                ogrNo: item["Öğrenci Numarası"],
                sinif: item["Sınıf"],
                grup: item["Grup"],
                okul: item["Okul Adı"],
                egitimProgrami: item["Eğitim Programı"],
                kayitTarihi: formatTarih(item["Kayıt Tarihi"]),
                islemTarihi: new Date().toISOString().split("T")[0]
            },
            veli: {
                adSoyad: item["Veli Ad Soyad"],
                telefon1: item["Veli Telefon 1"],
                telefon2: item["Veli Telefon 2"]
            },
            odeme: {
                toplamTutar: toplamTutar,
                paraBirimi: item["Para Birimi"],
                taksitler: taksitler
            }
        };

        firebase.database().ref("ogrenciler").push(payload)
            .then(() => {
                yuklenen++;
                if (yuklenen + basarisiz === jsonData.length) {
                    alert(`✔ Toplam Yükleme Tamamlandı\nBaşarılı: ${yuklenen}\nHatalı: ${basarisiz}`);
                }
            })
            .catch((err) => {
                console.error(`❌ Satır ${index + 2} yüklenemedi`, err);
                basarisiz++;
                if (yuklenen + basarisiz === jsonData.length) {
                    alert(`✔ Toplam Yükleme Tamamlandı\nBaşarılı: ${yuklenen}\nHatalı: ${basarisiz}`);
                }
            });
    });

    function formatTarih(tarihStr) {
        const [gun, ay, yil] = tarihStr.split(".");
        return `${yil}-${ay.padStart(2, "0")}-${gun.padStart(2, "0")}`;
    }
}



  // Toplu silme işlemi
  function acTopluSilModal() {
    // Filtrelenmiş öğrencileri kullan, yoksa önce listeleyin
    const list = window.filteredOgrenciler && Array.isArray(window.filteredOgrenciler)
      ? window.filteredOgrenciler
      : [];
    if (!list || list.length === 0) {
      Swal.fire('Uyarı', 'Silinecek öğrenci bulunamadı. Lütfen önce listeleyin veya filtreleyin.', 'warning');
      return;
    }
    // Hazırlanacak modal içeriği ve arama filtreli liste oluşturma
    Swal.fire({
      title: 'Toplu Silme',
      html: `
        <input id="sil-search" class="swal2-input" placeholder="Öğrenci ara (ad veya no)">
        <div id="sil-list" style="max-height:300px; overflow:auto; text-align:left; margin-top:0.5rem;"></div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Seçilenleri Sil',
      cancelButtonText: 'İptal',
      didOpen: () => {
        const listContainer = document.getElementById('sil-list');
        function renderList(filter = '') {
          const filtLower = filter.toLowerCase();
          listContainer.innerHTML = list
            .filter(item => {
              const ad = (item.ogrenci?.adSoyad || '').toLowerCase();
              const no = (item.ogrenci?.ogrNo || '').toLowerCase();
              return ad.includes(filtLower) || no.includes(filtLower);
            })
            .map(item => {
              const ad = item.ogrenci?.adSoyad || '-';
              const no = item.ogrenci?.ogrNo || '-';
              return `<label style="display:flex; align-items:center; margin:4px 0;">
                <input type="checkbox" value="${item.id}" style="margin-right:8px;"> ${ad} (${no})
              </label>`;
            })
            .join('');
        }
        renderList();
        const searchInput = document.getElementById('sil-search');
        searchInput.addEventListener('input', (e) => {
          renderList(e.target.value);
        });
      },
      preConfirm: () => {
        const checkboxes = document.querySelectorAll('#sil-list input[type=checkbox]:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);
        if (ids.length === 0) {
          Swal.showValidationMessage('Lütfen silinecek öğrencileri seçin');
        }
        return ids;
      }
    }).then(res => {
      if (!res.isConfirmed) return;
      const selectedIds = res.value || [];
      if (selectedIds.length === 0) return;
      // Kesin onay için ikinci bir modal
      Swal.fire({
        title: 'Emin misiniz?',
        text: `${selectedIds.length} öğrenciyi silmek üzeresiniz. Bu işlem geri alınamaz.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, sil',
        cancelButtonText: 'İptal'
      }).then(res2 => {
        if (!res2.isConfirmed) return;
        const updates = {};
        selectedIds.forEach(id => {
          updates[`ogrenciler/${id}`] = null;
        });
        firebase.database().ref().update(updates).then(() => {
          Swal.fire('Silindi', 'Seçilen öğrenciler silindi.', 'success');
          ogrListele();
          taksitListele();
          odemeListele();
        }).catch(err => {
          console.error(err);
          Swal.fire('Hata', 'Öğrenciler silinirken hata oluştu.', 'error');
        });
      });
    });
  }

  /* ========= YAZDIRMA VE RAPORLAMA ========= */
  // Yazdırma ve raporlama butonları için basit fonksiyonlar
  function taksitYazdir() {
    window.print();
  }
  function odemeYazdir() {
    window.print();
  }
  // taksitRaporla ve odemeRaporla fonksiyonları yukarıda tanımlandı

  /**
   * Taksit veya kısmi ödeme yapıldıktan sonra makbuz bilgilerini tekrar
   * görüntülemek veya WhatsApp mesajı oluşturmak için çağrılır. Bu fonksiyon
   * ilgili taksit kaydını ve öğrenci/ödeme bilgilerini okur ve showMakbuzOptions
   * fonksiyonunu yeniden tetikler. Böylece liste üzerindeki “Makbuz” butonları
   * aracılığıyla da ödeme makbuzu ve WhatsApp mesajı alınabilir.
   *
   * @param {string} ogrId  Öğrenci kayıt ID’si
   * @param {string} index  Taksit dizin anahtarı
   */
  function viewMakbuz(ogrId, index) {
    const db = firebase.database();
    Promise.all([
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once('value'),
      db.ref(`ogrenciler/${ogrId}/ogrenci`).once('value'),
      db.ref(`ogrenciler/${ogrId}/odeme`).once('value')
    ]).then(([tSnap, ogrSnap, odemeSnap]) => {
      const t = tSnap.val() || {};
      const ogrBilgi = ogrSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      const tutar = parseFloat(t.tutar || 0);
      const odenen = parseFloat(t.odenen || 0);
      showMakbuzOptions({
        ogrId: ogrId,
        ogrAd: ogrBilgi.adSoyad || '',
        ogrNo: ogrBilgi.ogrNo || '',
        veliTel: ogrBilgi.velTel || '',
        tutar: tutar,
        odenen: odenen,
        tarih: t.tarih || new Date().toISOString().split('T')[0],
        paraBirimi: odemeBilgi.paraBirimi || 'TRY',
        program: ogrBilgi.egitimProgrami || ''
      });
    });
  }

  /* ====== DASHBOARD ====== */
  // Chart instances (global) for destroying if re-rendered
  let monthlyChartObj = null;
  let statusChartObj = null;

  function loadDashboardData() {
    const dashStudent = document.getElementById('dashStudentCount');
    const dashDue = document.getElementById('dashTotalDue');
    const dashPaid = document.getElementById('dashTotalPaid');
    const dashRemaining = document.getElementById('dashTotalRemaining');
    const dashOverdue = document.getElementById('dashTotalOverdue');
    const dashPartial = document.getElementById('dashTotalPartial');
    // Clear old values
    dashStudent.textContent = '-';
    dashDue.textContent = '-';
    dashPaid.textContent = '-';
    dashRemaining.textContent = '-';
    dashOverdue.textContent = '-';
    dashPartial.textContent = '-';
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      let totalStudents = 0;
      // Toplam tutar tüm taksitlerin toplamı, ancak bugün beklenen alacak için ayrı hesap yapılacak
      let totalDue = 0;
      let totalPaid = 0;
      let totalOverdue = 0;
      let partialCount = 0;
      // Bugün ödemesi beklenen tutar (vadesi bugüne denk gelen ve henüz tam ödenmemiş taksitlerin kalan tutarı)
      let expectedToday = 0;
      // 12 ay için arrays
      const dueMonthly = new Array(12).fill(0);
      const paidMonthly = new Array(12).fill(0);
      const statusCounts = { tam: 0, kismi: 0, odenmemis: 0 };
      const today = new Date();
      Object.values(data).forEach(item => {
        totalStudents++;
        const taksitler = item.odeme?.taksitler || {};
        Object.values(taksitler).forEach(t => {
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          totalDue += tutar;
          if (t.odendi) totalPaid += tutar; else totalPaid += odenen;
          let durum;
          if (t.odendi || odenen >= tutar) durum = 'tam';
          else if (odenen > 0) durum = 'kismi';
          else durum = 'odenmemis';
          statusCounts[durum]++;
          const tarihStr = t.tarih;
          const date = tarihStr ? new Date(tarihStr) : null;
            if (date && !isNaN(date)) {
              const month = date.getMonth();
              // Aylık tutar dağılımı için toplam ve ödenen tutarları kaydet
              dueMonthly[month] += tutar;
              if (t.odendi) paidMonthly[month] += tutar; else paidMonthly[month] += odenen;
              // Vadesi geçmiş taksit sayısını hesapla
              if (date < today && !t.odendi) {
                totalOverdue++;
                if (odenen > 0 && odenen < tutar) {
                  partialCount++;
                }
              }
              // Bugün vadesi olan ve henüz tam olarak ödenmemiş taksitlerin kalan tutarını ekle
              const todayDate = new Date(today);
              todayDate.setHours(0,0,0,0);
              const dateOnly = new Date(date);
              dateOnly.setHours(0,0,0,0);
              if (dateOnly.getTime() === todayDate.getTime()) {
                const remaining = tutar - odenen;
                // Taksit henüz tamamı ödenmemişse, kalan tutarı beklenen alacağa ekle
                if (!t.odendi && remaining > 0) {
                  expectedToday += remaining;
                }
              }
            }
        });
      });
      const totalRemaining = totalDue - totalPaid;
      // Güncelle
      dashStudent.textContent = totalStudents;
      // 'Toplam Tutar' yerine bugünün beklenen alacak miktarını göster
      dashDue.textContent = expectedToday.toFixed(2);
      dashPaid.textContent = totalPaid.toFixed(2);
      dashRemaining.textContent = totalRemaining.toFixed(2);
      dashOverdue.textContent = totalOverdue;
      dashPartial.textContent = partialCount;
      // Chartler kaldırıldı; bunun yerine dashboard listeleri doldurulur
      // Son 5 kayıtlı öğrenci, son 10 gelir/gider kaydı ve vadesi geçmiş öğrenciler listesi
      fetchLastStudents();
      fetchLastRecords();
      fetchOverdueStudents();
      fetchUpcomingPayments();
    });
  }

  /* ====== Dashboard Listeleri ====== */
  // Son 5 kayıtlı öğrenci listesini getirir ve dashboard'a ekler
  function fetchLastStudents() {
    const listEl = document.getElementById('lastStudentsList');
    if (!listEl) return;
    // Verileri oku
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const students = Object.values(data).map(item => {
        const ogr = item.ogrenci || {};
        const tarihStr = ogr.kayitTarihi || ogr.islemTarihi || '';
        const tarih = tarihStr ? new Date(tarihStr) : null;
        return {
          name: ogr.adSoyad || '-',
          date: tarih
        };
      });
      // Tarihe göre sırala (en yeni önce)
      students.sort((a,b) => {
        const da = a.date && !isNaN(a.date) ? a.date.getTime() : 0;
        const db = b.date && !isNaN(b.date) ? b.date.getTime() : 0;
        return db - da;
      });
      const last = students.slice(0, 5);
      if (last.length === 0) {
        listEl.innerHTML = '<p>Kayıt bulunamadı.</p>';
        return;
      }
      listEl.innerHTML = last.map(st => {
        const dateStr = st.date && !isNaN(st.date) ? st.date.toLocaleDateString('tr-TR') : '';
        // 👤 Öğrenci satırı başında emoji ile göster
        return `<p>👤 ${st.name}${dateStr ? ' - ' + dateStr : ''}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yüklenemedi.</p>';
      console.error(err);
    });
  }

  // Son 10 gelir/gider kaydını getirir ve dashboard'a ekler
  function fetchLastRecords() {
    const listEl = document.getElementById('lastRecordsList');
    if (!listEl) return;
    firebase.database().ref('kayitlar').once('value').then(snap => {
      const data = snap.val() || {};
      const records = Object.values(data).map(item => {
        const tarih = item.tarih ? new Date(item.tarih) : null;
        return {
          date: tarih,
          type: item.tip || '',
          amount: parseFloat(item.tutar || 0),
          currency: (item.paraBirimi || '').toUpperCase(),
          category: item.kategori || '',
          description: item.aciklama || '',
          payment: item.odeme || ''
        };
      });
      // Sıralama (en yeni önce)
      records.sort((a,b) => {
        const da = a.date && !isNaN(a.date) ? a.date.getTime() : 0;
        const db = b.date && !isNaN(b.date) ? b.date.getTime() : 0;
        return db - da;
      });
      const last = records.slice(0, 10);
      if (last.length === 0) {
        listEl.innerHTML = '<p>Kayıt bulunamadı.</p>';
        return;
      }
      listEl.innerHTML = last.map(r => {
        const dateStr = r.date && !isNaN(r.date) ? r.date.toLocaleDateString('tr-TR') : '';
        const amountStr = `${r.amount.toFixed(2)} ${r.currency}`;
        const typeStr = r.type ? (r.type.charAt(0).toUpperCase() + r.type.slice(1)) : '';
        const catStr = r.category ? (r.category.charAt(0).toUpperCase() + r.category.slice(1)) : '';
        const descStr = r.description ? r.description : '';
        // Birleştirme: Tarih - Tür - Tutar - Kategori - Açıklama
        let line = `${dateStr} - ${typeStr} - ${amountStr}`;
        if (catStr) line += ` - ${catStr}`;
        if (descStr) line += ` - ${descStr}`;
        // Kayıt türüne göre emoji seçimi: gelir → para, gider → çıkış, diğer → doküman
        let emoji;
        if (r.type && r.type.toLowerCase() === 'gelir') {
          emoji = '💵';
        } else if (r.type && r.type.toLowerCase() === 'gider') {
          emoji = '💸';
        } else {
          emoji = '📄';
        }
        return `<p>${emoji} ${line}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yüklenemedi.</p>';
      console.error(err);
    });
  }

  // Vadesi geçmiş öğrencileri getirir ve dashboard'a ekler
  function fetchOverdueStudents() {
    const listEl = document.getElementById('overdueStudentsList');
    if (!listEl) return;
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const today = new Date();
      const overdueItems = [];
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const veli = item.veli || {};
        const taksitler = item.odeme?.taksitler || {};
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          const odendi = t.odendi;
          if (date && !isNaN(date) && date < today && !odendi && kalan > 0) {
            overdueItems.push({
              name: ogr.adSoyad || '-',
              ogrNo: ogr.ogrNo || '',
              veli: veli.adSoyad || '',
              taksitNo: parseInt(idx) + 1,
              date: date,
              due: kalan
            });
          }
        });
      });
      // Tarihe göre ve tutara göre sıralama: en erken vade önce
      overdueItems.sort((a,b) => a.date - b.date || b.due - a.due);
      if (overdueItems.length === 0) {
        listEl.innerHTML = '<p>Ödenmesi geçmiş taksit yok.</p>';
        return;
      }
      listEl.innerHTML = overdueItems.map(o => {
        const dateStr = o.date.toLocaleDateString('tr-TR');
        const nameStr = `${o.name}${o.ogrNo ? ' (' + o.ogrNo + ')' : ''}`;
        const veliStr = o.veli ? o.veli : '';
        const dueStr = '₺' + o.due.toFixed(2);
        // ⌛ Vadesi geçmiş satırların başına emoji ekle
        return `<p>⌛ ${nameStr} - ${o.taksitNo}. taksit - Veli: ${veliStr} - Vade: ${dateStr} - ${dueStr}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yüklenemedi.</p>';
      console.error(err);
    });
  }

  // Yaklaşan vade: bugünden itibaren 7 gün içinde vadesi gelecek taksitleri listeler
  function fetchUpcomingPayments() {
    const listEl = document.getElementById('upcomingPaymentsList');
    if (!listEl) return;
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const today = new Date();
      // Sadece tarih kısmını dikkate alarak bugünün saatini sıfırlayın
      today.setHours(0,0,0,0);
      const futureDate = new Date(today);
      futureDate.setDate(today.getDate() + 7);
      const upcomingItems = [];
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const veli = item.veli || {};
        const taksitler = item.odeme?.taksitler || {};
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          const odendi = t.odendi;
          if (date && !isNaN(date)) {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            if (d >= today && d <= futureDate && !odendi && kalan > 0) {
              upcomingItems.push({
                name: ogr.adSoyad || '-',
                ogrNo: ogr.ogrNo || '',
                veli: veli.adSoyad || '',
                taksitNo: parseInt(idx) + 1,
                date: d,
                due: kalan
              });
            }
          }
        });
      });
      upcomingItems.sort((a,b) => a.date - b.date || b.due - a.due);
      if (upcomingItems.length === 0) {
        listEl.innerHTML = '<p>Yaklaşan ödeme yok.</p>';
        return;
      }
      listEl.innerHTML = upcomingItems.map(o => {
        const dateStr = o.date.toLocaleDateString('tr-TR');
        const nameStr = `${o.name}${o.ogrNo ? ' (' + o.ogrNo + ')' : ''}`;
        const veliStr = o.veli ? o.veli : '';
        const dueStr = '₺' + o.due.toFixed(2);
        // 📅 Yaklaşan ödemelerin başına emoji ekle
        return `<p>📅 ${dateStr} - ${nameStr} - ${o.taksitNo}. taksit - Veli: ${veliStr} - ${dueStr}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yüklenemedi.</p>';
      console.error(err);
    });
  }

// 📊 Raporlar modülünün basit rapor oluşturma fonksiyonu
function raporlarOlustur() {
  const tur = document.getElementById('raporlar-tur')?.value || '';
  const baslangic = document.getElementById('raporlar-start-date')?.value || '';
  const bitis = document.getElementById('raporlar-end-date')?.value || '';
  const sinif = document.getElementById('raporlar-sinif')?.value || '';
  const grup = document.getElementById('raporlar-grup')?.value || '';
  const program = document.getElementById('raporlar-program')?.value || '';
  // Rapor türüne göre ilgili fonksiyona yönlendir
  if (tur === 'finans') {
    generateFinansRaporu(baslangic, bitis, sinif, grup, program);
  } else if (tur === 'ogrenci') {
    // Öğrenci raporu
    generateOgrenciRaporu(baslangic, bitis, sinif, grup, program);
  } else if (tur === 'taksit') {
    // Taksit durumu raporu
    generateTaksitRaporu(baslangic, bitis, sinif, grup, program);
  } else {
    // Desteklenmeyen rapor türü
    const sonucEl = document.getElementById('raporlarSonuc');
    sonucEl.innerHTML = '<p>Bu rapor türü için geliştirme yapılacaktır.</p>';
    // Desteklenmeyen rapor türü için baslık ve logo eklenerek kullanıcıya bilgi verilir
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Çocuk Kulübü</h2>' +
      '<p style="margin:0;">Seçilen rapor türü: ' + tur + ' henüz desteklenmiyor.</p>' +
      '</div>' +
      '</div>';
  }
}

// Finansal rapor üretimi – aylık özet (gelir/gider)
function generateFinansRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>Yükleniyor...</p>';
  firebase.database().ref('kayitlar').once('value', snap => {
    const data = snap.val();
    const summary = {};
    if (data) {
      Object.values(data).forEach(k => {
        const tarih = k.tarih;
        if (!tarih) return;
        const dateObj = new Date(tarih);
        if (startDate) {
          const sd = new Date(startDate);
          if (dateObj < sd) return;
        }
        if (endDate) {
          const ed = new Date(endDate);
          // son günün saat farklılığı nedeniyle ertesi güne kaymaması için gün sonu olarak ayarla
          ed.setHours(23,59,59,999);
          if (dateObj > ed) return;
        }
        // Sınıf, grup veya program filtreleri şu an finansal raporda kullanılmıyor; ileri geliştirme için hazır.
        const ayStr = dateObj.toLocaleDateString('tr-TR', { year:'numeric', month:'long' });
        if (!summary[ayStr]) summary[ayStr] = { gelir:0, gider:0 };
        const tutar = parseFloat(k.tutar) || 0;
        if (k.tip === 'gelir') summary[ayStr].gelir += tutar;
        else if (k.tip === 'gider') summary[ayStr].gider += tutar;
      });
    }
    const months = Object.keys(summary).sort((a,b) => new Date('1 ' + a) - new Date('1 ' + b));
    let tableHTML = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    tableHTML += '<thead><tr><th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Ay</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam Gelir (₺)</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam Gider (₺)</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Fark (₺)</th></tr></thead><tbody>';
    months.forEach(ay => {
      const g = summary[ay].gelir.toFixed(2);
      const d = summary[ay].gider.toFixed(2);
      const fark = (summary[ay].gelir - summary[ay].gider).toFixed(2);
      tableHTML += '<tr><td style="padding:6px;">' + ay + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + g + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + d + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + fark + '</td></tr>';
    });
    tableHTML += '</tbody></table>';
    sonucEl.innerHTML = tableHTML;
    // Yazdırma ve WhatsApp mesajı için başlık ve tabloyu sakla
    // Rapor çıktısında kulüp logosunun sol üst köşede görünmesi için başlığa logo ekliyoruz.
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Çocuk Kulübü</h2>' +
      '<h3 style="margin:0;">Aylık Finansal Özet</h3>' +
      '</div>' +
      '</div>' +
      tableHTML;
  });
}

// Öğrenci raporu oluşturur: ödeme bilgilerini ve kalan tutarları listeler
function generateOgrenciRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>Yükleniyor...</p>';
  firebase.database().ref('ogrenciler').once('value', snap => {
    const data = snap.val();
    const rows = [];
    if (data) {
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const taksitler = item.odeme?.taksitler || {};
        const toplamTutar = item.odeme?.toplamTutar ? parseFloat(item.odeme.toplamTutar) : 0;
        // Sınıf, grup ve program filtreleri
        if (sinif && ogr.sinif && ogr.sinif.toString() !== sinif.toString()) return;
        if (grup && ogr.grup && ogr.grup.toString() !== grup.toString()) return;
        if (program && ogr.egitimProgrami && ogr.egitimProgrami.toString() !== program.toString()) return;
        // Tarih aralığı filtresi: kayıt tarihi veya eklenmeZamani kullan
        let dateStr = ogr.kayitTarihi || ogr.islemTarihi || item.eklenmeZamani || '';
        if (startDate) {
          const sd = new Date(startDate);
          const d = dateStr ? new Date(dateStr) : null;
          if (d && d < sd) return;
        }
        if (endDate) {
          const ed = new Date(endDate);
          ed.setHours(23,59,59,999);
          const d = dateStr ? new Date(dateStr) : null;
          if (d && d > ed) return;
        }
        // Ödenen ve kalan tutarların hesabı
        let paid = 0;
        let remaining = 0;
        Object.values(taksitler).forEach(t => {
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          paid += odenen;
          remaining += (tutar - odenen);
        });
        rows.push({
          adSoyad: ogr.adSoyad || '',
          ogrNo: ogr.ogrNo || '',
          sinif: ogr.sinif || '',
          grup: ogr.grup || '',
          program: ogr.egitimProgrami || '',
          toplam: toplamTutar.toFixed(2),
          odenen: paid.toFixed(2),
          kalan: remaining.toFixed(2)
        });
      });
    }
    if (rows.length === 0) {
      sonucEl.innerHTML = '<p>Listelenecek öğrenci bulunamadı.</p>';
      window.lastReportHTML = '';
      return;
    }
    // Tabloyu oluştur
    let html = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    html += '<thead><tr>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Öğrenci</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">No</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Sınıf</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Grup</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Program</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam (₺)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Ödenen (₺)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Kalan (₺)</th>' +
      '</tr></thead><tbody>';
    let toplamToplam = 0, toplamOdenen = 0, toplamKalan = 0;
    rows.forEach(r => {
      html += '<tr><td style="padding:6px;">' + r.adSoyad + '</td>' +
        '<td style="padding:6px;">' + r.ogrNo + '</td>' +
        '<td style="padding:6px;">' + r.sinif + '</td>' +
        '<td style="padding:6px;">' + r.grup + '</td>' +
        '<td style="padding:6px;">' + r.program + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.toplam + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.odenen + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.kalan + '</td></tr>';
      toplamToplam += parseFloat(r.toplam);
      toplamOdenen += parseFloat(r.odenen);
      toplamKalan += parseFloat(r.kalan);
    });
    html += '<tr style="font-weight:bold;"><td style="padding:6px;" colspan="5">Toplam</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamToplam.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamOdenen.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamKalan.toFixed(2) + '</td></tr>';
    html += '</tbody></table>';
    sonucEl.innerHTML = html;
    // Öğrenci ödeme raporunun başlığına kulüp logosu eklendi
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Çocuk Kulübü</h2>' +
      '<h3 style="margin:0;">Öğrenci Ödeme Raporu</h3>' +
      '</div>' +
      '</div>' +
      html;
  });
}

// Taksit durumu raporu: taksitlerin vade ve ödeme durumlarını listeler
function generateTaksitRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>Yükleniyor...</p>';
  firebase.database().ref('ogrenciler').once('value', snap => {
    const data = snap.val();
    const rows = [];
    if (data) {
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const taksitler = item.odeme?.taksitler || {};
        // Sınıf, grup, program filtreleri
        if (sinif && ogr.sinif && ogr.sinif.toString() !== sinif.toString()) return;
        if (grup && ogr.grup && ogr.grup.toString() !== grup.toString()) return;
        if (program && ogr.egitimProgrami && ogr.egitimProgrami.toString() !== program.toString()) return;
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          if (!date || isNaN(date)) return;
          // Tarih aralığı filtresi (vade)
          if (startDate) {
            const sd = new Date(startDate);
            if (date < sd) return;
          }
          if (endDate) {
            const ed = new Date(endDate);
            ed.setHours(23,59,59,999);
            if (date > ed) return;
          }
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          let durum = '';
          const today = new Date();
          if (t.odendi || kalan <= 0) {
            durum = 'Ödendi';
          } else if (date < today) {
            durum = 'Vadesi Geçti';
          } else if (date.toDateString() === today.toDateString()) {
            durum = 'Bugün';
          } else {
            durum = 'Yaklaşan';
          }
          rows.push({
            tarih: date,
            adSoyad: ogr.adSoyad || '',
            ogrNo: ogr.ogrNo || '',
            sinif: ogr.sinif || '',
            grup: ogr.grup || '',
            program: ogr.egitimProgrami || '',
            taksitNo: parseInt(idx) + 1,
            tutar: tutar.toFixed(2),
            odenen: odenen.toFixed(2),
            kalan: kalan.toFixed(2),
            durum: durum
          });
        });
      });
    }
    if (rows.length === 0) {
      sonucEl.innerHTML = '<p>Listelenecek taksit bulunamadı.</p>';
      window.lastReportHTML = '';
      return;
    }
    // Vade sırasına göre sıralama
    rows.sort((a,b) => a.tarih - b.tarih);
    let html = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    html += '<thead><tr>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Vade</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Öğrenci</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">No</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Sınıf</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Grup</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Program</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Taksit No</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Tutar (₺)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Ödenen (₺)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Kalan (₺)</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Durum</th>' +
      '</tr></thead><tbody>';
    let toplamTutar = 0, toplamOdenen = 0, toplamKalan = 0;
    rows.forEach(r => {
      const dateStr = r.tarih.toLocaleDateString('tr-TR');
      html += '<tr><td style="padding:6px;">' + dateStr + '</td>' +
        '<td style="padding:6px;">' + r.adSoyad + '</td>' +
        '<td style="padding:6px;">' + r.ogrNo + '</td>' +
        '<td style="padding:6px;">' + r.sinif + '</td>' +
        '<td style="padding:6px;">' + r.grup + '</td>' +
        '<td style="padding:6px;">' + r.program + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.taksitNo + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.tutar + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.odenen + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.kalan + '</td>' +
        '<td style="padding:6px;">' + r.durum + '</td></tr>';
      toplamTutar += parseFloat(r.tutar);
      toplamOdenen += parseFloat(r.odenen);
      toplamKalan += parseFloat(r.kalan);
    });
    html += '<tr style="font-weight:bold;"><td style="padding:6px;" colspan="7">Toplam</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamTutar.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamOdenen.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamKalan.toFixed(2) + '</td>' +
      '<td style="padding:6px;"></td></tr>';
    html += '</tbody></table>';
    sonucEl.innerHTML = html;
    // Taksit durumu raporunun başlığına kulüp logosu eklendi
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Çocuk Kulübü</h2>' +
      '<h3 style="margin:0;">Taksit Durumu Raporu</h3>' +
      '</div>' +
      '</div>' +
      html;
  });
}

// Raporu Excel dosyasına kaydetmek için fonksiyon
function raporlarExcelIndir() {
  if (!window.lastReportHTML) {
    Swal.fire('Uyarı','Lütfen önce rapor oluşturun.','warning');
    return;
  }
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = window.lastReportHTML;
  const table = tempDiv.querySelector('table');
  if (!table) {
    Swal.fire('Hata','Tablo bulunamadı.','error');
    return;
  }
  // SheetJS ile tabloyu kitaba dönüştür
  const wb = XLSX.utils.table_to_book(table, {sheet: 'Rapor'});
  XLSX.writeFile(wb, 'rapor.xlsx');
}

// Raporu yazdırmak için yeni fonksiyon
function raporlarYazdir() {
  if (!window.lastReportHTML) {
    Swal.fire('Uyarı','Lütfen önce rapor oluşturun.','warning');
    return;
  }
  const printWin = window.open('', '_blank');
  printWin.document.write('<html><head><title>Fenomen Çocuk Kulübü Rapor</title>');
  printWin.document.write('<style>body{font-family:Arial, sans-serif; margin:20px;} table{width:100%; border-collapse:collapse;} th, td{border:1px solid #ddd; padding:8px;} th{background:#f2f2f2;}</style>');
  printWin.document.write('</head><body>');
  printWin.document.write(window.lastReportHTML);
  printWin.document.write('</body></html>');
  printWin.document.close();
  printWin.focus();
  printWin.print();
  printWin.close();
}

// WhatsApp mesajı oluşturma fonksiyonu
function raporlarWhatsappGonder() {
  // WhatsApp mesajını rapor verilerine göre hazırlayıp modal penceresini açar.
  // Kullanıcı rapor oluşturmadan bu butona basarsa uyarı gösterilir.
  if (!window.lastReportHTML) {
    Swal.fire('Uyarı','Lütfen önce rapor oluşturun.','warning');
    return;
  }
  // Seçilen rapor parametrelerini oku
  const tur = document.getElementById('raporlar-tur')?.value || '';
  const baslangic = document.getElementById('raporlar-start-date')?.value || '';
  const bitis = document.getElementById('raporlar-end-date')?.value || '';
  const sinif = document.getElementById('raporlar-sinif')?.value || '';
  const grup = document.getElementById('raporlar-grup')?.value || '';
  const program = document.getElementById('raporlar-program')?.value || '';
  // Rapor içeriğini DOM'a yükleyip düz metne çevir
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = window.lastReportHTML;
  // Tabloyu daha okunabilir bir düz metne çevir.
  let raporMetni = '';
  const table = tempDiv.querySelector('table');
  if (table) {
    const rows = Array.from(table.querySelectorAll('tr'));
    const rowTexts = rows.map(row => {
      const cells = Array.from(row.children);
      // Hücre içeriklerini çubuklarla ayırarak birleştir
      return cells.map(c => c.innerText.trim()).join(' | ');
    });
    raporMetni = rowTexts.join('\n');
  } else {
    // Eğer tablo yoksa tüm içeriği tek satır olarak al
    raporMetni = tempDiv.innerText.trim();
  }
  // Mesaj başlığı ve seçilen filtreleri topla
  const turMap = { finans: 'Finansal Rapor', ogrenci: 'Öğrenci Raporu', taksit: 'Taksit Durumu Raporu' };
  const lines = [];
  lines.push('Fenomen Çocuk Kulübü');
  if (turMap[tur]) {
    lines.push('');
    lines.push(turMap[tur]);
  }
  // Tarih aralığı varsa ekle
  if (baslangic || bitis) {
    let basStr = '';
    let bitStr = '';
    try {
      basStr = baslangic ? formatTarih(baslangic) : '';
    } catch(e) {
      basStr = baslangic;
    }
    try {
      bitStr = bitis ? formatTarih(bitis) : '';
    } catch(e) {
      bitStr = bitis;
    }
    if (basStr && bitStr) {
      lines.push(`Tarih Aralığı: ${basStr} - ${bitStr}`);
    } else if (basStr) {
      lines.push(`Başlangıç Tarihi: ${basStr}`);
    } else if (bitStr) {
      lines.push(`Bitiş Tarihi: ${bitStr}`);
    }
  }
  if (sinif) lines.push(`Sınıf: ${sinif}`);
  if (grup) lines.push(`Grup: ${grup}`);
  if (program) lines.push(`Program: ${program}`);
  if (lines[lines.length - 1] !== '') lines.push('');
  // Rapor tablosunun düz metnini ekle
  lines.push(raporMetni);
  const finalMsg = lines.join('\n');
  document.getElementById('whatsappMesaji').value = finalMsg;
  // Modal'i elle aç: mesaj zaten atandı, olusturWhatsappMesaji() çağrılmasın
  document.getElementById('whatsappModal').style.display = 'block';
}

  /* ------------------ TAKSIT / ODEME BITIS ------------------ */

  
// ----- Yedekleme Fonksiyonları -----
function yedekOlustur() {
    Swal.fire({
        title: 'Yedek alınsın mı?',
        text: 'Tüm verilerin yedeği oluşturularak cihaza indirilecektir.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, yedekle',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            firebase.database().ref().once('value').then((snapshot) => {
                const data = snapshot.val() || {};
                const now = new Date();
                const pad = (n) => n.toString().padStart(2,'0');
                const dateStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const fileName = `yedek_${dateStr}_${code}.json`;
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                Swal.fire('Başarılı', `Yedek dosyası oluşturuldu: ${fileName}`, 'success');
            }).catch((error) => {
                Swal.fire('Hata', 'Yedek alınırken bir hata oluştu: ' + error.message, 'error');
            });
        }
    });
}

function yedekYukle() {
    Swal.fire({
        title: 'Yedek geri yüklensin mi?',
        text: 'Bu işlem mevcut veri tabanını silip seçilen yedek dosyasını yükler.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, geri yükle',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            const input = document.getElementById('yedekDosyaInput');
            input.value = '';
            input.click();
        }
    });
}

// Gizli dosya seçme inputu için değişiklik olayını dinle
document.addEventListener('DOMContentLoaded', () => {
    const dosyaInput = document.getElementById('yedekDosyaInput');
    if (dosyaInput) {
        dosyaInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                let jsonData;
                try {
                    jsonData = JSON.parse(event.target.result);
                } catch (err) {
                    Swal.fire('Hata', 'Yedek dosyası okunamadı veya geçersiz format.', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Yükleniyor',
                    text: 'Veriler geri yükleniyor...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                firebase.database().ref().set(null).then(() => {
                    return firebase.database().ref().set(jsonData || {});
                }).then(() => {
                    Swal.close();
                    Swal.fire('Başarılı', 'Yedek geri yüklendi.', 'success');
                    if (typeof loadDashboardData === 'function') loadDashboardData();
                    if (typeof kayitlariGetir === 'function') kayitlariGetir();
                    if (typeof kategorileriYukle === 'function') kategorileriYukle();
                    if (typeof kategoriSecimiYukle === 'function') kategoriSecimiYukle();
                }).catch((error) => {
                    Swal.close();
                    Swal.fire('Hata', 'Geri yükleme sırasında hata: ' + error.message, 'error');
                });
            };
            reader.readAsText(file);
        });
    }
});
</script>

</body>
</html>
