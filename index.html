<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Firebase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS library for Excel read/write -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // Firebase yapÄ±landÄ±rmasÄ±
  // DoÄŸru yapÄ±landÄ±rma iÃ§in deÄŸiÅŸken adÄ± belirtilmeli
  const firebaseConfig = {
    apiKey: "AIzaSyBABt0TN-k_ALfHyDv0yGzOiZMhACxfJbU",
    authDomain: "odeme-37f3e.firebaseapp.com",
    databaseURL: "https://odeme-37f3e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odeme-37f3e",
    storageBucket: "odeme-37f3e.firebasestorage.app",
    messagingSenderId: "433986287426",
    appId: "1:433986287426:web:264fe3aa9fabcc09103adb",
    measurementId: "G-QFHTWMBGZ9"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>
  <title>Fenomen Ã‡ocuk KulÃ¼bÃ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-orange: #FF6B00;
      --light-orange: #ff8740;
      --white: #fff;
      --gray: #f4f4f4;
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Nunito', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--gray);
    }

    aside {
      width: 240px;
      background-color: var(--main-orange);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      color: white;
      box-shadow: var(--shadow);
    }

    aside h1 {
      font-size: 1.4rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .menu-item {
      background-color: transparent;
      border: none;
      color: white;
      font-size: 1rem;
      padding: 0.75rem 1rem;
      text-align: left;
      margin-bottom: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .menu-item:hover, .menu-item.active {
      background-color: var(--light-orange);
    }

    main {
      flex-grow: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .panel {
      display: none;
      animation: fade 0.4s ease;
    }

    .panel.active {
      display: block;
    }

    @keyframes fade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 768px) {
      aside {
        width: 100px;
        padding: 1rem 0.5rem;
      }

      aside h1 {
        font-size: 1rem;
      }

      .menu-item {
        font-size: 0.9rem;
        justify-content: center;
      }
    }
    
    .form-card {
  max-width: 700px;
  margin: auto;
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.form-title {
  color: #FF6B00;
  font-size: 1.6rem;
  text-align: center;
  margin-bottom: 2rem;
}

.form-section {
  border-top: 1px solid #ddd;
  padding-top: 1.5rem;
  margin-top: 1.5rem;
}

.form-section h3 {
  color: #FF6B00;
  margin-bottom: 0.3rem;
  font-size: 1.1rem;
}

.form-desc {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
}

label {
  display: block;
  font-weight: 600;
  margin: 0.5rem 0 0.25rem;
}

input, select, textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.radio-group {
  display: flex;
  gap: 1.5rem;
  margin-top: 0.5rem;
}

textarea {
  resize: vertical;
}

.submit-btn {
  margin-top: 0.5rem;
  background: #FF6B00;
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s;
}

.submit-btn:hover {
  background: #e05a00;
}

@media (max-width: 600px) {
  .form-card {
    padding: 1rem;
  }
}
.record-list {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.record-card {
  background: #fff;
  border: 1px solid #ddd;
  border-left: 5px solid #FF6B00;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.record-card p {
  margin: 0.3rem 0;
  font-size: 0.95rem;
}
.filter-bar {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

/* Dashboard kartlarÄ± ve grafik dÃ¼zeni */
.dashboard-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
}
.dash-card {
  flex: 1;
  min-width: 150px;
  background: #FFF8E1;
  border-left: 5px solid #FF6F00;
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
}
.dash-card h3 {
  margin: 0;
  font-size: 0.95rem;
  color: #BF360C;
  font-weight: bold;
}
.dash-card p {
  margin: 0.5rem 0 0;
  font-size: 1.4rem;
  font-weight: bold;
  color: #333;
}
.dashboard-charts {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

  /*
   * Dashboard list container and card styles (apply at all screen sizes)
   * The following styles ensure the four dashboard lists appear as separate cards
   * with consistent spacing and responsive behavior.  Previously these rules
   * were defined inside a mobile media query which prevented them from taking
   * effect on desktop screens.  By defining them here outside of any media
   * query they will be applied on all viewport widths.
   */
  .dashboard-lists {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .dashboard-card {
    flex: 1;
    min-width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Yeni dÃ¼zen: dashboard gruplarÄ± iki sÃ¼tun halinde daha dengeli gÃ¶sterilir */
  .dashboard-group {
    flex: 1;
    min-width: 250px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Dashboard listeleri iÃ§in satÄ±rlar arasÄ±nda daha fazla boÅŸluk ve okunabilirlik */
  .dashboard-list p {
    /* AralarÄ± aÃ§mak iÃ§in daha fazla boÅŸluk ve satÄ±r yÃ¼ksekliÄŸi ayarla */
    margin: 0.5rem 0;
    line-height: 1.6;
  }

  .card-header {
    padding: 0.6rem 1rem;
    color: #fff;
    font-weight: 700;
  }

  .card-content {
    padding: 0.6rem 1rem 1rem;
    flex: 1;
  }

  /* Colour variants for the card headers */
  .card-orange .card-header {
    background: #FF9800;
  }
  .card-blue .card-header {
    background: #42A5F5;
  }
  .card-red .card-header {
    background: #E57373;
  }
  .card-green .card-header {
    background: #66BB6A;
  }
@media (max-width: 768px) {
  .dashboard-summary {
    flex-direction: column;
  }

  /* Dashboard lists styles */
  .dashboard-lists {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .dashboard-section {
    flex: 1;
    min-width: 220px;
    background: #fff;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .dashboard-section h3 {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    color: #BF360C;
    font-weight: bold;
  }
  .dashboard-section ul {
    /* Liste madde iÅŸaretlerini kaldÄ±r */
    list-style-type: none !important;
    padding-left: 0;
    margin: 0;
  }
  .dashboard-section li {
    font-size: 0.9rem;
    padding: 0.3rem 0;
    border-bottom: 1px solid #f1f1f1;
  }
  .dashboard-section li:last-child {
    border-bottom: none;
  }

  /* AÃ§Ä±klama metni */
  .section-desc {
    font-size: 0.8rem;
    color: #555;
    margin: 0.25rem 0 0.5rem;
  }

  /* Yeni liste konteynerleri iÃ§in stil */
  .dashboard-list {
    display: flex;
    flex-direction: column;
  }
  .dashboard-list p {
    font-size: 0.9rem;
    padding: 0.3rem 0;
    border-bottom: 1px solid #f1f1f1;
    margin: 0.3rem 0;
  }
  .dashboard-list p:last-child {
    border-bottom: none;
  }

  /* Kart tabanlÄ± dashboard bÃ¶lÃ¼mleri */
  .dashboard-card {
    flex: 1;
    min-width: 240px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .card-header {
    padding: 0.6rem 1rem;
    color: #fff;
    font-weight: 700;
  }
  .card-content {
    padding: 0.6rem 1rem 1rem;
    flex: 1;
  }
  .card-orange .card-header {
    background: #FF9800;
  }
  .card-blue .card-header {
    background: #42A5F5;
  }
  .card-red .card-header {
    background: #E57373;
  }
  .card-green .card-header {
    background: #66BB6A;
  }
}

/* Mobil uyumluluk iÃ§in ek dÃ¼zenlemeler */
@media (max-width: 600px) {
  .filter-bar {
    flex-direction: column;
    gap: 0.5rem;
  }
  .btn1 {
    width: 100%;
    margin-right: 0;
  }
  .record-card, .form-card {
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  .record-actions button {
    margin-top: 0.3rem;
    width: 100%;
  }
}

.filter-bar input,
.filter-bar select {
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.record-card {
  background: white;
  padding: 1rem;
  border-left: 5px solid #FF6B00;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  margin-bottom: 1rem;
  position: relative;
}

.record-card .card-actions {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  gap: 0.5rem;
}

.card-actions button {
  padding: 4px 8px;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  font-size: 0.8rem;
}

.card-actions .delete {
  background: #e74c3c;
  color: white;
}

.card-actions .edit {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 99;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 10% auto;
  padding: 2rem;
  max-width: 400px;
  border-radius: 10px;
  position: relative;
}

.modal-content .close {
  position: absolute;
  top: 8px; right: 12px;
  font-size: 20px;
  cursor: pointer;
}
.tabs {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.tab-button {
  padding: 0.6rem 1.2rem;
  background: #eee;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.tab-button.active {
  background: #FF6B00;
  color: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
.kategori-listesi {
  margin-top: 2rem;
}

.kategori-list {
  list-style: none;
  padding: 0;
}

.kategori-list li {
  background: #fff;
  padding: 0.6rem 1rem;
  margin: 0.3rem 0;
  border-left: 4px solid #FF6B00;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 6px;
}

.kategori-list li .actions {
  display: flex;
  gap: 0.5rem;
}

.kategori-list li button {
  padding: 3px 7px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.8rem;
}

.kategori-list li .edit {
  background-color: #3498db;
  color: white;
}

.kategori-list li .delete {
  background-color: #e74c3c;
  color: white;
}
.btn1 {
  padding: 0.5rem 1.2rem;
  background-color: #FF6B00;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.3s ease;
  margin-top: 20px;
}

.btn1:hover {
  background-color: #e25a00;
}
.form-actions1 {
  text-align: right;
}
.date-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.date-btn {
  padding: 6px 12px;
  border: none;
  background: #eee;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}

.date-btn:hover {
  background-color: #FF6B00;
  color: white;
}

.rapor-kutular {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.rapor-kutu {
  background-color: #fff;
  padding: 1.8rem 2rem;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.07);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.2rem;
  font-weight: 600;
  transition: 0.3s ease;
}

.rapor-kutu:hover {
  transform: scale(1.01);
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.rapor-kutu.gelir {
  border-left: 8px solid #2ecc71;
  background: linear-gradient(to right, #e9f7ef, #d4efdf);
  color: #145a32;
}

.rapor-kutu.gider {
  border-left: 8px solid #e74c3c;
  background: linear-gradient(to right, #fdecea, #fadbd8);
  color: #78281f;
}

.rapor-kutu.fark {
  border-left: 8px solid #ff6b00;
  background: linear-gradient(to right, #fff2e6, #ffe0cc);
  color: #a04000;
}

.rapor-kutu span {
  font-size: 1.6rem;
  font-weight: bold;
}

.print-panel {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.06);
  margin-top: 1.5rem;
}


.yazdir-onizleme {
  margin-top: 1rem;
  padding: 1rem;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  max-height: 400px;
  overflow-y: auto;
  font-size: 0.95rem;
}

.yazdir-onizleme table {
  width: 100%;
  border-collapse: collapse;
}

.yazdir-onizleme th,
.yazdir-onizleme td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.modal-content {
  background: #fff;
  padding: 2rem;
  border-radius: 16px;
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
  width: 400px;
  max-width: 95%;
  font-family: 'Nunito', sans-serif;
  position: relative;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.modal-content h3 {
  font-size: 22px;
  color: #FF6B00;
  margin-bottom: 1.5rem;
  text-align: center;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.modal-content label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  font-size: 14px;
  color: #444;
}

.modal-content input[type="text"] {
  width: 100%;
  padding: 12px 14px;
  font-size: 15px;
  border: 1px solid #ddd;
  border-radius: 10px;
  transition: 0.3s;
  outline: none;
  background-color: #f9f9f9;
}

.modal-content input[type="text"]:focus {
  border-color: #FF6B00;
  background-color: #fff;
  box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.2);
}

.modal-content button[type="submit"] {
  margin-top: 1.2rem;
  background-color: #FF6B00;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background-color 0.3s ease;
}

.modal-content button[type="submit"]:hover {
  background-color: #e25a00;
}

.modal-content .close {
  position: absolute;
  top: 12px;
  right: 18px;
  font-size: 28px;        /* Daha bÃ¼yÃ¼k */
  font-weight: bold;      /* KalÄ±n */
  color: #333;            /* Daha koyu gri */
  cursor: pointer;
  transition: color 0.3s ease, transform 0.2s ease;
}

.modal-content .close:hover {
  color: #FF6B00;          /* Turuncuya dÃ¶ner */
  transform: scale(1.2);   /* Hafif bÃ¼yÃ¼r */
}

#giderListesi li {
  border-left: 4px solid #8e44ad; /* Mor ton */
}
.record-card {
  background: #fff;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: 0.2s;
}
.record-card:hover {
  transform: translateY(-2px);
}

.gelir-card {
  border-left: 4px solid #ffa726 !important;
}

.gider-card {
  border-left: 4px solid #ab47bc !important;
}

.record-title {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 6px;
}

.record-header {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-bottom: 6px;
}

.record-amount {
  font-weight: bold;
}

.record-details {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}

.record-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.record-actions .btn-sil {
  background: #f44336;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.record-actions .btn-guncelle {
  background: #2196f3;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}

.record-actions button {
  padding: 6px 12px;
  margin-right: 8px;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.record-actions button:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

/* GÃ¼ncelle modal stilleri */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 30px 25px;
  border-radius: 8px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  position: relative;
  animation: slideIn 0.3s ease-out;
  font-family: sans-serif;
}

.modal-content h3 {
  margin-top: 0;
  color: #ff6600;
  font-size: 20px;
}

.modal-content label {
  font-weight: bold;
  margin-top: 10px;
  display: block;
  font-size: 14px;
}

.modal-content input,
.modal-content textarea {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  margin-bottom: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.modal-content button {
  background-color: #28a745;
  color: #fff;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.modal-content button:hover {
  background-color: #218838;
}

/* Kapat X iÅŸareti */
.modal-content .close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 26px;
  font-weight: bold;
  color: #333;
  cursor: pointer;
  transition: color 0.2s ease;
}

.modal-content .close:hover {
  color: #000;
}

/* GiriÅŸ animasyonu */
@keyframes slideIn {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
.btn-guncelle {
  background-color: #ffc107;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-guncelle:hover {
  background-color: #ff9800;
  color: white;
}
/* Taksit Ã¶deme durumuna gÃ¶re renkler */
.taksit-odendi {
  border-left: 5px solid #2ecc71;
  background-color: #e9f7ef;
}

.taksit-odenmedi {
  border-left: 5px solid #e74c3c;
  background-color: #fdecea;
}

/* ğŸ”¶ KÄ±smi Ã¶denmiÅŸ taksitler iÃ§in stil */
.taksit-kismi {
  border-left: 5px solid #f1c40f;
  background-color: #fcf3cf;
  opacity: 0.9;
}

/* ğŸ”´ Vadesi geÃ§miÅŸ taksitler iÃ§in vurgu */
.taksit-overdue {
  border-left: 5px solid #e74c3c;
  background-color: #fadbd8;
}
.date-filter {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-end;
  gap: 1rem;
  margin: 1rem 0;
  background: #fff;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.date-filter label {
  font-weight: 600;
  margin-bottom: 4px;
  display: block;
  color: #333;
}

.date-filter input[type="date"] {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
  transition: border 0.3s;
  background: #f9f9f9;
}

.date-filter input[type="date"]:focus {
  border-color: #FF6B00;
  outline: none;
  background: #fff;
}

.quick-buttons {
  display: flex;
  gap: 0.5rem;
  margin-top: 6px;
}

.quick-buttons button {
  background-color: #eee;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.quick-buttons button:hover,
.quick-buttons button.active {
  background-color: #FF6B00;
  color: white;
}

.taksit-kart-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-top: 1rem;
}

.taksit-kart {
  background-color: #f1f1f1;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  padding: 1rem;
  position: relative;
  width: 240px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.taksit-kart label {
  font-weight: bold;
  margin-bottom: 0.3rem;
}

.taksit-kart input[type="number"],
.taksit-kart input[type="date"] {
  padding: 0.4rem;
  border-radius: 4px;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
}

.taksit-sil-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: #888;
  transition: color 0.2s ease;
}

.taksit-sil-btn:hover {
  color: #e53935;
}

.taksit-ekle-btn {
  background-color: #4caf50;
  color: white;
  padding: 0.5rem 1.2rem;
  border: none;
  border-radius: 6px;
  margin-top: 1rem;
  font-size: 15px;
  cursor: pointer;
}

.taksit-ekle-btn:hover {
  background-color: #3e8e41;
}

.record-card {
  background: #fff;
  border-left: 4px solid #FF6B00;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 10px;
  padding: 1.2rem 1.5rem;
  margin: 1rem auto;
  max-width: 550px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.ogrenci-kart-header {
  display: flex;
  justify-content: space-between;
  font-size: 1.1rem;
  font-weight: bold;
  color: #2c3e50;
}

.ogrenci-info {
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
  color: #444;
}

.ogrenci-info div {
  width: 48%;
}

.record-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.6rem;
  margin-top: 1rem;
}

.record-card {
  border-left: 4px solid #ccc; /* default */
}

.renk-mavi     { border-left-color: #3498db; }
.renk-yesil    { border-left-color: #2ecc71; }
.renk-lila     { border-left-color: #9b59b6; }
.renk-sari     { border-left-color: #f1c40f; }
.renk-pembe    { border-left-color: #e91e63; }
.renk-kahve    { border-left-color: #8e715f; }
.renk-kirmizi  { border-left-color: #e74c3c; }
.renk-turuncu  { border-left-color: #e67e22; }
.renk-default  { border-left-color: #bdc3c7; }


.responsive-modal {
    max-width: 95vw;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    margin: auto;
  }

  .grid-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group input,
  .form-group select {
    padding: 0.4rem;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  .grid-full {
    grid-column: 1 / -1;
  }

  .modal-actions {
    margin-top: 2rem;
    text-align: right;
    display: flex;
    gap: 1rem;
    justify: flex-end;
  }

  .btn-kaydet,
  .btn-iptal {
    padding: 0.6rem 1.2rem;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-kaydet {
    background-color: #28a745;
    color: white;
  }

  .btn-iptal {
    background-color: #dc3545;
    color: white;
  }
.taksit-buttons {
    display: flex;
    gap: 1rem;
  }

  .taksit-buttons button {
    padding: 0.4rem 1rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .taksit-buttons button:hover {
    background-color: #0056b3;
  }
  /* ğŸ“¦ Modal dÄ±ÅŸ Ã§erÃ§evesi */
.modal5 {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: none;
  justify-content: center;
  align-items: center;
  background-color: rgba(0,0,0,0.6);
  z-index: 999;
}

/* ğŸ“„ Ä°Ã§erik kutusu */
.modal-icerik {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 800px; /* yatay geniÅŸlik */
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  max-height: 90vh;
  overflow-y: auto;
}

/* ğŸ§© Form iÃ§erikleri grid yapÄ±sÄ±na bÃ¶l */
.form-grid-2col {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

#ogrenciGuncelleModal button:hover {
  background-color: #0056b3;
  transform: scale(1.05);
}
  </style>
<aside>
    <h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼</h1>
    <!-- Yeni Dashboard sekmesi -->
    <button class="menu-item" onclick="switchPanel('dashboard', event)">ğŸ  Anasayfa</button>
    <button class="menu-item active" onclick="switchPanel('gelir', event)">ğŸ’° Gelir-Gider</button>
    <button class="menu-item" onclick="switchPanel('ogrenci', event)">ğŸ“ Ã–ÄŸrenci Takip</button>
    <!-- Yeni Raporlar menÃ¼ Ã¶ÄŸesi -->
    <button class="menu-item" onclick="switchPanel('raporlar', event)">ğŸ“Š Raporlar</button>
    <!-- Yeni yedekleme menÃ¼ Ã¶ÄŸesi -->
    <button class="menu-item" onclick="switchPanel('yedekleme', event)">ğŸ—„ï¸ Yedekleme</button>
</aside>

<main>
    <!-- ğŸ  Dashboard Paneli -->
    <div id="panel-dashboard" class="panel">
      <div class="form-card" style="max-width:1200px;margin:auto;">
        <h2 class="form-title" style="margin-bottom:1rem;">ğŸ“Š Genel Dashboard</h2>
        <!-- Ã–zet Kutular -->
        <!-- Dashboard Ã¶zet kutularÄ±nÄ± iki grup halinde dÃ¼zenle -->
        <div class="dashboard-summary">
          <div class="dashboard-group">
            <div class="dash-card">
              <h3>ğŸ‘¥ Ã–ÄŸrenci SayÄ±sÄ±</h3>
              <p id="dashStudentCount">-</p>
            </div>
            <div class="dash-card">
              <!-- 'Toplam Tutar' kutusunu 'BugÃ¼n Beklenen Alacak' olarak deÄŸiÅŸtirdik -->
              <h3>ğŸ’° BugÃ¼n Beklenen Alacak</h3>
              <p id="dashTotalDue">-</p>
            </div>
            <div class="dash-card">
              <h3>âœ… Ã–denen</h3>
              <p id="dashTotalPaid">-</p>
            </div>
          </div>
          <div class="dashboard-group">
            <div class="dash-card">
              <h3>ğŸ§¾ Kalan</h3>
              <p id="dashTotalRemaining">-</p>
            </div>
            <div class="dash-card">
              <h3>â° Vadesi GeÃ§miÅŸ</h3>
              <p id="dashTotalOverdue">-</p>
            </div>
            <div class="dash-card">
              <h3>ğŸŒ“ KÄ±smi Taksitler</h3>
              <p id="dashTotalPartial">-</p>
            </div>
          </div>
        </div>
        <!-- Listeler -->
        <div class="dashboard-lists">
          <div class="dashboard-card card-orange">
            <div class="card-header">
              <h3>ğŸ§‘â€ğŸ“ Son 5 KayÄ±tlÄ± Ã–ÄŸrenci</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste sisteme en son kayÄ±t olan 5 Ã¶ÄŸrenciyi ve kayÄ±t/iÅŸlem tarihlerini gÃ¶sterir.</p>
              <div id="lastStudentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-blue">
            <div class="card-header">
              <h3>ğŸ“‘ Son 10 Gelir/Gider KaydÄ±</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste en son eklenen 10 gelir veya gider kaydÄ±nÄ±; tarih, tÃ¼r, tutar, kategori ve aÃ§Ä±klama bilgisiyle listeler.</p>
              <div id="lastRecordsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-red">
            <div class="card-header">
              <h3>â° Vadesi GeÃ§miÅŸ Taksitler</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste vadesi geÃ§miÅŸ taksitlerin hangi Ã¶ÄŸrenci ve veliden, kaÃ§Ä±ncÄ± taksit olduÄŸunu ve kalan tutarÄ± gÃ¶sterir.</p>
              <div id="overdueStudentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
          <div class="dashboard-card card-green">
            <div class="card-header">
              <h3>ğŸ“… 1 Hafta Ä°Ã§inde Vadesi Gelecek Taksitler</h3>
            </div>
            <div class="card-content">
              <p class="section-desc">Bu liste Ã¶nÃ¼mÃ¼zdeki 7 gÃ¼n iÃ§inde Ã¶demesi gelecek taksitleri; hangi Ã¶ÄŸrenci ve veliden, kaÃ§Ä±ncÄ± taksit olduÄŸunu ve kalan tutarÄ± gÃ¶sterir.</p>
              <div id="upcomingPaymentsList" class="dashboard-list">
                <!-- JavaScript ile doldurulacak -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel-gelir" class="panel active">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('form', event)">â• Yeni KayÄ±t</button>
            <button class="tab-button" onclick="switchTab('kategori', event)">ğŸ“‚ Kategori YÃ¶netimi</button>
            <button class="tab-button" onclick="switchTab('liste', event)">ğŸ“‹ KayÄ±t Listesi</button>
            <button class="tab-button" onclick="switchTab('rapor', event)">ğŸ“Š Raporlar</button>
        </div>

        <div id="tab-form" class="tab-content active">
            <form id="income-expense-form" class="form-card">
                <h2 class="form-title">Yeni Gelir/Gider KaydÄ±</h2>
                <div class="form-section">
                    <h3>ğŸ“Œ KayÄ±t Bilgisi</h3>
                    <p class="form-desc">Tarih ve gelir/gider tÃ¼rÃ¼nÃ¼ seÃ§in.</p>
                    <label for="date">Tarih:</label>
                    <input type="date" id="date" required>
                    <label>TÃ¼r:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="type" value="gelir" onclick="kategoriSecimiYukle()"> Gelir</label>
                        <label><input type="radio" name="type" value="gider" onclick="kategoriSecimiYukle()"> Gider</label>
                    </div>
                </div>
                <div class="form-section">
                    <h3>ğŸ“‚ Kategori & Ã–deme</h3>
                    <p class="form-desc">Kategori seÃ§in ve Ã¶deme yÃ¶ntemini belirtin.</p>
                    <label for="category">Kategori:</label>
                    <select id="category" required>
                        <option value="">Kategori seÃ§in</option>
                    </select>
                    <label for="payment">Ã–deme TÃ¼rÃ¼:</label>
                    <select id="payment" required>
                        <option value="">SeÃ§iniz</option>
                        <option value="nakit">Nakit</option>
                        <option value="kredi_karti">Kredi KartÄ±</option>
                        <option value="eft">EFT / Havale</option>
                        <option value="elden_banka">Elden Bankaya YatÄ±rma</option>
                        <option value="online">Online Ã–deme</option>
                        <option value="diÄŸer">DiÄŸer</option>
                    </select>
                </div>
                <div class="form-section">
                    <h3>ğŸ’° Tutar & Para Birimi</h3>
                    <p class="form-desc">Para birimi ve giriÅŸ tutarÄ±nÄ± girin.</p>
                    <label for="currency">Para Birimi:</label>
                   <select id="currency" onchange="updateCurrencySymbol()">
  <option value="TRY">â‚º TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">â‚¬ EUR</option>
</select>

<label for="amount">Tutar (<span id="currency-symbol">â‚º</span>)</label>
<input type="text"
       id="amount"
       autocomplete="off"
       data-raw="0"
       oninput="captureRawAmount()"
       onblur="formatAmountLive()">

                </div>
                <div class="form-section">
                    <h3>ğŸ“ AÃ§Ä±klama (Opsiyonel)</h3>
                    <p class="form-desc">Varsa kÄ±sa aÃ§Ä±klama yazabilirsiniz.</p>
                    <label for="note">AÃ§Ä±klama:</label>
                    <textarea id="note" rows="2" placeholder="AÃ§Ä±klama girin..."></textarea>
                </div>
                <div class="form-section">
                    <div class="form-actions1">
                        <button type="submit" class="submit-btn">KaydÄ± Ekle</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="tab-kategori" class="tab-content">
            <div class="form-card">
                <div class="form-section">
                    <h3>ğŸ“‚ Kategori YÃ¶netimi</h3>
                    <form id="kategoriForm">
                        <label>TÃ¼r:</label>
                        <select id="kategoriTur">
                            <option value="gelir">Gelir</option>
                            <option value="gider">Gider</option>
                        </select>
                        <label>Kategori AdÄ±:</label>
                        <input type="text" id="kategoriAdi" required>
                        <button type="submit" class="btn1">â• Ekle</button>
                    </form>
                    <div class="kategori-listesi">
                        <h4>ğŸ“¥ Gelir Kategorileri</h4>
                        <ul id="gelirListesi" class="kategori-list"></ul>
                        <h4>ğŸ“¤ Gider Kategorileri</h4>
                        <ul id="giderListesi" class="kategori-list"></ul>
                    </div>
                </div>
            </div>
            <div id="kategoriEditModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="kapatKategoriModal()">&times;</span>
                    <h3>Kategori GÃ¼ncelle</h3>
                    <form id="kategoriEditForm">
                        <input type="hidden" id="editKategoriId">
                        <input type="hidden" id="editKategoriTur">
                        <label for="editKategoriAdi">Yeni Ad:</label>
                        <input type="text" id="editKategoriAdi" required>
                        <button type="submit">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="tab-liste" class="tab-content">
            <div class="form-card">
                <div class="form-section">
                    <h3>ğŸ“‹ KayÄ±t Listesi</h3>
                    <p class="form-desc">TÃ¼m gelir/gider kayÄ±tlarÄ±nÄ± aÅŸaÄŸÄ±da gÃ¶rÃ¼ntÃ¼leyebilirsiniz.</p>
                    <div class="filter-bar">
                        <input type="text" id="searchInput" placeholder="ğŸ” Arama yapÄ±n...">
                        <select id="filterType" onchange="kategoriFiltreSecenekleriniYukle(); kayitlariGetir();">
                            <option value="">Hepsi</option>
                            <option value="gelir">Sadece Gelir</option>
                            <option value="gider">Sadece Gider</option>
                        </select>
                        <select id="filterKategori">
                            <option value="">TÃ¼m Kategoriler</option>
                        </select>
                    </div>
                    <!-- KayÄ±t listesi filtrelerinin hemen altÄ±na yenile butonu eklendi. Bu buton tÄ±klandÄ±ÄŸÄ±nda veriler yeniden Firebase'den Ã§ekilir ve liste gÃ¼ncellenir. -->
                    <div style="margin-top:0.5rem;">
                        <button id="yenileKayitBtn" class="btn1" onclick="kayitlariGetir()">ğŸ”„ Yenile</button>
                    </div>
                    <div id="kayitlarListesi" class="record-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-rapor" class="tab-content">
            <div class="form-card">
                <h3>ğŸ“Š Gelir-Gider RaporlarÄ±</h3>
                <div class="date-filters">
                    <button onclick="raporFiltrele('bugun')" class="date-btn">BugÃ¼n</button>
                    <button onclick="raporFiltrele('hafta')" class="date-btn">Bu Hafta</button>
                    <button onclick="raporFiltrele('ay')" class="date-btn">Bu Ay</button>
                    <button onclick="raporFiltrele('3ay')" class="date-btn">3 Ay</button>
                    <button onclick="raporFiltrele('6ay')" class="date-btn">6 Ay</button>
                    <button onclick="raporFiltrele('1yil')" class="date-btn">1 YÄ±l</button>
                </div>
                <div class="rapor-kutular">
                    <div class="rapor-kutu gelir">ğŸ’° Toplam Gelir: <span id="raporGelir">â‚º0</span></div>
                    <div class="rapor-kutu gider">ğŸ’¸ Toplam Gider: <span id="raporGider">â‚º0</span></div>
                    <div class="rapor-kutu fark">ğŸ”„ Fark: <span id="raporFark">â‚º0</span></div>
                </div>
                <canvas id="raporChart" height="200"></canvas>
                <div id="yazdirPaneli"></div>
                <hr>
                <h4>ğŸ–¨ YazdÄ±rma Paneli</h4>
                <div class="print-panel">
                    <label>Rapor TÃ¼rÃ¼:</label>
                    <select id="raporSecim" onchange="hazirlaYazdirmaOnizleme()">
                        <option value="tum" selected>TÃ¼m KayÄ±tlar</option>
                        <option value="gelir">Sadece Gelir</option>
                        <option value="gider">Sadece Gider</option>
                    </select>
                    <div class="date-filter">
                        <label>Tarih AralÄ±ÄŸÄ±:</label>
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        <div class="quick-buttons">
                            <button onclick="setQuickRange('today')">BugÃ¼n</button>
                            <button onclick="setQuickRange('week')">1 Hafta</button>
                            <button onclick="setQuickRange('month')">1 Ay</button>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn1" onclick="tarihiUygula()">Tarihi Uygula</button>
                        <button class="btn1" onclick="yazdirRapor()">ğŸ–¨ YazdÄ±r</button>
                        <button class="btn1" onclick="acWhatsappModal()">ğŸ“¤ WhatsApp'tan GÃ¶nder</button>
                    </div>
                </div>
                <div id="yazdirOnizleme" class="yazdir-onizleme"></div>
            </div>
        </div>
    </div>

    <div id="panel-ogrenci" class="panel">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('kayit', event)">â• Ã–ÄŸrenci KayÄ±t</button>
            <button class="tab-button" onclick="switchTab('ogrenci-liste', event)">ğŸ“„ Ã–ÄŸrenci Listesi</button>
            <button class="tab-button" onclick="switchTab('taksit', event)">ğŸ’¸ Taksitler</button>
            <button class="tab-button" onclick="switchTab('odeme', event)">ğŸ’³ Ã–demeler</button>
        </div>

        <div id="tab-kayit" class="tab-content active">
            <div class="form-card">
                <h2 class="form-title">ğŸ“š Ã–ÄŸrenci KayÄ±t Formu</h2>
                <form id="ogrenciKayitFormu" onsubmit="return validateForm();">
                    <div class="form-section">
                        <h3>ğŸ¤“ Ã–ÄŸrenci Bilgileri</h3>
                        <label>Ad Soyad <span style="color:red">*</span></label>
                        <small>Ã–ÄŸrencinin tam adÄ±nÄ± giriniz.</small>
                        <input type="text" id="adSoyad" autocomplete="off">
                        <small class="error" id="adSoyadError"></small>

                        <label>DoÄŸum Tarihi</label>
                        <small>Ä°steÄŸe baÄŸlÄ±dÄ±r. Ã–ÄŸrencinin doÄŸum tarihini giriniz.</small>
                        <input type="date" id="dogumTarihi">

                        <label for="tc">TC Kimlik No <span style="color:red">*</span></label>
                        <small>11 haneli T.C. Kimlik numarasÄ± girilmelidir.</small>
                        <input type="text" id="tc" autocomplete="off" name="tc" maxlength="11" inputmode="numeric" pattern="[1-9][0-9]{10}" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,11);">
                        <small class="error" id="tcError"></small>

                        <label>Ã–ÄŸrenci NumarasÄ± (4â€“5 rakam) <span style="color:red">*</span></label>
                        <small>KullanÄ±cÄ± tarafÄ±ndan belirlenir. 4 veya 5 rakamlÄ± bir numara giriniz. Ã–rn: 8001</small>
                        <input type="text" id="ogrNo" autocomplete="off" minlength="4" maxlength="5" pattern="\\d{4,5}" inputmode="numeric">
                        <small class="error" id="ogrNoError"></small>

                        <label>SÄ±nÄ±f <span style="color:red">*</span></label>
                        <small>1 ile 8 arasÄ±nda sÄ±nÄ±f seÃ§imi yapÄ±nÄ±z.</small>
                        <select id="sinif">
                            <option value="">SeÃ§in</option>
                            <option>1</option><option>2</option><option>3</option><option>4</option>
                            <option>5</option><option>6</option><option>7</option><option>8</option>
                        </select>
                        <small class="error" id="sinifError"></small>

                        <label>Grup <span style="color:red">*</span></label>
                        <small>Aâ€“H arasÄ±nda bir grup seÃ§iniz.</small>
                        <select id="grup">
                            <option value="">SeÃ§in</option>
                            <option>A</option><option>B</option><option>C</option><option>D</option>
                            <option>E</option><option>F</option><option>G</option><option>H</option>
                        </select>
                        <small class="error" id="grupError"></small>

                        <label>Okul AdÄ±</label>
                        <small>Ã–ÄŸrencinin devam ettiÄŸi okulun adÄ±nÄ± giriniz. (Zorunlu deÄŸil)</small>
                        <input type="text" id="okul" autocomplete="off">

                        <label>EÄŸitim ProgramÄ± <span style="color:red">*</span></label>
                        <small>ProgramÄ± seÃ§iniz: Yaz, KÄ±ÅŸ veya Deneme KulÃ¼bÃ¼.</small>
                        <select id="egitimProgrami">
                            <option value="">SeÃ§in</option>
                            <option>Yaz</option>
                            <option>KÄ±ÅŸ</option>
                            <option>Deneme KulÃ¼bÃ¼</option>
                        </select>
                        <small class="error" id="egitimProgramiError"></small>

                        <label for="kayitTarihi">KayÄ±t Tarihi <span style="color:red">*</span></label>
                        <small>Ã–ÄŸrencinin sisteme kayÄ±t olduÄŸu tarihi seÃ§iniz.</small>
                        <input type="date" id="kayitTarihi" onchange="guncelleKayitTarihi()">
                        <small style="color:#555">SeÃ§ilen tarih: <span id="kayitTarihiGorunum"></span></small>

                        <label for="islemTarihi">Ä°ÅŸlem Tarihi <span style="color:red">*</span></label>
                        <small>Bu formun doldurulduÄŸu sistem tarihidir, deÄŸiÅŸtirilemez.</small>
                        <input type="date" id="islemTarihi" disabled>
                        <small style="color:#555">GÃ¶rÃ¼nÃ¼m: <span id="islemTarihiGorunum"></span></small>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Veli Bilgileri</h3>
                        <label>Veli Ad Soyad <span style="color:red">*</span></label>
                        <small>Ã–ÄŸrencinin velisinin tam adÄ±nÄ± giriniz.</small>
                        <input type="text" id="veliAd" autocomplete="off">
                        <small class="error" id="veliAdError"></small>

                        <label>Veli Telefon 1 <span style="color:red">*</span></label>
                        <small>Veliye ulaÅŸÄ±lacak cep telefonu numarasÄ±nÄ± giriniz. Format: (5XX) XXX XX XX</small>
                        <input type="tel" id="veliTel1" autocomplete="off" maxlength="17" placeholder="(5__) ___ __ __" oninput="telefonGirisFormatla(this)">

                        <label>Veli Telefon 2</label>
                        <small>Ä°steÄŸe baÄŸlÄ±dÄ±r. Alternatif bir telefon numarasÄ± girilebilir.</small>
                        <input type="tel" id="veliTel2" autocomplete="off" maxlength="17" placeholder="(5__) ___ __ __" oninput="telefonGirisFormatla(this)">
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’³ Ã–deme Bilgileri</h3>
                        <label for="paraBirimi">Para Birimi:</label>
                        <small>Ä°ÅŸlemin yapÄ±lacaÄŸÄ± para birimini seÃ§iniz.</small>
                        <!-- Ã–ÄŸrenci Para Birimi -->
<select id="paraBirimi" onchange="updateToplamTutarSymbol(); formatToplamTutar(); formatTaksitGorunumleri();">
  <option value="TRY">â‚º TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">â‚¬ EUR</option>
</select>

<!-- Toplam Tutar -->
<label for="toplamTutar">
  Toplam Tutar (<span id="toplamTutarSymbol">â‚º</span>) <span style="color:red">*</span>
</label>
<small>Ã–ÄŸrencinin Ã¶deyeceÄŸi toplam Ã¼creti giriniz. Ã–rn: 10000</small>

<input type="text"
       id="toplamTutar"
       required
       data-raw="0"
       autocomplete="off"
       oninput="captureToplamTutar(); olusturTaksitler();"
       onblur="formatToplamTutar()">

<small class="error" id="toplamTutarError"></small>


                        <label>Taksit SayÄ±sÄ± (1â€“12) <span style="color:red">*</span></label>
                        <small>Toplam Ã¶deme kaÃ§ takside bÃ¶lÃ¼necekse onu seÃ§iniz. 1 ile 12 arasÄ±nda olmalÄ±dÄ±r.</small>
                        <input type="number" id="taksitSayisi" min="1" max="12" onchange="olusturTaksitler()">
                        <small class="error" id="taksitSayisiError"></small>

                        <label>Ä°lk Taksit Tarihi <span style="color:red">*</span></label>
                        <small>Ä°lk Ã¶demenin yapÄ±lacaÄŸÄ± tarihi giriniz. DiÄŸerleri buna gÃ¶re aylÄ±k hesaplanacaktÄ±r.</small>
                        <input type="date" id="ilkTaksitTarihi" onchange="olusturTaksitler()">
                        <small class="error" id="ilkTaksitTarihiError"></small>

                        <div id="taksitBolumu">
                            <h3>ğŸ“‹ Taksitler</h3>
                            <div id="taksitKutulari" class="taksit-kart-container"></div>
                            <button type="button" class="taksit-ekle-btn" onclick="taksitEkle()">+ Taksit Ekle</button>
                        </div>
                    </div>

                    <div class="form-actions1">
                        <button type="button" class="submit-btn" onclick="kaydetOgrenci()">Kaydet</button>
                        <button class="submit-btn" onclick="event.preventDefault(); sayfayiYenile()">â†» Yenile</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Yeni, Ã§akÄ±ÅŸmasÄ±z versiyon -->
<div id="tab-ogrenci-liste" class="tab-content active">
  <div class="form-card" style="max-width: 1200px; margin: auto;">

    <!-- ğŸ“Œ BaÅŸlÄ±k ve Toplam -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <h2 class="form-title" style="margin: 0;">ğŸ“ Ã–ÄŸrenci Listesi</h2>
      <span id="ogrToplam" style="font-weight: 600; font-size: 1rem; color: #555;">Toplam: 0 Ã¶ÄŸrenci</span>
    </div>

    <!-- ğŸ” Filtre Bar -->
    <div class="filter-bar" style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
      <input type="text" id="ogrAraNo" placeholder="ğŸ”¢ Ã–ÄŸrenci No">
      <input type="text" id="ogrAraAdSoyad" placeholder="ğŸ‘¤ Ad Soyad">
      <input type="text" id="ogrAraTC" placeholder="ğŸ†” TC Kimlik No">
      <select id="ogrAraProgram">
        <option value="">ğŸ“ TÃ¼m Programlar</option>
        <option value="Yaz">Yaz</option>
        <option value="KÄ±ÅŸ">KÄ±ÅŸ</option>
        <option value="Deneme KulÃ¼bÃ¼">Deneme KulÃ¼bÃ¼</option>
      </select>
    </div>

    <!-- ğŸ“‹ Listele Butonu (orta hizalÄ±) -->
    <div style="text-align: right; margin-top: 1rem;">
      <button class="btn1" onclick="ogrListele()">ğŸ“‹ Listele</button>
      <button class="btn1" onclick="ogrYenile()">ğŸ”„ Yenile</button>
    </div>

    <!-- ğŸ“¤ Ãœst Butonlar -->
    <div style="margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 0.8rem;">
      <button class="btn1" onclick="excelDisariAktar()">ğŸ“¥ DÄ±ÅŸa Aktar</button>
      <button class="btn1" onclick="acTopluYukleModal()">ğŸ“¤ Toplu Ã–ÄŸrenci YÃ¼kle</button>
      <button class="btn1" onclick="gosterSablonModal()">ğŸ“„ Åablon Ã–rneÄŸi</button>
      <button class="btn1" onclick="acTopluSilModal()">ğŸ§¹ Toplu Sil</button>
    </div>

    <!-- ğŸ§¾ Ã–ÄŸrenci KartlarÄ± -->
    <div id="ogrKartListesi" class="taksit-kart-container" style="margin-top: 2rem;"></div>

    <!-- ğŸ”¢ Sayfa Kontrolleri -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; flex-wrap: wrap;">
      <div>
        <label for="ogrSayfaBoyutu"><strong>ğŸ‘ Sayfa Boyutu:</strong></label>
        <select id="ogrSayfaBoyutu" onchange="ogrListele()" style="margin-left: 0.5rem;">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
      <div id="ogrPagination" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
    </div>

  </div>
</div>



        <div id="tab-taksit" class="tab-content">
            <div class="form-card">
                <h3>ğŸ’³ Taksit Listesi</h3>
                <div class="filter-bar">
                    <input type="text" id="taksitAraNo" placeholder="ğŸ”¢ Ã–ÄŸrenci No...">
                    <input type="text" id="taksitAraAd" placeholder="ğŸ‘¤ Ã–ÄŸrenci AdÄ±...">
                    <select id="taksitDurum">
                        <option value="">ğŸ’¼ TÃ¼m Durumlar</option>
                        <option value="odendi">Ã–dendi</option>
                        <option value="odenmedi">Ã–denmedi</option>
                    </select>
                    <input type="date" id="taksitBaslangic">
                    <input type="date" id="taksitBitis">
                    <button class="btn1" onclick="taksitListele()">ğŸ” Listele</button>
                    <button class="btn1" onclick="taksitFiltreTemizle()">âŒ Temizle</button>
                </div>
                <!-- ğŸ›‘ Vadesi geÃ§miÅŸ taksitler iÃ§in ayrÄ± liste -->
                <div id="taksitOverdueListesi" class="record-list"></div>
                <div id="taksitListesi" class="record-list"></div>

                <!-- ğŸ“Š Rapor ve YazdÄ±r butonlarÄ± -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <!-- Raporla butonu kaldÄ±rÄ±ldÄ± -->
                </div>
            </div>
        </div>

        <div id="tab-odeme" class="tab-content">
            <div class="form-card">
                <h3>ğŸ’¸ Ã–deme GeÃ§miÅŸi</h3>
                <div class="filter-bar">
                    <input type="text" id="odemeAraNo" placeholder="ğŸ”¢ Ã–ÄŸrenci No...">
                    <input type="text" id="odemeAraAd" placeholder="ğŸ‘¤ Ã–ÄŸrenci AdÄ±...">
                    <select id="odemeProgram">
                        <option value="">ğŸ“ TÃ¼m Programlar</option>
                        <option value="Yaz">Yaz</option>
                        <option value="KÄ±ÅŸ">KÄ±ÅŸ</option>
                        <option value="Deneme KulÃ¼bÃ¼">Deneme KulÃ¼bÃ¼</option>
                    </select>
                    <button class="btn1" onclick="odemeListele()">ğŸ” Listele</button>
                    <button class="btn1" onclick="odemeFiltreTemizle()">âŒ Temizle</button>
                </div>
                <div id="odemeListesi" class="record-list"></div>
                <!-- ğŸ“Š Rapor ve YazdÄ±r butonlarÄ± -->
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <!-- Raporla butonu kaldÄ±rÄ±ldÄ± -->
                </div>
            </div>
        </div>
    </div>
    <!-- ğŸ“Š Raporlar Paneli -->
    <div id="panel-raporlar" class="panel">
        <div class="form-card" style="max-width: 800px; margin: auto;">
            <h2 class="form-title">ğŸ“Š Raporlar</h2>
            <p style="margin-bottom: 1rem;">Bu bÃ¶lÃ¼mde finansal, Ã¶ÄŸrenci ve taksit durumu raporlarÄ± oluÅŸturabilirsiniz. Tarih aralÄ±ÄŸÄ±, rapor tÃ¼rÃ¼ ve sÄ±nÄ±f/grup gibi filtreler seÃ§erek rapor alÄ±n.</p>
            <label for="raporlar-tur">Rapor TÃ¼rÃ¼:</label>
            <select id="raporlar-tur" style="margin-bottom: 0.5rem;">
                <option value="finans">Finansal Rapor</option>
                <option value="ogrenci">Ã–ÄŸrenci Raporu</option>
                <option value="taksit">Taksit Durumu Raporu</option>
            </select>
            <label for="raporlar-start-date">Tarih AralÄ±ÄŸÄ±:</label>
            <div style="display:flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap:wrap;">
                <input type="date" id="raporlar-start-date">
                <input type="date" id="raporlar-end-date">
            </div>
            <label for="raporlar-sinif">SÄ±nÄ±f/Grup/Program (opsiyonel):</label>
            <div style="display:flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap:wrap;">
                <select id="raporlar-sinif">
                    <option value="">TÃ¼m SÄ±nÄ±flar</option>
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                </select>
                <select id="raporlar-grup">
                    <option value="">TÃ¼m Gruplar</option>
                    <option>A</option><option>B</option><option>C</option><option>D</option>
                    <option>E</option><option>F</option><option>G</option><option>H</option>
                </select>
                <!-- Program filtresi -->
                <select id="raporlar-program">
                    <option value="">TÃ¼m Programlar</option>
                    <option>Yaz</option>
                    <option>KÄ±ÅŸ</option>
                    <option>Deneme KulÃ¼bÃ¼</option>
                </select>
            </div>
            <div style="display:flex; gap: 0.5rem; flex-wrap:wrap; margin-bottom: 0.5rem;">
                <button class="btn1" onclick="raporlarOlustur()">Raporu OluÅŸtur</button>
                <button class="btn1" onclick="raporlarYazdir()">ğŸ–¨ YazdÄ±r</button>
                <button class="btn1" onclick="raporlarWhatsappGonder()">ğŸ“¤ WhatsApp'tan GÃ¶nder</button>
                <!-- ğŸ§¾ Excel indirme butonu -->
                <button class="btn1" onclick="raporlarExcelIndir()">ğŸ“¥ Excel Ä°ndir</button>
            </div>
            <div id="raporlarSonuc" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <!-- ğŸ—„ï¸ Yedekleme Paneli -->
    <div id="panel-yedekleme" class="panel">
      <div class="form-card" style="max-width:600px;margin:auto;">
        <h2 class="form-title">ğŸ—„ï¸ Yedekleme</h2>
        <p style="margin-bottom:1rem;">Veri tabanÄ±nÄ±zÄ± yedekleyebilir veya daha Ã¶nce oluÅŸturulmuÅŸ bir yedeÄŸi geri yÃ¼kleyebilirsiniz.</p>
        <button class="btn1" onclick="yedekOlustur()">ğŸ“ Yedek OluÅŸtur</button>
        <button class="btn1" onclick="yedekYukle()">ğŸ“‚ YedeÄŸi Geri YÃ¼kle</button>
        <!-- Dosya seÃ§imi iÃ§in gizli input -->
        <input type="file" id="yedekDosyaInput" accept=".json" style="display:none;" />
      </div>
    </div>
</main>

<div id="whatsappModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="kapatWhatsappModal()">&times;</span>
        <h3>ğŸ“² WhatsApp MesajÄ± GÃ¶nder</h3>
        <p>OluÅŸturulan mesaj:</p>
        <textarea id="whatsappMesaji" rows="6" style="width:100%; font-size:1rem;"></textarea>
        <button onclick="gonderWhatsappMesaji()" class="btn1">GÃ¶nder</button>
    </div>
</div>

<div id="guncelleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="modalKapat()">&times;</span>
        <h3>âœï¸ KaydÄ± GÃ¼ncelle</h3>
        <input type="hidden" id="modalId">
        <label>Tarih:</label>
        <input type="date" id="modalTarih"><br>
        <label>TÃ¼r:</label>
        <div class="radio-group">
            <label><input type="radio" name="modalType" value="gelir" onchange="modalKategoriYukle()"> Gelir</label>
            <label><input type="radio" name="modalType" value="gider" onchange="modalKategoriYukle()"> Gider</label>
        </div>
        <label>Kategori:</label>
        <select id="modalKategori"></select><br>
        <label>Ã–deme TÃ¼rÃ¼:</label>
        <select id="modalOdeme">
            <option value="nakit">Nakit</option>
            <option value="kredi_karti">Kredi KartÄ±</option>
            <option value="eft">EFT / Havale</option>
            <option value="elden_banka">Elden Bankaya YatÄ±rma</option>
            <option value="online">Online Ã–deme</option>
            <option value="diÄŸer">DiÄŸer</option>
        </select><br>
        <label>Para Birimi:</label>
        <select id="modalPara" onchange="modalFormatAmount()">
  <option value="TRY">â‚º TL</option>
  <option value="USD">$ USD</option>
  <option value="EUR">â‚¬ EUR</option>
</select>

<input type="text"
       id="modalTutar"
       autocomplete="off"
       data-raw="0"
       oninput="modalCaptureRawAmount()"
       onblur="modalFormatAmount()">

        <label>AÃ§Ä±klama:</label>
        <textarea id="modalAciklama"></textarea><br>
        <button onclick="kaydiGuncelle()">ğŸ’¾ Kaydet</button>
    </div>
</div>
<!-- Ã–ÄŸrenci GÃ¼ncelleme ModalÄ± -->
<div id="ogrenciGuncelleModal" class="modal5" style="display: none;">
  <div class="modal-icerik responsive-modal">
  <h2>ğŸ“‹ Ã–ÄŸrenci GÃ¼ncelle</h2>

  <div class="grid-form">
    <!-- ğŸ§â€â™‚ï¸ Ã–ÄŸrenci Bilgileri -->
    <div class="form-group">
      <label>Ad Soyad</label>
      <input type="text" id="guncelleAdSoyad">
    </div>
    <div class="form-group">
      <label>DoÄŸum Tarihi</label>
      <input type="date" id="guncelleDogumTarihi">
    </div>
    <div class="form-group">
      <label>Ã–ÄŸrenci No</label>
      <input type="text" id="guncelleOgrNo">
    </div>
    <div class="form-group">
      <label>SÄ±nÄ±f</label>
      <input type="text" id="guncelleSinif">
    </div>
    <div class="form-group">
      <label>Grup</label>
      <input type="text" id="guncelleGrup">
    </div>
    <div class="form-group">
      <label>Okul</label>
      <input type="text" id="guncelleOkul">
    </div>
    <div class="form-group">
      <label>EÄŸitim ProgramÄ±</label>
      <input type="text" id="guncelleProgram">
    </div>
    <div class="form-group">
      <label>KayÄ±t Tarihi</label>
      <input type="date" id="guncelleKayitTarihi">
    </div>
    <div class="form-group">
      <label>Ä°ÅŸlem Tarihi</label>
      <input type="date" id="guncelleIslemTarihi" disabled>
    </div>

    <!-- ğŸ‘ª Veli Bilgileri -->
    <div class="form-group">
      <label>Veli Ad Soyad</label>
      <input type="text" id="guncelleVeliAd">
    </div>
    <div class="form-group">
      <label>Veli Telefon 1</label>
      <input type="tel" id="guncelleVeliTel1">
    </div>
    <div class="form-group">
      <label>Veli Telefon 2</label>
      <input type="tel" id="guncelleVeliTel2">
    </div>

    <!-- ğŸ’° Ã–deme Bilgileri -->
    <div class="form-group">
      <label>Para Birimi</label>
      <select id="guncelleParaBirimi">
        <option value="TRY">â‚º TL</option>
        <option value="USD">$ USD</option>
        <option value="EUR">â‚¬ EUR</option>
      </select>
    </div>
    
    <div class="form-group">
  <label>Toplam Tutar (â‚º)</label>
  <input type="number" id="guncelleToplamTutar" oninput="guncelleTaksitKutulariniOlustur()">
</div>

<div class="form-group">
  <label>Taksit SayÄ±sÄ±</label>
  <input type="number" id="guncelleTaksitSayisi" min="1" oninput="guncelleTaksitKutulariniOlustur()">
</div>
<div class="form-group taksit-buttons">
  <button type="button" onclick="guncelleTaksitEkle()">â• Taksit Ekle</button>
  <button type="button" onclick="guncelleTaksitSil()">â– Taksit Sil</button>
</div>

    <!-- ğŸ’³ Taksit KutularÄ± -->
    <div class="form-group grid-full">
      <label>Taksitler</label>
      <div id="guncelleTaksitlerAlani" class="taksitler-wrapper">
        <!-- Taksit kutucuklarÄ± burada oluÅŸacak -->
      </div>
    </div>
  </div>

  <input type="hidden" id="guncelleOgrId">

  <!-- ğŸš€ Butonlar -->
  <div class="modal-actions">
    <button class="btn-kaydet" onclick="kaydetGuncelle()">ğŸ’¾ Kaydet</button>
    <button class="btn-iptal" onclick="document.getElementById('ogrenciGuncelleModal').style.display='none'">âŒ Kapat</button>
  </div>
</div>
</div>

<!-- ğŸ“„ Åablon rehberi modalÄ± -->
<div id="sablonModal" class="modal" style="display:none;" onclick="kapatSablonModal(event)">
  <!-- Ä°Ã§eriÄŸe tÄ±klanÄ±nca Ã¼st kattaki olayÄ±n tetiklenmesini engellemek iÃ§in stopPropagation ekle -->
  <div class="modal-content" style="max-width:600px;" onclick="event.stopPropagation()">
    <!-- SaÄŸ Ã¼st kÃ¶ÅŸede Ã§alÄ±ÅŸan kapatma butonu -->
    <button type="button" class="sablon-close" onclick="kapatSablonModal(event)" style="position:absolute; top:8px; right:12px; border:none; background:transparent; font-size:32px; font-weight:bold; cursor:pointer; color:#D84315;">Ã—</button>
    <h3>ğŸ“„ Excel Åablonu NasÄ±l HazÄ±rlanÄ±r?</h3>
    <p>1. AÅŸaÄŸÄ±daki ÅŸablonu inceleyin.</p>
    <p>2. DosyayÄ± aÃ§Ä±p her satÄ±ra sÄ±rasÄ±yla <strong>Ad Soyad, Ã–ÄŸrenci No, Veli Telefon, SÄ±nÄ±f, Grup, Program, Toplam Tutar, Taksit SayÄ±sÄ±</strong> bilgilerini girin.</p>
    <p>3. Kaydedip, geri dÃ¶nerek <em>Toplu Ã–ÄŸrenci YÃ¼kle</em> seÃ§eneÄŸinden bu dosyayÄ± sisteme yÃ¼kleyin.</p>
    <!-- Ã–rnek resim daha Ã¶nce yÃ¼klenemiyordu; yer tutucu resmi kullanÄ±yoruz -->
    <!-- Åablon rehberi iÃ§erisindeki Ã¶rnek resmi kullanÄ±cÄ± tarafÄ±ndan saÄŸlanan ekran gÃ¶rÃ¼ntÃ¼sÃ¼ ile deÄŸiÅŸtirildi -->
    <img src="https://i.ibb.co/MyMJJJtH/Screenshot-1.png" alt="Excel ÅŸablon Ã¶rneÄŸi" style="width:100%;height:auto;border-radius:8px;margin:0.5rem 0;" />
    <!-- Ä°Ã§erideki indirme butonu kaldÄ±rÄ±ldÄ±; kullanÄ±cÄ± zaten modal dÄ±ÅŸÄ±ndan ÅŸablon indirebilir -->
  </div>
</div>

  <script>

const aktifSekmeler = {
  gelir: "form",        // default: "Yeni KayÄ±t"
  ogrenci: "kayit"      // default: "Ã–ÄŸrenci KayÄ±t"
};

function switchTab(tabId, event) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
  document.getElementById(`tab-${tabId}`).classList.add("active");

  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");

  // âœ… Aktif paneli bul ve aktif sekmeyi kaydet
  const aktifPanel = document.querySelector(".panel.active");
  if (aktifPanel) {
    if (aktifPanel.id === "panel-gelir") aktifSekmeler.gelir = tabId;
    if (aktifPanel.id === "panel-ogrenci") aktifSekmeler.ogrenci = tabId;
  }

  // ğŸ“Š Rapor sekmesinde tetikleyiciler
  if (tabId === "rapor") {
    document.getElementById("raporSecim").value = "tum";
    hazirlaYazdirmaOnizleme();
    raporFiltrele("bugun");
  }

  // ğŸ“‘ Taksit ve Ã–deme tablarÄ±nda listeleme fonksiyonlarÄ±nÄ± Ã§aÄŸÄ±r
  if (tabId === "taksit") {
    // Listelemeyi Ã§aÄŸÄ±r sadece taksit paneli aktif olduÄŸunda
    if (typeof taksitListele === 'function') taksitListele();
  }
  if (tabId === "odeme") {
    if (typeof odemeListele === 'function') odemeListele();
  }
}



function switchPanel(panel, event) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const aktifPanel = document.getElementById(`panel-${panel}`);
  aktifPanel.classList.add('active');

  document.querySelectorAll('.menu-item').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  // âœ… HafÄ±zadaki tab'a otomatik tÄ±kla
  const aktifTabId = aktifSekmeler[panel];
  const tabButton = aktifPanel.querySelector(`.tab-button[onclick*="${aktifTabId}"]`);
  if (tabButton) {
    tabButton.click();
  }

  // EÄŸer dashboard paneline geÃ§iliyorsa verileri yÃ¼kle
  if (panel === 'dashboard') {
    loadDashboardData();
  }
}



    

document.getElementById("currency").addEventListener("change", () => {
  updateCurrencySymbol();
  formatAmountLive();
});
    
document.addEventListener("DOMContentLoaded", () => {
  kayitlariGetir(); // ilk baÅŸta hepsini gÃ¶ster

  document.getElementById("filterType").addEventListener("change", kayitlariGetir);
  document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
  document.getElementById("searchInput").addEventListener("input", kayitlariGetir);
});


  // Tarih otomatik ayarlanÄ±r
  document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("date").value = today;

  kategoriSecimiYukle();        // âœ… kategori select'i yÃ¼kle
  kategorileriYukle();          // âœ… kategori listeleri yÃ¼kle
  kayitlariGetir();             // âœ… kayÄ±tlarÄ± listele
});


  // Form gÃ¶nderimi
 document.getElementById("income-expense-form").addEventListener("submit", function(e) {
  e.preventDefault();

  const type = document.querySelector('input[name="type"]:checked')?.value;
  const date = document.getElementById("date").value;
  const category = document.getElementById("category").value;
  const payment = document.getElementById("payment").value;
  const currency = document.getElementById("currency").value;
  const tutar = parseFloat(document.getElementById("amount").dataset.raw);
  const note = document.getElementById("note").value.trim(); // âœ… aÃ§Ä±klama alÄ±nÄ±r

  if (!type || !date || !category || !payment || isNaN(tutar)) {
    alert("LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun.");
    return;
  }

  const kayit = {
    tip: type,
    tarih: date,
    kategori: category,
    odeme: payment,
    paraBirimi: currency,
    tutar: tutar,
    aciklama: note, // âœ… aÃ§Ä±klama kaydÄ±
    eklenmeZamani: new Date().toISOString()
  };

  firebase.database().ref("kayitlar").push(kayit).then(() => {
    alert("KayÄ±t baÅŸarÄ±yla eklendi!");
    this.reset();
    document.getElementById("amount").dataset.raw = "0";
    formatAmountLive();
    kategoriSecimiYukle();
    kayitlariGetir();
    
    const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const today = now.toISOString().split("T")[0];
  document.getElementById("date").value = today;
  });
});



function formatTarih(tarihStr) {
  const d = new Date(tarihStr);
  const gun = String(d.getDate()).padStart(2, "0");
  const ay = String(d.getMonth() + 1).padStart(2, "0");
  const yil = d.getFullYear();
  return `${gun}-${ay}-${yil}`;
}



function bugununTarihiISO() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  return now.toISOString().split("T")[0];
}


function kaydiSil(id) {
  if (confirm("Bu kaydÄ± silmek istediÄŸinize emin misiniz?")) {
    firebase.database().ref("kayitlar/" + id).remove().then(() => {
      alert("KayÄ±t silindi");
      kayitlariGetir();
    });
  }
}

// GÃ¼ncelleme modalÄ±nÄ± tetikleyecek (temel Ã¶rnek)
function kaydiGuncellePopup(id, tutar, aciklama) {
  const yeniAd = prompt("Yeni aÃ§Ä±klama girin:", aciklama);
  if (yeniAd === null) return;

  firebase.database().ref("kayitlar/" + id).update({
    aciklama: yeniAd
  }).then(() => {
    alert("KayÄ±t gÃ¼ncellendi.");
    kayitlariGetir();
  });
}


 document.getElementById("filterType").addEventListener("change", kayitlariGetir);
 document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
 document.getElementById("searchInput").addEventListener("input", kayitlariGetir);

 window.addEventListener("DOMContentLoaded", () => {
  kategoriFiltreSecenekleriniYukle(); // Dinamik kategorileri getir
  kayitlariGetir();                   // TÃ¼m kayÄ±tlarÄ± ilk baÅŸta listele
});

 // Sayfa yÃ¼klendiÄŸinde otomatik getir
 document.addEventListener("DOMContentLoaded", kayitlariGetir);
 let tumKayitlar = [];

 function kayitlariGetir() {
  const listDiv = document.getElementById("kayitlarListesi");
  const filterType = document.getElementById("filterType")?.value || "";
  const filterKategori = document.getElementById("filterKategori")?.value || "";
  const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";

  firebase.database().ref("kayitlar").once("value", (snap) => {
    const data = snap.val();
    listDiv.innerHTML = "";

    if (!data) {
      listDiv.innerHTML = "<p>ğŸ“­ HenÃ¼z kayÄ±t yok.</p>";
      return;
    }

    const kayitlarArray = Object.entries(data).sort((a, b) => {
  return new Date(b[1].tarih) - new Date(a[1].tarih);
});


    kayitlarArray.forEach(([id, kayit]) => {
      // Filtreleme
      if (
        (filterType && filterType !== "hepsi" && kayit.tip !== filterType) ||
        (filterKategori && kayit.kategori !== filterKategori) ||
        (searchTerm && !(
          (kayit.kategori || "").toLowerCase().includes(searchTerm) ||
          (kayit.tip || "").toLowerCase().includes(searchTerm) ||
          (kayit.aciklama || "").toLowerCase().includes(searchTerm)
        ))
      ) {
        return;
      }

      const formattedDate = new Date(kayit.tarih).toLocaleDateString("tr-TR");
      const upperCurrency = (kayit.paraBirimi || "").toUpperCase();
      const formattedAmount = `${kayit.tutar?.toFixed(2)} ${upperCurrency}`;
      const cardColor = kayit.tip === "gelir" ? "gelir-card" : "gider-card";

      const div = document.createElement("div");
      div.className = `record-card ${cardColor}`;
      div.innerHTML = `
        <div class="record-title"><strong>${kayit.aciklama || "(AÃ§Ä±klama yok)"}</strong></div>
        <div class="record-header">
          <span>${formattedDate}</span>
          <span class="record-amount">${formattedAmount}</span>
        </div>
        <div class="record-details">
          <span>Kategori: <strong>${
  kayit.kategori.charAt(0).toUpperCase() + kayit.kategori.slice(1)
}</strong></span> |
<span>Ã–deme: <strong>${
  kayit.odeme.charAt(0).toUpperCase() + kayit.odeme.slice(1)
}</strong></span> |
<span>TÃ¼r: <strong>${
  kayit.tip.charAt(0).toUpperCase() + kayit.tip.slice(1)
}</strong></span>

        </div>
        <div class="record-actions">
          <button onclick="sil('${id}')" class="btn-sil">ğŸ—‘ Sil</button>
<button data-id="${id}" class="btn-guncelle">âœï¸ GÃ¼ncelle</button>        
        </div>
      `;
      listDiv.appendChild(div);
    });
  });
}

 document.addEventListener("click", function(e) {
  if (e.target.classList.contains("btn-guncelle")) {
    const id = e.target.getAttribute("data-id");

    // Sadece aktif panel gelir paneliyse Ã§alÄ±ÅŸtÄ±r
    const aktifPanel = document.querySelector(".panel.active");
    if (aktifPanel && aktifPanel.id === "panel-gelir") {
      guncelleModal(id);
    }
  }
});



 function kayitlariFiltrele() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const filterType = document.getElementById("filterType").value;
  const filterKategori = document.getElementById("filterKategori").value;
  const listeDiv = document.getElementById("kayitlarListesi");

  const filtreli = tumKayitlar.filter(k =>
    (!filterType || k.tur === filterType) &&
    (!filterKategori || k.kategori === filterKategori) &&
    (
      k.kategori?.toLowerCase().includes(search) ||
      k.odeme?.toLowerCase().includes(search) ||
      k.aciklama?.toLowerCase().includes(search)
    )
  );

  listeDiv.innerHTML = "";
  if (filtreli.length === 0) {
    listeDiv.innerHTML = "<p>Filtrene uygun kayÄ±t yok.</p>";
    return;
  }

  filtreli.forEach(k => {
    const kart = document.createElement("div");
    kart.className = "record-card";
    kart.innerHTML = `
      <div class="card-actions">
        <button class="edit" onclick="duzenle('${k.id}', '${k.kategori}', '${k.odeme}', '${k.tutar}', \`${k.aciklama || ''}\`)">DÃ¼zenle</button>
        <button class="delete" onclick="sil('${k.id}')">Sil</button>
      </div>
      <p><strong>${k.tarih}</strong> - ${k.tur.toUpperCase()} | ${k.kategori}</p>
      <p><strong>Tutar:</strong> ${k.tutar} ${k.paraBirimi.toUpperCase()}</p>
      <p><strong>Ã–deme:</strong> ${k.odeme}</p>
      ${k.aciklama ? `<p><strong>AÃ§Ä±klama:</strong> ${k.aciklama}</p>` : ""}
    `;
    listeDiv.appendChild(kart);
  });
 }

 function sil(id) {
  if (!confirm("Bu kaydÄ± silmek istediÄŸinize emin misiniz?")) return;
  firebase.database().ref("kayitlar/" + id).remove()
    .then(() => {
      alert("KayÄ±t silindi.");
      kayitlariGetir();
    })
    .catch(err => alert("Silme hatasÄ±: " + err.message));
 }

 function duzenle(id, kategori, odeme, tutar, aciklama) {
  document.getElementById("editId").value = id;
  document.getElementById("editKategori").value = kategori;
  document.getElementById("editOdeme").value = odeme;
  document.getElementById("editTutar").value = tutar;
  document.getElementById("editAciklama").value = aciklama;
  document.getElementById("editModal").style.display = "block";
 }

 function kapatModal() {
  document.getElementById("editModal").style.display = "none";
 }

 // Filtre olaylarÄ±
 document.getElementById("searchInput").addEventListener("input", kayitlariFiltrele);
 document.getElementById("filterType").addEventListener("change", kayitlariFiltrele);
 document.getElementById("filterKategori").addEventListener("change", kayitlariFiltrele);

 // Yeni kategori ekle
 document.getElementById("kategoriForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const tur = document.getElementById("kategoriTur").value;
  const adi = document.getElementById("kategoriAdi").value.trim();

  if (!adi) return alert("Kategori adÄ± boÅŸ olamaz.");

  firebase.database().ref(`kategori${tur.charAt(0).toUpperCase() + tur.slice(1)}`).push({ ad: adi })
    .then(() => {
      document.getElementById("kategoriAdi").value = "";
      kategoriSecimiYukle();   // âœ… kayÄ±t formundaki select'e yÃ¼kle
      kategorileriYukle();     // âœ… listeyi yenile
    });
 });



 // Kategorileri yÃ¼kle
 function kategorileriYukle() {
  const gelirListesi = document.getElementById("gelirListesi");
  const giderListesi = document.getElementById("giderListesi");
  gelirListesi.innerHTML = ""; giderListesi.innerHTML = "";

  // GELÄ°R
  firebase.database().ref("kategoriGelir").once("value", snap => {
    const data = snap.val();
    for (let id in data) {
      const li = document.createElement("li");
      li.innerHTML = `
        ${data[id].ad}
        <div class="actions">
          <button class="edit" onclick="acKategoriModal('gelir', '${id}', '${data[id].ad}')">DÃ¼zenle</button>
          <button class="delete" onclick="kategoriSil('kategoriGelir', '${id}')">Sil</button>
        </div>
      `;
      gelirListesi.appendChild(li);
    }
    // â• DiÄŸer sabit eklenmez burada, Ã§Ã¼nkÃ¼ form tarafÄ±nda olacak
    kategoriSecimiYukle("gelir", data);
  });

  // GÄ°DER
  firebase.database().ref("kategoriGider").once("value", snap => {
    const data = snap.val();
    for (let id in data) {
      const li = document.createElement("li");
      li.innerHTML = `
        ${data[id].ad}
        <div class="actions">
          <button class="edit" onclick="acKategoriModal('gider', '${id}', '${data[id].ad}')">DÃ¼zenle</button>
          <button class="delete" onclick="kategoriSil('kategoriGider', '${id}')">Sil</button>
        </div>
      `;
      giderListesi.appendChild(li);
    }
    kategoriSecimiYukle("gider", data);
  });
 }

 // Modal aÃ§/kapat
 function acKategoriModal(tur, id, ad) {
  document.getElementById("editKategoriId").value = id;
  document.getElementById("editKategoriTur").value = tur;
  document.getElementById("editKategoriAdi").value = ad;
  document.getElementById("kategoriEditModal").style.display = "block";
 }
 function kapatKategoriModal() {
  document.getElementById("kategoriEditModal").style.display = "none";
 }

 // GÃ¼ncelleme
 document.getElementById("kategoriEditForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const id = document.getElementById("editKategoriId").value;
  const tur = document.getElementById("editKategoriTur").value;
  const yeniAd = document.getElementById("editKategoriAdi").value.trim();
  const ref = tur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(`${ref}/${id}`).update({ ad: yeniAd }).then(() => {
    kapatKategoriModal();
    kategorileriYukle();
  });
 });

 // Silme
 function kategoriSil(ref, id) {
  if (!confirm("Bu kategoriyi silmek istediÄŸinize emin misiniz?")) return;
  firebase.database().ref(`${ref}/${id}`).remove().then(kategorileriYukle);
 }

 // KayÄ±t formuna kategori yÃ¼kle

 let raporChart;

 function raporFiltrele(aralik) {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC dÃ¼zeltmesi
  const bugunStr = now.toISOString().split("T")[0]; // "YYYY-MM-DD"

  let baslangic = new Date(now);

  switch(aralik) {
    case "bugun":
      // bugunStr zaten bugÃ¼nÃ¼n tarihi ISO formatÄ±nda
      break;
    case "hafta":
      baslangic.setDate(baslangic.getDate() - 7);
      break;
    case "ay":
      baslangic.setMonth(baslangic.getMonth() - 1);
      break;
    case "3ay":
      baslangic.setMonth(baslangic.getMonth() - 3);
      break;
    case "6ay":
      baslangic.setMonth(baslangic.getMonth() - 6);
      break;
    case "1yil":
      baslangic.setFullYear(baslangic.getFullYear() - 1);
      break;
  }

  firebase.database().ref("kayitlar").once("value", snap => {
    let gelir = 0, gider = 0;
    const data = snap.val();

    for (let id in data) {
      const kayit = data[id];
      const kayitTarih = kayit.tarih; // "YYYY-MM-DD" formatÄ±nda geliyor varsayÄ±yoruz

      if (aralik === "bugun") {
        if (kayitTarih === bugunStr) {
          const tutar = parseFloat(kayit.tutar);
          if (kayit.tip === "gelir") gelir += tutar;
          else if (kayit.tip === "gider") gider += tutar;
        }
      } else {
        const tarihObj = new Date(kayitTarih);
        if (tarihObj >= baslangic && tarihObj <= now) {
          const tutar = parseFloat(kayit.tutar);
          if (kayit.tip === "gelir") gelir += tutar;
          else if (kayit.tip === "gider") gider += tutar;
        }
      }
    }

    document.getElementById("raporGelir").textContent = `â‚º${gelir.toFixed(2)}`;
    document.getElementById("raporGider").textContent = `â‚º${gider.toFixed(2)}`;
    document.getElementById("raporFark").textContent = `â‚º${(gelir - gider).toFixed(2)}`;

    guncelleGrafik(gelir, gider);
  });
 }


 function guncelleGrafik(gelir, gider) {
  if (raporChart) raporChart.destroy();

  const ctx = document.getElementById('raporChart').getContext('2d');
  raporChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Gelir', 'Gider'],
      datasets: [{
        data: [gelir, gider],
        backgroundColor: ['green', 'red']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
      }
    }
  });
 }
 function hazirlaYazdirmaOnizleme() {
  const secim = document.getElementById("raporSecim").value;
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;
  const onizleme = document.getElementById("yazdirOnizleme");

  onizleme.innerHTML = "<p>YÃ¼kleniyor...</p>";

  // Tarih nesnelerine Ã§evir
  const startDate = startDateStr ? new Date(startDateStr) : null;
  const endDate = endDateStr ? new Date(endDateStr) : null;

  firebase.database().ref("kayitlar").once("value", snap => {
    const data = snap.val();

    if (!data) {
      onizleme.innerHTML = "<p>ğŸ“­ KayÄ±t bulunamadÄ±.</p>";
      return;
    }

    const entries = Object.entries(data)
      .filter(([id, k]) => {
        // Tip filtresi (gelir/gider/tum)
        if (secim === "gelir" && k.tip !== "gelir") return false;
        if (secim === "gider" && k.tip !== "gider") return false;

        // Tarih filtresi
        const kayitTarihi = new Date(k.tarih);
        if (startDate && kayitTarihi < startDate) return false;
        if (endDate && kayitTarihi > endDate) return false;

        return true;
      })
      .sort((a, b) => new Date(b[1].tarih) - new Date(a[1].tarih)); // Tarihe gÃ¶re azalan sÄ±rala

    if (entries.length === 0) {
      onizleme.innerHTML = "<p>ğŸ“­ Belirtilen aralÄ±kta kayÄ±t bulunamadÄ±.</p>";
      return;
    }

    // GLOBAL: WhatsApp iÃ§in kayÄ±tlarÄ± sakla
    window.sonFiltrelenenKayitlar = entries.map(([id, k]) => k);

    let html = `
      <table>
        <tr>
          <th>Tarih</th>
          <th>Tip</th>
          <th>Kategori</th>
          <th>Ã–deme TÃ¼rÃ¼</th>
          <th>Tutar</th>
        </tr>`;

    for (let [id, k] of entries) {
      html += `
        <tr>
          <td>${formatTarih(k.tarih)}</td>
          <td>${capitalize(k.tip)}</td>
          <td>${capitalize(k.kategori)}</td>
          <td>${capitalize(k.odeme)}</td>
          <td>${k.tutar.toFixed(2)} â‚º</td>
        </tr>`;
    }

    html += `</table>`;
    onizleme.innerHTML = html;
  });
 }



function yazdirRapor() {
  const secim = document.getElementById("raporSecim").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  const kurumAdi = "Fenomen Ã‡ocuk KulÃ¼bÃ¼";
  const raporTarihi = new Date().toLocaleDateString("tr-TR", { day: '2-digit', month: 'long', year: 'numeric' });

  let raporBaslik = "TÃ¼m KayÄ±tlar";
  if (secim === "gelir") raporBaslik = "TÃ¼m Gelirler";
  else if (secim === "gider") raporBaslik = "TÃ¼m Giderler";

  const tarihAraligiMetni = (start && end)
    ? `<p class="date-range"><strong>${formatTarih(start)} â€“ ${formatTarih(end)}</strong> tarihleri arasÄ± kayÄ±tlar</p>`
    : "";

  firebase.database().ref("kayitlar").once("value", snap => {
    const data = snap.val();
    if (!data) return alert("YazdÄ±rÄ±lacak kayÄ±t bulunamadÄ±.");

    let entries = Object.entries(data)
      .filter(([id, k]) => {
        if (secim === "gelir" && k.tip !== "gelir") return false;
        if (secim === "gider" && k.tip !== "gider") return false;

        const kayitTarih = new Date(k.tarih);
        const startDate = start ? new Date(start) : null;
        const endDate = end ? new Date(end) : null;

        if (startDate && kayitTarih < startDate) return false;
        if (endDate && kayitTarih > endDate) return false;

        return true;
      })
      .sort((a, b) => new Date(a[1].tarih) - new Date(b[1].tarih));

    let toplamGelir = 0, toplamGider = 0;
    let rowsHTML = "";

    for (let [id, k] of entries) {
      const tutar = parseFloat(k.tutar) || 0;
      if (k.tip === "gelir") toplamGelir += tutar;
      else if (k.tip === "gider") toplamGider += tutar;

      rowsHTML += `
        <tr>
          <td style="text-align: center;"><strong>${formatTarih(k.tarih)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.tip)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.kategori)}</strong></td>
          <td style="text-align: center;"><strong>${capitalize(k.odeme)}</strong></td>
          <td style="text-align: center;"><strong>${tutar.toFixed(2)} â‚º</strong></td>
        </tr>`;
    }

    const fark = toplamGelir - toplamGider;

    const html = `
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>${raporTarihi} â€“ ${raporBaslik}</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 2rem;
      background-color: #fff;
      color: #222;
    }
    .header-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .logo {
      width: 60px;
      height: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
    }
    .header-text h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #D84315;
      font-weight: bold;
    }
    .header-text h2 {
      margin: 0.2rem 0 0 0;
      font-size: 1rem;
      color: #555;
      font-weight: normal;
    }
    .date-range {
      font-size: 0.95rem;
      color: #333;
      margin-top: 0.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 0.9rem 1rem;
      border: 1px solid #999;
      font-size: 0.95rem;
      text-transform: capitalize;
      text-align: center;
    }
    th {
      background-color: #FFE0B2;
      color: #BF360C;
      font-weight: bold;
    }
    tr:nth-child(even) td {
      background-color: #FFF3E0;
    }
    .summary {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }
    .summary-box {
      flex: 1;
      border: 2px solid #FF6F00;
      border-radius: 10px;
      padding: 1rem;
      background-color: #FFF8E1;
      text-align: center;
    }
    .summary-box h3 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      color: #FF6F00;
      font-weight: bold;
      text-transform: uppercase;
    }
    .summary-box p {
      margin: 0;
      font-size: 1.2rem;
      font-weight: bold;
      color: #222;
    }
    .footer {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-top: 3rem;
    }
  </style>
</head>
<body>
  <div class="header-wrapper">
    <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" class="logo">
    <div class="header-text">
      <h1>${kurumAdi}</h1>
      <h2>${raporBaslik}</h2>
      ${tarihAraligiMetni}
    </div>
  </div>

  <table>
    <tr>
      <th>Tarih</th>
      <th>Tip</th>
      <th>Kategori</th>
      <th>Ã–deme TÃ¼rÃ¼</th>
      <th>Tutar</th>
    </tr>
    ${rowsHTML}
  </table>

  <div class="summary">
    <div class="summary-box">
      <h3>Toplam Gelir</h3>
      <p>â‚º${toplamGelir.toFixed(2)}</p>
    </div>
    <div class="summary-box">
      <h3>Toplam Gider</h3>
      <p>â‚º${toplamGider.toFixed(2)}</p>
    </div>
    <div class="summary-box">
      <h3>Fark</h3>
      <p>â‚º${fark.toFixed(2)}</p>
    </div>
  </div>

  <div class="footer">YazdÄ±rÄ±lma Tarihi: <strong>${raporTarihi}</strong> â€“ Sayfa 1</div>
</body>
</html>`;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  });
}





 function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
 }



 function kategoriSecimiYukle() {
  const kategoriSelect = document.getElementById("category");
  const seciliTur = document.querySelector('input[name="type"]:checked')?.value;

  if (!seciliTur) {
    kategoriSelect.innerHTML = `<option value="">LÃ¼tfen tÃ¼r seÃ§in</option>`;
    return;
  }

  const ref = seciliTur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(ref).once("value", (snap) => {
    const data = snap.val();
    kategoriSelect.innerHTML = `<option value="">Kategori seÃ§in</option>`;

    if (data) {
      for (let id in data) {
        const opt = document.createElement("option");
        opt.value = data[id].ad;
        opt.textContent = data[id].ad;
        kategoriSelect.appendChild(opt);
      }
    }

    // â• DiÄŸer her zaman en sonda
    const diger = document.createElement("option");
    diger.value = "diÄŸer";
    diger.textContent = "â• DiÄŸer...";
    kategoriSelect.appendChild(diger);
  });
 }



 document.querySelectorAll('input[name="type"]').forEach(r => r.addEventListener("change", kategoriSecimiYukle));
 document.addEventListener("DOMContentLoaded", kategoriSecimiYukle);



 function kategoriFiltreSecenekleriniYukle() {
  const kategoriFilter = document.getElementById("filterKategori");
  let seciliTur = document.getElementById("filterType").value;
  if (!seciliTur) seciliTur = "hepsi"; // boÅŸsa hepsi gibi dÃ¼ÅŸÃ¼n

  kategoriFilter.innerHTML = `<option value="">TÃ¼m Kategoriler</option>`;

  let refGelir = firebase.database().ref("kategoriGelir").once("value");
  let refGider = firebase.database().ref("kategoriGider").once("value");

  Promise.all([refGelir, refGider]).then(([snapGelir, snapGider]) => {
    const kategoriler = new Set();

    if (seciliTur === "hepsi" || seciliTur === "gelir") {
      const gelirData = snapGelir.val();
      if (gelirData) {
        Object.values(gelirData).forEach(item => {
          if (item.ad) kategoriler.add(item.ad);
        });
      }
    }

    if (seciliTur === "hepsi" || seciliTur === "gider") {
      const giderData = snapGider.val();
      if (giderData) {
        Object.values(giderData).forEach(item => {
          if (item.ad) kategoriler.add(item.ad);
        });
      }
    }

    // DOMâ€™a kategorileri sÄ±rayla ekle
    Array.from(kategoriler).sort().forEach(ad => {
      const opt = document.createElement("option");
      opt.value = ad;
      opt.textContent = ad;
      kategoriFilter.appendChild(opt);
    });

    // DiÄŸer seÃ§eneÄŸini en sona ekle
    const diger = document.createElement("option");
    diger.value = "diÄŸer";
    diger.textContent = "â• DiÄŸer";
    kategoriFilter.appendChild(diger);
  });
 }








 document.getElementById("filterKategori").addEventListener("change", kayitlariGetir);
 document.getElementById("searchInput").addEventListener("input", kayitlariGetir);


 function guncelleModal(id) {
  firebase.database().ref("kayitlar/" + id).once("value", (snap) => {
    const kayit = snap.val();
    if (!kayit) return alert("KayÄ±t bulunamadÄ±");

    document.getElementById("modalId").value = id;
    document.getElementById("modalTarih").value = kayit.tarih;
    document.getElementById("modalTutar").value = kayit.tutar.toFixed(2); // formatNumber yerine
    document.getElementById("modalTutar").dataset.raw = kayit.tutar;
    document.getElementById("modalAciklama").value = kayit.aciklama || "";
    document.getElementById("modalOdeme").value = kayit.odeme;
    document.getElementById("modalPara").value = kayit.paraBirimi;
modalFormatAmount();
    const radio = document.querySelector(`input[name="modalType"][value="${kayit.tip}"]`);
    if (radio) radio.checked = true;

    // Kategorileri yÃ¼kle ve seÃ§
    modalKategoriYukle(() => {
      document.getElementById("modalKategori").value = kayit.kategori;
    });

    document.getElementById("guncelleModal").style.display = "block";
  });
 }


 function formatNumber(num) {
  return Number(num).toLocaleString("tr-TR", { minimumFractionDigits: 2 });
 }

 function modalCaptureRawAmount() {
  const input = document.getElementById("modalTutar");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }


 function modalFormatAmount() {
  const input = document.getElementById("modalTutar");
  const raw = parseFloat(input.dataset.raw || "0");
  const currency = document.getElementById("modalPara")?.value || "TRY";

  if (!isNaN(raw)) {
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(raw);
  }
 }





 function modalKategoriYukle(callback) {
  const seciliTur = document.querySelector('input[name="modalType"]:checked')?.value;
  const kategoriSelect = document.getElementById("modalKategori");

  kategoriSelect.innerHTML = "<option value=''>Kategori seÃ§in</option>";

  if (!seciliTur) return;

  const ref = seciliTur === "gelir" ? "kategoriGelir" : "kategoriGider";

  firebase.database().ref(ref).once("value", (snap) => {
    const data = snap.val();
    if (data) {
      for (let id in data) {
        const opt = document.createElement("option");
        opt.value = data[id].ad;
        opt.textContent = data[id].ad;
        kategoriSelect.appendChild(opt);
      }
    }
    const diger = document.createElement("option");
    diger.value = "diÄŸer";
    diger.textContent = "â• DiÄŸer...";
    kategoriSelect.appendChild(diger);

    if (typeof callback === "function") callback(); // kategori seÃ§imini Ã§aÄŸÄ±r
  });
 }


 modalKategoriYukle(() => {
  document.getElementById("modalKategori").value = kayit.kategori;
 });


 function kaydiGuncelle() {
  const id = document.getElementById("modalId").value;
  const tarih = document.getElementById("modalTarih").value;
  const tip = document.querySelector('input[name="modalType"]:checked')?.value;
  const kategori = document.getElementById("modalKategori").value;
  const odeme = document.getElementById("modalOdeme").value;
  const para = document.getElementById("modalPara").value;
  const tutar = parseFloat(document.getElementById("modalTutar").dataset.raw || "0");
  const aciklama = document.getElementById("modalAciklama").value;

  if (!id || !tarih || !tip || !kategori || !odeme || !para || isNaN(tutar)) {
    alert("TÃ¼m alanlarÄ± doldurun.");
    return;
  }

  const guncel = {
    tarih,
    tip,
    kategori,
    odeme,
    paraBirimi: para,
    tutar,
    aciklama
  };

  firebase.database().ref("kayitlar/" + id).update(guncel).then(() => {
    alert("KayÄ±t gÃ¼ncellendi!");
    document.getElementById("guncelleModal").style.display = "none";
    kayitlariGetir(); // listeyi gÃ¼ncelle
  });
 }





 function modalKapat() {
  document.getElementById("guncelleModal").style.display = "none";
 }


 document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("kategoriEditForm");
  if (form) {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const id = document.getElementById("editKategoriId").value;
      const tur = document.getElementById("editKategoriTur").value;
      const yeniAd = document.getElementById("editKategoriAdi").value.trim();
      const ref = tur === "gelir" ? "kategoriGelir" : "kategoriGider";

      firebase.database().ref(`${ref}/${id}`).update({ ad: yeniAd }).then(() => {
        kapatKategoriModal();
        kategorileriYukle();
      });
    });
  }
 });

 function setQuickRange(tip) {
  // ButonlarÄ± temizle
  document.querySelectorAll('.quick-buttons button').forEach(btn => btn.classList.remove('active'));

  // UTC farkÄ± dÃ¼zeltilmiÅŸ bugÃ¼nÃ¼n tarihi
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const todayStr = now.toISOString().split("T")[0];

  const start = new Date(now); // baÅŸlangÄ±cÄ± UTC dÃ¼zeltilmiÅŸ olarak baÅŸlat

  if (tip === 'week') start.setDate(start.getDate() - 7);
  else if (tip === 'month') start.setMonth(start.getMonth() - 1);

  document.getElementById("startDate").value = start.toISOString().split("T")[0];
  document.getElementById("endDate").value = todayStr;

  // Aktif sÄ±nÄ±fÄ± ekle
  const clickedBtn = [...document.querySelectorAll('.quick-buttons button')].find(btn =>
    btn.textContent.includes(tip === 'week' ? 'Hafta' : tip === 'month' ? 'Ay' : 'BugÃ¼n')
  );
  if (clickedBtn) clickedBtn.classList.add("active");

  hazirlaYazdirmaOnizleme();
 }



 function acWhatsappModal() {
  const mesaj = olusturWhatsappMesaji(); // HenÃ¼z oluÅŸturulmadÄ±, sÄ±radaki iÅŸ
  document.getElementById("whatsappMesaji").value = mesaj;
  document.getElementById("whatsappModal").style.display = "block";
 }

 function kapatWhatsappModal() {
  document.getElementById("whatsappModal").style.display = "none";
 }
 function olusturWhatsappMesaji() {
  const raporBaslik = "Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Mali Rapor";
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const kayitlar = window.sonFiltrelenenKayitlar || [];

  if (!kayitlar.length) return "ğŸ“­ HiÃ§bir kayÄ±t bulunamadÄ±.";

  const tarihMetni = start && end ? `${formatTarih(start)} - ${formatTarih(end)}` : "TÃ¼m KayÄ±tlar";

  let toplamGelir = 0;
  let toplamGider = 0;

  const satirlar = kayitlar.map(k => {
    const tutar = k.tutar.toFixed(2);
    const aciklama = k.aciklama ? ` (${k.aciklama})` : "";
    const satir = `- ${k.aciklama || "AÃ§Ä±klama Yok"} | ${capitalize(k.odeme)} | ${tutar} â‚º`;

    if (k.tip === "gelir") toplamGelir += k.tutar;
    else if (k.tip === "gider") toplamGider += k.tutar;

    return { satir, tip: k.tip };
  });

  const gelirSatirlari = satirlar.filter(s => s.tip === "gelir").map(s => s.satir).join("\n") || "- Yok";
  const giderSatirlari = satirlar.filter(s => s.tip === "gider").map(s => s.satir).join("\n") || "- Yok";

  const fark = toplamGelir - toplamGider;

  const mesaj =
`ğŸ“„ *${raporBaslik}*

ğŸ“… Tarih AralÄ±ÄŸÄ±: ${tarihMetni}

ğŸŸ© *Gelir KayÄ±tlarÄ±*
${gelirSatirlari}

ğŸŸ¥ *Gider KayÄ±tlarÄ±*
${giderSatirlari}

ğŸ’° Toplam Gelir: ${toplamGelir.toFixed(2)} â‚º
ğŸ’¸ Toplam Gider: ${toplamGider.toFixed(2)} â‚º
ğŸ“ˆ Fark: ${fark.toFixed(2)} â‚º`;

  return mesaj;
 }
 function gonderWhatsappMesaji() {
  const message = document.getElementById("whatsappMesaji").value.trim();

  if (!message) {
    Swal.fire({
      icon: 'warning',
      title: 'Mesaj BoÅŸ!',
      text: 'LÃ¼tfen Ã¶nce bir mesaj oluÅŸturun.',
      confirmButtonText: 'Tamam'
    });
    return;
  }

  // âœ… encode iÅŸlemini burada doÄŸrudan mesaj Ã¼stÃ¼nde yap
  const url = `https://api.whatsapp.com/send/?text=${encodeURIComponent(message)}`;
  window.open(url, "_blank");
 }





 function tarihiUygula() {
  hazirlaYazdirmaOnizleme(); // Ã–nizlemeyi yenile

  // TÃ¼m hÄ±zlÄ± tarih butonlarÄ±nÄ±n turunculuÄŸunu (active) kaldÄ±r
  document.querySelectorAll('.quick-buttons button').forEach(btn => {
    btn.classList.remove("active");
  });
 }

 function validateForm() {
  let isValid = true;

  const fields = [
    { id: "adSoyad", message: "âš ï¸ Ad Soyad alanÄ± zorunludur." },
    { id: "tc", message: "âš ï¸ TC Kimlik No 11 haneli olmalÄ±dÄ±r.", condition: val => val.length === 11 },
    { id: "ogrNo", message: "âš ï¸ Ã–ÄŸrenci numarasÄ± 4â€“5 rakam olmalÄ±dÄ±r.", condition: val => /^\\d{4,5}$/.test(val) },
    { id: "sinif", message: "âš ï¸ SÄ±nÄ±f seÃ§imi zorunludur." },
    { id: "grup", message: "âš ï¸ Grup seÃ§imi zorunludur." },
    { id: "egitimProgrami", message: "âš ï¸ EÄŸitim programÄ± seÃ§ilmelidir." },
    { id: "kayitTarihi", message: "âš ï¸ KayÄ±t tarihi girilmelidir." },
    { id: "veliAd", message: "âš ï¸ Veli adÄ± girilmelidir." },
    { id: "veliTel1", message: "âš ï¸ Veli cep telefonu girilmelidir." },
    { id: "toplamTutar", message: "âš ï¸ Toplam Ã¶deme tutarÄ± girilmelidir.", condition: val => !isNaN(val) && val.trim() !== "" },
    { id: "taksitSayisi", message: "âš ï¸ Taksit sayÄ±sÄ± girilmelidir." },
    { id: "ilkTaksitTarihi", message: "âš ï¸ Ä°lk taksit tarihi girilmelidir." },
  ];

  fields.forEach(field => {
    const el = document.getElementById(field.id);
    const err = document.getElementById(field.id + "Error");
    const value = el.value.trim();

    if (!value || (field.condition && !field.condition(value))) {
      err.textContent = field.message;
      isValid = false;
    } else {
      err.textContent = "";
    }
  });

  return isValid;
 }

 function olusturTaksitler() {
  const toplamTutarEl = document.getElementById("toplamTutar");
  const taksitSayisiEl = document.getElementById("taksitSayisi");
  const ilkTaksitTarihiEl = document.getElementById("ilkTaksitTarihi");

  const toplamTutar = parseFloat(toplamTutarEl?.dataset.raw || "0");
  let taksitSayisi = parseInt(taksitSayisiEl?.value || "0");
  const ilkTaksitTarihi = ilkTaksitTarihiEl?.value;

  if (isNaN(toplamTutar) || isNaN(taksitSayisi) || !ilkTaksitTarihi) return;

  // âœ… SÄ±nÄ±r kontrolÃ¼
  if (taksitSayisi > 12) {
    taksitSayisi = 12;
    taksitSayisiEl.value = 12;
    alert("âš ï¸ En fazla 12 taksit girilebilir.");
  }

  if (taksitSayisi < 1) {
    taksitSayisi = 1;
    taksitSayisiEl.value = 1;
    alert("âš ï¸ En az 1 taksit olmalÄ±dÄ±r.");
  }

  taksitler = [];

  // ğŸ¯ SayÄ± tam bÃ¶lÃ¼nÃ¼yorsa yuvarlama yok
  if (toplamTutar % taksitSayisi === 0) {
    const esitTutar = toplamTutar / taksitSayisi;

    for (let i = 0; i < taksitSayisi; i++) {
      const tarih = new Date(ilkTaksitTarihi);
      tarih.setMonth(tarih.getMonth() + i);

      taksitler.push({
        tutar: esitTutar,
        tarih: tarih.toISOString().split("T")[0]
      });
    }

  } else {
    // ğŸ” Yuvarlama gerekiyorsa tabanÄ± belirle
    let yuvarlamaTabani = 50;
    if (toplamTutar < 200) {
      yuvarlamaTabani = 20;
    } else if (toplamTutar >= 1000) {
      yuvarlamaTabani = 100;
    }

    const yuvarlanan = Math.floor((toplamTutar / taksitSayisi) / yuvarlamaTabani) * yuvarlamaTabani;
    const fark = toplamTutar - (yuvarlanan * taksitSayisi);

    for (let i = 0; i < taksitSayisi; i++) {
      const tarih = new Date(ilkTaksitTarihi);
      tarih.setMonth(tarih.getMonth() + i);

      taksitler.push({
        tutar: i === 0 ? yuvarlanan + fark : yuvarlanan,
        tarih: tarih.toISOString().split("T")[0]
      });
    }
  }

  renderTaksitKartlari();
  // Yeni taksitler oluÅŸturulurken toplam tutarÄ± bir kez hesapla. BÃ¶ylece taksit kutularÄ±
  // render edilirken manuel deÄŸiÅŸiklikler toplam tutarÄ± etkilemez.
  if (typeof toplamTaksitleriHesapla === 'function') {
    toplamTaksitleriHesapla();
  }
 }








 function tutarGuncelle(degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("toplamTutar").dataset.raw || "0");

  let yeniDeger = parseFloat(document.querySelectorAll(".taksit-tutar")[degisenIndex].value);
  if (isNaN(yeniDeger)) return;

  taksitler[degisenIndex].tutar = yeniDeger;

  const kalanAdet = taksitler.length - 1;
  const kalanTutar = toplamTutar - yeniDeger;

  if (kalanTutar < 0 || kalanAdet <= 0) {
    // HatalÄ± giriÅŸ
    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    const pay = Math.floor(kalanTutar / kalanAdet);
    const fark = kalanTutar - pay * kalanAdet;
    let farkEklendi = false;

    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) {
        t.tutar = pay + (farkEklendi ? 0 : fark);
        farkEklendi = true;
      }
    });
  }

  renderTaksitKartlari(); // DOM'u yeniden oluÅŸtur
 }
 function captureRawAmount() {
  const input = document.getElementById("amount");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }
 function formatAmountLive() {
  const input = document.getElementById("amount");
  const rawValue = parseFloat(input.dataset.raw);

  if (!isNaN(rawValue)) {
    const currency = document.getElementById("currency").value;
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(rawValue);
  }
 }
 function updateCurrencySymbol() {
  const currency = document.getElementById("currency").value;
  const symbolMap = {
    "TRY": "â‚º",
    "USD": "$",
    "EUR": "â‚¬"
  };
  document.getElementById("currency-symbol").textContent = symbolMap[currency] || "";
  formatAmountLive();
 }
 function captureToplamTutar() {
  const input = document.getElementById("toplamTutar");
  const raw = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const parsed = parseFloat(raw);
  input.dataset.raw = !isNaN(parsed) ? parsed.toFixed(2) : "0";
 }
 function formatToplamTutar() {
  const input = document.getElementById("toplamTutar");
  const rawValue = parseFloat(input.dataset.raw);

  if (!isNaN(rawValue)) {
    const currency = document.getElementById("paraBirimi").value;
    const formatter = new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
    });

    input.value = formatter.format(rawValue);
  }
 }
 function updateToplamTutarSymbol() {
  const currency = document.getElementById("paraBirimi").value;
  const symbolMap = {
    "TRY": "â‚º",
    "USD": "$",
    "EUR": "â‚¬"
  };
  document.getElementById("toplamTutarSymbol").textContent = symbolMap[currency] || "";
  formatToplamTutar();
 }


 function formatTaksitGorunumleri() {
  const currency = document.getElementById("paraBirimi")?.value || "TRY";
  const formatter = new Intl.NumberFormat("tr-TR", {
    style: "currency",
    currency,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });

  const tutarInputlar = document.querySelectorAll(".taksit-tutar");
  const gorunumler = document.querySelectorAll(".tutar-gorunum");

  tutarInputlar.forEach((input, index) => {
    const deger = parseFloat(input.value || "0");
    if (!isNaN(deger) && gorunumler[index]) {
      gorunumler[index].textContent = formatter.format(deger);
    }
  });
 }

 // Sayfa yÃ¼klendiÄŸinde baÅŸlat
 document.addEventListener("DOMContentLoaded", () => {
  updateCurrencySymbol();
  formatAmountLive();
 });

 // Para birimi deÄŸiÅŸince gÃ¼ncelle
 document.getElementById("paraBirimi").addEventListener("change", updateCurrencySymbol);
 let taksitSayisi = 0; 

 function taksitEkle() {
  const input = document.getElementById("taksitSayisi");
  let sayi = parseInt(input.value || "0");
  if (sayi >= 12) {
    alert("En fazla 12 taksit ekleyebilirsiniz.");
    return;
  }

  input.value = sayi + 1;
  olusturTaksitTarihiVarsa(); // ilk tarih varsa taksitleri gÃ¼ncelle
 }

 function olusturTaksitTarihiVarsa() {
  const tarih = document.getElementById("ilkTaksitTarihi").value;
  if (tarih) olusturTaksitler();
 }


 function taksitSil(index) {
  const input = document.getElementById("taksitSayisi");
  let sayi = parseInt(input.value || "0");
  if (sayi > 1) {
    input.value = sayi - 1;
    olusturTaksitler();
  }
 }


 // Tarih varsayÄ±lanÄ± bugÃ¼nÃ¼n tarihi
 function bugunISO() {
  const now = new Date();
  return now.toISOString().split("T")[0];
 }

 function renderTaksitKartlari() {
  const container = document.getElementById("taksitKutulari");
  container.innerHTML = "";

  const currency = document.getElementById("paraBirimi")?.value || "TRY";
  const formatter = new Intl.NumberFormat("tr-TR", {
    style: "currency",
    currency,
    minimumFractionDigits: 2
  });

  taksitler.forEach((taksit, index) => {
    const kart = document.createElement("div");
    kart.classList.add("taksit-kart");

    // 1. Etiket
    const label = document.createElement("label");
    label.textContent = `Taksit ${index + 1}`;

    // 2. Tutar input
    const inputTutar = document.createElement("input");
    inputTutar.type = "number";
    inputTutar.classList.add("taksit-tutar");
    inputTutar.value = taksit.tutar;

    // 2.1. FormatlÄ± tutar gÃ¶rÃ¼nÃ¼mÃ¼ (sadece gÃ¶sterim)
    const tutarFormatli = document.createElement("small");
    tutarFormatli.textContent = formatter.format(taksit.tutar);
    tutarFormatli.style.color = "#777";
    tutarFormatli.style.fontSize = "0.85rem";

    // âŒ¨ï¸ Enter'a basÄ±ldÄ±ÄŸÄ±nda gÃ¼ncelle
    inputTutar.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const yeni = parseFloat(inputTutar.value) || 0;
        taksitler[index].tutar = yeni;
        tutarFormatli.textContent = formatter.format(yeni);
        tutarGuncelle(index); // varsa tetikle
      }
    });

    // 3. Tarih input
    const inputTarih = document.createElement("input");
    inputTarih.type = "date";
    inputTarih.classList.add("taksit-tarih");
    inputTarih.value = taksit.tarih;
    inputTarih.onchange = () => guncelleTarih(inputTarih.value, index);

    // 4. GÃ¶rÃ¼nÃ¼m
    const gorunum = document.createElement("small");
    gorunum.style.color = "#555";
    gorunum.textContent = `GÃ¶rÃ¼nÃ¼m: ${formatlaGorunurTarih(taksit.tarih)}`;

    // âœ… 5. KullanÄ±cÄ±ya aÃ§Ä±klayÄ±cÄ± not
    const not = document.createElement("small");
    not.style.color = "#888";
    not.style.fontSize = "0.8rem";
    not.style.marginTop = "4px";
    not.textContent = "ğŸ’¡ TutarÄ± deÄŸiÅŸtirdikten sonra Enter'a basÄ±n.";

    // 6. Silme butonu
    const silBtn = document.createElement("button");
    silBtn.classList.add("taksit-sil-btn");
    silBtn.textContent = "âŒ";
    silBtn.onclick = () => {
      taksitSil(index);
      renderTaksitKartlari();
    };

    // KartÄ± oluÅŸtur
    kart.appendChild(label);
    kart.appendChild(inputTutar);
    kart.appendChild(tutarFormatli);   // ğŸ†• BiÃ§imli gÃ¶sterim
    kart.appendChild(inputTarih);
    kart.appendChild(gorunum);
    kart.appendChild(not);
    kart.appendChild(silBtn);

    container.appendChild(kart);
  });

  //
  // Not: previously we recalculated the "Toplam Tutar" whenever the taksit cards were rendered.
  // This caused the total amount input to update when the user manually adjusted a single installment
  // amount and pressed Enter. The desired behaviour is that the overall total remains what the
  // user initially specified, and only the remaining instalments are recalculated. Therefore
  // we removed the automatic call to toplamTaksitleriHesapla() here. The total will instead be
  // calculated once when new taksitler are first created in olusturTaksitler().
  // toplamTaksitleriHesapla();
 }





 function toplamTaksitleriHesapla() {
  const inputlar = document.querySelectorAll(".taksit-kart input[type='number']");
  let toplam = 0;

  inputlar.forEach(input => {
    const deger = parseFloat(input.value);
    if (!isNaN(deger)) {
      toplam += deger;
    }
  });

  const toplamGosterge = document.getElementById("toplamTutar");
  if (toplamGosterge) {
    const formatted = toplam.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    toplamGosterge.textContent = `${formatted} â‚º`;
    toplamGosterge.dataset.raw = toplam.toFixed(2);
  }
 }






 function guncelleTutar(yeniDeger, degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("toplamTutar")?.dataset.raw || "0");
  const yeniTutar = parseFloat(yeniDeger) || 0;

  taksitler[degisenIndex].tutar = yeniTutar;

  const kalanTaksitler = taksitler.length - 1;
  const kalanTutar = toplamTutar - yeniTutar;

  if (kalanTaksitler <= 0 || kalanTutar < 0) {
    // HatalÄ± giriÅŸ: kalan taksit yok veya tutar fazla
    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    const yeniTaksit = Math.floor(kalanTutar / kalanTaksitler);
    const fark = kalanTutar - yeniTaksit * kalanTaksitler;

    let farkDagitildi = false;

    taksitler.forEach((t, i) => {
      if (i !== degisenIndex) {
        t.tutar = yeniTaksit;
        if (!farkDagitildi) {
          t.tutar += fark;
          farkDagitildi = true;
        }
      }
    });
  }

  renderTaksitKartlari(); // DOM'u gÃ¼ncelle
 }





 function guncelleTarih(yeni, index) {
  taksitler[index].tarih = yeni;
  renderTaksitKartlari(); // Tarih deÄŸiÅŸince kartlarÄ± yeniden Ã§iz
 }

 function formatlaGorunurTarih(isoTarih) {
  const tarih = new Date(isoTarih);
  return tarih.toLocaleDateString("tr-TR", {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
 }
 document.addEventListener("DOMContentLoaded", () => {
  ayarlaIslemTarihi();     // ğŸ” Ä°ÅŸlem tarihi input ve gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼nceller
  const now = new Date();
 now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // TÃ¼rkiye saati dÃ¼zeltme
 const isoTarih = now.toISOString().split("T")[0];

 document.getElementById("kayitTarihi").value = isoTarih;
 });

 function guncelleKayitTarihi() {
  const secilen = document.getElementById("kayitTarihi").value;
  const gorunum = document.getElementById("kayitTarihiGorunum");

  if (secilen && gorunum) {
    const tarih = new Date(secilen);
    gorunum.textContent = tarih.toLocaleDateString("tr-TR", {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
  }
 }


 function ayarlaIslemTarihi() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC -> Local fix
  const iso = now.toISOString().split("T")[0];
  
  document.getElementById("islemTarihi").value = iso;
  document.getElementById("islemTarihiGorunum").textContent = formatlaGorunurTarih(iso);
 }


 document.addEventListener("DOMContentLoaded", () => {
  ayarlaIslemTarihi(); // Form aÃ§Ä±ldÄ±ÄŸÄ±nda iÅŸlem tarihi hazÄ±r
 });
 document.addEventListener("DOMContentLoaded", () => {
  // Ã–rnek varsayÄ±lan 1 taksit
  taksitEkle(0, bugunISO());
 });


 function getOgrenciBilgileri() {
  return {
    adSoyad: getValue("adSoyad"),
    tc: getValue("tc"),
    ogrNo: getValue("ogrNo"),
    sinif: getValue("sinif"),
    grup: getValue("grup"),
    dogumTarihi: getValue("dogumTarihi"),
    okul: getValue("okul"),
    egitimProgrami: getValue("egitimProgrami"),
    kayitTarihi: getValue("kayitTarihi"),
    islemTarihi: getValue("islemTarihi")
  };
 }
 function getVeliBilgileri() {
  return {
    adSoyad: getValue("veliAd"),
    telefon1: getValue("veliTel1"),
    telefon2: getValue("veliTel2", true) // opsiyonel
  };
 }
 function getTaksitListesi() {
  const kartlar = document.querySelectorAll(".taksit-kart");
  const liste = [];

  kartlar.forEach(kart => {
    const tutar = kart.querySelector("input[type='number']")?.value;
    const tarih = kart.querySelector("input[type='date']")?.value;

    if (tutar && tarih) {
      liste.push({
        tutar: parseFloat(tutar),
        tarih: tarih
      });
    }
  });

  return liste;
 }
 function toplaTumVeri() {
  return {
    ogrenci: getOgrenciBilgileri(),
    veli: getVeliBilgileri(),
    odeme: {
  taksitler: getTaksitListesi(),
  paraBirimi: getValue("paraBirimi"), // <select id="paraBirimi">
 toplamTutar: parseFloat(document.getElementById("toplamTutar")?.dataset.raw || "0")
},
    eklenmeZamani: new Date().toISOString()
  };
 }

 function getValue(id, optional = false) {
  const el = document.getElementById(id);
  if (!el && !optional) {
    throw new Error(`Form elemanÄ± bulunamadÄ±: #${id}`);
  }
  return el?.value.trim() || "";
 }

 function kaydetOgrenci() {
  try {
    const veri = toplaTumVeri();

    // âœ… TC ve Ã–ÄŸrenci No boÅŸ mu kontrolÃ¼
    if (!veri.ogrenci.tc || !veri.ogrenci.ogrNo) {
      alert("ğŸš« TC Kimlik No ve Ã–ÄŸrenci NumarasÄ± boÅŸ olamaz.");
      return;
    }

    // ğŸ” Firebase'de bu TC veya Ã–ÄŸrenci No ile kayÄ±tlÄ± Ã¶ÄŸrenci var mÄ± kontrolÃ¼
    firebase.database().ref("ogrenciler").once("value")
      .then(snapshot => {
        const data = snapshot.val();
        let tcVar = false;
        let ogrNoVar = false;

        if (data) {
          for (let id in data) {
            const ogr = data[id];
            if (ogr?.ogrenci?.tc === veri.ogrenci.tc) tcVar = true;
            if (ogr?.ogrenci?.ogrNo === veri.ogrenci.ogrNo) ogrNoVar = true;
            if (tcVar || ogrNoVar) break;
          }
        }

        if (tcVar) {
          alert("ğŸš« Bu TC Kimlik NumarasÄ±na sahip bir Ã¶ÄŸrenci zaten kayÄ±tlÄ±.");
          return;
        }

        if (ogrNoVar) {
          alert("ğŸš« Bu Ã–ÄŸrenci NumarasÄ±na sahip bir Ã¶ÄŸrenci zaten kayÄ±tlÄ±.");
          return;
        }

        // âœ… Her ÅŸey uygunsa kayÄ±t yapÄ±lÄ±r
        return firebase.database().ref("ogrenciler").push(veri)
          .then(() => {
            alert("âœ… KayÄ±t baÅŸarÄ±yla tamamlandÄ±.");
            sayfayiGercektenYenile(); // Formu sÄ±fÄ±rla
          });
      })
      .catch((err) => {
        console.error("Firebase HatasÄ±:", err);
        alert("âŒ KayÄ±t baÅŸarÄ±sÄ±z: " + err.message);
      });

  } catch (err) {
    alert("ğŸš¨ Hata: " + err.message);
  }
 }


 document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("ogrenciKayitFormu");
  if (form) {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      kaydetOgrenci();
    });
  }
 });



 function sayfayiYenile() {
  Swal.fire({
    title: 'Form sÄ±fÄ±rlansÄ±n mÄ±?',
    text: "Bu iÅŸlem geri alÄ±namaz.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Evet, sÄ±fÄ±rla',
    cancelButtonText: 'VazgeÃ§',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6'
  }).then((result) => {
    if (result.isConfirmed) {
      sayfayiGercektenYenile(); // sÄ±fÄ±rlama iÅŸlemini ayrÄ± fonksiyonda yap
    }
  });
 }
 document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTC dÃ¼zelt
  const today = now.toISOString().split("T")[0];

  const dateInput = document.getElementById("date");
  if (dateInput) dateInput.value = today;
 });

 function sayfayiGercektenYenile() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const today = now.toISOString().split("T")[0];

  // Form alanlarÄ±nÄ± temizle
  const alanlar = [
    "adSoyad", "tc", "ogrNo", "sinif", "grup", "dogumTarihi",
    "okul", "egitimProgrami", "kayitTarihi", "islemTarihi",
    "veliAd", "veliTel1", "veliTel2",
    "taksitSayisi", "ilkTaksitTarihi"
  ];
  alanlar.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // BugÃ¼nÃ¼n tarihi atanacak alanlar
  const kayitEl = document.getElementById("kayitTarihi");
  const islemEl = document.getElementById("islemTarihi");
  if (kayitEl) kayitEl.value = today;
  if (islemEl) islemEl.value = today;

  const toplamEl = document.getElementById("toplamTutar");
  if (toplamEl) {
    toplamEl.dataset.raw = "0";
    toplamEl.value = "";
    formatAmountLive();
  }

  const kutular = document.getElementById("taksitKutulari");
  if (kutular) kutular.innerHTML = "";

  if (typeof taksitler !== "undefined") taksitler = [];

  if (typeof toplamTaksitleriHesapla === "function") toplamTaksitleriHesapla();
 }



 function telefonGirisFormatla(input) {
  let raw = input.value.replace(/\D/g, "").slice(0, 10); // En fazla 10 rakam
  let formatted = "";

  if (raw.length > 0) {
    formatted += "(" + raw.substring(0, 3);
  }
  if (raw.length >= 4) {
    formatted += ") " + raw.substring(3, 6);
  }
  if (raw.length >= 7) {
    formatted += " " + raw.substring(6, 8);
  }
  if (raw.length >= 9) {
    formatted += " " + raw.substring(8, 10);
  }

  input.value = formatted;
 }

 function temizTelefon(numaraliGiris) {
  let numara = numaraliGiris.replace(/\D/g, ""); // TÃ¼m rakamlarÄ± al
  if (numara.length === 10) {
    return "90" + numara; // TÃ¼rkiye iÃ§in Ã¼lke kodu ekle
  }
  return numara;
 }

 // Ã–rnek kullanÄ±m: whatsapp
 let veliTel1 = document.getElementById("veliTel1").value;
 let temiz1 = temizTelefon(veliTel1); // "90554XXXXXXX"



 //***************************

 async function ogrListele() {
  // Sayfa sÄ±fÄ±rlama (yeni listeleme yapÄ±ldÄ±ÄŸÄ±nda)
  if (typeof ogrAktifSayfa === 'undefined') ogrAktifSayfa = 1;

  const ogrNo = document.getElementById("ogrAraNo").value.trim().toLowerCase();
  const adSoyad = document.getElementById("ogrAraAdSoyad").value.trim().toLowerCase();
  const tc = document.getElementById("ogrAraTC").value.trim();
  const program = document.getElementById("ogrAraProgram").value;

  const sayfaBoyutu = parseInt(document.getElementById("ogrSayfaBoyutu").value);
  const kartListesi = document.getElementById("ogrKartListesi");
  const toplamEl = document.getElementById("ogrToplam");
  const paginationDiv = document.getElementById("ogrPagination");

  kartListesi.innerHTML = `<p>YÃ¼kleniyor...</p>`;
  paginationDiv.innerHTML = "";

  try {
    const snapshot = await firebase.database().ref("ogrenciler").once("value");
    const veriler = snapshot.val() || {};
    const liste = Object.entries(veriler).map(([id, data]) => ({ id, ...data }));

    // ğŸ” Filtreleme
    const filtreli = liste.filter(item => {
      const no = (item.ogrenci?.ogrNo || "").toLowerCase();
      const ad = (item.ogrenci?.adSoyad || "").toLowerCase();
      const tcno = (item.ogrenci?.tc || "");
      const prog = (item.ogrenci?.egitimProgrami || "");

      return (!ogrNo || no.includes(ogrNo)) &&
             (!adSoyad || ad.includes(adSoyad)) &&
             (!tc || tcno.includes(tc)) &&
             (!program || prog === program);
    });

    // FiltrelenmiÅŸ listeyi dÄ±ÅŸa aktarmada kullanmak Ã¼zere global deÄŸiÅŸkende sakla
    window.filteredOgrenciler = filtreli;

    // ğŸ“„ Sayfalama hesaplamasÄ±
    const toplamSayfa = Math.ceil(filtreli.length / sayfaBoyutu);
    if (ogrAktifSayfa > toplamSayfa) ogrAktifSayfa = 1;

    const basla = (ogrAktifSayfa - 1) * sayfaBoyutu;
    const bitir = basla + sayfaBoyutu;
    const sayfaVeri = filtreli.slice(basla, bitir);

    // ğŸ§± KartlarÄ± OluÅŸtur
    const kartlarHTML = sayfaVeri.map(item => `
      <div class="record-card ${renkSinifi(item.ogrenci?.sinif)}">
        <div class="ogrenci-kart-header">
          <div class="ogrenci-ad"><span>ğŸ‘¤</span> <strong>${item.ogrenci?.adSoyad || "-"}</strong></div>
          <div class="ogrenci-sinif">ğŸ« ${item.ogrenci?.sinif || ""} / ${item.ogrenci?.grup || ""}</div>
        </div>

        <div class="ogrenci-info">
          <div class="ogrenci-no">ğŸ†” <strong>Ã–ÄŸrenci No:</strong> ${item.ogrenci?.ogrNo || "-"}</div>
          <div class="ogrenci-program">ğŸ“ <strong>Program:</strong> ${item.ogrenci?.egitimProgrami || "-"}</div>
        </div>

        <div class="ogrenci-info">
          <div class="ogrenci-veli">ğŸ‘ª <strong>Veli:</strong> ${item.veli?.adSoyad || "-"}</div>
          <div class="ogrenci-tutar">ğŸ’° <strong>Toplam Tutar:</strong> â‚º${parseFloat(item.odeme?.toplamTutar || 0).toLocaleString("tr-TR")}</div>
        </div>

        <div class="record-actions">
          <button class="btn-guncelle" onclick="ogrenciGuncelle('${item.id}')">âœï¸ DÃ¼zenle</button>
          <button class="btn-sil" onclick="ogrenciSil('${item.id}')">ğŸ—‘ Sil</button>
        </div>
      </div>
    `).join("");

    // ğŸ“¤ KartlarÄ± GÃ¶ster
    kartListesi.innerHTML = kartlarHTML || `<p>HiÃ§ Ã¶ÄŸrenci bulunamadÄ±.</p>`;
    toplamEl.textContent = `Toplam: ${filtreli.length} Ã¶ÄŸrenci`;

    // ğŸ“Œ Sayfa ButonlarÄ±
    if (toplamSayfa > 1) {
      const once = document.createElement("button");
      once.textContent = "â¬…ï¸ Geri";
      once.disabled = ogrAktifSayfa === 1;
      once.onclick = () => {
        ogrAktifSayfa--;
        ogrListele();
      };

      const ileri = document.createElement("button");
      ileri.textContent = "Ä°leri â¡ï¸";
      ileri.disabled = ogrAktifSayfa === toplamSayfa;
      ileri.onclick = () => {
        ogrAktifSayfa++;
        ogrListele();
      };

      const bilgi = document.createElement("span");
      bilgi.textContent = `Sayfa ${ogrAktifSayfa} / ${toplamSayfa}`;
      bilgi.style.padding = "6px";

      paginationDiv.appendChild(once);
      paginationDiv.appendChild(bilgi);
      paginationDiv.appendChild(ileri);
    }

  } catch (err) {
    kartListesi.innerHTML = `<p style="color: red;">Hata oluÅŸtu: ${err.message}</p>`;
    toplamEl.textContent = "";
  }
 }


 function renkSinifi(sinif) {
  if (!sinif) return "renk-default";

  const s = sinif.toString().toLowerCase();

  if (s.includes("1")) return "renk-mavi";
  if (s.includes("2")) return "renk-yesil";
  if (s.includes("3")) return "renk-lila";
  if (s.includes("4")) return "renk-sari";
  if (s.includes("5")) return "renk-pembe";
  if (s.includes("6")) return "renk-kahve";
  if (s.includes("7")) return "renk-kirmizi";
  if (s.includes("8")) return "renk-turuncu";

  return "renk-default";
 }

 function ogrYenile() {
  // Filtre alanlarÄ±nÄ± temizle
  document.getElementById("ogrAraNo").value = "";
  document.getElementById("ogrAraAdSoyad").value = "";
  document.getElementById("ogrAraTC").value = "";
  document.getElementById("ogrAraProgram").value = "";
  document.getElementById("ogrSayfaBoyutu").value = "10";

  // KartlarÄ± temizle
  const kartListesi = document.getElementById("ogrKartListesi");
  kartListesi.innerHTML = `<p>HenÃ¼z listeleme yapÄ±lmadÄ±.</p>`;

  // Toplam Ã¶ÄŸrenci sayÄ±sÄ±nÄ± sÄ±fÄ±rla
  const toplamEl = document.getElementById("ogrToplam");
  toplamEl.textContent = `Toplam: 0 Ã¶ÄŸrenci`;
 }

 document.getElementById("ogrSayfaBoyutu").addEventListener("change", () => {
  ogrAktifSayfa = 1;
  ogrListele();
 });

 async function ogrenciGuncelle(id) {
  try {
    const snapshot = await firebase.database().ref("ogrenciler/" + id).once("value");
    const data = snapshot.val();

    if (!data || !data.ogrenci) {
      alert("Ã–ÄŸrenci verisi alÄ±namadÄ±.");
      return;
    }

    // Ã–ÄŸrenci bilgileri
    document.getElementById("guncelleAdSoyad").value = data.ogrenci.adSoyad || "";
    document.getElementById("guncelleDogumTarihi").value = data.ogrenci.dogumTarihi || "";
    document.getElementById("guncelleOgrNo").value = data.ogrenci.ogrNo || "";
    document.getElementById("guncelleSinif").value = data.ogrenci.sinif || "";
    document.getElementById("guncelleGrup").value = data.ogrenci.grup || "";
    document.getElementById("guncelleOkul").value = data.ogrenci.okul || "";
    document.getElementById("guncelleProgram").value = data.ogrenci.egitimProgrami || "";
    document.getElementById("guncelleKayitTarihi").value = data.ogrenci.kayitTarihi || "";
    document.getElementById("guncelleIslemTarihi").value = data.ogrenci.islemTarihi || "";

    // Veli bilgileri
    document.getElementById("guncelleVeliAd").value = data.veli?.adSoyad || "";
    document.getElementById("guncelleVeliTel1").value = data.veli?.telefon1 || "";
    document.getElementById("guncelleVeliTel2").value = data.veli?.telefon2 || "";

    // Ã–deme bilgileri
    const toplamTutar = data.odeme?.toplamTutar || 0;
    const paraBirimi = data.odeme?.paraBirimi || "TRY";
    const taksitler = data.odeme?.taksitler || {};

    document.getElementById("guncelleToplamTutar").value = toplamTutar;
    document.getElementById("guncelleParaBirimi").value = paraBirimi;

    const taksitSayisi = Object.keys(taksitler).length || 1;
    document.getElementById("guncelleTaksitSayisi").value = taksitSayisi;

    // ğŸ†• Takip deÄŸiÅŸkeni
    guncelleTaksitler = [];

    // ğŸ§± Taksit kutularÄ±nÄ± oluÅŸtur
    const taksitDiv = document.getElementById("guncelleTaksitlerAlani");
    taksitDiv.innerHTML = "";
    taksitDiv.style.display = "grid";
    taksitDiv.style.gridTemplateColumns = "1fr 1fr";
    taksitDiv.style.gap = "1rem";

    for (let i = 0; i < taksitSayisi; i++) {
      const val = taksitler[i] || { tarih: "", tutar: 0 };

      const kart = document.createElement("div");
      kart.className = "taksit-kart";

      const label = document.createElement("label");
      label.textContent = `Taksit ${i + 1}`;

      const tutarInput = document.createElement("input");
      tutarInput.type = "number";
      tutarInput.classList.add("taksitTutarInput");
      tutarInput.value = val.tutar || 0;

      tutarInput.addEventListener("blur", () => {
        yenidenDagit(i); // ğŸ” DiÄŸer taksitleri yeniden hesapla
      });

      const tarihInput = document.createElement("input");
      tarihInput.type = "date";
      tarihInput.classList.add("taksitTarihInput");
      tarihInput.value = val.tarih || new Date().toISOString().split("T")[0];

      tarihInput.addEventListener("input", e => {
        guncelleTaksitler[i].tarih = e.target.value;
      });

      guncelleTaksitler.push({
        tutar: parseFloat(tutarInput.value),
        tarih: tarihInput.value
      });

      kart.appendChild(label);
      kart.appendChild(tutarInput);
      kart.appendChild(tarihInput);
      taksitDiv.appendChild(kart);
    }

    // ğŸ‘‰ Toplam tutar veya taksit sayÄ±sÄ± deÄŸiÅŸirse yeniden hesapla
    const toplamTutarInput = document.getElementById("guncelleToplamTutar");
    const taksitSayiInput = document.getElementById("guncelleTaksitSayisi");

    if (toplamTutarInput) {
      toplamTutarInput.addEventListener("input", guncelleTaksitKutulariniOlustur);
    }

    if (taksitSayiInput) {
      taksitSayiInput.addEventListener("input", guncelleTaksitKutulariniOlustur);
    }

    // Gizli ID alanÄ±
    document.getElementById("guncelleOgrId").value = id;

    // ModalÄ± aÃ§
    document.getElementById("ogrenciGuncelleModal").style.display = "flex";

  } catch (err) {
    console.error("Hata:", err);
    alert("Veri alÄ±namadÄ±: " + err.message);
  }
 }

 function guncelleTaksitKutulariniOlustur() {
  const container = document.getElementById("guncelleTaksitlerAlani");
  container.innerHTML = "";
  container.style.display = "grid";
  container.style.gridTemplateColumns = "1fr 1fr";
  container.style.gap = "1rem";

  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar")?.value || "0");
  const taksitSayisi = parseInt(document.getElementById("guncelleTaksitSayisi")?.value || "0");

  if (isNaN(toplamTutar) || isNaN(taksitSayisi) || taksitSayisi < 1) return;

  const kalanTaksitSayisi = taksitSayisi - 1;
  const ortalama = Math.floor((toplamTutar / taksitSayisi) / 50) * 50;
  const kalanToplam = ortalama * kalanTaksitSayisi;
  const ilkTaksit = toplamTutar - kalanToplam;

  guncelleTaksitler = [];

  // ğŸ“… Taksit tarihlerini ayarla: ilk taksit tarihini belirle ve her biri iÃ§in ay ekle
  let basTarih = null;
  if (Array.isArray(guncelleTaksitler) && guncelleTaksitler.length > 0 && guncelleTaksitler[0].tarih) {
    basTarih = new Date(guncelleTaksitler[0].tarih);
  } else {
    basTarih = new Date();
  }
  for (let i = 0; i < taksitSayisi; i++) {
    const taksitDiv = document.createElement("div");
    taksitDiv.classList.add("taksit-kart");

    const label = document.createElement("label");
    label.textContent = `Taksit ${i + 1}`;

    const tutarInput = document.createElement("input");
    tutarInput.type = "number";
    tutarInput.classList.add("taksitTutarInput");
    tutarInput.value = i === 0 ? ilkTaksit.toFixed(2) : ortalama.toFixed(2);

    const tarihInput = document.createElement("input");
    tarihInput.type = "date";
    tarihInput.classList.add("taksitTarihInput");
    const d = new Date(basTarih.getTime());
    d.setMonth(d.getMonth() + i);
    tarihInput.value = d.toISOString().split("T")[0];

    guncelleTaksitler.push({
      tutar: parseFloat(tutarInput.value),
      tarih: tarihInput.value
    });

    tutarInput.addEventListener("blur", () => {
      yenidenDagit(i);
    });

    tarihInput.addEventListener("input", (e) => {
      guncelleTaksitler[i].tarih = e.target.value;
    });

    taksitDiv.appendChild(label);
    taksitDiv.appendChild(tutarInput);
    taksitDiv.appendChild(tarihInput);
    container.appendChild(taksitDiv);
  }
 }

 function guncelleTaksitEkle() {
  const mevcutSayi = parseInt(document.getElementById("guncelleTaksitSayisi").value) || 1;
  const yeniSayi = mevcutSayi + 1;
  document.getElementById("guncelleTaksitSayisi").value = yeniSayi;

  guncelleTaksitKutulariniOlustur(); // otomatik daÄŸÄ±tÄ±m yapÄ±lÄ±r
 }

 function guncelleTaksitSil() {
  const mevcutSayi = parseInt(document.getElementById("guncelleTaksitSayisi").value) || 1;

  if (mevcutSayi <= 1) {
    alert("En az 1 taksit kalmalÄ±dÄ±r.");
    return;
  }

  const yeniSayi = mevcutSayi - 1;
  document.getElementById("guncelleTaksitSayisi").value = yeniSayi;

  guncelleTaksitKutulariniOlustur(); // yeniden dengeli ÅŸekilde oluÅŸturulur
 }

 async function kaydetGuncelle() {
  const id = document.getElementById("guncelleOgrId").value;
  if (!id) {
    alert("ID bulunamadÄ±.");
    return;
  }

  // ğŸ“˜ Zorunlu alanlar
  const adSoyad = document.getElementById("guncelleAdSoyad").value.trim();
  const ogrNo = document.getElementById("guncelleOgrNo").value.trim();
  const veliAd = document.getElementById("guncelleVeliAd").value.trim();
  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar").value) || 0;

  if (!adSoyad || !ogrNo || !veliAd || toplamTutar <= 0) {
    alert("âš ï¸ Ad Soyad, Ã–ÄŸrenci No, Veli AdÄ± ve Toplam Tutar alanlarÄ±nÄ± eksiksiz doldurun.");
    return;
  }

  // ğŸ“˜ Ã–ÄŸrenci bilgileri
  const ogrenci = {
    adSoyad,
    ogrNo,
    sinif: document.getElementById("guncelleSinif").value.trim(),
    grup: document.getElementById("guncelleGrup").value.trim(),
    egitimProgrami: document.getElementById("guncelleProgram").value.trim(),
    dogumTarihi: document.getElementById("guncelleDogumTarihi")?.value || "",
    okul: document.getElementById("guncelleOkul")?.value || "",
    kayitTarihi: document.getElementById("guncelleKayitTarihi")?.value || "",
    islemTarihi: document.getElementById("guncelleIslemTarihi")?.value || ""
  };

  // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Veli bilgileri
  const veli = {
    adSoyad: veliAd,
    telefon1: document.getElementById("guncelleVeliTel1")?.value.trim() || "",
    telefon2: document.getElementById("guncelleVeliTel2")?.value.trim() || ""
  };

  // ğŸ’³ Ã–deme bilgileri
  const odeme = {
    toplamTutar,
    paraBirimi: document.getElementById("guncelleParaBirimi")?.value || "TRY",
    taksitler: {}
  };

  const tarihInputs = document.querySelectorAll(".taksitTarihInput");
  const tutarInputs = document.querySelectorAll(".taksitTutarInput");

  tarihInputs.forEach((tarihInput, index) => {
    const tarih = tarihInput.value || "";
    const tutar = parseFloat(tutarInputs[index].value) || 0;
    odeme.taksitler[index] = { tarih, tutar };
  });

  try {
    await firebase.database().ref(`ogrenciler/${id}`).set({
      ogrenci,
      veli,
      odeme,
      guncellenmeZamani: new Date().toISOString()
    });

    alert("âœ… Ã–ÄŸrenci baÅŸarÄ±yla gÃ¼ncellendi.");
    document.getElementById("ogrenciGuncelleModal").style.display = "none";

    if (typeof ogrListele === "function") {
      ogrListele(); // listeyi yenile
    }

  } catch (err) {
    alert("âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z: " + err.message);
  }
 }
 function kapatGuncelleModal() {
  const modal = document.getElementById("ogrenciGuncelleModal");
  if (modal) {
    modal.style.display = "none";
  }

  // ğŸ§¼ Formu temizle
  document.getElementById("guncelleOgrId").value = "";
  document.getElementById("guncelleAdSoyad").value = "";
  document.getElementById("guncelleDogumTarihi").value = "";
  document.getElementById("guncelleOgrNo").value = "";
  document.getElementById("guncelleSinif").value = "";
  document.getElementById("guncelleGrup").value = "";
  document.getElementById("guncelleOkul").value = "";
  document.getElementById("guncelleProgram").value = "";
  document.getElementById("guncelleKayitTarihi").value = "";
  document.getElementById("guncelleIslemTarihi").value = "";

  document.getElementById("guncelleVeliAd").value = "";
  document.getElementById("guncelleVeliTel1").value = "";
  document.getElementById("guncelleVeliTel2").value = "";

  document.getElementById("guncelleParaBirimi").value = "TRY";
  document.getElementById("guncelleToplamTutar").value = "";
  document.getElementById("guncelleTaksitSayisi").value = "";

  const taksitAlan = document.getElementById("guncelleTaksitlerAlani");
  if (taksitAlan) taksitAlan.innerHTML = "";

  if (typeof guncelleTaksitler !== "undefined") {
    guncelleTaksitler = [];
  }
 }
 function yenidenDagit(degisenIndex) {
  const toplamTutar = parseFloat(document.getElementById("guncelleToplamTutar").value) || 0;
  const taksitSayisi = guncelleTaksitler.length;

  // KullanÄ±cÄ±nÄ±n deÄŸiÅŸtirdiÄŸi taksit
  const sabitTutar = parseFloat(document.querySelectorAll(".taksitTutarInput")[degisenIndex].value) || 0;
  guncelleTaksitler[degisenIndex].tutar = sabitTutar;

  // Kalan tutar ve kalan taksit sayÄ±sÄ±
  const kalanTaksitler = taksitSayisi - 1;
  const kalanTutar = toplamTutar - sabitTutar;

  if (kalanTaksitler <= 0 || kalanTutar <= 0) {
    // DiÄŸerlerini sÄ±fÄ±rla
    guncelleTaksitler.forEach((t, i) => {
      if (i !== degisenIndex) t.tutar = 0;
    });
  } else {
    // 50â€™nin katÄ± olacak ÅŸekilde bÃ¶lÃ¼ÅŸtÃ¼r
    const ortalama = Math.floor((kalanTutar / kalanTaksitler) / 50) * 50;
    const toplamBolen = ortalama * kalanTaksitler;
    const fark = kalanTutar - toplamBolen;

    let farkDagitildi = false;
    guncelleTaksitler.forEach((t, i) => {
      if (i === degisenIndex) return;
      t.tutar = ortalama;
      if (!farkDagitildi && fark > 0) {
        t.tutar += fark;
        farkDagitildi = true;
      }
    });
  }

  // GÃ¼ncel deÄŸerleri inputlara yaz
  const tutarInputs = document.querySelectorAll(".taksitTutarInput");
  guncelleTaksitler.forEach((t, i) => {
    tutarInputs[i].value = t.tutar.toFixed(2);
  });
 }

 async function ogrenciSil(id) {
  const onay = confirm("ğŸ—‘ï¸ Bu Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz.");

  if (!onay) return;

  try {
    await firebase.database().ref("ogrenciler/" + id).remove();

    alert("âœ… Ã–ÄŸrenci baÅŸarÄ±yla silindi.");
    ogrListele(); // Listeyi yeniden yÃ¼kle
  } catch (err) {
    console.error("âŒ Silme hatasÄ±:", err);
    alert("Bir hata oluÅŸtu: " + err.message);
  }
 }

  /* ------------------ TAKSIT LISTELEME VE ODEME ------------------ */
  // Listeleme fonksiyonlarÄ±, taksit ve Ã¶deme sayfalarÄ± iÃ§in
  function taksitListele() {
    // Listeleme: hem normal hem de vadesi geÃ§miÅŸ taksitleri ayÄ±rarak gÃ¶sterir.
    const listEl = document.getElementById("taksitListesi");
    if (!listEl) return;
    const overdueEl = document.getElementById("taksitOverdueListesi");
    const noSearch = document.getElementById("taksitAraNo")?.value.trim().toLowerCase() || "";
    const search = document.getElementById("taksitAraAd")?.value.trim().toLowerCase() || "";
    const durum = document.getElementById("taksitDurum")?.value || "";
    const bas = document.getElementById("taksitBaslangic")?.value || "";
    const bit = document.getElementById("taksitBitis")?.value || "";
    // Temizle
    listEl.innerHTML = "<p>YÃ¼kleniyor...</p>";
    if (overdueEl) overdueEl.innerHTML = "";
    firebase.database().ref("ogrenciler").once("value", snap => {
      const data = snap.val();
      if (!data) {
        listEl.innerHTML = "<p>ğŸ“­ KayÄ±t bulunamadÄ±.</p>";
        return;
      }
      let normalItems = [];
      let overdueItems = [];
      const todayStr = new Date().toISOString().split("T")[0];
      Object.keys(data).forEach(id => {
        const ogr = data[id];
        const ogrBilgi = ogr.ogrenci || {};
        const odeme = ogr.odeme || {};
        const taksitler = odeme.taksitler || {};
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const odendi = t.odendi === true;
          const partialAmount = parseFloat(t.odenen || 0);
          // Duruma gÃ¶re filtrele
          if (durum === "odendi" && !odendi) return;
          if (durum === "odenmedi" && odendi) return;
          const nameLower = (ogrBilgi.adSoyad || "").toLowerCase();
          const ogrNoLower = (ogrBilgi.ogrNo || "").toLowerCase();
          if (search && !nameLower.includes(search)) return;
          if (noSearch && !ogrNoLower.includes(noSearch)) return;
          const tarih = t.tarih || "";
          if (bas && tarih < bas) return;
          if (bit && tarih > bit) return;
          const isOverdue = !odendi && tarih && tarih < todayStr;
          const item = {
            ogrId: id,
            ogrAd: ogrBilgi.adSoyad || "",
            ogrNo: ogrBilgi.ogrNo || "",
            program: ogrBilgi.egitimProgrami || "",
            index: idx,
            tutar: parseFloat(t.tutar || 0),
            tarih: tarih,
            odendi: odendi,
            partial: partialAmount,
            paraBirimi: odeme.paraBirimi || "TRY",
            veliTel: ogrBilgi.velTel || ""
          };
          if (isOverdue) overdueItems.push(item); else normalItems.push(item);
        });
      });
      // Tarihe gÃ¶re sÄ±rala
      normalItems.sort((a,b) => new Date(a.tarih) - new Date(b.tarih));
      overdueItems.sort((a,b) => new Date(a.tarih) - new Date(b.tarih));
      // Normal listeyi yaz
      listEl.innerHTML = "";
      if (normalItems.length === 0) {
        listEl.innerHTML = "<p>ğŸ“­ Taksit bulunamadÄ±.</p>";
      } else {
        normalItems.forEach(item => {
          const div = document.createElement("div");
          // Her kart iÃ§in benzersiz bir id ata, bÃ¶ylece Ã¶deme iÅŸlemi sonrasÄ± aynÄ± karta kaydÄ±rabiliriz
          div.id = `taksit-${item.ogrId}-${item.index}`;
          // SÄ±nÄ±f belirleme: Ã¶denmiÅŸ, kÄ±smi veya Ã¶denmemiÅŸ
          let cardClass = "record-card";
          if (item.odendi) {
            cardClass += " taksit-odendi";
          } else if (item.partial > 0) {
            cardClass += " taksit-kismi";
          } else {
            cardClass += " taksit-odenmedi";
          }
          div.className = cardClass;
          const symbolMap = { "TRY":"â‚º", "USD":"$", "EUR":"â‚¬" };
          const sym = symbolMap[item.paraBirimi] || "";
          const formattedAmount = `${item.tutar.toFixed(2)} ${sym}`;
          const kalan = Math.max(0, item.tutar - item.partial).toFixed(2);
          const durumText = item.odendi ? "Ã–dendi" : (item.partial > 0 ? "KÄ±smi Ã–dendi" : "Ã–denmedi");
          let actionsHTML = "";
          if (item.odendi) {
            // Ã–dendi: Ã¶denmediye Ã§evir ve makbuz gÃ¶rÃ¼ntÃ¼le butonlarÄ±
            actionsHTML += `<button class="btn-guncelle" onclick="taksitSetOdenmedi('${item.ogrId}','${item.index}')">Ã–denmedi</button>`;
            actionsHTML += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
          } else {
            // Ã–denmedi veya kÄ±smi: Ã¶deme, kÄ±smi Ã¶deme ve kÄ±smi geri al seÃ§enekleri
            actionsHTML += `<button class="btn-guncelle" onclick="taksitSetOdendi('${item.ogrId}','${item.index}')">Ã–dendi</button>`;
            actionsHTML += `<button class="btn-guncelle" onclick="taksitKismiOdeme('${item.ogrId}','${item.index}',${item.tutar},${item.partial})">KÄ±smi Ã–deme</button>`;
            if (item.partial > 0) {
              actionsHTML += `<button class="btn-guncelle" onclick="taksitKismiGeriAl('${item.ogrId}','${item.index}')">KÄ±smi Geri Al</button>`;
              // KÄ±smi Ã¶denmiÅŸ taksitlerde makbuz gÃ¶rÃ¼ntÃ¼leme seÃ§eneÄŸi
              actionsHTML += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
            }
          }
          // Kart iÃ§eriÄŸi
          div.innerHTML = `
          <div class="record-header">
            <span>${item.ogrAd} (${item.ogrNo})</span>
            <span>${formattedAmount}</span>
          </div>
          <div class="record-details">
            <span>Program: <strong>${item.program}</strong></span> |
            <span>Tarih: <strong>${formatTarih(item.tarih)}</strong></span> |
            <span>Durum: <strong>${durumText}</strong></span>
          </div>
          <div class="record-details">
            <span>Kalan: <strong>${kalan} ${sym}</strong></span>
          </div>
          <div class="record-actions">
            ${actionsHTML}
          </div>
          `;
          listEl.appendChild(div);
        });
      }
      // Vadesi geÃ§miÅŸleri yaz
      if (overdueEl) {
        overdueEl.innerHTML = "";
        if (overdueItems.length > 0) {
          // BaÅŸlÄ±k ekle
          const h = document.createElement("h4");
          h.textContent = "ğŸ”´ Vadesi GeÃ§miÅŸ Taksitler";
          overdueEl.appendChild(h);
          overdueItems.forEach(item => {
            const div = document.createElement("div");
            // Her vadesi geÃ§miÅŸ kart iÃ§in benzersiz id ata
            div.id = `taksit-${item.ogrId}-${item.index}`;
            let cardClass = "record-card taksit-overdue";
            if (item.partial > 0) cardClass += " taksit-kismi";
            div.className = cardClass;
            const symb = { "TRY":"â‚º","USD":"$","EUR":"â‚¬" }[item.paraBirimi] || "";
            const kalan = Math.max(0, item.tutar - item.partial).toFixed(2);
            const durumText = item.odendi ? "Ã–dendi" : (item.partial > 0 ? "KÄ±smi Ã–dendi" : "Ã–denmedi");
            let actions = "";
            if (item.odendi) {
              actions += `<button class="btn-guncelle" onclick="taksitSetOdenmedi('${item.ogrId}','${item.index}')">Ã–denmedi</button>`;
              actions += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
            } else {
              actions += `<button class="btn-guncelle" onclick="taksitSetOdendi('${item.ogrId}','${item.index}')">Ã–dendi</button>`;
              actions += `<button class="btn-guncelle" onclick="taksitKismiOdeme('${item.ogrId}','${item.index}',${item.tutar},${item.partial})">KÄ±smi Ã–deme</button>`;
              if (item.partial > 0) {
                actions += `<button class="btn-guncelle" onclick="taksitKismiGeriAl('${item.ogrId}','${item.index}')">KÄ±smi Geri Al</button>`;
                actions += `<button class="btn-guncelle" onclick="viewMakbuz('${item.ogrId}','${item.index}')">Makbuz</button>`;
              }
            }
            // UyarÄ± gÃ¶nder butonu
            actions += `<button class="btn-guncelle" onclick="sendOverdueReminder('${item.ogrId}','${item.index}')">UyarÄ± GÃ¶nder</button>`;
            div.innerHTML = `
            <div class="record-header">
              <span>${item.ogrAd} (${item.ogrNo})</span>
              <span>${item.tutar.toFixed(2)} ${symb}</span>
            </div>
            <div class="record-details">
              <span>Program: <strong>${item.program}</strong></span> |
              <span>Tarih: <strong>${formatTarih(item.tarih)}</strong></span> |
              <span>Durum: <strong>${durumText}</strong></span>
            </div>
            <div class="record-details">
              <span>Kalan: <strong>${kalan} ${symb}</strong></span>
            </div>
            <div class="record-actions">
              ${actions}
            </div>
            `;
            overdueEl.appendChild(div);
          });
        } else {
          // overdueEl boÅŸsa gizle
          overdueEl.innerHTML = "";
        }
      }
      // Liste oluÅŸturulduktan sonra, kaydedilen kaydÄ±rma konumu varsa geri dÃ¶n
      if (typeof window.prevTaksitScrollY !== 'undefined') {
        const yPos = window.prevTaksitScrollY;
        window.prevTaksitScrollY = undefined;
        setTimeout(() => {
          window.scrollTo(0, yPos);
        }, 0);
        // Modal aÃ§Ä±lÄ±p kapandÄ±ktan sonra da konum korunsun diye gecikmeli olarak tekrar kaydÄ±r
        setTimeout(() => {
          window.scrollTo(0, yPos);
        }, 500);
      }
      // EÄŸer son tÄ±klanan kart ID'si kaydedildiyse, bu kartÄ± merkeze kaydÄ±r
      if (window.lastTaksitCardId) {
        const target = document.getElementById(window.lastTaksitCardId);
        window.lastTaksitCardId = undefined;
        if (target) {
          setTimeout(() => {
            target.scrollIntoView({ block: 'center' });
          }, 0);
          // Modal kapandÄ±ktan sonra da hedefe kaydÄ±r
          setTimeout(() => {
            target.scrollIntoView({ block: 'center' });
          }, 500);
        }
      }
    });
  }

  function taksitOdendiToggle(ogrId, index, mevcut) {
    const ref = firebase.database().ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/odendi`);
    ref.set(!mevcut).then(() => {
      taksitListele();
    });
  }

  function taksitFiltreTemizle() {
    const ad = document.getElementById("taksitAraAd");
    const durumSel = document.getElementById("taksitDurum");
    const basInp = document.getElementById("taksitBaslangic");
    const bitInp = document.getElementById("taksitBitis");
    if (ad) ad.value = "";
    if (durumSel) durumSel.value = "";
    if (basInp) basInp.value = "";
    if (bitInp) bitInp.value = "";
    taksitListele();
  }

  function odemeListele() {
    const listEl = document.getElementById("odemeListesi");
    if (!listEl) return;
    const search = document.getElementById("odemeAraAd")?.value.trim().toLowerCase() || "";
    const noSearch = document.getElementById("odemeAraNo")?.value.trim().toLowerCase() || "";
    const program = document.getElementById("odemeProgram")?.value || "";
    listEl.innerHTML = "<p>YÃ¼kleniyor...</p>";
    firebase.database().ref("ogrenciler").once("value", snap => {
      const data = snap.val();
      if (!data) {
        listEl.innerHTML = "<p>ğŸ“­ KayÄ±t bulunamadÄ±.</p>";
        return;
      }
      let items = [];
      Object.keys(data).forEach(id => {
        const ogr = data[id];
        const ogrBilgi = ogr.ogrenci || {};
        const odeme = ogr.odeme || {};
        const taksitler = odeme.taksitler || {};
        if (program && ogrBilgi.egitimProgrami !== program) return;
        const nameLower = (ogrBilgi.adSoyad || "").toLowerCase();
        const ogrNoLower = (ogrBilgi.ogrNo || "").toLowerCase();
        if (search && !nameLower.includes(search)) return;
        if (noSearch && !ogrNoLower.includes(noSearch)) return;
        // Toplam tutarÄ± taksitlerin toplamÄ±ndan hesapla
        let toplamTutar = 0;
        let odenen = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          toplamTutar += parseFloat(t.tutar || 0);
          if (t.odendi) {
            odenen += parseFloat(t.tutar || 0);
          } else if (t.odenen) {
            odenen += parseFloat(t.odenen || 0);
          }
        });
        items.push({
          ogrId: id,
          ogrAd: ogrBilgi.adSoyad || "",
          ogrNo: ogrBilgi.ogrNo || "",
          sinif: ogrBilgi.sinif || "",
          grup: ogrBilgi.grup || "",
          program: ogrBilgi.egitimProgrami || "",
          toplamTutar: toplamTutar,
          odenen: odenen,
          paraBirimi: odeme.paraBirimi || "TRY"
        });
      });
      listEl.innerHTML = "";
      if (items.length === 0) {
        listEl.innerHTML = "<p>ğŸ“­ KayÄ±t bulunamadÄ±.</p>";
        return;
      }
      items.forEach(item => {
        const symbolMap = { "TRY":"â‚º", "USD":"$", "EUR":"â‚¬" };
        const sym = symbolMap[item.paraBirimi] || "";
        const format = (v) => `${v.toFixed(2)} ${sym}`;
        const kalan = item.toplamTutar - item.odenen;
        const div = document.createElement("div");
        div.className = "record-card";
        div.innerHTML = `
        <div class="record-title"><strong>${item.ogrAd} (${item.ogrNo})</strong></div>
        <div class="record-details">
          <span>Program: <strong>${item.program}</strong></span> |
          <span>SÄ±nÄ±f/Grup: <strong>${item.sinif}/${item.grup}</strong></span>
        </div>
        <div class="record-details">
          <span>Toplam: <strong>${format(item.toplamTutar)}</strong></span> |
          <span>Ã–denen: <strong>${format(item.odenen)}</strong></span> |
          <span>Kalan: <strong>${format(kalan)}</strong></span>
        </div>
        `;
        listEl.appendChild(div);
      });
    });
  }

  function odemeFiltreTemizle() {
    const ad = document.getElementById("odemeAraAd");
    const noInp = document.getElementById("odemeAraNo");
    const progSel = document.getElementById("odemeProgram");
    if (ad) ad.value = "";
    if (noInp) noInp.value = "";
    if (progSel) progSel.value = "";
    odemeListele();
  }

  /* ========= RAPORLAMA VE YAZDIRMA ========= */
  // YardÄ±mcÄ±: seÃ§ilen rapor tÃ¼rÃ¼ne gÃ¶re tarih aralÄ±ÄŸÄ± dÃ¶ndÃ¼rÃ¼r
  function getDateRangeForReport(type) {
    const now = new Date();
    let start;
    let end = new Date();
    // normalize to 00:00:00 for start and end at 23:59:59? We'll use inclusive conditions later
    switch (type) {
      case 'today':
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week': {
        // Pazartesi baÅŸlangÄ±Ã§lÄ± hafta
        const day = now.getDay() || 7;
        start = new Date(now);
        start.setDate(now.getDate() - day + 1);
        start.setHours(0,0,0,0);
        break;
      }
      case 'month':
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        break;
      case 'year':
        start = new Date(now.getFullYear(), 0, 1);
        break;
      default:
        start = new Date(0);
    }
    return { start, end };
  }

  // Taksit raporu oluÅŸturma ve yazdÄ±rma fonksiyonu
  function taksitRaporla() {
    // Ã–nce rapor tÃ¼rÃ¼nÃ¼ sor
    Swal.fire({
      title: 'Taksit Raporu',
      input: 'select',
      inputOptions: {
        'today': 'BugÃ¼n',
        'week': 'Bu Hafta',
        'month': 'Bu Ay',
        'year': 'Bu YÄ±l',
        'all': 'TÃ¼m Zamanlar',
        'ogrenci': 'Ã–ÄŸrenci BazlÄ±'
      },
      inputPlaceholder: 'Rapor tÃ¼rÃ¼nÃ¼ seÃ§in',
      showCancelButton: true,
      confirmButtonText: 'Devam',
      cancelButtonText: 'Ä°ptal'
    }).then(result => {
      if (!result.isConfirmed) return;
      const type = result.value;
      // Ä°steÄŸe baÄŸlÄ± Ã¶ÄŸrenci numarasÄ± sorulacak
      const getStudentNo = () => {
        return Swal.fire({
          title: 'Ã–ÄŸrenci NumarasÄ±',
          input: 'text',
          inputLabel: 'Raporlamak istediÄŸiniz Ã¶ÄŸrenci numarasÄ±nÄ± girin',
          inputPlaceholder: 'Ã–rn: 8001',
          showCancelButton: true,
          confirmButtonText: 'Devam',
          preConfirm: (value) => {
            if (!value) {
              Swal.showValidationMessage('Ã–ÄŸrenci numarasÄ± girmelisiniz');
            }
            return value;
          }
        });
      };
      const askStatus = (ogrNoVal) => {
        // Durum filtreleri modalÄ±
        Swal.fire({
          title: 'Durum SeÃ§imi',
          html: `
            <div style="text-align:left;">
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="tam" checked> Tam Ã–denen</label>
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="kismi" checked> KÄ±smi Ã–denen</label>
              <label style="display:block;margin-bottom:4px;"><input type="checkbox" value="odenmemis" checked> Ã–denmemiÅŸ</label>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Raporla',
          preConfirm: () => {
            const inputs = document.querySelectorAll('.swal2-content input[type=checkbox]:checked');
            const arr = Array.from(inputs).map(i => i.value);
            if (arr.length === 0) {
              Swal.showValidationMessage('En az bir durum seÃ§melisiniz');
            }
            return arr;
          }
        }).then(res3 => {
          if (!res3.isConfirmed) return;
          const statuses = res3.value;
          generateTaksitReport(type, ogrNoVal, statuses);
        });
      };
      if (type === 'ogrenci') {
        getStudentNo().then(res2 => {
          if (!res2.isConfirmed) return;
          askStatus(res2.value.trim());
        });
      } else {
        askStatus(null);
      }
    });
  }

  function generateTaksitReport(type, ogrNo, statuses) {
    // Tarih aralÄ±ÄŸÄ± belirle
    const { start, end } = getDateRangeForReport(type);
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [];
      Object.keys(data).forEach(id => {
        const ogrBilgi = data[id].ogrenci || {};
        if (ogrNo && ogrBilgi.ogrNo != ogrNo) return;
        const odeme = data[id].odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenen = 0;
        let kalan = 0;
        let count = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const tarihStr = t.tarih;
          if (!tarihStr) return;
          const tarih = new Date(tarihStr);
          if (type !== 'all' && (tarih < start || tarih > end)) return;
          // Taksit durumu belirle: tam, kismi veya odenmemis
          let durum;
          const tutar = parseFloat(t.tutar || 0);
          const odenenTutar = parseFloat(t.odenen || 0);
          if (t.odendi || odenenTutar >= tutar) {
            durum = 'tam';
          } else if (odenenTutar > 0) {
            durum = 'kismi';
          } else {
            durum = 'odenmemis';
          }
          // EÄŸer durum filtre listesinde deÄŸilse bu taksiti dahil etme
          if (Array.isArray(statuses) && statuses.length > 0 && !statuses.includes(durum)) return;
          // tutar ve odenenTutar zaten yukarÄ±da tanÄ±mlandÄ±
          toplam += tutar;
          if (t.odendi) {
            odenen += tutar;
          } else {
            odenen += odenenTutar;
          }
          count++;
        });
        kalan = toplam - odenen;
        if (count > 0) {
          rows.push({
            ogrAd: ogrBilgi.adSoyad || '',
            ogrNo: ogrBilgi.ogrNo || '',
            program: ogrBilgi.egitimProgrami || '',
            sinif: ogrBilgi.sinif || '',
            grup: ogrBilgi.grup || '',
            toplam: toplam,
            odenen: odenen,
          });
        }
      });
      // ToplamlarÄ±n Ã¶zetini hazÄ±rla
      let totalToplam = 0;
      let totalOdenen = 0;
      rows.forEach(r => {
        totalToplam += r.toplam;
        totalOdenen += r.odenen;
      });
      const totalKalan = totalToplam - totalOdenen;
      // Raporun baÅŸlÄ±k ve tarih aralÄ±ÄŸÄ± metinlerini oluÅŸtur
      const titleMap = { 'today':'BugÃ¼n', 'week':'Bu Hafta', 'month':'Bu Ay', 'year':'Bu YÄ±l', 'all':'TÃ¼m Zaman', 'ogrenci':'Ã–ÄŸrenci BazlÄ±' };
      let titleText = titleMap[type] || '';
      if (type === 'ogrenci' && ogrNo) titleText += ` - ${ogrNo}`;
      // Tarih aralÄ±ÄŸÄ± aÃ§Ä±klamasÄ±
      let rangeDesc = '';
      if (type !== 'all') {
        // start ve end Date nesnelerini formatTarih kullanarak formatla
        const s = formatTarih(start.toISOString().split('T')[0]);
        const e = formatTarih(end.toISOString().split('T')[0]);
        rangeDesc = `${s} - ${e}`;
      }
      // HTML ve stil 
      let reportHTML = '<html><head><meta charset="UTF-8"><title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Taksit Raporu</title>';
      reportHTML += '<style>' +
        'body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#333;}' +
        'h1,h2{margin:0;padding:0;text-align:center;}' +
        '.summary{display:flex;justify-content:space-around;background:#f9f9f9;padding:10px 0;margin-top:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}' +
        '.summary div{flex:1;text-align:center;font-size:14px;}' +
        '.summary div span{display:block;font-size:18px;font-weight:bold;margin-top:4px;}' +
        'table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}' +
        'th,td{border:1px solid #ddd;padding:8px;}' +
        'th{background:#ffefe3;color:#b14400;font-weight:600;}' +
        'tr:nth-child(even){background:#f9f9f9;}' +
        '.footer{margin-top:25px;font-size:12px;text-align:center;color:#666;}' +
        '</style>';
      reportHTML += '</head><body onload="window.print()">';
      // Logo ve rapor baÅŸlÄ±ÄŸÄ± satÄ±r haline getirildi; logo sol tarafta, baÅŸlÄ±k hemen saÄŸÄ±nda yer alacak
      reportHTML += `<div style="display:flex; align-items:center; margin-bottom:1rem;">` +
                    `<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />` +
                    `<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Taksit Raporu</h2>` +
                    `</div>`;
      reportHTML += `<h3>${titleText}${rangeDesc ? ' (' + rangeDesc + ')' : ''}</h3>`;
      if (rows.length === 0) {
        reportHTML += `<p>Rapor iÃ§in kayÄ±t bulunamadÄ±.</p>`;
      } else {
        reportHTML += `<div class="summary">` +
          `<div><strong>Toplam Tutar</strong><span>${totalToplam.toFixed(2)}</span></div>` +
          `<div><strong>Ã–denen</strong><span>${totalOdenen.toFixed(2)}</span></div>` +
          `<div><strong>Kalan</strong><span>${totalKalan.toFixed(2)}</span></div>` +
          `<div><strong>Ã–ÄŸrenci SayÄ±sÄ±</strong><span>${rows.length}</span></div>` +
        `</div>`;
        reportHTML += `<table><tr><th>Ã–ÄŸrenci</th><th>Program</th><th>SÄ±nÄ±f/Grup</th><th>Toplam Tutar</th><th>Ã–denen</th><th>Kalan</th></tr>`;
        rows.forEach(r => {
          const kalan = (r.toplam - r.odenen).toFixed(2);
          reportHTML += `<tr><td>${r.ogrAd} (${r.ogrNo})</td><td>${r.program}</td><td>${r.sinif}/${r.grup}</td><td>${r.toplam.toFixed(2)}</td><td>${r.odenen.toFixed(2)}</td><td>${kalan}</td></tr>`;
        });
        reportHTML += `</table>`;
      }
      reportHTML += `<div class="footer">Bu rapor ${new Date().toLocaleString('tr-TR')} tarihinde oluÅŸturuldu.</div>`;
      reportHTML += '</body></html>';
      const newWin = window.open('', '_blank');
      newWin.document.write(reportHTML);
      newWin.document.close();
      newWin.focus();
    });
  }

  // Ã–deme raporu benzeri ÅŸekilde oluÅŸturulur
  function odemeRaporla() {
    Swal.fire({
      title: 'Ã–deme Raporu',
      input: 'select',
      inputOptions: {
        'today': 'BugÃ¼n',
        'week': 'Bu Hafta',
        'month': 'Bu Ay',
        'year': 'Bu YÄ±l',
        'all': 'TÃ¼m Zamanlar',
        'ogrenci': 'Ã–ÄŸrenci BazlÄ±'
      },
      inputPlaceholder: 'Rapor tÃ¼rÃ¼nÃ¼ seÃ§in',
      showCancelButton: true,
      confirmButtonText: 'Devam',
      cancelButtonText: 'Ä°ptal'
    }).then(result => {
      if (!result.isConfirmed) return;
      const type = result.value;
      if (type === 'ogrenci') {
        Swal.fire({
          title: 'Ã–ÄŸrenci NumarasÄ±',
          input: 'text',
          inputLabel: 'Raporlamak istediÄŸiniz Ã¶ÄŸrenci numarasÄ±nÄ± girin',
          inputPlaceholder: 'Ã–rn: 8001',
          showCancelButton: true,
          confirmButtonText: 'OluÅŸtur',
          preConfirm: (value) => {
            if (!value) {
              Swal.showValidationMessage('Ã–ÄŸrenci numarasÄ± girmelisiniz');
            }
            return value;
          }
        }).then(res => {
          if (!res.isConfirmed) return;
          generateOdemeReport(type, res.value.trim());
        });
      } else {
        generateOdemeReport(type, null);
      }
    });
  }

  function generateOdemeReport(type, ogrNo) {
    const { start, end } = getDateRangeForReport(type);
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [];
      Object.keys(data).forEach(id => {
        const ogrBilgi = data[id].ogrenci || {};
        if (ogrNo && ogrBilgi.ogrNo != ogrNo) return;
        const odeme = data[id].odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenen = 0;
        let count = 0;
        Object.keys(taksitler).forEach(idx => {
          const t = taksitler[idx] || {};
          const tarihStr = t.tarih;
          if (!tarihStr) return;
          const tarih = new Date(tarihStr);
          if (type !== 'all' && (tarih < start || tarih > end)) return;
          const tutar = parseFloat(t.tutar || 0);
          toplam += tutar;
          if (t.odendi) {
            odenen += tutar;
          } else {
            odenen += parseFloat(t.odenen || 0);
          }
          count++;
        });
        const kalan = toplam - odenen;
        if (count > 0) {
          rows.push({
            ogrAd: ogrBilgi.adSoyad || '',
            ogrNo: ogrBilgi.ogrNo || '',
            program: ogrBilgi.egitimProgrami || '',
            sinif: ogrBilgi.sinif || '',
            grup: ogrBilgi.grup || '',
            toplam: toplam,
            odenen: odenen,
            kalan: kalan
          });
        }
      });
      // ToplamlarÄ±n Ã¶zetini hazÄ±rla
      let totalToplam = 0;
      let totalOdenen = 0;
      let totalKalan = 0;
      rows.forEach(r => {
        totalToplam += r.toplam;
        totalOdenen += r.odenen;
        totalKalan += r.kalan;
      });
      const titleMap = { 'today':'BugÃ¼n', 'week':'Bu Hafta', 'month':'Bu Ay', 'year':'Bu YÄ±l', 'all':'TÃ¼m Zaman', 'ogrenci':'Ã–ÄŸrenci BazlÄ±' };
      let titleText = titleMap[type] || '';
      if (type === 'ogrenci' && ogrNo) titleText += ` - ${ogrNo}`;
      let rangeDesc = '';
      if (type !== 'all') {
        const s = formatTarih(start.toISOString().split('T')[0]);
        const e = formatTarih(end.toISOString().split('T')[0]);
        rangeDesc = `${s} - ${e}`;
      }
      let reportHTML = '<html><head><meta charset="UTF-8"><title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–deme Raporu</title>';
      reportHTML += '<style>' +
        'body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#333;}' +
        'h1,h2,h3{margin:0;padding:0;text-align:center;}' +
        '.summary{display:flex;justify-content:space-around;background:#f9f9f9;padding:10px 0;margin-top:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}' +
        '.summary div{flex:1;text-align:center;font-size:14px;}' +
        '.summary div span{display:block;font-size:18px;font-weight:bold;margin-top:4px;}' +
        'table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}' +
        'th,td{border:1px solid #ddd;padding:8px;}' +
        'th{background:#ffefe3;color:#b14400;font-weight:600;}' +
        'tr:nth-child(even){background:#f9f9f9;}' +
        '.footer{margin-top:25px;font-size:12px;text-align:center;color:#666;}' +
        '</style>';
      reportHTML += '</head><body onload="window.print()">';
      // Logo ve Ã¶deme raporu baÅŸlÄ±ÄŸÄ± birlikte gÃ¶sterilir; logo sol tarafta konumlandÄ±rÄ±lmÄ±ÅŸtÄ±r
      reportHTML += `<div style="display:flex; align-items:center; margin-bottom:1rem;">` +
                    `<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />` +
                    `<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–deme Raporu</h2>` +
                    `</div>`;
      reportHTML += `<h3>${titleText}${rangeDesc ? ' (' + rangeDesc + ')' : ''}</h3>`;
      if (rows.length === 0) {
        reportHTML += `<p>Rapor iÃ§in kayÄ±t bulunamadÄ±.</p>`;
      } else {
        reportHTML += `<div class="summary">` +
          `<div><strong>Toplam Tutar</strong><span>${totalToplam.toFixed(2)}</span></div>` +
          `<div><strong>Ã–denen</strong><span>${totalOdenen.toFixed(2)}</span></div>` +
          `<div><strong>Kalan</strong><span>${totalKalan.toFixed(2)}</span></div>` +
          `<div><strong>Ã–ÄŸrenci SayÄ±sÄ±</strong><span>${rows.length}</span></div>` +
        `</div>`;
        reportHTML += `<table><tr><th>Ã–ÄŸrenci</th><th>Program</th><th>SÄ±nÄ±f/Grup</th><th>Toplam Tutar</th><th>Ã–denen</th><th>Kalan</th></tr>`;
        rows.forEach(r => {
          reportHTML += `<tr><td>${r.ogrAd} (${r.ogrNo})</td><td>${r.program}</td><td>${r.sinif}/${r.grup}</td><td>${r.toplam.toFixed(2)}</td><td>${r.odenen.toFixed(2)}</td><td>${r.kalan.toFixed(2)}</td></tr>`;
        });
        reportHTML += `</table>`;
      }
      reportHTML += `<div class="footer">Bu rapor ${new Date().toLocaleString('tr-TR')} tarihinde oluÅŸturuldu.</div>`;
      reportHTML += '</body></html>';
      const newWin = window.open('', '_blank');
      newWin.document.write(reportHTML);
      newWin.document.close();
      newWin.focus();
    });
  }

  /* ========= TAKSIT Ã–DEME Ä°ÅLEMLERÄ° ========= */

  // Bu yardÄ±mcÄ± fonksiyon, bir taksit Ã¶demesi alÄ±ndÄ±ÄŸÄ±nda gelir/kayitlar
  // tablosuna otomatik bir gelir kaydÄ± ekler. Odeme tutarÄ± ve kÄ±smi olup olmadÄ±ÄŸÄ±
  // parametre olarak alÄ±nÄ±r ve kaydedilen kayÄ±t kimliÄŸi taksit verisine not edilir.
  async function addGelirForTaksit(ogrId, index, odemeTutari, isKismi) {
    try {
      const db = firebase.database();
      // Ã–ÄŸrenci ve Ã¶deme bilgilerini al
      const [ogrSnap, odemeSnap] = await Promise.all([
        db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
        db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
      ]);
      const ogrBilgi = ogrSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      // Taksit numarasÄ±nÄ± belirle (index genellikle 0 tabanlÄ±)
      const taksitNo = parseInt(index) + 1;
      const adSoyad = ogrBilgi.adSoyad || "";
      const ogrNo = ogrBilgi.ogrNo || "";
      // AÃ§Ä±klama: Ã¶ÄŸrenci adÄ±, numarasÄ± ve taksit numarasÄ±. KÄ±smi Ã¶demede not dÃ¼ÅŸÃ¼lÃ¼r
      const aciklama = `${adSoyad} (${ogrNo}) - ${taksitNo}. taksit${isKismi ? ' (KÄ±smi Ã–deme)' : ''}`;
      // GÃ¼ncel tarih (saat dilimi farkÄ±nÄ± hesaba katar)
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const tarihISO = now.toISOString().split("T")[0];
      // Kategorilerde "Taksit" kategorisi yoksa ekle
      const kategoriRef = db.ref("kategoriGelir");
      try {
        const catSnap = await kategoriRef.orderByChild("ad").equalTo("Taksit").once("value");
        if (!catSnap.exists()) {
          await kategoriRef.push({ ad: "Taksit" });
        }
      } catch (err) {
        console.error("Kategori kontrol hatasÄ±:", err);
      }

      // KayÄ±t nesnesi
      const kayit = {
        tip: "gelir",
        tarih: tarihISO,
        kategori: "Taksit",
        odeme: "taksit",
        paraBirimi: odemeBilgi.paraBirimi || "TRY",
        tutar: parseFloat(odemeTutari) || 0,
        aciklama: aciklama,
        eklenmeZamani: new Date().toISOString()
      };
      // KayÄ±tlar listesine ekle ve anahtarÄ±nÄ± al
      const kayitRef = await db.ref("kayitlar").push(kayit);
      const kayitId = kayitRef.key;
      // Taksit verisine bu kaydÄ± not et
      const gelirKayitlarRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
      await gelirKayitlarRef.update({ [kayitId]: true });
      return kayitId;
    } catch (e) {
      console.error("Gelir kaydÄ± ekleme hatasÄ±:", e);
    }
  }
  // Bu fonksiyon bir taksiti tamamen Ã¶denmiÅŸ olarak iÅŸaretler ve makbuz seÃ§eneklerini gÃ¶sterir.
  // odemeMiktari parametresi isteÄŸe baÄŸlÄ±dÄ±r; eÄŸer verilirse o tutar gelir kaydÄ± iÃ§in kullanÄ±lÄ±r.
  function taksitSetOdendi(ogrId, index, odemeMiktari) {
    // KaydÄ±rma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dÃ¶n
    window.prevTaksitScrollY = window.scrollY;
    // Son tÄ±klanan kartÄ±n id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini gÃ¼ncelleyerek bu karta baÄŸlantÄ±yÄ± kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const taksitRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`);
    taksitRef.once("value").then(snap => {
      const t = snap.val() || {};
      const tutar = parseFloat(t.tutar || 0);
      // Daha Ã¶nce Ã¶denmiÅŸ bir miktar varsa, kalan kÄ±smÄ± hesapla
      const oncekiOdenen = parseFloat(t.odenen || 0);
      let odemeToRecord;
      if (typeof odemeMiktari === "number" && !isNaN(odemeMiktari)) {
        odemeToRecord = odemeMiktari;
      } else {
        odemeToRecord = tutar - oncekiOdenen;
      }
      // odeme bilgilerini gÃ¼ncelle
      taksitRef.update({ odendi: true, odenen: tutar }).then(() => {
        // Ã–deme iÃ§in gelir kaydÄ± ekle (kÄ±smi deÄŸil)
        addGelirForTaksit(ogrId, index, odemeToRecord, false);
        // Ã¶ÄŸrenci bilgilerini al
        Promise.all([
          db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
          db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
        ]).then(([ogrSnap, odemeSnap]) => {
          const ogrBilgi = ogrSnap.val() || {};
          const odemeBilgi = odemeSnap.val() || {};
          // Makbuz seÃ§eneklerini gÃ¶ster
          showMakbuzOptions({
            ogrId: ogrId,
            ogrAd: ogrBilgi.adSoyad || "",
            ogrNo: ogrBilgi.ogrNo || "",
            veliTel: ogrBilgi.velTel || "",
            tutar: tutar,
            odenen: tutar,
            tarih: t.tarih || new Date().toISOString().split("T")[0],
            paraBirimi: odemeBilgi.paraBirimi || "TRY",
            program: ogrBilgi.egitimProgrami || ""
          });
          // Listeleri gÃ¼ncelle
          taksitListele();
          odemeListele();
          // Ã–deme alÄ±ndÄ±ÄŸÄ±nda dashboard ve diÄŸer listeleri yenile
          if (typeof loadDashboardData === 'function') {
            loadDashboardData();
          }
          // Gelir/Gider kayÄ±t listesini de anÄ±nda yenile
          if (typeof kayitlariGetir === 'function') {
            kayitlariGetir();
          }
        });
      });
    });
  }

  // Bu fonksiyon bir taksiti Ã¶denmemiÅŸ olarak iÅŸaretler (geri alma).
  function taksitSetOdenmedi(ogrId, index) {
    // KaydÄ±rma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dÃ¶n
    window.prevTaksitScrollY = window.scrollY;
    // Son tÄ±klanan kartÄ±n id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini gÃ¼ncelleyerek bu karta baÄŸlantÄ±yÄ± kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const taksitRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`);
    taksitRef.once("value").then(snap => {
      const t = snap.val() || {};
      taksitRef.update({ odendi: false, odenen: 0 }).then(() => {
        // Ä°lgili gelir kayÄ±tlarÄ±nÄ± sil
        const gelirKeyRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
        gelirKeyRef.once("value").then(kSnap => {
          const keys = kSnap.val();
          if (keys) {
            const promises = [];
            Object.keys(keys).forEach(k => {
              promises.push(db.ref(`kayitlar/${k}`).remove());
            });
            Promise.all(promises).then(() => {
              gelirKeyRef.remove();
            });
          }
        });
        taksitListele();
        odemeListele();
        // DeÄŸiÅŸiklik sonrasÄ± dashboard'Ä± yenile
        if (typeof loadDashboardData === 'function') {
          loadDashboardData();
        }
        // Kayit listesi de yenilensin
        if (typeof kayitlariGetir === 'function') {
          kayitlariGetir();
        }
      });
    });
  }

  // KÄ±smi Ã¶demeyi geri alÄ±r (Ã¶denen tutarÄ± sÄ±fÄ±rlar ve durum Ã¶denmedi olur)
  function taksitKismiGeriAl(ogrId, index) {
    // KaydÄ±rma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dÃ¶n
    window.prevTaksitScrollY = window.scrollY;
    // Son tÄ±klanan kartÄ±n id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini gÃ¼ncelleyerek bu karta baÄŸlantÄ±yÄ± kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).update({
      odenen: 0,
      odendi: false
    }).then(() => {
      // KÄ±smi Ã¶demelere ait gelir kayÄ±tlarÄ±nÄ± sil
      const gelirKeyRef = db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}/gelirKayitlar`);
      gelirKeyRef.once("value").then(kSnap => {
        const keys = kSnap.val();
        if (keys) {
          const promises = [];
          Object.keys(keys).forEach(k => {
            promises.push(db.ref(`kayitlar/${k}`).remove());
          });
          Promise.all(promises).then(() => {
            gelirKeyRef.remove();
          });
        }
      });
      taksitListele();
      odemeListele();
      // KÄ±smi Ã¶deme geri alÄ±ndÄ±ktan sonra dashboard'Ä± yenile
      if (typeof loadDashboardData === 'function') {
        loadDashboardData();
      }
      // Gelir/Gider kayÄ±t listesini de yenile
      if (typeof kayitlariGetir === 'function') {
        kayitlariGetir();
      }
    });
  }

  // KÄ±smi Ã¶deme iÅŸlemi: kullanÄ±cÄ±dan Ã¶deme tutarÄ± alÄ±r ve gÃ¼nceller.
  function taksitKismiOdeme(ogrId, index, toplamTutar, mevcutOdenen) {
    // KaydÄ±rma konumunu kaydet, liste yenilendikten sonra bu pozisyona geri dÃ¶n
    window.prevTaksitScrollY = window.scrollY;
    // Son tÄ±klanan kartÄ±n id'sini sakla
    window.lastTaksitCardId = `taksit-${ogrId}-${index}`;
    // URL hash'ini gÃ¼ncelleyerek bu karta baÄŸlantÄ±yÄ± kaydet
    try {
      window.location.hash = `taksit-${ogrId}-${index}`;
    } catch(e) {}
    const db = firebase.database();
    const kalan = toplamTutar - mevcutOdenen;
    Swal.fire({
      heightAuto: false,
      title: 'KÄ±smi Ã–deme',
      html: `<p>Kalan tutar: <strong>${kalan.toFixed(2)}</strong></p>`,
      input: 'number',
      inputAttributes: {
        min: 0.01,
        step: '0.01'
      },
      inputLabel: 'Ã–deme TutarÄ±',
      showCancelButton: true,
      confirmButtonText: 'Tamam',
      cancelButtonText: 'Ä°ptal',
      preConfirm: (value) => {
        const v = parseFloat(value);
        if (isNaN(v) || v <= 0) {
          Swal.showValidationMessage('GeÃ§erli bir tutar girin');
        } else if (v > kalan) {
          Swal.showValidationMessage('Tutar kalan deÄŸeri aÅŸamaz');
        }
        return v;
      }
    }).then(result => {
      if (!result.isConfirmed) return;
      // Girilen Ã¶deme tutarÄ±nÄ± deÄŸiÅŸkene al
      const paymentAmount = parseFloat(result.value);
      const yeniOdenen = mevcutOdenen + paymentAmount;
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once("value").then(snap => {
        const t = snap.val() || {};
        const tutar = parseFloat(t.tutar || 0);
        // EÄŸer yeni Ã¶deme tÃ¼m tutarÄ± karÅŸÄ±lÄ±yorsa tam Ã¶deme fonksiyonunu Ã§aÄŸÄ±r.
        // Son yapÄ±lan Ã¶deme tutarÄ± gelir kaydÄ±nda kullanÄ±lmak Ã¼zere parametre olarak iletilir
        if (yeniOdenen >= tutar) {
          taksitSetOdendi(ogrId, index, paymentAmount);
          return;
        }
        db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).update({
          odendi: false,
          odenen: yeniOdenen
        }).then(() => {
          // KÄ±smi Ã¶deme iÃ§in gelir kaydÄ± ekle
          addGelirForTaksit(ogrId, index, paymentAmount, true);
          // Makbuz seÃ§enekleri iÃ§in bilgileri al
          Promise.all([
            db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
            db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
          ]).then(([ogrSnap, odemeSnap]) => {
            const ogrBilgi = ogrSnap.val() || {};
            const odemeBilgi = odemeSnap.val() || {};
            showMakbuzOptions({
              ogrId: ogrId,
              ogrAd: ogrBilgi.adSoyad || "",
              ogrNo: ogrBilgi.ogrNo || "",
              veliTel: ogrBilgi.velTel || "",
              tutar: tutar,
              odenen: yeniOdenen,
              tarih: t.tarih || new Date().toISOString().split("T")[0],
              paraBirimi: odemeBilgi.paraBirimi || "TRY",
              program: ogrBilgi.egitimProgrami || ""
            });
            taksitListele();
            odemeListele();
            // Ã–deme sonrasÄ± dashboard verilerini gÃ¼ncelle
            if (typeof loadDashboardData === 'function') {
              loadDashboardData();
            }
            // Gelir/Gider kayÄ±t listesini de yenile
            if (typeof kayitlariGetir === 'function') {
              kayitlariGetir();
            }
          });
        });
      });
    });
  }

  // Ã–deme sonrasÄ± makbuz ve WhatsApp seÃ§eneklerini gÃ¶steren modal
  async function showMakbuzOptions(detay) {
    // TÃ¼m taksitleri okuyarak toplam kalan borcu ve kalan taksit sayÄ±sÄ±nÄ± hesapla
    let toplamKalan = 0;
    let kalanTaksitSayisi = 0;
    try {
      const snap = await firebase.database().ref(`ogrenciler/${detay.ogrId}/odeme/taksitler`).once("value");
      snap.forEach(child => {
        const t = child.val() || {};
        const tutar = parseFloat(t.tutar || 0);
        const odenen = parseFloat(t.odenen || 0);
        toplamKalan += tutar - odenen;
        // EÄŸer taksit tamamen Ã¶denmemiÅŸse kalan taksit sayÄ±sÄ±na ekle
        if (odenen < tutar) {
          kalanTaksitSayisi++;
        }
      });
    } catch (e) {
      console.error(e);
    }
    const symbolMap = { "TRY":"â‚º", "USD":"$", "EUR":"â‚¬" };
    const sym = symbolMap[detay.paraBirimi] || "";
    const kalanTaksit = (detay.tutar - detay.odenen).toFixed(2);
    const formatted = `${detay.odenen.toFixed(2)} ${sym}`;
    const kalanToplam = toplamKalan.toFixed(2);
    // hesaplanan toplam kalan ve kalan taksit sayÄ±sÄ±nÄ± detay nesnesine ekle
    detay.totalKalan = parseFloat(kalanToplam);
    detay.kalanTaksitSayisi = kalanTaksitSayisi;
    // Daha profesyonel ve bilgilendirici WhatsApp mesajÄ±nÄ± hazÄ±rla
    let waMsg;
    if (detay.odenen >= detay.tutar) {
      // Tam Ã¶deme yapÄ±ldÄ±: taksit kalanÄ± zaten sÄ±fÄ±rdÄ±r. Mesajda kalan toplam borcu bilgilendirme olarak sunulur
      waMsg =
        `Fenomen Ã‡ocuk KulÃ¼bÃ¼\n\n` +
        `SayÄ±n Veli,\n` +
        `${detay.ogrAd} (${detay.ogrNo}) Ã¶ÄŸrencimizin ${formatTarih(detay.tarih)} tarihli Ã¶demesi (${formatted}) tarafÄ±mÄ±za ulaÅŸmÄ±ÅŸtÄ±r.\n` +
        `Toplam kalan tutar: ${kalanToplam} ${sym}\n\n` +
        `Ä°lginiz iÃ§in teÅŸekkÃ¼r eder, saÄŸlÄ±klÄ± ve baÅŸarÄ±lÄ± gÃ¼nler dileriz.`;
    } else {
      // KÄ±smi Ã¶deme: hem taksit kalanÄ± hem toplam borÃ§ bilgisi yer alÄ±r
      waMsg =
        `Fenomen Ã‡ocuk KulÃ¼bÃ¼\n\n` +
        `SayÄ±n Veli,\n` +
        `${detay.ogrAd} (${detay.ogrNo}) Ã¶ÄŸrencimizin ${formatTarih(detay.tarih)} tarihli taksitine ${formatted} tutarÄ±nda kÄ±smi Ã¶deme yapÄ±lmÄ±ÅŸtÄ±r.\n` +
        `Bu taksitin kalan tutarÄ±: ${kalanTaksit} ${sym}\n` +
        `Toplam kalan tutar: ${kalanToplam} ${sym}\n\n` +
        `Ä°lginiz iÃ§in teÅŸekkÃ¼r eder, saÄŸlÄ±klÄ± ve baÅŸarÄ±lÄ± gÃ¼nler dileriz.`;
    }
    // Modal baÅŸlÄ±ÄŸÄ±nÄ± belirle
    const title = (detay.odenen >= detay.tutar) ? 'Ã–deme Kaydedildi' : 'KÄ±smi Ã–deme Kaydedildi';
    // Ä°Ã§erik: kalan taksit ve toplam/Ã¶denecek bilgisi. 
    // BaÅŸlÄ±k satÄ±rlarÄ± kullanÄ±cÄ±ya Ã¶deme detaylarÄ±nÄ± Ã¶zetler.
    let htmlContent = `
        <p><strong>${detay.ogrAd} (${detay.ogrNo})</strong> iÃ§in ${formatted} Ã¶deme kaydedildi.</p>
        <p>Tarih: <strong>${formatTarih(detay.tarih)}</strong></p>
        <p>Taksit KalanÄ±: <strong>${kalanTaksit} ${sym}</strong></p>
        <p>Toplam Kalan Tutar: <strong>${kalanToplam} ${sym}</strong></p>
        <div style="margin-top:1rem; display:flex; gap:0.5rem; justify-content:center;">
          <button id="printReceiptBtn" class="swal2-confirm swal2-styled" style="background:#28a745;">Makbuz Ã‡Ä±ktÄ±sÄ±</button>
          <button id="whatsAppBtn" class="swal2-confirm swal2-styled" style="background:#25D366;">WhatsApp</button>
        </div>
      `;
    // EÄŸer tam Ã¶deme ise taksit kalanÄ±nÄ± sÄ±fÄ±r olarak gÃ¶ster, ancak yine de bilgilendirme satÄ±rÄ±nda yazdÄ±r
    Swal.fire({
      title: title,
      html: htmlContent,
      showConfirmButton: false,
      showCloseButton: true,
      didOpen: () => {
        const printBtn = document.getElementById('printReceiptBtn');
        const waBtn = document.getElementById('whatsAppBtn');
        // Makbuzu yazdÄ±rma butonu
        printBtn.addEventListener('click', () => {
          const receiptHTML = generateMakbuzHTML(detay);
          // Yeni pencere aÃ§Ä±p makbuzu gÃ¶ster, otomatik yazdÄ±rma yerine kullanÄ±cÄ±ya bÄ±rak
          const win = window.open('', '_blank');
          win.document.write(receiptHTML);
          win.document.close();
          win.focus();
        });
        // WhatsApp butonu: mesajÄ± gÃ¶nder
        waBtn.addEventListener('click', () => {
          sendWhatsappReceipt(waMsg, detay.veliTel);
        });
      },
      // Modal kapanÄ±rken kaydÄ±rma konumunu koru
      willClose: () => {
        try {
          // KayÄ±tlÄ± scroll pozisyonu varsa geri dÃ¶n
          if (typeof window.prevTaksitScrollY !== 'undefined') {
            const y = window.prevTaksitScrollY;
            // birkaÃ§ deneme ile scroll'u geri getir
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 0);
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 300);
            window.prevTaksitScrollY = undefined;
          }
          // Son tÄ±klanan kart id'sine scroll
          if (window.lastTaksitCardId) {
            const target = document.getElementById(window.lastTaksitCardId);
            window.lastTaksitCardId = undefined;
            if (target) {
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 0);
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 300);
            }
          }
        } catch (e) {
          console.error(e);
        }
      },
      heightAuto: false,
      didClose: () => {
        // BazÄ± tarayÄ±cÄ±larda modal tamamen kapatÄ±ldÄ±ktan sonra scroll sÄ±fÄ±rlanabilir;
        // bu nedenle aynÄ± iÅŸlemi burada da tekrarla
        try {
          if (typeof window.prevTaksitScrollY !== 'undefined') {
            const y = window.prevTaksitScrollY;
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 0);
            setTimeout(() => {
              window.scrollTo(0, y);
            }, 300);
            window.prevTaksitScrollY = undefined;
          }
          if (window.lastTaksitCardId) {
            const target = document.getElementById(window.lastTaksitCardId);
            window.lastTaksitCardId = undefined;
            if (target) {
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 0);
              setTimeout(() => {
                target.scrollIntoView({ block: 'center' });
              }, 300);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }
    });
  }

// ğŸ“„ Åablon rehberi modalÄ±nÄ± aÃ§ar
function gosterSablonModal() {
  const modal = document.getElementById('sablonModal');
  if (modal) {
    modal.style.display = 'block';
  }
}

// ğŸ“„ Åablon rehberi modalÄ±nÄ± kapatÄ±r
function kapatSablonModal(evt) {
  // EÄŸer bir etkinlik gÃ¶nderilmiÅŸse, Ã¼stteki olayÄ± durdur
  if (evt) evt.stopPropagation();
  const modal = document.getElementById('sablonModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// DOM yÃ¼klendiÄŸinde ÅŸablon modalÄ±ndaki Ã§arpÄ± dÃ¼ÄŸmesine kapatma davranÄ±ÅŸÄ± baÄŸlanÄ±r
document.addEventListener('DOMContentLoaded', () => {
  const sablonModal = document.getElementById('sablonModal');
  if (sablonModal) {
    const closeBtn = sablonModal.querySelector('.close');
    if (closeBtn) {
      // Daha gÃ¼venilir kapatma iÃ§in addEventListener kullanÄ±lÄ±yor
      closeBtn.addEventListener('click', () => {
        sablonModal.style.display = 'none';
      });
    }
  }
});

  // Makbuz HTML iÃ§eriÄŸi oluÅŸturur (A4 formatÄ±nda basit bir dizayn)
  function generateMakbuzHTML(detay) {
    const symbolMap = { "TRY":"â‚º", "USD":"$", "EUR":"â‚¬" };
    const sym = symbolMap[detay.paraBirimi] || "";
    const formatted = `${detay.odenen.toFixed(2)} ${sym}`;
    const kalanInstalment = (detay.tutar - detay.odenen).toFixed(2);
    const totalKalan = (typeof detay.totalKalan !== 'undefined') ? detay.totalKalan.toFixed(2) : '';
    const kalanTaksitSayisi = (typeof detay.kalanTaksitSayisi !== 'undefined') ? detay.kalanTaksitSayisi : '';
    return `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Makbuz</title>
        <style>
          body { font-family: Arial, sans-serif; padding:40px; }
          h2 { text-align:center; margin-bottom:20px; }
          table { width:100%; border-collapse: collapse; margin-top:20px; }
          td { padding:8px; vertical-align: top; }
          .footer { margin-top:40px; text-align:center; font-size:12px; color:#666; }
        </style>
      </head>
      <body>
        <!-- Makbuz baÅŸlÄ±ÄŸÄ±nda kulÃ¼p logosu gÃ¶sterilir -->
        <div style="display:flex; align-items:center; margin-bottom:20px;">
          <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />
          <h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–deme Makbuzu</h2>
        </div>
        <table>
          <tr>
            <td><strong>Ã–ÄŸrenci:</strong></td><td>${detay.ogrAd} (${detay.ogrNo})</td>
          </tr>
          <tr>
            <td><strong>Program:</strong></td><td>${detay.program}</td>
          </tr>
          <tr>
            <td><strong>Tarih:</strong></td><td>${formatTarih(detay.tarih)}</td>
          </tr>
          <tr>
            <td><strong>Ã–denen Tutar:</strong></td><td>${formatted}</td>
          </tr>
          <tr>
            <td><strong>Taksit KalanÄ±:</strong></td><td>${kalanInstalment} ${sym}</td>
          </tr>
          <tr>
            <td><strong>Toplam Kalan Tutar:</strong></td><td>${totalKalan} ${sym}</td>
          </tr>
          <tr>
            <td><strong>Kalan Taksit SayÄ±sÄ±:</strong></td><td>${kalanTaksitSayisi}</td>
          </tr>
        </table>
        <div class="footer">
          Bu makbuz Fenomen Ã‡ocuk KulÃ¼bÃ¼ tarafÄ±ndan ${new Date().toLocaleDateString("tr-TR")} tarihinde oluÅŸturulmuÅŸtur.
        </div>
      </body>
    </html>
    `;
  }

  // Yeni pencere aÃ§arak makbuzu yazdÄ±rÄ±r
  function printMakbuz(html) {
    const newWin = window.open("", "_blank");
    newWin.document.write(html);
    newWin.document.close();
    // baskÄ±yÄ± tetikle
    newWin.focus();
    newWin.print();
    newWin.close();
  }

  // WhatsApp mesajÄ± gÃ¶nderme fonksiyonu
  function sendWhatsappReceipt(message, phone) {
    // Telefon numarasÄ± varsa linki ona gÃ¶re hazÄ±rla; yoksa genel link
    let url = "https://wa.me/";
    if (phone) {
      // TÃ¼rkiye formatÄ±nda telefon numarasÄ±ndan non-digit karakterleri Ã§Ä±kar
      const digits = phone.replace(/\D/g, "");
      // EÄŸer baÅŸta sÄ±fÄ±r varsa kaldÄ±r ve +90 ekle
      let normalized = digits;
      if (normalized.startsWith("0")) normalized = normalized.substring(1);
      if (!normalized.startsWith("90")) normalized = "90" + normalized;
      url += normalized;
    }
    url += "?text=" + encodeURIComponent(message);
    window.open(url, "_blank");
  }

  // Vadesi geÃ§miÅŸ taksitler iÃ§in hatÄ±rlatma mesajÄ±
  function sendOverdueReminder(ogrId, index) {
    const db = firebase.database();
    Promise.all([
      db.ref(`ogrenciler/${ogrId}/ogrenci`).once("value"),
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once("value"),
      db.ref(`ogrenciler/${ogrId}/odeme`).once("value")
    ]).then(([ogrSnap, tSnap, odemeSnap]) => {
      const ogrBilgi = ogrSnap.val() || {};
      const t = tSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      const symbolMap = { "TRY":"â‚º","USD":"$","EUR":"â‚¬" };
      const sym = symbolMap[odemeBilgi.paraBirimi || "TRY"] || "";
      const kalan = (parseFloat(t.tutar || 0) - parseFloat(t.odenen || 0)).toFixed(2);
      const msg = `Fenomen Ã‡ocuk KulÃ¼bÃ¼\n\n` +
        `DeÄŸerli Veli,\n` +
        `${ogrBilgi.adSoyad || ""} (${ogrBilgi.ogrNo || ""}) Ã¶ÄŸrencimizin ${formatTarih(t.tarih)} tarihli ${kalan} ${sym} tutarÄ±ndaki Ã¶demesi vadesini geÃ§miÅŸtir. ` +
        `LÃ¼tfen en kÄ±sa sÃ¼rede Ã¶demenizi gerÃ§ekleÅŸtirmenizi rica ederiz.\n` +
        `Fenomen Ã‡ocuk KulÃ¼bÃ¼`;
      sendWhatsappReceipt(msg, ogrBilgi.velTel || "");
    });
  }

  /* ========= TOPLU Ã–ÄRENCÄ° Ä°ÅLEMLERÄ° ========= */
  // Ã–ÄŸrenci listesini CSV olarak dÄ±ÅŸa aktar
  function excelDisariAktar() {
    // Ã–ÄŸrenci listesini Excel formatÄ±nda dÄ±ÅŸa aktar. FiltrelenmiÅŸ sonuÃ§lar varsa onlarÄ± kullan, yoksa tÃ¼m listeyi getir.
    const ogrList = window.filteredOgrenciler;
    const promise = ogrList && Array.isArray(ogrList) ? Promise.resolve(ogrList) : firebase.database().ref("ogrenciler").once("value").then(snap => {
      const data = snap.val() || {};
      return Object.entries(data).map(([id, d]) => ({ id, ...d }));
    });
    promise.then(list => {
      if (!list || list.length === 0) {
        Swal.fire('UyarÄ±', 'AktarÄ±lacak Ã¶ÄŸrenci bulunamadÄ±.', 'warning');
        return;
      }

  // Excel ÅŸablon dosyasÄ±nÄ± indir
  function indirExcelSablon() {
    const link = document.createElement('a');
    link.href = 'ogrenci_sablon.xlsx';
    link.download = 'ogrenci_sablon.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
      // Excel Ã§alÄ±ÅŸma kitabÄ± oluÅŸtur
      const wb = XLSX.utils.book_new();
      const rows = [];
      // BaÅŸlÄ±k satÄ±rÄ±
      rows.push(["Ã–ÄŸrenci ID", "Ad Soyad", "Ã–ÄŸrenci No", "SÄ±nÄ±f", "Grup", "Program", "Toplam Tutar", "Ã–denen"]);
      list.forEach(item => {
        const info = item.ogrenci || {};
        const odeme = item.odeme || {};
        const taksitler = odeme.taksitler || {};
        let toplam = 0;
        let odenenTop = 0;
        Object.keys(taksitler).forEach(k => {
          const t = taksitler[k];
          toplam += parseFloat(t.tutar || 0);
          if (t.odendi) {
            odenenTop += parseFloat(t.tutar || 0);
          } else if (t.odenen) {
            odenenTop += parseFloat(t.odenen || 0);
          }
        });
        rows.push([
          item.id,
          info.adSoyad || "",
          info.ogrNo || "",
          info.sinif || "",
          info.grup || "",
          info.egitimProgrami || "",
          toplam.toFixed(2),
          odenenTop.toFixed(2)
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      // Stil: baÅŸlÄ±k satÄ±rÄ± iÃ§in arka plan rengi ve kalÄ±n font (ÅŸu an basit)
      // ExcelJS kullanÄ±lmadÄ±ÄŸÄ± iÃ§in sÄ±nÄ±rlÄ± stil; ancak bold uygulanabilir.
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell = ws[XLSX.utils.encode_cell({ r:0, c:C })];
        if (cell) {
          cell.s = {
            fill: { fgColor: { rgb: "FFF3E0" } },
            font: { bold: true, color: { rgb: "BF360C" } },
            alignment: { horizontal: "center" }
          };
        }
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Ã–ÄŸrenciler');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ogrenci_listesi.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  // Toplu Ã¶ÄŸrenci yÃ¼kleme modalÄ±
  function acTopluYukleModal() {
    Swal.fire({
      title: 'Excel DosyasÄ± YÃ¼kle',
      html: '<input type="file" id="excelFileInput" accept=".xlsx" />',
      showCancelButton: true,
      confirmButtonText: 'YÃ¼kle',
      cancelButtonText: 'Ä°ptal',
      preConfirm: () => {
        const fileInput = document.getElementById('excelFileInput');
        if (!fileInput.files || fileInput.files.length === 0) {
          Swal.showValidationMessage('LÃ¼tfen bir Excel (.xlsx) dosyasÄ± seÃ§in');
        }
        return fileInput.files[0];
      }
    }).then(res => {
      if (!res.isConfirmed) return;
      const file = res.value;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        try {
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          topluOgrenciYukleExcel(json);
        } catch (error) {
          console.error('Excel dosyasÄ± iÅŸlenirken hata oluÅŸtu', error);
          Swal.fire('Hata', 'Dosya okunurken hata oluÅŸtu. LÃ¼tfen geÃ§erli bir Excel dosyasÄ± seÃ§in.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });
  }

  // CSV'den Ã¶ÄŸrencileri ekle
  function topluOgrenciYukle(csvText) {
    const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
    // Ä°lk satÄ±r baÅŸlÄ±k olabilir, onu atla
    let startIndex = 0;
    if (lines[0] && (lines[0].toLowerCase().includes("ad") || lines[0].toLowerCase().includes("ogrno"))) {
      startIndex = 1;
    }

  // Excel veri dizisinden Ã¶ÄŸrencileri ekle
  function topluOgrenciYukleExcel(rows) {
    if (!rows || rows.length === 0) {
      Swal.fire('UyarÄ±', 'YÃ¼klenecek veri bulunamadÄ±.', 'warning');
      return;
    }
    const updates = {};
    rows.forEach(row => {
      // SatÄ±rda gereken alanlar: Ad Soyad, Ã–ÄŸrenci No, Veli Telefon, SÄ±nÄ±f, Grup, Program, Toplam Tutar, Taksit SayÄ±sÄ±
      const adSoyad = (row['Ad Soyad'] || '').toString().trim();
      const ogrNo = (row['Ã–ÄŸrenci No'] || '').toString().trim();
      const veliTel = (row['Veli Telefon'] || '').toString().trim();
      const sinif = (row['SÄ±nÄ±f'] || '').toString().trim();
      const grup = (row['Grup'] || '').toString().trim();
      const program = (row['Program'] || '').toString().trim();
      const toplamTutar = parseFloat(row['Toplam Tutar'] || 0) || 0;
      const taksitSayisi = parseInt(row['Taksit SayÄ±sÄ±'] || 0) || 0;
      if (!adSoyad || !ogrNo) return; // temel alanlar
      const newKey = firebase.database().ref().child('ogrenciler').push().key;
      updates[`ogrenciler/${newKey}/ogrenci`] = {
        adSoyad: adSoyad,
        ogrNo: ogrNo,
        velTel: veliTel,
        egitimProgrami: program,
        sinif: sinif,
        grup: grup
      };
      // odeme ve taksitler
      const taksitler = {};
      const taksitTutar = taksitSayisi > 0 ? (toplamTutar / taksitSayisi) : 0;
      for (let i = 0; i < taksitSayisi; i++) {
        // Taksit tarihlerini boÅŸ bÄ±rak; kullanÄ±cÄ± daha sonra dÃ¼zenlesin
        taksitler[i] = { tutar: taksitTutar, tarih: '', odenen: 0, odendi: false };
      }
      updates[`ogrenciler/${newKey}/odeme`] = {
        paraBirimi: 'TRY',
        toplamTutar: toplamTutar,
        taksitler: taksitler
      };
    });
    firebase.database().ref().update(updates).then(() => {
      Swal.fire('BaÅŸarÄ±lÄ±', 'Ã–ÄŸrenciler yÃ¼klendi.', 'success');
      ogrListele();
    }).catch(err => {
      console.error(err);
      Swal.fire('Hata', 'Ã–ÄŸrenciler yÃ¼klenirken bir hata oluÅŸtu.', 'error');
    });
  }
    const updates = {};
    lines.slice(startIndex).forEach(line => {
      const parts = line.split(",");
      if (parts.length < 3) return;
      const adSoyad = parts[0].replace(/^\"|\"$/g, "").trim();
      const ogrNo = parts[1].trim();
      const velTel = parts[2].trim();
      const newKey = firebase.database().ref().child('ogrenciler').push().key;
      updates[`ogrenciler/${newKey}/ogrenci`] = {
        adSoyad: adSoyad,
        ogrNo: ogrNo,
        velTel: velTel,
        egitimProgrami: "",
        sinif: "",
        grup: ""
      };
      updates[`ogrenciler/${newKey}/odeme`] = {
        paraBirimi: "TRY",
        toplamTutar: 0,
        taksitler: {}
      };
    });
    firebase.database().ref().update(updates).then(() => {
      Swal.fire('BaÅŸarÄ±lÄ±', 'Ã–ÄŸrenciler yÃ¼klendi.', 'success');
      ogrListele();
    }).catch(err => {
      console.error(err);
      Swal.fire('Hata', 'Ã–ÄŸrenciler yÃ¼klenemedi.', 'error');
    });
  }
function topluOgrenciYukleExcel(jsonData) {
    if (!Array.isArray(jsonData) || jsonData.length === 0) {
        alert("Excel dosyasÄ±nda geÃ§erli Ã¶ÄŸrenci verisi bulunamadÄ±.");
        return;
    }

    let yuklenen = 0;
    let basarisiz = 0;

    jsonData.forEach((item, index) => {
        const toplamTutar = parseFloat(item["Toplam Tutar"] || 0);
        const taksitSayisi = parseInt(item["Taksit SayÄ±sÄ±"] || 1);
        const ilkTaksitTarihi = new Date(item["Ä°lk Taksit Tarihi"]);
        const taksitTutari = Math.floor(toplamTutar / taksitSayisi);

        const taksitler = [];
        for (let i = 0; i < taksitSayisi; i++) {
            const tarih = new Date(ilkTaksitTarihi);
            tarih.setMonth(tarih.getMonth() + i);
            taksitler.push({
                tarih: tarih.toISOString().split("T")[0], // yyyy-mm-dd
                tutar: taksitTutari,
                odenen: 0,
                odendi: false
            });
        }

        const payload = {
            guncellenmeZamani: new Date().toISOString(),
            ogrenci: {
                adSoyad: item["Ad Soyad"],
                dogumTarihi: formatTarih(item["DoÄŸum Tarihi"]),
                tc: item["TC Kimlik No"],
                ogrNo: item["Ã–ÄŸrenci NumarasÄ±"],
                sinif: item["SÄ±nÄ±f"],
                grup: item["Grup"],
                okul: item["Okul AdÄ±"],
                egitimProgrami: item["EÄŸitim ProgramÄ±"],
                kayitTarihi: formatTarih(item["KayÄ±t Tarihi"]),
                islemTarihi: new Date().toISOString().split("T")[0]
            },
            veli: {
                adSoyad: item["Veli Ad Soyad"],
                telefon1: item["Veli Telefon 1"],
                telefon2: item["Veli Telefon 2"]
            },
            odeme: {
                toplamTutar: toplamTutar,
                paraBirimi: item["Para Birimi"],
                taksitler: taksitler
            }
        };

        firebase.database().ref("ogrenciler").push(payload)
            .then(() => {
                yuklenen++;
                if (yuklenen + basarisiz === jsonData.length) {
                    alert(`âœ” Toplam YÃ¼kleme TamamlandÄ±\nBaÅŸarÄ±lÄ±: ${yuklenen}\nHatalÄ±: ${basarisiz}`);
                }
            })
            .catch((err) => {
                console.error(`âŒ SatÄ±r ${index + 2} yÃ¼klenemedi`, err);
                basarisiz++;
                if (yuklenen + basarisiz === jsonData.length) {
                    alert(`âœ” Toplam YÃ¼kleme TamamlandÄ±\nBaÅŸarÄ±lÄ±: ${yuklenen}\nHatalÄ±: ${basarisiz}`);
                }
            });
    });

    function formatTarih(tarihStr) {
        const [gun, ay, yil] = tarihStr.split(".");
        return `${yil}-${ay.padStart(2, "0")}-${gun.padStart(2, "0")}`;
    }
}



  // Toplu silme iÅŸlemi
  function acTopluSilModal() {
    // FiltrelenmiÅŸ Ã¶ÄŸrencileri kullan, yoksa Ã¶nce listeleyin
    const list = window.filteredOgrenciler && Array.isArray(window.filteredOgrenciler)
      ? window.filteredOgrenciler
      : [];
    if (!list || list.length === 0) {
      Swal.fire('UyarÄ±', 'Silinecek Ã¶ÄŸrenci bulunamadÄ±. LÃ¼tfen Ã¶nce listeleyin veya filtreleyin.', 'warning');
      return;
    }
    // HazÄ±rlanacak modal iÃ§eriÄŸi ve arama filtreli liste oluÅŸturma
    Swal.fire({
      title: 'Toplu Silme',
      html: `
        <input id="sil-search" class="swal2-input" placeholder="Ã–ÄŸrenci ara (ad veya no)">
        <div id="sil-list" style="max-height:300px; overflow:auto; text-align:left; margin-top:0.5rem;"></div>
      `,
      showCancelButton: true,
      confirmButtonText: 'SeÃ§ilenleri Sil',
      cancelButtonText: 'Ä°ptal',
      didOpen: () => {
        const listContainer = document.getElementById('sil-list');
        function renderList(filter = '') {
          const filtLower = filter.toLowerCase();
          listContainer.innerHTML = list
            .filter(item => {
              const ad = (item.ogrenci?.adSoyad || '').toLowerCase();
              const no = (item.ogrenci?.ogrNo || '').toLowerCase();
              return ad.includes(filtLower) || no.includes(filtLower);
            })
            .map(item => {
              const ad = item.ogrenci?.adSoyad || '-';
              const no = item.ogrenci?.ogrNo || '-';
              return `<label style="display:flex; align-items:center; margin:4px 0;">
                <input type="checkbox" value="${item.id}" style="margin-right:8px;"> ${ad} (${no})
              </label>`;
            })
            .join('');
        }
        renderList();
        const searchInput = document.getElementById('sil-search');
        searchInput.addEventListener('input', (e) => {
          renderList(e.target.value);
        });
      },
      preConfirm: () => {
        const checkboxes = document.querySelectorAll('#sil-list input[type=checkbox]:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);
        if (ids.length === 0) {
          Swal.showValidationMessage('LÃ¼tfen silinecek Ã¶ÄŸrencileri seÃ§in');
        }
        return ids;
      }
    }).then(res => {
      if (!res.isConfirmed) return;
      const selectedIds = res.value || [];
      if (selectedIds.length === 0) return;
      // Kesin onay iÃ§in ikinci bir modal
      Swal.fire({
        title: 'Emin misiniz?',
        text: `${selectedIds.length} Ã¶ÄŸrenciyi silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, sil',
        cancelButtonText: 'Ä°ptal'
      }).then(res2 => {
        if (!res2.isConfirmed) return;
        const updates = {};
        selectedIds.forEach(id => {
          updates[`ogrenciler/${id}`] = null;
        });
        firebase.database().ref().update(updates).then(() => {
          Swal.fire('Silindi', 'SeÃ§ilen Ã¶ÄŸrenciler silindi.', 'success');
          ogrListele();
          taksitListele();
          odemeListele();
        }).catch(err => {
          console.error(err);
          Swal.fire('Hata', 'Ã–ÄŸrenciler silinirken hata oluÅŸtu.', 'error');
        });
      });
    });
  }

  /* ========= YAZDIRMA VE RAPORLAMA ========= */
  // YazdÄ±rma ve raporlama butonlarÄ± iÃ§in basit fonksiyonlar
  function taksitYazdir() {
    window.print();
  }
  function odemeYazdir() {
    window.print();
  }
  // taksitRaporla ve odemeRaporla fonksiyonlarÄ± yukarÄ±da tanÄ±mlandÄ±

  /**
   * Taksit veya kÄ±smi Ã¶deme yapÄ±ldÄ±ktan sonra makbuz bilgilerini tekrar
   * gÃ¶rÃ¼ntÃ¼lemek veya WhatsApp mesajÄ± oluÅŸturmak iÃ§in Ã§aÄŸrÄ±lÄ±r. Bu fonksiyon
   * ilgili taksit kaydÄ±nÄ± ve Ã¶ÄŸrenci/Ã¶deme bilgilerini okur ve showMakbuzOptions
   * fonksiyonunu yeniden tetikler. BÃ¶ylece liste Ã¼zerindeki â€œMakbuzâ€ butonlarÄ±
   * aracÄ±lÄ±ÄŸÄ±yla da Ã¶deme makbuzu ve WhatsApp mesajÄ± alÄ±nabilir.
   *
   * @param {string} ogrId  Ã–ÄŸrenci kayÄ±t IDâ€™si
   * @param {string} index  Taksit dizin anahtarÄ±
   */
  function viewMakbuz(ogrId, index) {
    const db = firebase.database();
    Promise.all([
      db.ref(`ogrenciler/${ogrId}/odeme/taksitler/${index}`).once('value'),
      db.ref(`ogrenciler/${ogrId}/ogrenci`).once('value'),
      db.ref(`ogrenciler/${ogrId}/odeme`).once('value')
    ]).then(([tSnap, ogrSnap, odemeSnap]) => {
      const t = tSnap.val() || {};
      const ogrBilgi = ogrSnap.val() || {};
      const odemeBilgi = odemeSnap.val() || {};
      const tutar = parseFloat(t.tutar || 0);
      const odenen = parseFloat(t.odenen || 0);
      showMakbuzOptions({
        ogrId: ogrId,
        ogrAd: ogrBilgi.adSoyad || '',
        ogrNo: ogrBilgi.ogrNo || '',
        veliTel: ogrBilgi.velTel || '',
        tutar: tutar,
        odenen: odenen,
        tarih: t.tarih || new Date().toISOString().split('T')[0],
        paraBirimi: odemeBilgi.paraBirimi || 'TRY',
        program: ogrBilgi.egitimProgrami || ''
      });
    });
  }

  /* ====== DASHBOARD ====== */
  // Chart instances (global) for destroying if re-rendered
  let monthlyChartObj = null;
  let statusChartObj = null;

  function loadDashboardData() {
    const dashStudent = document.getElementById('dashStudentCount');
    const dashDue = document.getElementById('dashTotalDue');
    const dashPaid = document.getElementById('dashTotalPaid');
    const dashRemaining = document.getElementById('dashTotalRemaining');
    const dashOverdue = document.getElementById('dashTotalOverdue');
    const dashPartial = document.getElementById('dashTotalPartial');
    // Clear old values
    dashStudent.textContent = '-';
    dashDue.textContent = '-';
    dashPaid.textContent = '-';
    dashRemaining.textContent = '-';
    dashOverdue.textContent = '-';
    dashPartial.textContent = '-';
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      let totalStudents = 0;
      // Toplam tutar tÃ¼m taksitlerin toplamÄ±, ancak bugÃ¼n beklenen alacak iÃ§in ayrÄ± hesap yapÄ±lacak
      let totalDue = 0;
      let totalPaid = 0;
      let totalOverdue = 0;
      let partialCount = 0;
      // BugÃ¼n Ã¶demesi beklenen tutar (vadesi bugÃ¼ne denk gelen ve henÃ¼z tam Ã¶denmemiÅŸ taksitlerin kalan tutarÄ±)
      let expectedToday = 0;
      // 12 ay iÃ§in arrays
      const dueMonthly = new Array(12).fill(0);
      const paidMonthly = new Array(12).fill(0);
      const statusCounts = { tam: 0, kismi: 0, odenmemis: 0 };
      const today = new Date();
      Object.values(data).forEach(item => {
        totalStudents++;
        const taksitler = item.odeme?.taksitler || {};
        Object.values(taksitler).forEach(t => {
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          totalDue += tutar;
          if (t.odendi) totalPaid += tutar; else totalPaid += odenen;
          let durum;
          if (t.odendi || odenen >= tutar) durum = 'tam';
          else if (odenen > 0) durum = 'kismi';
          else durum = 'odenmemis';
          statusCounts[durum]++;
          const tarihStr = t.tarih;
          const date = tarihStr ? new Date(tarihStr) : null;
            if (date && !isNaN(date)) {
              const month = date.getMonth();
              // AylÄ±k tutar daÄŸÄ±lÄ±mÄ± iÃ§in toplam ve Ã¶denen tutarlarÄ± kaydet
              dueMonthly[month] += tutar;
              if (t.odendi) paidMonthly[month] += tutar; else paidMonthly[month] += odenen;
              // Vadesi geÃ§miÅŸ taksit sayÄ±sÄ±nÄ± hesapla
              if (date < today && !t.odendi) {
                totalOverdue++;
                if (odenen > 0 && odenen < tutar) {
                  partialCount++;
                }
              }
              // BugÃ¼n vadesi olan ve henÃ¼z tam olarak Ã¶denmemiÅŸ taksitlerin kalan tutarÄ±nÄ± ekle
              const todayDate = new Date(today);
              todayDate.setHours(0,0,0,0);
              const dateOnly = new Date(date);
              dateOnly.setHours(0,0,0,0);
              if (dateOnly.getTime() === todayDate.getTime()) {
                const remaining = tutar - odenen;
                // Taksit henÃ¼z tamamÄ± Ã¶denmemiÅŸse, kalan tutarÄ± beklenen alacaÄŸa ekle
                if (!t.odendi && remaining > 0) {
                  expectedToday += remaining;
                }
              }
            }
        });
      });
      const totalRemaining = totalDue - totalPaid;
      // GÃ¼ncelle
      dashStudent.textContent = totalStudents;
      // 'Toplam Tutar' yerine bugÃ¼nÃ¼n beklenen alacak miktarÄ±nÄ± gÃ¶ster
      dashDue.textContent = expectedToday.toFixed(2);
      dashPaid.textContent = totalPaid.toFixed(2);
      dashRemaining.textContent = totalRemaining.toFixed(2);
      dashOverdue.textContent = totalOverdue;
      dashPartial.textContent = partialCount;
      // Chartler kaldÄ±rÄ±ldÄ±; bunun yerine dashboard listeleri doldurulur
      // Son 5 kayÄ±tlÄ± Ã¶ÄŸrenci, son 10 gelir/gider kaydÄ± ve vadesi geÃ§miÅŸ Ã¶ÄŸrenciler listesi
      fetchLastStudents();
      fetchLastRecords();
      fetchOverdueStudents();
      fetchUpcomingPayments();
    });
  }

  /* ====== Dashboard Listeleri ====== */
  // Son 5 kayÄ±tlÄ± Ã¶ÄŸrenci listesini getirir ve dashboard'a ekler
  function fetchLastStudents() {
    const listEl = document.getElementById('lastStudentsList');
    if (!listEl) return;
    // Verileri oku
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const students = Object.values(data).map(item => {
        const ogr = item.ogrenci || {};
        const tarihStr = ogr.kayitTarihi || ogr.islemTarihi || '';
        const tarih = tarihStr ? new Date(tarihStr) : null;
        return {
          name: ogr.adSoyad || '-',
          date: tarih
        };
      });
      // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce)
      students.sort((a,b) => {
        const da = a.date && !isNaN(a.date) ? a.date.getTime() : 0;
        const db = b.date && !isNaN(b.date) ? b.date.getTime() : 0;
        return db - da;
      });
      const last = students.slice(0, 5);
      if (last.length === 0) {
        listEl.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
        return;
      }
      listEl.innerHTML = last.map(st => {
        const dateStr = st.date && !isNaN(st.date) ? st.date.toLocaleDateString('tr-TR') : '';
        // ğŸ‘¤ Ã–ÄŸrenci satÄ±rÄ± baÅŸÄ±nda emoji ile gÃ¶ster
        return `<p>ğŸ‘¤ ${st.name}${dateStr ? ' - ' + dateStr : ''}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yÃ¼klenemedi.</p>';
      console.error(err);
    });
  }

  // Son 10 gelir/gider kaydÄ±nÄ± getirir ve dashboard'a ekler
  function fetchLastRecords() {
    const listEl = document.getElementById('lastRecordsList');
    if (!listEl) return;
    firebase.database().ref('kayitlar').once('value').then(snap => {
      const data = snap.val() || {};
      const records = Object.values(data).map(item => {
        const tarih = item.tarih ? new Date(item.tarih) : null;
        return {
          date: tarih,
          type: item.tip || '',
          amount: parseFloat(item.tutar || 0),
          currency: (item.paraBirimi || '').toUpperCase(),
          category: item.kategori || '',
          description: item.aciklama || '',
          payment: item.odeme || ''
        };
      });
      // SÄ±ralama (en yeni Ã¶nce)
      records.sort((a,b) => {
        const da = a.date && !isNaN(a.date) ? a.date.getTime() : 0;
        const db = b.date && !isNaN(b.date) ? b.date.getTime() : 0;
        return db - da;
      });
      const last = records.slice(0, 10);
      if (last.length === 0) {
        listEl.innerHTML = '<p>KayÄ±t bulunamadÄ±.</p>';
        return;
      }
      listEl.innerHTML = last.map(r => {
        const dateStr = r.date && !isNaN(r.date) ? r.date.toLocaleDateString('tr-TR') : '';
        const amountStr = `${r.amount.toFixed(2)} ${r.currency}`;
        const typeStr = r.type ? (r.type.charAt(0).toUpperCase() + r.type.slice(1)) : '';
        const catStr = r.category ? (r.category.charAt(0).toUpperCase() + r.category.slice(1)) : '';
        const descStr = r.description ? r.description : '';
        // BirleÅŸtirme: Tarih - TÃ¼r - Tutar - Kategori - AÃ§Ä±klama
        let line = `${dateStr} - ${typeStr} - ${amountStr}`;
        if (catStr) line += ` - ${catStr}`;
        if (descStr) line += ` - ${descStr}`;
        // KayÄ±t tÃ¼rÃ¼ne gÃ¶re emoji seÃ§imi: gelir â†’ para, gider â†’ Ã§Ä±kÄ±ÅŸ, diÄŸer â†’ dokÃ¼man
        let emoji;
        if (r.type && r.type.toLowerCase() === 'gelir') {
          emoji = 'ğŸ’µ';
        } else if (r.type && r.type.toLowerCase() === 'gider') {
          emoji = 'ğŸ’¸';
        } else {
          emoji = 'ğŸ“„';
        }
        return `<p>${emoji} ${line}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yÃ¼klenemedi.</p>';
      console.error(err);
    });
  }

  // Vadesi geÃ§miÅŸ Ã¶ÄŸrencileri getirir ve dashboard'a ekler
  function fetchOverdueStudents() {
    const listEl = document.getElementById('overdueStudentsList');
    if (!listEl) return;
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const today = new Date();
      const overdueItems = [];
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const veli = item.veli || {};
        const taksitler = item.odeme?.taksitler || {};
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          const odendi = t.odendi;
          if (date && !isNaN(date) && date < today && !odendi && kalan > 0) {
            overdueItems.push({
              name: ogr.adSoyad || '-',
              ogrNo: ogr.ogrNo || '',
              veli: veli.adSoyad || '',
              taksitNo: parseInt(idx) + 1,
              date: date,
              due: kalan
            });
          }
        });
      });
      // Tarihe gÃ¶re ve tutara gÃ¶re sÄ±ralama: en erken vade Ã¶nce
      overdueItems.sort((a,b) => a.date - b.date || b.due - a.due);
      if (overdueItems.length === 0) {
        listEl.innerHTML = '<p>Ã–denmesi geÃ§miÅŸ taksit yok.</p>';
        return;
      }
      listEl.innerHTML = overdueItems.map(o => {
        const dateStr = o.date.toLocaleDateString('tr-TR');
        const nameStr = `${o.name}${o.ogrNo ? ' (' + o.ogrNo + ')' : ''}`;
        const veliStr = o.veli ? o.veli : '';
        const dueStr = 'â‚º' + o.due.toFixed(2);
        // âŒ› Vadesi geÃ§miÅŸ satÄ±rlarÄ±n baÅŸÄ±na emoji ekle
        return `<p>âŒ› ${nameStr} - ${o.taksitNo}. taksit - Veli: ${veliStr} - Vade: ${dateStr} - ${dueStr}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yÃ¼klenemedi.</p>';
      console.error(err);
    });
  }

  // YaklaÅŸan vade: bugÃ¼nden itibaren 7 gÃ¼n iÃ§inde vadesi gelecek taksitleri listeler
  function fetchUpcomingPayments() {
    const listEl = document.getElementById('upcomingPaymentsList');
    if (!listEl) return;
    firebase.database().ref('ogrenciler').once('value').then(snap => {
      const data = snap.val() || {};
      const today = new Date();
      // Sadece tarih kÄ±smÄ±nÄ± dikkate alarak bugÃ¼nÃ¼n saatini sÄ±fÄ±rlayÄ±n
      today.setHours(0,0,0,0);
      const futureDate = new Date(today);
      futureDate.setDate(today.getDate() + 7);
      const upcomingItems = [];
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const veli = item.veli || {};
        const taksitler = item.odeme?.taksitler || {};
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          const odendi = t.odendi;
          if (date && !isNaN(date)) {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            if (d >= today && d <= futureDate && !odendi && kalan > 0) {
              upcomingItems.push({
                name: ogr.adSoyad || '-',
                ogrNo: ogr.ogrNo || '',
                veli: veli.adSoyad || '',
                taksitNo: parseInt(idx) + 1,
                date: d,
                due: kalan
              });
            }
          }
        });
      });
      upcomingItems.sort((a,b) => a.date - b.date || b.due - a.due);
      if (upcomingItems.length === 0) {
        listEl.innerHTML = '<p>YaklaÅŸan Ã¶deme yok.</p>';
        return;
      }
      listEl.innerHTML = upcomingItems.map(o => {
        const dateStr = o.date.toLocaleDateString('tr-TR');
        const nameStr = `${o.name}${o.ogrNo ? ' (' + o.ogrNo + ')' : ''}`;
        const veliStr = o.veli ? o.veli : '';
        const dueStr = 'â‚º' + o.due.toFixed(2);
        // ğŸ“… YaklaÅŸan Ã¶demelerin baÅŸÄ±na emoji ekle
        return `<p>ğŸ“… ${dateStr} - ${nameStr} - ${o.taksitNo}. taksit - Veli: ${veliStr} - ${dueStr}</p>`;
      }).join('');
    }).catch(err => {
      listEl.innerHTML = '<p>Liste yÃ¼klenemedi.</p>';
      console.error(err);
    });
  }

// ğŸ“Š Raporlar modÃ¼lÃ¼nÃ¼n basit rapor oluÅŸturma fonksiyonu
function raporlarOlustur() {
  const tur = document.getElementById('raporlar-tur')?.value || '';
  const baslangic = document.getElementById('raporlar-start-date')?.value || '';
  const bitis = document.getElementById('raporlar-end-date')?.value || '';
  const sinif = document.getElementById('raporlar-sinif')?.value || '';
  const grup = document.getElementById('raporlar-grup')?.value || '';
  const program = document.getElementById('raporlar-program')?.value || '';
  // Rapor tÃ¼rÃ¼ne gÃ¶re ilgili fonksiyona yÃ¶nlendir
  if (tur === 'finans') {
    generateFinansRaporu(baslangic, bitis, sinif, grup, program);
  } else if (tur === 'ogrenci') {
    // Ã–ÄŸrenci raporu
    generateOgrenciRaporu(baslangic, bitis, sinif, grup, program);
  } else if (tur === 'taksit') {
    // Taksit durumu raporu
    generateTaksitRaporu(baslangic, bitis, sinif, grup, program);
  } else {
    // Desteklenmeyen rapor tÃ¼rÃ¼
    const sonucEl = document.getElementById('raporlarSonuc');
    sonucEl.innerHTML = '<p>Bu rapor tÃ¼rÃ¼ iÃ§in geliÅŸtirme yapÄ±lacaktÄ±r.</p>';
    // Desteklenmeyen rapor tÃ¼rÃ¼ iÃ§in baslÄ±k ve logo eklenerek kullanÄ±cÄ±ya bilgi verilir
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼</h2>' +
      '<p style="margin:0;">SeÃ§ilen rapor tÃ¼rÃ¼: ' + tur + ' henÃ¼z desteklenmiyor.</p>' +
      '</div>' +
      '</div>';
  }
}

// Finansal rapor Ã¼retimi â€“ aylÄ±k Ã¶zet (gelir/gider)
function generateFinansRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>YÃ¼kleniyor...</p>';
  firebase.database().ref('kayitlar').once('value', snap => {
    const data = snap.val();
    const summary = {};
    if (data) {
      Object.values(data).forEach(k => {
        const tarih = k.tarih;
        if (!tarih) return;
        const dateObj = new Date(tarih);
        if (startDate) {
          const sd = new Date(startDate);
          if (dateObj < sd) return;
        }
        if (endDate) {
          const ed = new Date(endDate);
          // son gÃ¼nÃ¼n saat farklÄ±lÄ±ÄŸÄ± nedeniyle ertesi gÃ¼ne kaymamasÄ± iÃ§in gÃ¼n sonu olarak ayarla
          ed.setHours(23,59,59,999);
          if (dateObj > ed) return;
        }
        // SÄ±nÄ±f, grup veya program filtreleri ÅŸu an finansal raporda kullanÄ±lmÄ±yor; ileri geliÅŸtirme iÃ§in hazÄ±r.
        const ayStr = dateObj.toLocaleDateString('tr-TR', { year:'numeric', month:'long' });
        if (!summary[ayStr]) summary[ayStr] = { gelir:0, gider:0 };
        const tutar = parseFloat(k.tutar) || 0;
        if (k.tip === 'gelir') summary[ayStr].gelir += tutar;
        else if (k.tip === 'gider') summary[ayStr].gider += tutar;
      });
    }
    const months = Object.keys(summary).sort((a,b) => new Date('1 ' + a) - new Date('1 ' + b));
    let tableHTML = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    tableHTML += '<thead><tr><th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Ay</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam Gelir (â‚º)</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam Gider (â‚º)</th>' +
                 '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Fark (â‚º)</th></tr></thead><tbody>';
    months.forEach(ay => {
      const g = summary[ay].gelir.toFixed(2);
      const d = summary[ay].gider.toFixed(2);
      const fark = (summary[ay].gelir - summary[ay].gider).toFixed(2);
      tableHTML += '<tr><td style="padding:6px;">' + ay + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + g + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + d + '</td>' +
                   '<td style="padding:6px; text-align:right;">' + fark + '</td></tr>';
    });
    tableHTML += '</tbody></table>';
    sonucEl.innerHTML = tableHTML;
    // YazdÄ±rma ve WhatsApp mesajÄ± iÃ§in baÅŸlÄ±k ve tabloyu sakla
    // Rapor Ã§Ä±ktÄ±sÄ±nda kulÃ¼p logosunun sol Ã¼st kÃ¶ÅŸede gÃ¶rÃ¼nmesi iÃ§in baÅŸlÄ±ÄŸa logo ekliyoruz.
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼</h2>' +
      '<h3 style="margin:0;">AylÄ±k Finansal Ã–zet</h3>' +
      '</div>' +
      '</div>' +
      tableHTML;
  });
}

// Ã–ÄŸrenci raporu oluÅŸturur: Ã¶deme bilgilerini ve kalan tutarlarÄ± listeler
function generateOgrenciRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>YÃ¼kleniyor...</p>';
  firebase.database().ref('ogrenciler').once('value', snap => {
    const data = snap.val();
    const rows = [];
    if (data) {
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const taksitler = item.odeme?.taksitler || {};
        const toplamTutar = item.odeme?.toplamTutar ? parseFloat(item.odeme.toplamTutar) : 0;
        // SÄ±nÄ±f, grup ve program filtreleri
        if (sinif && ogr.sinif && ogr.sinif.toString() !== sinif.toString()) return;
        if (grup && ogr.grup && ogr.grup.toString() !== grup.toString()) return;
        if (program && ogr.egitimProgrami && ogr.egitimProgrami.toString() !== program.toString()) return;
        // Tarih aralÄ±ÄŸÄ± filtresi: kayÄ±t tarihi veya eklenmeZamani kullan
        let dateStr = ogr.kayitTarihi || ogr.islemTarihi || item.eklenmeZamani || '';
        if (startDate) {
          const sd = new Date(startDate);
          const d = dateStr ? new Date(dateStr) : null;
          if (d && d < sd) return;
        }
        if (endDate) {
          const ed = new Date(endDate);
          ed.setHours(23,59,59,999);
          const d = dateStr ? new Date(dateStr) : null;
          if (d && d > ed) return;
        }
        // Ã–denen ve kalan tutarlarÄ±n hesabÄ±
        let paid = 0;
        let remaining = 0;
        Object.values(taksitler).forEach(t => {
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          paid += odenen;
          remaining += (tutar - odenen);
        });
        rows.push({
          adSoyad: ogr.adSoyad || '',
          ogrNo: ogr.ogrNo || '',
          sinif: ogr.sinif || '',
          grup: ogr.grup || '',
          program: ogr.egitimProgrami || '',
          toplam: toplamTutar.toFixed(2),
          odenen: paid.toFixed(2),
          kalan: remaining.toFixed(2)
        });
      });
    }
    if (rows.length === 0) {
      sonucEl.innerHTML = '<p>Listelenecek Ã¶ÄŸrenci bulunamadÄ±.</p>';
      window.lastReportHTML = '';
      return;
    }
    // Tabloyu oluÅŸtur
    let html = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    html += '<thead><tr>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Ã–ÄŸrenci</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">No</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">SÄ±nÄ±f</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Grup</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Program</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Toplam (â‚º)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Ã–denen (â‚º)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Kalan (â‚º)</th>' +
      '</tr></thead><tbody>';
    let toplamToplam = 0, toplamOdenen = 0, toplamKalan = 0;
    rows.forEach(r => {
      html += '<tr><td style="padding:6px;">' + r.adSoyad + '</td>' +
        '<td style="padding:6px;">' + r.ogrNo + '</td>' +
        '<td style="padding:6px;">' + r.sinif + '</td>' +
        '<td style="padding:6px;">' + r.grup + '</td>' +
        '<td style="padding:6px;">' + r.program + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.toplam + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.odenen + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.kalan + '</td></tr>';
      toplamToplam += parseFloat(r.toplam);
      toplamOdenen += parseFloat(r.odenen);
      toplamKalan += parseFloat(r.kalan);
    });
    html += '<tr style="font-weight:bold;"><td style="padding:6px;" colspan="5">Toplam</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamToplam.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamOdenen.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamKalan.toFixed(2) + '</td></tr>';
    html += '</tbody></table>';
    sonucEl.innerHTML = html;
    // Ã–ÄŸrenci Ã¶deme raporunun baÅŸlÄ±ÄŸÄ±na kulÃ¼p logosu eklendi
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼</h2>' +
      '<h3 style="margin:0;">Ã–ÄŸrenci Ã–deme Raporu</h3>' +
      '</div>' +
      '</div>' +
      html;
  });
}

// Taksit durumu raporu: taksitlerin vade ve Ã¶deme durumlarÄ±nÄ± listeler
function generateTaksitRaporu(startDate, endDate, sinif, grup, program) {
  const sonucEl = document.getElementById('raporlarSonuc');
  sonucEl.innerHTML = '<p>YÃ¼kleniyor...</p>';
  firebase.database().ref('ogrenciler').once('value', snap => {
    const data = snap.val();
    const rows = [];
    if (data) {
      Object.values(data).forEach(item => {
        const ogr = item.ogrenci || {};
        const taksitler = item.odeme?.taksitler || {};
        // SÄ±nÄ±f, grup, program filtreleri
        if (sinif && ogr.sinif && ogr.sinif.toString() !== sinif.toString()) return;
        if (grup && ogr.grup && ogr.grup.toString() !== grup.toString()) return;
        if (program && ogr.egitimProgrami && ogr.egitimProgrami.toString() !== program.toString()) return;
        Object.entries(taksitler).forEach(([idx, t]) => {
          const date = t.tarih ? new Date(t.tarih) : null;
          if (!date || isNaN(date)) return;
          // Tarih aralÄ±ÄŸÄ± filtresi (vade)
          if (startDate) {
            const sd = new Date(startDate);
            if (date < sd) return;
          }
          if (endDate) {
            const ed = new Date(endDate);
            ed.setHours(23,59,59,999);
            if (date > ed) return;
          }
          const tutar = parseFloat(t.tutar || 0);
          const odenen = parseFloat(t.odenen || 0);
          const kalan = tutar - odenen;
          let durum = '';
          const today = new Date();
          if (t.odendi || kalan <= 0) {
            durum = 'Ã–dendi';
          } else if (date < today) {
            durum = 'Vadesi GeÃ§ti';
          } else if (date.toDateString() === today.toDateString()) {
            durum = 'BugÃ¼n';
          } else {
            durum = 'YaklaÅŸan';
          }
          rows.push({
            tarih: date,
            adSoyad: ogr.adSoyad || '',
            ogrNo: ogr.ogrNo || '',
            sinif: ogr.sinif || '',
            grup: ogr.grup || '',
            program: ogr.egitimProgrami || '',
            taksitNo: parseInt(idx) + 1,
            tutar: tutar.toFixed(2),
            odenen: odenen.toFixed(2),
            kalan: kalan.toFixed(2),
            durum: durum
          });
        });
      });
    }
    if (rows.length === 0) {
      sonucEl.innerHTML = '<p>Listelenecek taksit bulunamadÄ±.</p>';
      window.lastReportHTML = '';
      return;
    }
    // Vade sÄ±rasÄ±na gÃ¶re sÄ±ralama
    rows.sort((a,b) => a.tarih - b.tarih);
    let html = '<table style="width:100%; border-collapse: collapse; font-size:0.9rem;">';
    html += '<thead><tr>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Vade</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Ã–ÄŸrenci</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">No</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">SÄ±nÄ±f</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Grup</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Program</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Taksit No</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Tutar (â‚º)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Ã–denen (â‚º)</th>' +
      '<th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Kalan (â‚º)</th>' +
      '<th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Durum</th>' +
      '</tr></thead><tbody>';
    let toplamTutar = 0, toplamOdenen = 0, toplamKalan = 0;
    rows.forEach(r => {
      const dateStr = r.tarih.toLocaleDateString('tr-TR');
      html += '<tr><td style="padding:6px;">' + dateStr + '</td>' +
        '<td style="padding:6px;">' + r.adSoyad + '</td>' +
        '<td style="padding:6px;">' + r.ogrNo + '</td>' +
        '<td style="padding:6px;">' + r.sinif + '</td>' +
        '<td style="padding:6px;">' + r.grup + '</td>' +
        '<td style="padding:6px;">' + r.program + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.taksitNo + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.tutar + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.odenen + '</td>' +
        '<td style="padding:6px; text-align:right;">' + r.kalan + '</td>' +
        '<td style="padding:6px;">' + r.durum + '</td></tr>';
      toplamTutar += parseFloat(r.tutar);
      toplamOdenen += parseFloat(r.odenen);
      toplamKalan += parseFloat(r.kalan);
    });
    html += '<tr style="font-weight:bold;"><td style="padding:6px;" colspan="7">Toplam</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamTutar.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamOdenen.toFixed(2) + '</td>' +
      '<td style="padding:6px; text-align:right;">' + toplamKalan.toFixed(2) + '</td>' +
      '<td style="padding:6px;"></td></tr>';
    html += '</tbody></table>';
    sonucEl.innerHTML = html;
    // Taksit durumu raporunun baÅŸlÄ±ÄŸÄ±na kulÃ¼p logosu eklendi
    window.lastReportHTML =
      '<div style="display:flex; align-items:center; margin-bottom:1rem;">' +
      '<img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" style="width:60px;height:auto;margin-right:10px;" />' +
      '<div>' +
      '<h2 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼</h2>' +
      '<h3 style="margin:0;">Taksit Durumu Raporu</h3>' +
      '</div>' +
      '</div>' +
      html;
  });
}

// Raporu Excel dosyasÄ±na kaydetmek iÃ§in fonksiyon
function raporlarExcelIndir() {
  if (!window.lastReportHTML) {
    Swal.fire('UyarÄ±','LÃ¼tfen Ã¶nce rapor oluÅŸturun.','warning');
    return;
  }
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = window.lastReportHTML;
  const table = tempDiv.querySelector('table');
  if (!table) {
    Swal.fire('Hata','Tablo bulunamadÄ±.','error');
    return;
  }
  // SheetJS ile tabloyu kitaba dÃ¶nÃ¼ÅŸtÃ¼r
  const wb = XLSX.utils.table_to_book(table, {sheet: 'Rapor'});
  XLSX.writeFile(wb, 'rapor.xlsx');
}

// Raporu yazdÄ±rmak iÃ§in yeni fonksiyon
function raporlarYazdir() {
  if (!window.lastReportHTML) {
    Swal.fire('UyarÄ±','LÃ¼tfen Ã¶nce rapor oluÅŸturun.','warning');
    return;
  }
  const printWin = window.open('', '_blank');
  printWin.document.write('<html><head><title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ Rapor</title>');
  printWin.document.write('<style>body{font-family:Arial, sans-serif; margin:20px;} table{width:100%; border-collapse:collapse;} th, td{border:1px solid #ddd; padding:8px;} th{background:#f2f2f2;}</style>');
  printWin.document.write('</head><body>');
  printWin.document.write(window.lastReportHTML);
  printWin.document.write('</body></html>');
  printWin.document.close();
  printWin.focus();
  printWin.print();
  printWin.close();
}

// WhatsApp mesajÄ± oluÅŸturma fonksiyonu
function raporlarWhatsappGonder() {
  // WhatsApp mesajÄ±nÄ± rapor verilerine gÃ¶re hazÄ±rlayÄ±p modal penceresini aÃ§ar.
  // KullanÄ±cÄ± rapor oluÅŸturmadan bu butona basarsa uyarÄ± gÃ¶sterilir.
  if (!window.lastReportHTML) {
    Swal.fire('UyarÄ±','LÃ¼tfen Ã¶nce rapor oluÅŸturun.','warning');
    return;
  }
  // SeÃ§ilen rapor parametrelerini oku
  const tur = document.getElementById('raporlar-tur')?.value || '';
  const baslangic = document.getElementById('raporlar-start-date')?.value || '';
  const bitis = document.getElementById('raporlar-end-date')?.value || '';
  const sinif = document.getElementById('raporlar-sinif')?.value || '';
  const grup = document.getElementById('raporlar-grup')?.value || '';
  const program = document.getElementById('raporlar-program')?.value || '';
  // Rapor iÃ§eriÄŸini DOM'a yÃ¼kleyip dÃ¼z metne Ã§evir
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = window.lastReportHTML;
  // Tabloyu daha okunabilir bir dÃ¼z metne Ã§evir.
  let raporMetni = '';
  const table = tempDiv.querySelector('table');
  if (table) {
    const rows = Array.from(table.querySelectorAll('tr'));
    const rowTexts = rows.map(row => {
      const cells = Array.from(row.children);
      // HÃ¼cre iÃ§eriklerini Ã§ubuklarla ayÄ±rarak birleÅŸtir
      return cells.map(c => c.innerText.trim()).join(' | ');
    });
    raporMetni = rowTexts.join('\n');
  } else {
    // EÄŸer tablo yoksa tÃ¼m iÃ§eriÄŸi tek satÄ±r olarak al
    raporMetni = tempDiv.innerText.trim();
  }
  // Mesaj baÅŸlÄ±ÄŸÄ± ve seÃ§ilen filtreleri topla
  const turMap = { finans: 'Finansal Rapor', ogrenci: 'Ã–ÄŸrenci Raporu', taksit: 'Taksit Durumu Raporu' };
  const lines = [];
  lines.push('Fenomen Ã‡ocuk KulÃ¼bÃ¼');
  if (turMap[tur]) {
    lines.push('');
    lines.push(turMap[tur]);
  }
  // Tarih aralÄ±ÄŸÄ± varsa ekle
  if (baslangic || bitis) {
    let basStr = '';
    let bitStr = '';
    try {
      basStr = baslangic ? formatTarih(baslangic) : '';
    } catch(e) {
      basStr = baslangic;
    }
    try {
      bitStr = bitis ? formatTarih(bitis) : '';
    } catch(e) {
      bitStr = bitis;
    }
    if (basStr && bitStr) {
      lines.push(`Tarih AralÄ±ÄŸÄ±: ${basStr} - ${bitStr}`);
    } else if (basStr) {
      lines.push(`BaÅŸlangÄ±Ã§ Tarihi: ${basStr}`);
    } else if (bitStr) {
      lines.push(`BitiÅŸ Tarihi: ${bitStr}`);
    }
  }
  if (sinif) lines.push(`SÄ±nÄ±f: ${sinif}`);
  if (grup) lines.push(`Grup: ${grup}`);
  if (program) lines.push(`Program: ${program}`);
  if (lines[lines.length - 1] !== '') lines.push('');
  // Rapor tablosunun dÃ¼z metnini ekle
  lines.push(raporMetni);
  const finalMsg = lines.join('\n');
  document.getElementById('whatsappMesaji').value = finalMsg;
  // Modal'i elle aÃ§: mesaj zaten atandÄ±, olusturWhatsappMesaji() Ã§aÄŸrÄ±lmasÄ±n
  document.getElementById('whatsappModal').style.display = 'block';
}

  /* ------------------ TAKSIT / ODEME BITIS ------------------ */

  
// ----- Yedekleme FonksiyonlarÄ± -----
function yedekOlustur() {
    Swal.fire({
        title: 'Yedek alÄ±nsÄ±n mÄ±?',
        text: 'TÃ¼m verilerin yedeÄŸi oluÅŸturularak cihaza indirilecektir.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, yedekle',
        cancelButtonText: 'Ä°ptal'
    }).then((result) => {
        if (result.isConfirmed) {
            firebase.database().ref().once('value').then((snapshot) => {
                const data = snapshot.val() || {};
                const now = new Date();
                const pad = (n) => n.toString().padStart(2,'0');
                const dateStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const fileName = `yedek_${dateStr}_${code}.json`;
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                Swal.fire('BaÅŸarÄ±lÄ±', `Yedek dosyasÄ± oluÅŸturuldu: ${fileName}`, 'success');
            }).catch((error) => {
                Swal.fire('Hata', 'Yedek alÄ±nÄ±rken bir hata oluÅŸtu: ' + error.message, 'error');
            });
        }
    });
}

function yedekYukle() {
    Swal.fire({
        title: 'Yedek geri yÃ¼klensin mi?',
        text: 'Bu iÅŸlem mevcut veri tabanÄ±nÄ± silip seÃ§ilen yedek dosyasÄ±nÄ± yÃ¼kler.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, geri yÃ¼kle',
        cancelButtonText: 'Ä°ptal'
    }).then((result) => {
        if (result.isConfirmed) {
            const input = document.getElementById('yedekDosyaInput');
            input.value = '';
            input.click();
        }
    });
}

// Gizli dosya seÃ§me inputu iÃ§in deÄŸiÅŸiklik olayÄ±nÄ± dinle
document.addEventListener('DOMContentLoaded', () => {
    const dosyaInput = document.getElementById('yedekDosyaInput');
    if (dosyaInput) {
        dosyaInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                let jsonData;
                try {
                    jsonData = JSON.parse(event.target.result);
                } catch (err) {
                    Swal.fire('Hata', 'Yedek dosyasÄ± okunamadÄ± veya geÃ§ersiz format.', 'error');
                    return;
                }
                Swal.fire({
                    title: 'YÃ¼kleniyor',
                    text: 'Veriler geri yÃ¼kleniyor...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                firebase.database().ref().set(null).then(() => {
                    return firebase.database().ref().set(jsonData || {});
                }).then(() => {
                    Swal.close();
                    Swal.fire('BaÅŸarÄ±lÄ±', 'Yedek geri yÃ¼klendi.', 'success');
                    if (typeof loadDashboardData === 'function') loadDashboardData();
                    if (typeof kayitlariGetir === 'function') kayitlariGetir();
                    if (typeof kategorileriYukle === 'function') kategorileriYukle();
                    if (typeof kategoriSecimiYukle === 'function') kategoriSecimiYukle();
                }).catch((error) => {
                    Swal.close();
                    Swal.fire('Hata', 'Geri yÃ¼kleme sÄ±rasÄ±nda hata: ' + error.message, 'error');
                });
            };
            reader.readAsText(file);
        });
    }
});
</script>

</body>
</html>
